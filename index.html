<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ShulTime Diagnostic</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        :root { --primary: #0D2B4F; --bg: #F2F4F8; }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Roboto", sans-serif; background: var(--bg); color: #111; padding-bottom: 250px; }
        
        /* FLOATING HEADER */
        .floating-header {
            position: fixed; top: 15px; left: 15px; right: 15px; z-index: 1000;
            display: flex; gap: 10px; align-items: center; pointer-events: none;
        }

        /* SEARCH BAR (Standard HTML) */
        .search-container {
            flex-grow: 1; background: white; height: 50px; border-radius: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15); display: flex; align-items: center;
            padding-left: 15px; padding-right: 5px; pointer-events: auto;
        }

        #search-input {
            border: none; background: transparent; font-size: 16px; color: #111;
            flex-grow: 1; height: 100%; outline: none; font-weight: 500;
        }

        /* BUTTONS */
        .circle-btn {
            width: 50px; height: 50px; border-radius: 50%; background: white; border: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15); display: flex; align-items: center; justify-content: center;
            cursor: pointer; color: var(--primary); pointer-events: auto;
        }
        .go-btn {
            background: var(--primary); color: white; border-radius: 20px; 
            width: 50px; height: 40px; border: none; font-weight: bold; cursor: pointer;
        }

        /* DEBUG CONSOLE */
        #debug-console {
            position: fixed; bottom: 0; left: 0; right: 0; height: 150px;
            background: black; color: #0f0; font-family: monospace; font-size: 11px;
            padding: 10px; overflow-y: scroll; z-index: 9999; opacity: 0.9;
            border-top: 2px solid #0f0;
        }

        /* LIST & CARD STYLES */
        #list-view { padding: 15px; padding-top: 90px; }
        .minyan-card {
            background: white; border-radius: 12px; padding: 16px; margin-bottom: 10px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.04); border-left: 5px solid #ccc;
        }
        .type-Shacharis { border-left-color: #4CAF50; } 
        .type-Mincha { border-left-color: #FF9800; }    
        .type-Maariv { border-left-color: #3F51B5; }    

        .card-left h3 { margin: 0; font-size: 16px; color: var(--primary); }
        .distance-tag { font-size: 11px; color: #fff; background: #666; padding: 2px 6px; border-radius: 8px; margin-left: 5px; }
        
        /* MAP VIEW (Forced Visible Logic) */
        #map-view { 
            position: fixed; top: 0; left: 0; right: 0; bottom: 150px; z-index: 0; 
            display: none; /* Toggled by JS */
        }

        /* STATUS PILL */
        #status-pill {
            position: fixed; top: 75px; left: 50%; transform: translateX(-50%);
            background: rgba(13, 43, 79, 0.9); color: white; padding: 6px 16px;
            border-radius: 20px; font-size: 12px; font-weight: 600; 
            backdrop-filter: blur(4px); z-index: 800; display: none;
        }

        /* FAB */
        .fab-location {
            position: fixed; bottom: 160px; right: 20px; width: 56px; height: 56px;
            background: #fff; border-radius: 50%; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            border: none; color: #333; display: flex; align-items: center; justify-content: center; 
            cursor: pointer; z-index: 200;
        }
    </style>
</head>
<body>

    <div class="floating-header">
        <div class="search-container">
            <i class="material-icons" style="color:#888; margin-right:8px;">search</i>
            <input type="text" id="search-input" placeholder="Enter City (e.g. Lakewood)">
            <button class="go-btn" onclick="forceSearch()">GO</button>
        </div>

        <button class="circle-btn" onclick="toggleView()">
            <i class="material-icons" id="toggle-icon">map</i>
        </button>
    </div>

    <div id="status-pill">System Ready</div>

    <div id="list-view"></div>
    <div id="map-view"></div>

    <button class="fab-location" onclick="useMyLocation()">
        <i class="material-icons">my_location</i>
    </button>

    <div id="debug-console">Initializing...<br></div>

    <script>
        // LOGGING
        function log(msg) {
            const c = document.getElementById('debug-console');
            c.innerHTML += `> ${msg}<br>`;
            c.scrollTop = c.scrollHeight;
            console.log(msg);
        }

        let map, geocoder, allMinyanim = [];
        let searchCenter = null;
        let googleLoaded = false;
        const DEFAULT_RADIUS = 20;

        // 1. DATABASE
        fetch('database.json').then(r => r.json()).then(data => {
            log(`DB Loaded: ${data.length} records`);
            processMinyanim(data);
        }).catch(e => log("DB Error: " + e));

        function processMinyanim(data) {
            allMinyanim = [];
            data.forEach(shul => {
                ['Shacharis','Mincha','Maariv'].forEach(type => {
                    if(!shul[type.toLowerCase()]) return;
                    shul[type.toLowerCase()].split(',').forEach(t => {
                        let raw = t.trim().replace(/[^0-9:]/g, '');
                        let [h, m] = raw.split(':').map(Number);
                        let isPM = (type==='Maariv' || (type==='Mincha' && h<9));
                        let sortH = (isPM && h<12) ? h+12 : ((!isPM && h===12) ? 0 : h);
                        allMinyanim.push({
                            name: shul.name, address: shul.address,
                            lat: shul.lat, lng: shul.lng,
                            tefillah: type, timeDisplay: `${h}:${String(m).padStart(2,'0')}`,
                            ampm: isPM ? "PM" : "AM", timeValue: (sortH*60)+m, distance: null
                        });
                    });
                });
            });
            log(`Processed ${allMinyanim.length} times.`);
        }

        // 2. GOOGLE INIT
        async function initApp() {
            log("Google Maps loading...");
            try {
                const { Map } = await google.maps.importLibrary("maps");
                const { Autocomplete } = await google.maps.importLibrary("places");
                
                geocoder = new google.maps.Geocoder();
                googleLoaded = true;

                // MAP SETUP
                map = new Map(document.getElementById("map-view"), {
                    center: { lat: 40.091, lng: -74.218 },
                    zoom: 13,
                    disableDefaultUI: true
                });
                log("Map Initialized (Hidden).");

                // AUTOCOMPLETE SETUP
                const input = document.getElementById("search-input");
                const autocomplete = new Autocomplete(input, { fields: ["geometry", "name"] });

                // EVENT: User selects from dropdown
                autocomplete.addListener("place_changed", () => {
                    log("Dropdown selection detected.");
                    const place = autocomplete.getPlace();
                    if (!place.geometry) {
                        log("No geometry in selection. Trying manual search...");
                        forceSearch();
                        return;
                    }
                    setSearchLocation(place.geometry.location.lat(), place.geometry.location.lng(), place.name);
                });

                // EVENT: User hits Enter
                input.addEventListener("keydown", (e) => {
                    if (e.key === "Enter") forceSearch();
                });

                log("Search System Ready.");

            } catch (e) {
                log("INIT ERROR: " + e.message);
            }
        }

        // 3. SEARCH LOGIC
        function forceSearch() {
            const query = document.getElementById("search-input").value;
            if(!query) { log("Search box empty."); return; }
            
            log(`Forcing search for: "${query}"`);
            
            if(!geocoder) { log("Geocoder not ready yet."); return; }

            geocoder.geocode({ address: query }, (results, status) => {
                if (status === "OK" && results[0]) {
                    const loc = results[0].geometry.location;
                    const name = results[0].formatted_address.split(',')[0]; // Simple name
                    log(`Geocode Success: ${name} (${loc.lat().toFixed(4)})`);
                    setSearchLocation(loc.lat(), loc.lng(), name);
                } else {
                    log("Geocode Failed: " + status);
                    alert("Could not find that location.");
                }
            });
        }

        function setSearchLocation(lat, lng, name) {
            searchCenter = { lat, lng, name };
            
            // UI Updates
            document.getElementById('status-pill').style.display = 'block';
            document.getElementById('status-pill').innerText = `Near: ${name}`;
            log(`Location Locked: ${name}`);

            // Update Map
            if(map) {
                map.setCenter({ lat, lng });
                map.setZoom(14);
            }

            // Run Filter
            runFilter();
        }

        function runFilter() {
            if(!searchCenter) return;
            log("Filtering results...");

            // Calc Distances
            let results = allMinyanim.map(m => {
                m.distance = getDistance(searchCenter.lat, searchCenter.lng, m.lat, m.lng);
                return m;
            }).filter(m => m.distance <= DEFAULT_RADIUS);

            results.sort((a,b) => a.distance - b.distance);
            
            log(`Found ${results.length} matches.`);
            renderList(results);
        }

        function renderList(results) {
            const list = document.getElementById('list-view');
            list.innerHTML = '';
            
            if(results.length === 0) {
                list.innerHTML = `<div style="text-align:center; padding:40px; color:#888;">No results found.</div>`;
                return;
            }

            results.forEach(m => {
                const card = document.createElement('div');
                card.className = `minyan-card type-${m.tefillah}`;
                card.innerHTML = `
                    <div class="card-left">
                        <h3>${m.name} <span class="distance-tag">${m.distance.toFixed(1)} mi</span></h3>
                        <span style="font-size:12px; color:#666;">${m.address}</span>
                    </div>
                    <div class="card-right">
                        <div class="time-display">${m.timeDisplay}<span style="font-size:12px;">${m.ampm}</span></div>
                    </div>
                `;
                // Simple Map Jump
                card.onclick = () => {
                    toggleView(true);
                    if(map) {
                        map.setCenter({ lat: m.lat, lng: m.lng });
                        map.setZoom(16);
                        new google.maps.Marker({
                            position: { lat: m.lat, lng: m.lng },
                            map: map, title: m.name
                        });
                    }
                };
                list.appendChild(card);
            });
        }

        // 4. UTILS
        function useMyLocation() {
            log("Getting GPS...");
            navigator.geolocation.getCurrentPosition(pos => {
                log("GPS Success.");
                document.getElementById("search-input").value = "";
                setSearchLocation(pos.coords.latitude, pos.coords.longitude, "Current Location");
            }, e => log("GPS Error: " + e.message));
        }

        function toggleView(forceMap) {
            const list = document.getElementById('list-view');
            const mapV = document.getElementById('map-view');
            const icon = document.getElementById('toggle-icon');

            if(forceMap || list.style.display !== 'none') {
                list.style.display='none'; mapV.style.display='block'; icon.innerText='list';
                log("Switched to Map");
            } else {
                list.style.display='block'; mapV.style.display='none'; icon.innerText='map';
                log("Switched to List");
            }
        }

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 3958.8; 
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2); 
            return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a))); 
        }

    </script>

    <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAOpNebt0dPJUmiEw-i1W-Dx_UezLpIvxI&loading=async&libraries=places,maps,marker&callback=initApp"></script>
</body>
</html>
