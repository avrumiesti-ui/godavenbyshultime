<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>ShulTime</title>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<style>
    :root { 
        --primary: #0D2B4F; 
        --bg: #F2F4F8; 
        
        /* TEFILLAH COLORS */
        --t-Shacharis: #16a34a; /* Green */
        --t-Mincha: #ea580c;    /* Orange */
        --t-Maariv: #2563eb;    /* Blue */

        /* NUSACH COLORS (Medium Strength) */
        --n-Ashkenaz: #3b82f6;       /* Blue */
        --n-Sefard: #22c55e;         /* Green */
        --n-Ari: #a855f7;            /* Purple */
        --n-Edot-HaMizrach: #f97316; /* Orange */
        --n-Chabad: #14b8a6;         /* Teal */
        --n-Other: #6b7280;          /* Grey */
    }
    
    html, body { margin: 0; padding: 0; height: 100%; overscroll-behavior-y: contain; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Roboto", sans-serif; background: var(--bg); overflow: hidden; }
    
    /* FLOATING HEADER */
    .floating-header {
        position: fixed; top: 15px; left: 12px; right: 12px;
        z-index: 1000; display: flex; gap: 10px; align-items: center; pointer-events: auto;
    }
    .search-container {
        flex: 1; pointer-events: auto; display: flex; align-items: center;
        background: #fff; height: 50px; border-radius: 25px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.15); padding: 0 15px;
        overflow: hidden; 
    }

    gmp-place-autocomplete { width: 100%; height: 100%; --gmp-filled-input-container-color: #fff !important; --gmp-text-color: #111 !important; background-color: #fff !important; }
    gmp-place-autocomplete::part(input) { background-color: #fff !important; padding: 0; font-size: 16px; height: 100%; width: 100%; color: #111 !important; font-weight: 500 !important; outline: none !important; }
    .pac-container { background-color: #fff !important; border-radius: 12px !important; box-shadow: 0 8px 20px rgba(0,0,0,0.15) !important; border: none !important; }

    .circle-btn {
        width: 50px; height: 50px; flex-shrink: 0; pointer-events: auto;
        border-radius: 50%; background: #fff; border: none;
        box-shadow: 0 4px 15px rgba(0,0,0,0.15); display: flex; align-items: center; justify-content: center;
        cursor: pointer; color: var(--primary); transition: all 0.2s;
    }
    .circle-btn.active { background: var(--primary); color: #fff; }

    /* STATUS PILLS */
    .status-area {
        position: fixed; top: 75px; left: 0; right: 0;
        display: flex; justify-content: center; align-items: center; flex-wrap: wrap; gap: 6px;
        z-index: 800; pointer-events: none; padding: 0 10px;
    }
    .status-pill {
        padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: 700;
        display: none; box-shadow: 0 2px 8px rgba(0,0,0,0.1); white-space: nowrap;
    }
    #status-pill { background: rgba(13, 43, 79, 0.95); color: #fff; }
    #count-pill { background: #fff; color: var(--primary); border: 1px solid var(--primary); }
    #map-radius-pill { background: var(--t-Shacharis); color: #fff; }

    /* STICKY HEADER (For Recent/Saved) */
    .sticky-header {
        position: fixed; top: 0; left: 0; right: 0; height: 60px;
        background: rgba(242, 244, 248, 0.85); backdrop-filter: blur(20px);
        border-bottom: 1px solid rgba(0,0,0,0.05); z-index: 900; 
        display: flex; align-items: flex-end; justify-content: center;
        padding-bottom: 12px; font-weight: 800; font-size: 17px; color: var(--primary);
        opacity: 0; transition: opacity 0.2s ease-in-out; pointer-events: none;
    }
    .sticky-header.visible { opacity: 1; pointer-events: auto; }

    /* PAGE HEADERS */
    .page-header {
        font-size: 34px; font-weight: 800; color: var(--primary);
        margin-top: 40px; margin-bottom: 15px; padding-left: 12px;
    }

    /* VIEWS */
    .view-section { 
        position: absolute; inset: 0; 
        padding-bottom: 100px; 
        overflow-y: auto; background: var(--bg); 
        z-index: 10; display: none; 
    }
    #home-view { display: block; }
    
    /* We keep map ALWAYS rendering, but hide list when map is active by display toggling list only */
    #list-view { position: absolute; inset: 0; padding: 110px 12px 100px 12px; overflow-y: auto; z-index: 10; background: var(--bg); }
    #map-view { position: absolute; inset: 0; z-index: 5; }

    #center-marker {
        position: fixed; top: 50%; left: 50%; width: 16px; height: 16px;
        background: #2196F3; border: 3px solid #fff; border-radius: 50%;
        transform: translate(-50%, -50%); z-index: 20; box-shadow: 0 2px 6px rgba(0,0,0,0.4);
        pointer-events: none; display: none;
    }

    /* BOTTOM TOOLBAR */
    .bottom-nav {
        position: fixed; bottom: 0; left: 0; right: 0; height: 75px;
        background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
        border-top: 1px solid #ddd; display: flex; justify-content: space-around; align-items: center;
        z-index: 1500; padding-bottom: env(safe-area-inset-bottom);
    }
    .nav-item {
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        color: #888; font-size: 10px; font-weight: 700; background: none; border: none; cursor: pointer; flex: 1;
    }
    .nav-item.active { color: var(--primary); }
    .nav-item i { font-size: 26px; margin-bottom: 3px; }

    /* CARDS */
    .minyan-card {
        background: #fff; border-radius: 12px; margin-bottom: 8px;
        display: flex; justify-content: space-between; align-items: stretch;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05); overflow: hidden; 
        min-height: 75px; 
    }
    .info-zone { 
        flex: 1; padding: 10px 12px; cursor: pointer; 
        display: flex; flex-direction: column; justify-content: space-between;
        min-width: 0; 
    }
    .map-zone { 
        width: 120px; display: flex; flex-direction: column; align-items: flex-end; justify-content: space-between;
        border-left: 1px solid #f0f0f0; cursor: pointer; background: #fafafa; padding: 10px 12px;
        flex-shrink: 0; text-align: right; position: relative;
    }
    
    .shul-name { font-weight: 800; font-size: 18px; color: #333; line-height: 1.1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .shul-address { font-size: 14px; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 2px; } 
    
    .tefillah-label { position: absolute; top: 10px; right: 12px; font-size: 13px; font-weight: 900; text-transform: uppercase; letter-spacing: 0.5px; } 
    .time-val { position: absolute; top: 50%; right: 12px; transform: translateY(-50%); font-weight: 800; font-size: 20px; color: var(--primary); } 
    
    .map-footer { position: absolute; bottom: 10px; right: 12px; display: flex; align-items: flex-end; gap: 6px; }
    .dist-label { font-size: 13px; font-weight: 800; color: #666; line-height: 1; margin-bottom: 2px; } 
    
    .map-circle { width: 30px; height: 30px; border-radius: 50%; background: #fff; display: flex; align-items: center; justify-content: center; border: 1px solid #eee; box-shadow: 0 2px 4px rgba(0,0,0,0.05);}
    .google-maps-icon { background: linear-gradient(135deg, #4285F4 25%, #34A853 25% 50%, #FBBC05 50% 75%, #EA4335 75%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 20px !important; font-weight: bold; }

    /* NUSACH & TEFILLAH COLORS (Solid Backgrounds) */
    .bg-Ashkenaz { background: var(--n-Ashkenaz) !important; color: #fff !important; }
    .bg-Sefard { background: var(--n-Sefard) !important; color: #fff !important; }
    .bg-Ari { background: var(--n-Ari) !important; color: #fff !important; }
    .bg-Edot-HaMizrach { background: var(--n-Edot-HaMizrach) !important; color: #fff !important; }
    .bg-Chabad { background: var(--n-Chabad) !important; color: #fff !important; }
    .bg-Other { background: var(--n-Other) !important; color: #fff !important; }

    /* For Markers arrow */
    .bg-Ashkenaz::after { border-top-color: var(--n-Ashkenaz) !important; }
    .bg-Sefard::after { border-top-color: var(--n-Sefard) !important; }
    .bg-Ari::after { border-top-color: var(--n-Ari) !important; }
    .bg-Edot-HaMizrach::after { border-top-color: var(--n-Edot-HaMizrach) !important; }
    .bg-Chabad::after { border-top-color: var(--n-Chabad) !important; }
    .bg-Other::after { border-top-color: var(--n-Other) !important; }

    /* Outlined Text for Pills/Chips */
    .text-Ashkenaz { color: var(--n-Ashkenaz) !important; border-color: var(--n-Ashkenaz) !important; }
    .text-Sefard { color: var(--n-Sefard) !important; border-color: var(--n-Sefard) !important; }
    .text-Ari { color: var(--n-Ari) !important; border-color: var(--n-Ari) !important; }
    .text-Edot-HaMizrach { color: var(--n-Edot-HaMizrach) !important; border-color: var(--n-Edot-HaMizrach) !important; }
    .text-Chabad { color: var(--n-Chabad) !important; border-color: var(--n-Chabad) !important; }
    .text-Other { color: var(--n-Other) !important; border-color: var(--n-Other) !important; }

    .txt-Shacharis { color: var(--t-Shacharis) !important; border-color: var(--t-Shacharis) !important; } 
    .txt-Mincha { color: var(--t-Mincha) !important; border-color: var(--t-Mincha) !important; } 
    .txt-Maariv { color: var(--t-Maariv) !important; border-color: var(--t-Maariv) !important; }

    /* TAGS */
    .nusach-tag { font-size: 11px; padding: 4px 10px; border-radius: 12px; display: inline-block; font-weight: 700; text-transform: uppercase; width: fit-content; margin-top: 8px;}
    .time-pill { display: inline-block; padding: 4px 12px; border-radius: 14px; font-weight: 800; font-size: 15px; white-space: nowrap; margin: 2px; border: 2px solid currentColor; background: #fff; }
    
    /* MAP MARKERS */
    .custom-marker { padding: 4px 9px; border-radius: 12px; font-size: 13px; font-weight: 800; box-shadow: 0 2px 6px rgba(0,0,0,0.3); border: 2px solid #fff; display: flex; align-items: center; justify-content: center; position: relative; top: 10px; cursor: pointer; transition: transform 0.1s; }
    .custom-marker::after { content: ''; position: absolute; bottom: -5px; left: 50%; transform: translateX(-50%); border-width: 5px 5px 0; border-style: solid; border-color: inherit transparent transparent transparent; }

    /* FILTER CHIPS */
    .chip { padding: 6px 12px; border-radius: 15px; border: 2px solid #ddd; background: #fff; font-size: 12px; font-weight: 600; color: #444; cursor: pointer; transition: all 0.1s; }
    
    /* Active Chip Logic */
    .chip-nusach.active.text-Ashkenaz { background: var(--n-Ashkenaz) !important; color: #fff !important; }
    .chip-nusach.active.text-Sefard { background: var(--n-Sefard) !important; color: #fff !important; }
    .chip-nusach.active.text-Ari { background: var(--n-Ari) !important; color: #fff !important; }
    .chip-nusach.active.text-Edot-HaMizrach { background: var(--n-Edot-HaMizrach) !important; color: #fff !important; }
    .chip-nusach.active.text-Chabad { background: var(--n-Chabad) !important; color: #fff !important; }
    .chip-nusach.active.text-Other { background: var(--n-Other) !important; color: #fff !important; }

    .chip-tef.active.txt-Shacharis { background: var(--t-Shacharis) !important; color: #fff !important; }
    .chip-tef.active.txt-Mincha { background: var(--t-Mincha) !important; color: #fff !important; }
    .chip-tef.active.txt-Maariv { background: var(--t-Maariv) !important; color: #fff !important; }

    /* FILTER DRAWER */
    #filter-drawer {
        display: none; position: fixed; top: 80px; left: 12px; right: 12px;
        background: #fff; border-radius: 20px; padding: 15px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.25); z-index: 2000;
        max-width: 500px; margin: 0 auto;
    }
    .filter-section { margin-bottom: 12px; } 
    .filter-label { font-size: 10px; font-weight: 800; color: #bbb; text-transform: uppercase; margin-bottom: 5px; display: block; }
    .chip-group { display: flex; flex-wrap: wrap; gap: 6px; }
    
    .date-nav { display: flex; align-items: center; justify-content: space-between; background: #f5f5f5; padding: 8px; border-radius: 12px; }
    .date-btn { background: none; border: none; font-size: 24px; color: var(--primary); cursor: pointer; padding: 0 15px; display: flex; align-items: center; }
    .date-display-container { text-align: center; }
    .date-display { font-weight: 800; color: #333; font-size: 16px; line-height: 1.2; }
    .hebrew-date { font-weight: 600; color: var(--primary); font-size: 13px; opacity: 0.8; }

    .radius-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
    .radius-row input[type=range] { flex: 1; accent-color: var(--primary); }
    .radius-input { width: 50px; padding: 5px; border: 1px solid #ddd; border-radius: 8px; text-align: center; font-weight: bold; font-family: inherit; }

    .time-inputs-row { display: flex; gap: 8px; }
    .time-input { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 15px; text-align: center; font-family: inherit; font-size: 12px; font-weight: 600; }
    .action-btn { width: 100%; background: #eee; color: #333; border: none; padding: 10px; border-radius: 15px; font-size: 12px; font-weight: 700; cursor: pointer; margin-top: 6px; }
    .primary-action { background: var(--primary); color: white; }

    /* DETAILS DRAWER */
    #details-drawer {
        position: fixed; bottom: -100%; left: 10px; right: 10px; height: 80vh;
        background: #fff; border-radius: 25px; 
        z-index: 3000; margin-bottom: 15px;
        box-shadow: 0 5px 30px rgba(0,0,0,0.3); transition: transform 0.3s ease-out;
        padding: 0; display: flex; flex-direction: column; overflow: hidden;
    }
    #details-drawer.open { bottom: 0; transform: translateY(0); }
    
    .drawer-sticky-header {
        position: sticky; top: 0; background: #fff; z-index: 10;
        padding: 20px 20px 15px 20px;
        border-bottom: 1px solid #f0f0f0;
        display: flex; justify-content: space-between; align-items: flex-start; gap: 10px;
    }
    .drawer-title { font-size: 20px; font-weight: 800; color: var(--primary); line-height: 1.2; flex: 1; padding-right: 10px; word-break: break-word; } 
    .drawer-actions { display: flex; gap: 8px; flex-shrink: 0; }
    .circle-action-btn { width: 36px; height: 36px; border-radius: 50%; background: #f0f0f0; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #555; }
    
    .drawer-body { flex: 1; overflow-y: auto; padding: 15px 20px; }
    
    .drawer-top-info { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
    .rabbi-info { font-size: 14px; color: #555; font-weight: 600; display: flex; align-items: center; gap: 4px; margin-top: 5px; }
    .address-info { font-size: 14px; color: #777; margin-bottom: 10px; line-height: 1.4; }

    .schedule-section { margin-top: 15px; }
    .schedule-title { font-weight:800; font-size:15px; margin-bottom:10px; color:#333; border-bottom:1px solid #eee; padding-bottom:5px; }
    .schedule-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 14px; }
    .schedule-item { margin-bottom: 6px; }
    .schedule-day { font-weight: 700; color: #666; font-size: 12px; text-transform: uppercase; margin-bottom: 4px;}
    
    .contact-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 20px; margin-bottom: 10px;}
    .contact-btn { 
        background: #f5f5f5; border: 1px solid #ddd; 
        padding: 10px; border-radius: 12px; 
        font-weight: 700; font-size: 12px; 
        text-align: center; text-decoration: none; color: #333; 
        display: flex; align-items: center; justify-content: center; gap: 6px; 
    }
    .contact-btn:active { background: #eee; }
    .contact-btn.disabled { opacity: 0.5; cursor: default; pointer-events: none; }

    .drawer-nav-row { 
        display: flex; justify-content: space-between; align-items: center; 
        margin-top: 5px; background: #fafafa; 
        padding: 10px 12px; 
        border-radius: 12px; border: 1px solid #f0f0f0; 
    }
    .drawer-nav-left { display: flex; align-items: center; gap: 8px; }

    /* SETTINGS STYLES */
    .settings-card { background: #fff; border-radius: 16px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .input-group { margin-bottom: 15px; }
    .input-label { display: block; font-size: 12px; font-weight: 700; color: #666; margin-bottom: 5px; text-transform: uppercase; }
    .settings-input { width: 100%; padding: 12px; border: 1px solid #eee; border-radius: 12px; font-size: 16px; background: #fafafa; box-sizing: border-box; font-family: inherit; }
    .settings-link { display: flex; align-items: center; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid #f0f0f0; color: #333; text-decoration: none; cursor: pointer; }
    .settings-link:last-child { border-bottom: none; }
    .settings-link-text { font-size: 16px; font-weight: 600; }

    #scrim { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 2500; display: none; }

    .fab-location {
        position: fixed; bottom: 95px; right: 20px; width: 56px; height: 56px;
        background: #fff; border-radius: 50%; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        border: none; color: var(--primary); display: flex; align-items: center; justify-content: center; z-index: 900;
    }

    .empty-state { text-align: center; color: #555; margin-top: 50px; padding: 0 30px; line-height: 1.6; }
</style>
</head>
<body>

    <div id="home-view" class="view-section">
        <div class="floating-header" id="filter-header" onclick="scrollToTop(event)">
            <div class="search-container" onclick="event.stopPropagation()">
                <div id="autocomplete-container" style="flex:1; height:100%;"></div>
            </div>
            <button class="circle-btn" onclick="toggleFilters(); event.stopPropagation()">
                <i class="material-icons">tune</i>
            </button>
            <button class="circle-btn" id="view-toggle-btn" onclick="toggleMapList(); event.stopPropagation()">
                <i class="material-icons" id="view-icon">map</i>
            </button>
        </div>

        <div class="status-area">
            <div id="status-pill" class="status-pill"></div>
            <div id="count-pill" class="status-pill"></div>
            <div id="map-radius-pill" class="status-pill"></div>
        </div>

        <div id="center-marker"></div>
        
        <div id="list-view">
            <div class="empty-state">
                <i class="material-icons" style="font-size:54px; margin-bottom:15px; color: var(--primary); opacity: 0.8;">explore</i><br>
                <strong>Welcome to ShulTime</strong><br><br>
                Loading database...
            </div>
        </div>
        
        <div id="map-view"></div>
        
        <button class="fab-location" onclick="useMyLocation()">
            <i class="material-icons" style="font-size:26px;">my_location</i>
        </button>
    </div>

    <div id="saved-view" class="view-section" style="padding: 15px;">
        <div class="page-header">Saved Shuls</div>
        <div id="saved-list"></div>
    </div>

    <div id="recent-view" class="view-section" style="padding: 15px;">
        <div class="page-header">Recent Shuls</div>
        <div id="recent-list"></div>
    </div>

    <div id="settings-view" class="view-section" style="padding: 15px;">
        <div class="page-header">Settings</div>
        <div class="settings-card">
            <div class="input-group">
                <label class="input-label">Name</label>
                <input type="text" class="settings-input" id="profile-name" placeholder="Your Name" oninput="saveProfile()">
            </div>
            <div class="input-group">
                <label class="input-label">Phone</label>
                <input type="tel" class="settings-input" id="profile-phone" placeholder="Phone Number" oninput="saveProfile()">
            </div>
        </div>
        <div class="settings-card" style="padding: 0 20px;">
            <a class="settings-link" href="#"><span class="settings-link-text">Privacy Policy</span><i class="material-icons">chevron_right</i></a>
            <a class="settings-link" href="#"><span class="settings-link-text">Rate App</span><i class="material-icons">star_rate</i></a>
            <a class="settings-link" href="mailto:support@shultime.com"><span class="settings-link-text">Contact Us</span><i class="material-icons">email</i></a>
        </div>
    </div>

    <div class="bottom-nav">
        <button class="nav-item active" id="nav-home" onclick="switchTab('home')">
            <i class="material-icons">search</i><span>Explore</span>
        </button>
        <button class="nav-item" id="nav-saved" onclick="switchTab('saved')">
            <i class="material-icons">bookmark_border</i><span>Saved</span>
        </button>
        <button class="nav-item" id="nav-recent" onclick="switchTab('recent')">
            <i class="material-icons">history</i><span>Recent</span>
        </button>
        <button class="nav-item" id="nav-settings" onclick="switchTab('settings')">
            <i class="material-icons">settings</i><span>Settings</span>
        </button>
    </div>

    <div id="scrim" onclick="closeDetails()"></div>

    <div id="details-drawer">
        <div class="drawer-sticky-header">
            <div class="drawer-title" id="drawer-title"></div>
            <div class="drawer-actions">
                <button class="circle-action-btn" id="bookmark-btn" onclick="toggleFavorite()">
                    <i class="material-icons" id="bookmark-icon" style="font-size:20px;">bookmark_border</i>
                </button>
                <button class="circle-action-btn" onclick="shareShul()">
                    <i class="material-icons" style="font-size:20px;">ios_share</i>
                </button>
                <button class="circle-action-btn" onclick="closeDetails()">
                    <i class="material-icons" style="font-size:20px;">close</i>
                </button>
            </div>
        </div>
        <div id="drawer-content" class="drawer-body"></div>
    </div>

    <div id="filter-drawer">
        <div class="filter-section">
            <label class="filter-label">Date</label>
            <div class="date-nav">
                <button class="date-btn" onclick="changeDate(-1)"><i class="material-icons">chevron_left</i></button>
                <div class="date-display-container">
                    <div class="date-display" id="date-display">Today</div>
                    <div class="hebrew-date" id="hebrew-date"></div>
                </div>
                <button class="date-btn" onclick="changeDate(1)"><i class="material-icons">chevron_right</i></button>
            </div>
        </div>

        <div class="filter-section">
            <label class="filter-label">Radius (Miles)</label>
            <div class="radius-row">
                <input type="range" min="0.1" max="99" step="0.1" value="20" id="radius-slider" oninput="manualRadiusUpdate(this.value)">
                <input type="number" id="radius-input" class="radius-input" value="20" onchange="manualRadiusUpdate(this.value)">
            </div>
            <div class="chip-group">
                <div class="chip" onclick="manualRadiusUpdate(1)">1</div>
                <div class="chip" onclick="manualRadiusUpdate(2)">2</div>
                <div class="chip" onclick="manualRadiusUpdate(3)">3</div>
                <div class="chip" onclick="manualRadiusUpdate(5)">5</div>
                <div class="chip" onclick="manualRadiusUpdate(20)">20</div>
                <div class="chip" onclick="manualRadiusUpdate(99)">99</div>
            </div>
        </div>
        
        <div class="filter-section">
            <label class="filter-label">Sort By</label>
            <div class="chip-group" id="sort-group">
                <div class="chip active" style="background:#0D2B4F; color:#fff; border-color:#0D2B4F;" onclick="setFilter('sort', 'time_asc', this)">Earliest</div>
                <div class="chip" onclick="setFilter('sort', 'distance', this)">Distance</div>
                <div class="chip" onclick="setFilter('sort', 'abc', this)">A-Z</div>
            </div>
        </div>

        <div class="filter-section">
            <label class="filter-label">Tefillah</label>
            <div class="chip-group" id="tefillah-group">
                <div class="chip active chip-tef" style="background:#0D2B4F; color:#fff; border-color:#0D2B4F;" onclick="setFilter('tefillah', '', this)">All</div>
                <div class="chip chip-tef txt-Shacharis" onclick="setFilter('tefillah', 'Shacharis', this)">Shacharis</div>
                <div class="chip chip-tef txt-Mincha" onclick="setFilter('tefillah', 'Mincha', this)">Mincha</div>
                <div class="chip chip-Maariv chip-tef txt-Maariv" onclick="setFilter('tefillah', 'Maariv', this)">Maariv</div>
            </div>
        </div>

        <div class="filter-section">
            <label class="filter-label">Nusach</label>
            <div class="chip-group" id="nusach-group">
                <div class="chip active chip-nusach" style="background:#0D2B4F; color:#fff; border-color:#0D2B4F;" onclick="setFilter('nusach', '', this)">All</div>
            </div>
        </div>

        <div class="filter-section">
            <label class="filter-label">Time Range</label>
            <div class="time-inputs-row">
                <input type="time" id="time-start" class="time-input" onchange="onStartTimeChange()">
                <input type="time" id="time-end" class="time-input" onchange="applyFilters()">
            </div>
            <div style="display:flex; gap:6px;">
                <button class="action-btn" onclick="setAllDay()">All Day</button>
                <button class="action-btn primary-action" onclick="setNextHour()">Next Hour</button>
            </div>
        </div>
        
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button class="action-btn" onclick="resetFilters()" style="margin-top:0; flex:1; background:#f0f0f0; color:#555;">Reset</button>
            <button class="action-btn primary-action" onclick="toggleFilters()" style="margin-top:0; flex:2;">Done</button>
        </div>
    </div>

    <div id="sticky-header" class="sticky-header"></div>

    <script>
        // HEBCAL ENGINE FOR HEBREW DATES
        const HebCal = {
            mapMonth: e => { const t = {Tishri:"Tishrei",Cheshvan:"Cheshvan",Kislev:"Kislev",Tevet:"Teves",Shevat:"Shevat",Adar:"Adar","Adar I":"Adar I","Adar II":"Adar II",Nisan:"Nisan",Iyar:"Iyar",Sivan:"Sivan",Tamuz:"Tamuz",Av:"Av",Elul:"Elul"}; return t[e]||e; },
            getHebrewStr: e => {
                try {
                    const t = new Intl.DateTimeFormat("en-US-u-ca-hebrew", {day:"numeric",month:"long",year:"numeric"}).formatToParts(e);
                    return t.find(x=>x.type==="day").value + " " + HebCal.mapMonth(t.find(x=>x.type==="month").value) + " " + t.find(x=>x.type==="year").value.split(" ")[0];
                } catch(err) { return ""; }
            }
        };

        let map, allMinyanim = [], processedMinyanim = [], searchCenter = null, currentRadius = 20;
        let filters = { sort: 'time_asc', tefillah: '', nusach: '' };
        let selectedShul = null;
        let markers = [];
        let isProgrammaticMove = false;
        let allNusachs = new Set();
        let currentFilterDate = new Date();
        let fullDbData = [];
        let currentViewIsMap = false; 

        document.addEventListener("DOMContentLoaded", async () => {
            document.getElementById('time-start').value = "00:00";
            document.getElementById('time-end').value = "23:59";
            
            updateDateDisplay();
            loadProfile();

            // Fetch Database dynamically from GitHub (Bypass caching)
            try {
                const res = await fetch("database.json?v=" + new Date().getTime(), { cache: "no-store" });
                if (!res.ok) throw new Error(`Server returned ${res.status} ${res.statusText}`);
                
                fullDbData = await res.json();
                
                if (!Array.isArray(fullDbData) || fullDbData.length === 0) {
                    throw new Error("Database file is empty or not formatted correctly.");
                }

                processMinyanim(fullDbData);
                populateNusachFilter();
                
                if (searchCenter && !currentViewIsMap) applyFilters();
                else {
                    document.getElementById("list-view").innerHTML = `
                        <div class="empty-state">
                            <i class="material-icons" style="font-size:54px; margin-bottom:15px; color: var(--primary); opacity: 0.8;">explore</i><br>
                            <strong>Welcome to ShulTime</strong><br><br>
                            <b>1. Search</b> for a city or zip code.<br>
                            <b>2. Filter</b> by time or Nusach.<br>
                            <b>3. Tap</b> the target to use GPS.
                        </div>`;
                }
            } catch(e) {
                console.error("Database Fetch Error:", e);
                let errMsg = e.message;
                if (window.location.protocol === 'file:') {
                    errMsg = "Browsers block loading local databases for security. You must test this via your live GitHub link, not by double-clicking the HTML file on your computer.";
                }
                document.getElementById("list-view").innerHTML = `
                    <div class="empty-state" style="color: red;">
                        <i class="material-icons" style="font-size:54px; margin-bottom:15px; color: red;">error_outline</i><br>
                        <strong>Database Connection Failed</strong><br><br>
                        ${errMsg}<br><br>
                        Make sure a file named exactly <b>database.json</b> is uploaded to your GitHub repository in the exact same folder as this index.html file.
                    </div>`;
            }

            // Sticky Header Logic for Recent/Saved
            document.getElementById('list-view').addEventListener('scroll', function() {
                const header = document.getElementById('sticky-header');
                const isSavedOrRecent = (document.getElementById('saved-view').style.display === 'block' || document.getElementById('recent-view').style.display === 'block');
                
                if(this.scrollTop > 40 && isSavedOrRecent) {
                    header.classList.add('visible');
                    header.innerText = document.getElementById('recent-view').style.display === 'block' ? "Recent Shuls" : "Saved Shuls";
                } else {
                    header.classList.remove('visible');
                }
            });
        });

        // --- BOTTOM NAVIGATION LOGIC ---
        function switchTab(tabId) {
            document.getElementById('filter-drawer').style.display = 'none';
            closeDetails();
            document.querySelectorAll('.nav-item').forEach(btn => btn.classList.remove('active'));
            document.getElementById('nav-' + tabId).classList.add('active');
            document.querySelectorAll('.view-section').forEach(sec => sec.style.display = 'none');
            document.getElementById('sticky-header').classList.remove('visible');

            if (tabId === 'home') {
                document.getElementById('home-view').style.display = 'block';
                if (currentViewIsMap) {
                    document.getElementById('list-view').style.display = 'none';
                    document.getElementById('center-marker').style.display = 'block';
                    document.querySelector('.fab-location').style.display = 'flex';
                } else {
                    document.getElementById('list-view').style.display = 'block';
                    document.getElementById('center-marker').style.display = 'none';
                    document.querySelector('.fab-location').style.display = 'flex';
                }
                if(searchCenter) applyFilters(); 
            } 
            else if (tabId === 'saved') {
                document.getElementById('saved-view').style.display = 'block';
                renderFavorites();
            }
            else if (tabId === 'recent') {
                document.getElementById('recent-view').style.display = 'block';
                renderRecents();
            }
            else if (tabId === 'settings') {
                document.getElementById('settings-view').style.display = 'block';
            }
        }

        // --- MAP/LIST TOGGLE INSIDE HOME TAB ---
        function toggleMapList() {
            document.getElementById('filter-drawer').style.display = 'none';
            const list = document.getElementById("list-view");
            const btn = document.getElementById("view-toggle-btn");
            const icon = document.getElementById("view-icon");
            const dot = document.getElementById("center-marker");
            const mapPill = document.getElementById("map-radius-pill");
            
            if (currentViewIsMap) {
                currentViewIsMap = false;
                list.style.display = "block";
                icon.innerText = "map";
                btn.classList.remove("active");
                dot.style.display = "none";
                mapPill.style.display = "none";
            } else {
                currentViewIsMap = true;
                list.style.display = "none";
                icon.innerText = "list";
                btn.classList.add("active");
                dot.style.display = "block";
                if(searchCenter) mapPill.style.display = "block";
                
                if(map && searchCenter && !isProgrammaticMove) {
                    isProgrammaticMove = true;
                    map.panTo(searchCenter);
                }
            }
            if(searchCenter) applyFilters();
        }

        function scrollToTop(e) {
            if(e) e.stopPropagation();
            document.getElementById('list-view').scrollTo({ top: 0, behavior: 'smooth' });
        }

        function getTodayKey() {
            const d = currentFilterDate.getDay(); 
            if (d === 0) return 'sun';
            if (d === 1 || d === 4) return 'mon_thu';
            return 'tue_wed_fri';
        }

        function updateDateDisplay() {
            const options = { weekday: 'long', month: 'short', day: 'numeric', year: 'numeric' };
            document.getElementById('date-display').innerText = currentFilterDate.toLocaleDateString('en-US', options);
            document.getElementById('hebrew-date').innerText = HebCal.getHebrewStr(currentFilterDate);
        }

        function changeDate(days) {
            currentFilterDate.setDate(currentFilterDate.getDate() + days);
            updateDateDisplay();
            if(fullDbData.length > 0) {
                processMinyanim(fullDbData);
                if(searchCenter) applyFilters();
            }
        }

        function resetFilters() {
            currentFilterDate = new Date();
            updateDateDisplay();
            
            document.getElementById('time-start').value = "00:00";
            document.getElementById('time-end').value = "23:59";
            
            filters = { sort: 'time_asc', tefillah: '', nusach: '' };
            
            ['sort-group', 'tefillah-group', 'nusach-group'].forEach(gid => {
                const group = document.getElementById(gid);
                if(group) {
                    group.querySelectorAll('.chip').forEach(c => {
                        c.classList.remove('active');
                        c.style.background = ''; c.style.color = ''; c.style.borderColor = '';
                    });
                    const firstChip = group.querySelector('.chip');
                    if(firstChip) {
                        firstChip.classList.add('active');
                        firstChip.style.background = '#0D2B4F';
                        firstChip.style.color = '#fff';
                        firstChip.style.borderColor = '#0D2B4F';
                    }
                }
            });

            currentRadius = 20;
            document.getElementById("radius-input").value = 20;
            document.getElementById("radius-slider").value = 20;

            if(fullDbData.length > 0) processMinyanim(fullDbData);
            if(searchCenter) applyFilters();
        }

        function processMinyanim(data){
            processedMinyanim = [];
            allNusachs = new Set();
            const dayKey = getTodayKey();
            const isFri = currentFilterDate.getDay() === 5;
            const isSat = currentFilterDate.getDay() === 6;

            data.forEach(shul => {
                if(!shul.name) return; 
                if(shul.nusach && shul.nusach !== "Unspecified" && shul.nusach.trim() !== "") allNusachs.add(shul.nusach.trim());

                let hasTimes = false;
                let minyanimForThisShul = []; 
                
                if (!isSat && shul.shacharis && shul.shacharis[dayKey] && shul.shacharis[dayKey].length > 0) {
                    shul.shacharis[dayKey].forEach(t => { addMinyan(shul, 'Shacharis', t, minyanimForThisShul); hasTimes = true; });
                }
                if (isFri) { 
                    if (shul.mincha && shul.mincha.fri && shul.mincha.fri.length > 0) shul.mincha.fri.forEach(t => { addMinyan(shul, 'Mincha', t, minyanimForThisShul); hasTimes = true; }); 
                } 
                else if (isSat) { 
                    if (shul.mincha && shul.mincha.shabbos && shul.mincha.shabbos.length > 0) shul.mincha.shabbos.forEach(t => { addMinyan(shul, 'Mincha', t, minyanimForThisShul); hasTimes = true; }); 
                } 
                else { 
                    if (shul.mincha && shul.mincha.week && shul.mincha.week.length > 0) shul.mincha.week.forEach(t => { addMinyan(shul, 'Mincha', t, minyanimForThisShul); hasTimes = true; }); 
                }
                if (isSat) { 
                    if (shul.maariv && shul.maariv.shabbos && shul.maariv.shabbos.length > 0) shul.maariv.shabbos.forEach(t => { addMinyan(shul, 'Maariv', t, minyanimForThisShul); hasTimes = true; }); 
                } 
                else { 
                    if (shul.maariv && shul.maariv.week && shul.maariv.week.length > 0) shul.maariv.week.forEach(t => { addMinyan(shul, 'Maariv', t, minyanimForThisShul); hasTimes = true; }); 
                }
                
                if (!hasTimes) {
                    processedMinyanim.push({ ...shul, tefillah: 'Info', timeDisplay: '--:--', ampm: '', timeValue: 9999 });
                } else {
                    processedMinyanim.push(...minyanimForThisShul);
                }
            });
            allMinyanim = processedMinyanim;
        }

        function formatTimeShort(tStr, type) {
            if(!tStr) return "";
            let clean = tStr.replace(/[^0-9:]/g, "");
            let [h,m] = clean.split(":").map(Number);
            let suffix = h >= 12 ? "p" : "a";
            
            if (type === "Mincha" && h < 9) suffix = "p";
            if (type === "Maariv" && h < 12) suffix = "p";
            
            let h12 = h > 12 ? h - 12 : (h === 0 ? 12 : h);
            let mStr = String(m).padStart(2,"0");
            return `${h12}:${mStr}${suffix}`;
        }

        function addMinyan(shul, type, tStr, list) {
            if(!tStr) return;
            let raw = tStr.trim().replace(/[^0-9:]/g,"");
            if(!raw) return;
            let [h,m] = raw.split(":").map(Number);
            let sortH = h;
            if (type === "Mincha" && h < 9) sortH += 12;
            if (type === "Maariv" && h < 12) sortH += 12; 
            let formatted = formatTimeShort(raw, type);
            list.push({ ...shul, tefillah: type, timeDisplay: formatted, timeValue: (sortH * 60) + m });
        }

        function populateNusachFilter() {
            const group = document.getElementById("nusach-group");
            group.innerHTML = `<div class="chip active chip-nusach" style="background:#0D2B4F; color:#fff; border-color:#0D2B4F;" onclick="setFilter('nusach', '', this)">All</div>`;
            Array.from(allNusachs).sort().forEach(n => {
                if(!n || n===" ") return;
                const safeClass = `text-${n.replace(/\s+/g, '-')}`;
                const chip = document.createElement("div");
                chip.className = `chip chip-nusach ${safeClass}`;
                chip.innerText = n;
                chip.onclick = function() { setFilter('nusach', n, this); };
                group.appendChild(chip);
            });
        }

        function setSearchLocation(lat, lng, name){
            searchCenter = { lat, lng };
            document.getElementById("status-pill").style.display = "block";
            document.getElementById("status-pill").innerText = `Near: ${name}`;
            
            if(map) {
                isProgrammaticMove = true;
                map.setCenter({ lat, lng });
                map.setZoom(13);
            }
            if(!currentViewIsMap) {
                toggleMapList(); 
            } else {
                applyFilters();
            }
        }

        function manualRadiusUpdate(val) {
            updateRadius(val);
            applyFilters();
        }

        function updateRadius(val) {
            currentRadius = parseFloat(val);
            document.getElementById("radius-input").value = currentRadius;
            document.getElementById("radius-slider").value = currentRadius;
        }

        function applyFilters(){
            if(!searchCenter || !allMinyanim.length) return;
            const [sH, sM] = document.getElementById('time-start').value.split(':').map(Number);
            const [eH, eM] = document.getElementById('time-end').value.split(':').map(Number);
            const startVal = (sH*60)+sM, endVal = (eH*60)+eM;

            let results = allMinyanim.map(m => {
                m.distance = getDistance(searchCenter.lat, searchCenter.lng, m.lat, m.lng);
                return m;
            }).filter(m => m.distance <= currentRadius);

            if(filters.tefillah) results = results.filter(m => m.tefillah === filters.tefillah);
            if(filters.nusach) results = results.filter(m => m.nusach === filters.nusach);
            
            results = results.filter(m => {
                if (m.timeValue === 9999) return true; 
                return m.timeValue >= startVal && m.timeValue <= endVal;
            });

            if(filters.sort === 'abc') {
                results.sort((a,b) => (a.name || "").localeCompare(b.name || ""));
            } else if(filters.sort === 'distance') {
                results.sort((a,b) => a.distance - b.distance);
            } else {
                results.sort((a,b) => a.timeValue - b.timeValue);
            }
            
            const uniqueShuls = new Set(results.map(r => r.id)).size;
            const countPill = document.getElementById("count-pill");
            const mapPill = document.getElementById("map-radius-pill");
            
            document.getElementById("status-pill").style.display = "block";
            countPill.style.display = "block";
            
            if(currentViewIsMap) {
                countPill.innerText = `${uniqueShuls} Shuls`;
                mapPill.innerText = `Radius: ${currentRadius} mi`;
                mapPill.style.display = "block";
            } else {
                const validMinyanim = results.filter(m => m.timeValue !== 9999).length;
                countPill.innerText = `${uniqueShuls} Shuls / ${validMinyanim} Minyanim`;
                mapPill.style.display = "none";
            }

            // Only redraw list if we are on the Home screen
            if (currentTab === 'home') {
                renderListCards(results, document.getElementById("list-view"));
            }
            if(currentViewIsMap) updateMapMarkers(results);
        }

        function renderListCards(results, container){
            container.innerHTML = results.length ? "" : '<div class="empty-state">No minyanim found matching your filters.</div>';
            results.forEach(m => {
                let nCls = `bg-${(m.nusach || 'Other').replace(/\s+/g, '-')}`;
                let tCls = `txt-${m.tefillah}`;
                const godavenId = m.godaven_link ? m.godaven_link.split('/').pop() : m.id;
                const link = `https://www.godaven.com/shul-details/${godavenId}`;
                
                const card = document.createElement("div");
                card.className = "minyan-card";
                
                let rightSide = '';
                if(m.timeValue === 9999) {
                    rightSide = `<div class="map-zone" onclick="event.stopPropagation(); window.open('${link}','_blank')">
                        <div class="map-footer">
                            <div class="dist-label">${m.distance.toFixed(1)}mi</div>
                            <div class="map-circle"><i class="material-icons google-maps-icon">place</i></div>
                        </div>
                    </div>`;
                } else {
                    rightSide = `<div class="map-zone" onclick="event.stopPropagation(); window.open('${link}','_blank')">
                        <div class="tefillah-label ${tCls}">${m.tefillah}</div>
                        <div class="time-val">${m.timeDisplay}</div>
                        <div class="map-footer">
                            <div class="dist-label">${m.distance.toFixed(1)}mi</div>
                            <div class="map-circle"><i class="material-icons google-maps-icon">place</i></div>
                        </div>
                    </div>`;
                }

                card.innerHTML = `
                    <div class="info-zone" onclick='openDetails(${JSON.stringify(m).replace(/'/g, "&#39;")})'>
                        <div class="shul-name">${m.name}</div>
                        <div class="shul-address">${m.address}</div>
                        <div class="nusach-tag ${nCls}">${m.nusach}</div>
                    </div>
                    ${rightSide}`;
                container.appendChild(card);
            });
        }

        async function updateMapMarkers(results) {
            if (!map) return;
            const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");
            markers.forEach(m => m.map = null); markers = [];
            
            const groups = {};
            results.forEach(r => {
                const key = r.lat + "," + r.lng;
                if (!groups[key] || r.timeValue < groups[key].timeValue) groups[key] = r;
            });

            Object.values(groups).forEach(m => {
                const pinDiv = document.createElement("div");
                let nCls = `bg-${(m.nusach || 'Other').replace(/\s+/g, '-')}`;
                // Fallback color if class not found
                pinDiv.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue(`--n-${m.nusach?.replace(/\s+/g, '-')}`) || '#6b7280';
                
                pinDiv.className = `custom-marker ${nCls}`;
                pinDiv.textContent = (m.timeValue === 9999) ? "?" : `${m.timeDisplay}`; 

                const marker = new AdvancedMarkerElement({
                    map: map, position: { lat: m.lat, lng: m.lng },
                    content: pinDiv, title: m.name
                });
                marker.element.addEventListener("click", () => openDetails(m));
                markers.push(marker);
            });
        }

        function onMapIdle() {
            if (isProgrammaticMove) { isProgrammaticMove = false; return; }
            if(!map) return;
            const center = map.getCenter();
            const bounds = map.getBounds();
            if(!center || !bounds) return;

            searchCenter = { lat: center.lat(), lng: center.lng() };
            document.getElementById("status-pill").innerText = `Near: Map Center`;

            const ne = bounds.getNorthEast();
            const r = getDistance(center.lat(), center.lng(), ne.lat(), ne.lng());
            
            updateRadius(r.toFixed(1)); 
            document.getElementById("map-radius-pill").innerText = `Radius: ${r.toFixed(1)} mi`;
            
            applyFilters();
        }

        function formatListPills(list, nusach, type) {
            if(!list || list.length === 0) return '-';
            let nCls = `text-${(nusach || 'Other').replace(/\s+/g, '-')}`;
            return list.map(t => {
                return `<span class="time-pill ${nCls}">${formatTimeShort(t, type)}</span>`;
            }).join(" ");
        }

        function openDetails(m) {
            selectedShul = m;
            addToRecents(m);
            checkFavoriteStatus(m.id);
            
            const godavenId = m.godaven_link ? m.godaven_link.split('/').pop() : m.id;
            const link = `https://www.godaven.com/shul-details/${godavenId}`;
            const nCls = `bg-${(m.nusach || 'Other').replace(/\s+/g, '-')}`;
            const content = document.getElementById("drawer-content");
            const headerTitle = document.getElementById("drawer-title");
            
            let rabbiText = m.rabbi && m.rabbi !== "Rabbi Not Listed" ? `<div class="rabbi-info"><i class="material-icons" style="font-size:16px;">person</i> ${m.rabbi}</div>` : '';

            // Sticky Header
            headerTitle.innerText = m.name;

            // Contacts
            let contacts = [];
            if(m.phone) contacts.push(`<a href="tel:${m.phone}" class="contact-btn"><i class="material-icons" style="font-size:16px">call</i> Call</a>`);
            if(m.email) contacts.push(`<a href="mailto:${m.email}" class="contact-btn"><i class="material-icons" style="font-size:16px">email</i> Email</a>`);
            contacts.push(`<a href="http://googleusercontent.com/maps.google.com/8{m.lat},${m.lng}" target="_blank" class="contact-btn"><i class="material-icons" style="font-size:16px">place</i> Map</a>`);
            contacts.push(`<a href="${link}" target="_blank" rel="noopener noreferrer" class="contact-btn"><i class="material-icons" style="font-size:16px">open_in_new</i> GoDaven</a>`);
            contacts.push(`<a href="mailto:support@shultime.com?subject=Feedback regarding ${encodeURIComponent(m.name)}" class="contact-btn" style="grid-column: span 2;"><i class="material-icons" style="font-size:16px">feedback</i> Leave Feedback about this Shul</a>`);

            let tCls = `txt-${m.tefillah}`;
            let timePillClass = `text-${(m.nusach || 'Other').replace(/\s+/g, '-')}`;
            
            let timeDisplayHtml = '';
            if (m.timeValue !== 9999) {
                timeDisplayHtml = `
                <div class="drawer-nav-row">
                    <div class="drawer-nav-left"><span class="tefillah-label ${tCls}">${m.tefillah}</span><span class="time-pill ${timePillClass}" style="margin-left:10px;">${m.timeDisplay}</span></div>
                    <div style="display:flex; align-items:center; gap:8px;"><div style="font-size:14px; font-weight:700; color:#666;">${(m.distance || 0).toFixed(1)}mi</div></div>
                </div>`;
            }

            content.innerHTML = `
                <div class="drawer-top-info"><span class="nusach-tag ${nCls}" style="margin:0;">${m.nusach}</span>${rabbiText}</div>
                <div class="address-info">${m.address}, ${m.city}, ${m.state} ${m.zip}</div>
                ${timeDisplayHtml}
                <div class="contact-grid">${contacts.join('')}</div>

                <div class="schedule-section">
                    <div class="schedule-title">Weekday Schedule</div>
                    <div class="schedule-grid">
                        <div class="schedule-item"><div class="schedule-day">Shacharis Sun</div><div class="sched-times">${formatListPills(m.shacharis?.sun, m.nusach, 'Shacharis')}</div></div>
                        <div class="schedule-item"><div class="schedule-day">Shacharis M/Th</div><div class="sched-times">${formatListPills(m.shacharis?.mon_thu, m.nusach, 'Shacharis')}</div></div>
                        <div class="schedule-item"><div class="schedule-day">Shacharis T/W/F</div><div class="sched-times">${formatListPills(m.shacharis?.tue_wed_fri, m.nusach, 'Shacharis')}</div></div>
                        <div class="schedule-item"><div class="schedule-day">Rosh Chodesh</div><div class="sched-times">${formatListPills(m.shacharis?.rosh_chodesh, m.nusach, 'Shacharis')}</div></div>
                        <div class="schedule-item"><div class="schedule-day">Mincha</div><div class="sched-times">${formatListPills(m.mincha?.week, m.nusach, 'Mincha')}</div></div>
                        <div class="schedule-item"><div class="schedule-day">Maariv</div><div class="sched-times">${formatListPills(m.maariv?.week, m.nusach, 'Maariv')}</div></div>
                    </div>
                </div>

                <div class="schedule-section">
                    <div class="schedule-title">Shabbos Schedule</div>
                    <div class="schedule-grid">
                        <div class="schedule-item"><div class="schedule-day">Mincha Erev Shab</div><div class="sched-times">${formatListPills(m.mincha?.fri, m.nusach, 'Mincha')}</div></div>
                        <div class="schedule-item"><div class="schedule-day">Mincha Shabbos</div><div class="sched-times">${formatListPills(m.mincha?.shabbos, m.nusach, 'Mincha')}</div></div>
                        <div class="schedule-item"><div class="schedule-day">Maariv Motzei</div><div class="sched-times">${formatListPills(m.maariv?.shabbos, m.nusach, 'Maariv')}</div></div>
                    </div>
                </div>
            `;
            const drawer = document.getElementById("details-drawer");
            drawer.classList.add("open");
            drawer.style.transform = "translateY(0)";
            document.getElementById("scrim").style.display = "block";
        }

        async function shareShul() {
            if(!selectedShul) return;
            const godavenId = selectedShul.godaven_link ? selectedShul.godaven_link.split('/').pop() : selectedShul.id;
            const link = `https://www.godaven.com/shul-details/${godavenId}`;
            const text = `Shared by ShulTime:\n\n${selectedShul.name}\n${selectedShul.address}\n\nNusach: ${selectedShul.nusach}\nLink: ${link}`;
            if(navigator.share) {
                try { await navigator.share({ title: selectedShul.name, text: text, url: link }); } 
                catch(e) {}
            } else {
                navigator.clipboard.writeText(text + "\n" + link);
                alert("Copied to clipboard!");
            }
        }

        function closeDetails() {
            const drawer = document.getElementById("details-drawer");
            drawer.classList.remove("open");
            drawer.style.transform = "translateY(100%)";
            document.getElementById("scrim").style.display = "none";
        }

        function toggleFilters() {
            const d = document.getElementById('filter-drawer');
            d.style.display = (d.style.display==='block') ? 'none' : 'block';
        }

        function setFilter(type, val, btn) {
            filters[type] = val;
            const group = btn.parentElement;
            group.querySelectorAll('.chip').forEach(c => {
                c.classList.remove('active');
                c.style.background = ''; c.style.color = ''; c.style.borderColor = '';
            });
            btn.classList.add('active');
            
            // Set generic fallback for "All" and "Earliest"
            if(val === '' || val === 'time_asc' || val === 'distance' || val === 'abc') {
                btn.style.background = '#0D2B4F'; btn.style.color = '#fff'; btn.style.borderColor = '#0D2B4F';
            }
            applyFilters();
        }

        function setAllDay() { document.getElementById('time-start').value = "00:00"; document.getElementById('time-end').value = "23:59"; applyFilters(); }
        
        function setNextHour() {
            const now = new Date(); const pad = n => String(n).padStart(2,'0');
            document.getElementById('time-start').value = `${pad(now.getHours())}:${pad(now.getMinutes())}`;
            const next = new Date(now.getTime() + 60*60*1000);
            document.getElementById('time-end').value = `${pad(next.getHours())}:${pad(next.getMinutes())}`;
            applyFilters();
        }

        function onStartTimeChange() {
            const [h,m] = document.getElementById('time-start').value.split(':').map(Number);
            let endH = h + 1; if(endH > 23) endH = 23;
            document.getElementById('time-end').value = `${String(endH).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
            applyFilters();
        }

        function useMyLocation() {
            navigator.geolocation.getCurrentPosition(pos => {
                setSearchLocation(pos.coords.latitude, pos.coords.longitude, "Current Location");
            }, e => alert("Please enable GPS/Location services."));
        }

        // SETTINGS & STORAGE
        function saveProfile() {
            const name = document.getElementById('profile-name').value;
            const phone = document.getElementById('profile-phone').value;
            localStorage.setItem('shultime_profile', JSON.stringify({ name, phone }));
        }
        function loadProfile() {
            const p = JSON.parse(localStorage.getItem('shultime_profile') || "{}");
            if(p.name) document.getElementById('profile-name').value = p.name;
            if(p.phone) document.getElementById('profile-phone').value = p.phone;
        }
        function addToRecents(m) {
            let recents = JSON.parse(localStorage.getItem("shultime_recents") || "[]");
            recents = recents.filter(id => id !== m.id);
            recents.unshift(m.id);
            if(recents.length > 20) recents.pop(); 
            localStorage.setItem("shultime_recents", JSON.stringify(recents));
        }
        function toggleFavorite() {
            if(!selectedShul) return;
            let favs = JSON.parse(localStorage.getItem("shultime_favs") || "[]");
            const index = favs.indexOf(selectedShul.id);
            const icon = document.getElementById("bookmark-icon");
            if (index > -1) { favs.splice(index, 1); icon.innerText = "bookmark_border"; } 
            else { favs.push(selectedShul.id); icon.innerText = "bookmark"; }
            localStorage.setItem("shultime_favs", JSON.stringify(favs));
        }
        function checkFavoriteStatus(id) {
            let favs = JSON.parse(localStorage.getItem("shultime_favs") || "[]");
            const icon = document.getElementById("bookmark-icon");
            icon.innerText = favs.includes(id) ? "bookmark" : "bookmark_border";
        }
        function renderFavorites() {
            let favs = JSON.parse(localStorage.getItem("shultime_favs") || "[]");
            const uniqueResults = []; const seen = new Set();
            processedMinyanim.forEach(m => {
                if(favs.includes(m.id) && !seen.has(m.id)) { uniqueResults.push(m); seen.add(m.id); }
            });
            const list = document.getElementById('saved-list');
            if(uniqueResults.length === 0) list.innerHTML = '<div class="empty-state">No saved shuls.</div>';
            else { renderListCards(uniqueResults, list); }
        }
        function renderRecents() {
            let recents = JSON.parse(localStorage.getItem("shultime_recents") || "[]");
            const uniqueResults = []; const seen = new Set();
            recents.forEach(id => {
                const match = processedMinyanim.find(r => r.id === id);
                if(match && !seen.has(id)) { uniqueResults.push(match); seen.add(id); }
            });
            const list = document.getElementById('recent-list');
            if(uniqueResults.length === 0) list.innerHTML = '<div class="empty-state">No recent activity.</div>';
            else { renderListCards(uniqueResults, list); }
        }

        async function initApp(){
            const { Map } = await google.maps.importLibrary("maps");
            const { PlaceAutocompleteElement } = await google.maps.importLibrary("places");
            const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");

            const autocomplete = new PlaceAutocompleteElement();
            autocomplete.setAttribute("types", "(cities)");
            autocomplete.placeholder = "Search City...";
            const container = document.getElementById("autocomplete-container");
            container.appendChild(autocomplete);

            map = new Map(document.getElementById("map-view"), {
                center: { lat: 40.091, lng: -74.218 },
                zoom: 12, disableDefaultUI: true, clickableIcons: false, mapId: "DEMO_MAP_ID",
                styles: [ { featureType: "poi", elementType: "labels", stylers: [{ visibility: "off" }] } ]
            });

            map.addListener('idle', onMapIdle);

            autocomplete.addEventListener('input', () => { 
                if (!autocomplete.value) {
                    searchCenter = null;
                    document.getElementById("status-pill").style.display = "none";
                    document.getElementById("count-pill").style.display = "none";
                    document.getElementById("map-radius-pill").style.display = "none";
                    document.getElementById("list-view").innerHTML = `
                        <div class="empty-state">
                            <i class="material-icons" style="font-size:54px; margin-bottom:15px; color: var(--primary); opacity: 0.8;">explore</i><br>
                            <strong>Welcome to ShulTime</strong><br><br>
                            <b>1. Search</b> for a city or zip code.<br>
                            <b>2. Filter</b> by time or Nusach.<br>
                            <b>3. Tap</b> the target to use GPS.
                        </div>`;
                    if(map) { markers.forEach(m => m.map = null); }
                } 
            });

            autocomplete.addEventListener("gmp-select", async (event) => {
                if (event.placePrediction) {
                    if (document.activeElement) document.activeElement.blur();
                    setTimeout(() => { if (document.activeElement) document.activeElement.blur(); }, 200);

                    const place = event.placePrediction.toPlace();
                    await place.fetchFields({ fields: ["displayName", "location"] });
                    setSearchLocation(place.location.lat(), place.location.lng(), place.displayName);
                }
            });
        }
    </script>
    <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAOpNebt0dPJUmiEw-i1W-Dx_UezLpIvxI&loading=async&libraries=places,maps,marker&callback=initApp"></script>
</body>
</html>
