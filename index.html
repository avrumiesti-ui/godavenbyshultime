<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoDavenByShulTime | Master Pro</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.9.0/suncalc.min.js"></script>

    <style>
        :root {
            --primary: #1a365d;
            --accent: #d4af37;
            --ashkenaz: #3b82f6; /* Blue */
            --sefard: #10b981;   /* Green */
            --edot: #f59e0b;     /* Orange */
            --bg: #f1f5f9;
        }

        body { font-family: -apple-system, sans-serif; margin: 0; background: var(--bg); overflow: hidden; }

        /* --- STICKY HEADER --- */
        header {
            position: fixed;
            top: 0; width: 100%; height: 160px;
            background: var(--primary); color: white;
            z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .header-content { max-width: 1000px; margin: 0 auto; padding: 15px; text-align: center; }
        
        h1 { margin: 0; font-size: 1.5rem; color: var(--accent); }
        
        .controls { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; justify-content: center; }

        input, select { 
            padding: 10px; border-radius: 8px; border: none; font-size: 0.9rem;
        }
        #search { flex-grow: 1; min-width: 200px; }

        /* --- LAYOUT --- */
        #main-view {
            display: flex;
            height: calc(100vh - 160px);
            margin-top: 160px;
        }

        #map { flex: 1; height: 100%; }

        #sidebar {
            width: 400px;
            background: white;
            overflow-y: auto;
            border-left: 1px solid #ddd;
            padding: 15px;
            box-sizing: border-box;
        }

        /* --- CARDS --- */
        .shul-card {
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            background: white;
            transition: 0.2s;
            position: relative;
            border-top: 5px solid #ccc;
        }
        .shul-card.Sefard { border-top-color: var(--sefard); }
        .shul-card.Ashkenaz { border-top-color: var(--ashkenaz); }
        .shul-card[data-nusach*="Edot"] { border-top-color: var(--edot); }

        .shul-name { font-weight: bold; font-size: 1.1rem; color: var(--primary); }
        .distance-tag { 
            position: absolute; top: 15px; right: 15px; 
            background: #edf2f7; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem;
        }

        .zman-row { 
            display: flex; justify-content: space-between; 
            margin-top: 10px; padding: 8px; background: #f8fafc; border-radius: 6px; font-size: 0.85rem;
        }

        .zman-item { text-align: center; flex: 1; border-right: 1px solid #ddd; }
        .zman-item:last-child { border-right: none; }
        .zman-label { font-size: 0.7rem; color: #64748b; text-transform: uppercase; }
        .zman-time { font-weight: bold; color: #1e293b; }

        @media (max-width: 800px) {
            #main-view { flex-direction: column; }
            #sidebar { width: 100%; height: 50%; }
            #map { height: 50%; }
        }
    </style>
</head>
<body>

<header>
    <div class="header-content">
        <h1>GoDavenByShulTime</h1>
        <div class="controls">
            <input type="text" id="search" placeholder="Search Shul, Rabbi, or Street..." onkeyup="processAll()">
            <select id="radius" onchange="processAll()">
                <option value="1">1 Mile</option>
                <option value="5" selected>5 Miles</option>
                <option value="10">10 Miles</option>
                <option value="25">25 Miles</option>
            </select>
            <div id="count-display" style="font-size: 0.9rem; margin-top: 5px;">Finding Shuls...</div>
        </div>
    </div>
</header>

<div id="main-view">
    <div id="map"></div>
    <div id="sidebar">
        <div id="shul-list"></div>
    </div>
</div>

<script>
    let map, userMarker, shulLayer;
    let allShuls = [];
    let userCoords = [40.0912, -74.2221]; // Default Lakewood

    // 1. INITIALIZE APP
    async function init() {
        initMap();
        await loadData();
        getLocation();
    }

    function initMap() {
        map = L.map('map').setView(userCoords, 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap'
        }).addTo(map);
        shulLayer = L.layerGroup().addTo(map);
        userMarker = L.circleMarker(userCoords, { color: 'red', radius: 8 }).addTo(map).bindPopup("You are here");
    }

    function getLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(position => {
                userCoords = [position.coords.latitude, position.coords.longitude];
                userMarker.setLatLng(userCoords);
                map.setView(userCoords, 13);
                processAll();
            });
        }
    }

    // 2. DATA PULL
    async function loadData() {
        try {
            // Using your raw GitHub link to ensure it works everywhere
            const response = await fetch('https://raw.githubusercontent.com/avrumiesti-ui/godavenbyshultime/main/database.json');
            allShuls = await response.json();
            processAll();
        } catch (err) {
            document.getElementById('shul-list').innerHTML = "Error loading database.json";
        }
    }

    // 3. CORE LOGIC (Distance, Filter, Zmanim)
    function processAll() {
        const searchTerm = document.getElementById('search').value.toLowerCase();
        const radiusLimit = parseFloat(document.getElementById('radius').value);
        
        shulLayer.clearLayers();
        const listContainer = document.getElementById('shul-list');
        listContainer.innerHTML = '';

        const filtered = allShuls.filter(shul => {
            const dist = getDistance(userCoords[0], userCoords[1], shul.lat, shul.lng);
            shul.currentDist = dist;

            const matchesSearch = shul.shul_name.toLowerCase().includes(searchTerm) || 
                                 shul.rabbi_name.toLowerCase().includes(searchTerm);
            const matchesRadius = dist <= radiusLimit;

            return matchesSearch && matchesRadius;
        });

        // Sort by distance
        filtered.sort((a, b) => a.currentDist - b.currentDist);

        document.getElementById('count-display').innerText = `${filtered.length} Shuls within ${radiusLimit} miles`;

        filtered.forEach(shul => {
            addMapMarker(shul);
            addListCard(shul);
        });
    }

    // 4. ZMANIM CALCULATOR
    function getShulZmanim(lat, lng) {
        const times = SunCalc.getTimes(new Date(), lat, lng);
        
        const format = (date, offsetMinutes = 0) => {
            const d = new Date(date.getTime() + offsetMinutes * 60000);
            return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        };

        // Standard logic: Shacharis (Sunrise), Mincha (20m before sunset), Maariv (30m after sunset)
        return {
            shacharis: format(times.sunrise),
            mincha: format(times.sunset, -20),
            maariv: format(times.sunset, 30)
        };
    }

    // 5. HELPER FUNCTIONS
    function getDistance(lat1, lon1, lat2, lon2) {
        const R = 3958.8; // Miles
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function addMapMarker(shul) {
        const color = shul.nusach === 'Sefard' ? 'green' : (shul.nusach === 'Ashkenaz' ? 'blue' : 'orange');
        L.circleMarker([shul.lat, shul.lng], {
            color: color,
            fillOpacity: 0.8,
            radius: 10
        }).addTo(shulLayer).bindPopup(`<b>${shul.shul_name}</b><br>${shul.nusach}`);
    }

    function addListCard(shul) {
        const z = getShulZmanim(shul.lat, shul.lng);
        const card = document.createElement('div');
        card.className = `shul-card ${shul.nusach}`;
        card.innerHTML = `
            <div class="distance-tag">${shul.currentDist.toFixed(1)} mi</div>
            <div class="shul-name">${shul.shul_name}</div>
            <div style="font-size:0.85rem; color:#666;">üìç ${shul.address}</div>
            <div style="font-size:0.85rem; margin-top:5px;">üë≥ ${shul.rabbi_name} | üìñ ${shul.nusach}</div>
            
            <div class="zman-row">
                <div class="zman-item">
                    <div class="zman-label">Shacharis</div>
                    <div class="zman-time">${z.shacharis}</div>
                </div>
                <div class="zman-item">
                    <div class="zman-label">Mincha</div>
                    <div class="zman-time">${z.mincha}</div>
                </div>
                <div class="zman-item">
                    <div class="zman-label">Maariv</div>
                    <div class="zman-time">${z.maariv}</div>
                </div>
            </div>
        `;
        document.getElementById('shul-list').appendChild(card);
    }

    window.onload = init;
</script>

</body>
</html>
