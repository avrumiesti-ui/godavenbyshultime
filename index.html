<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>ShulTime</title>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<style>
    /* --- 1. GLOBAL VARIABLES & COLORS --- */
    :root { 
        --primary: #0D2B4F; 
        --bg: #F2F4F8; 
        
        /* NUSACH COLORS (Backgrounds & Text) */
        --ashkenaz-bg: #E3F2FD; --ashkenaz-text: #1565C0;
        --sefard-bg: #E8F5E9;   --sefard-text: #2E7D32;
        --ari-bg: #F3E5F5;      --ari-text: #7B1FA2;
        --chabad-bg: #FFF3E0;   --chabad-text: #E65100;
        --edot-bg: #FBE9E7;     --edot-text: #D84315;
        --other-bg: #EEEEEE;    --other-text: #616161;
    }
    
    html, body { margin: 0; padding: 0; height: 100%; overscroll-behavior-y: contain; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Roboto", sans-serif; background: var(--bg); overflow: hidden; color: #333; -webkit-tap-highlight-color: transparent; }
    
    /* --- 2. HEADER & SEARCH --- */
    .floating-header {
        position: fixed; top: 15px; left: 12px; right: 12px;
        z-index: 1000; display: flex; gap: 10px; align-items: center; pointer-events: auto;
    }
    .search-container {
        flex: 1; display: flex; align-items: center;
        background: #fff; height: 50px; border-radius: 25px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.12); padding: 0 15px; overflow: hidden; 
    }
    gmp-place-autocomplete { width: 100%; height: 100%; background-color: #fff !important; }
    
    .circle-btn {
        width: 50px; height: 50px; flex-shrink: 0;
        border-radius: 50%; background: #fff; border: none;
        box-shadow: 0 4px 15px rgba(0,0,0,0.12); display: flex; align-items: center; justify-content: center;
        cursor: pointer; color: var(--primary); transition: transform 0.1s;
    }
    .circle-btn:active { transform: scale(0.95); }

    /* STATUS PILLS (Map Overlay) */
    .status-area {
        position: fixed; top: 80px; left: 0; right: 0;
        display: flex; justify-content: center; align-items: center; gap: 8px;
        z-index: 800; pointer-events: none;
    }
    .status-pill {
        padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: 700;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1); white-space: nowrap;
        background: #fff; color: var(--primary); border: 1px solid var(--primary);
    }
    #status-pill-loc { background: rgba(13, 43, 79, 0.95); color: #fff; border: none; }

    /* --- 3. VIEWS LAYOUT --- */
    .view-container { 
        position: absolute; inset: 0; 
        padding-bottom: 120px; /* Space for bottom bar */
        overflow-y: auto; background: var(--bg); 
        display: none; z-index: 10;
        -webkit-overflow-scrolling: touch;
    }
    #map-view { padding: 0; z-index: 5; } /* Map takes full screen */

    /* --- 4. LIST CARDS (With Color Coding) --- */
    .minyan-card {
        background: #fff; border-radius: 12px; margin-bottom: 8px;
        display: flex; justify-content: space-between; align-items: stretch;
        box-shadow: 0 2px 5px rgba(0,0,0,0.03); overflow: hidden; 
        height: 85px; box-sizing: border-box; position: relative;
    }
    .info-zone { 
        width: 60%; padding: 8px 12px; display: flex; flex-direction: column; justify-content: center; 
        border-right: 1px solid #f0f0f0; cursor:pointer; 
    }
    .map-zone { 
        width: 40%; background: #fafafa; position: relative; cursor:pointer; 
    }
    
    .shul-name { font-weight: 800; font-size: 16px; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 2px; }
    .shul-address { font-size: 12px; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.2; }
    .shul-city { font-size: 11px; color: #999; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 4px; line-height: 1.2; }
    
    /* DYNAMIC COLOR CLASSES */
    .n-Ashkenaz { background: var(--ashkenaz-bg) !important; color: var(--ashkenaz-text) !important; border-color: var(--ashkenaz-text) !important; }
    .n-Sefard { background: var(--sefard-bg) !important; color: var(--sefard-text) !important; border-color: var(--sefard-text) !important; }
    .n-Ari { background: var(--ari-bg) !important; color: var(--ari-text) !important; border-color: var(--ari-text) !important; }
    .n-Chabad { background: var(--chabad-bg) !important; color: var(--chabad-text) !important; border-color: var(--chabad-text) !important; }
    .n-Edot-HaMizrach { background: var(--edot-bg) !important; color: var(--edot-text) !important; border-color: var(--edot-text) !important; }
    .n-Other { background: var(--other-bg) !important; color: var(--other-text) !important; border-color: var(--other-text) !important; }

    .nusach-tag { 
        font-size: 10px; padding: 2px 8px; border-radius: 6px; 
        display: inline-block; font-weight: 700; text-transform: uppercase; width: fit-content; 
    }

    /* RIGHT SIDE LAYOUT (40px Buffer) */
    .tefillah-label { position: absolute; top: 8px; right: 40px; font-size: 10px; font-weight: 900; text-transform: uppercase; letter-spacing: 0.5px; color: #555; } 
    .time-val-card { 
        position: absolute; top: 50%; right: 40px; transform: translateY(-50%); 
        padding: 4px 8px; border-radius: 8px; font-weight: 800; font-size: 16px; white-space: nowrap; 
        /* Color will be injected by Nusach class */
    }
    .dist-row { position: absolute; bottom: 8px; right: 40px; display: flex; align-items: center; gap: 4px; font-size: 11px; font-weight: 800; color: #666; }
    
    .map-circle { 
        position: absolute; top: 50%; right: 8px; transform: translateY(-50%);
        width: 26px; height: 26px; border-radius: 50%; background: #fff; 
        display: flex; align-items: center; justify-content: center; border: 1px solid #eee; 
        box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
    }
    .google-maps-icon { font-size: 16px !important; color: #4285F4; }

    /* --- 5. CUSTOM MARKERS ON MAP --- */
    .custom-marker { 
        padding: 4px 8px; border-radius: 8px; background: white; 
        font-weight: 800; font-size: 12px; box-shadow: 0 3px 6px rgba(0,0,0,0.3); 
        border: 2px solid #555; position: relative; top: -10px; cursor: pointer;
    }
    .custom-marker::after { content: ""; position: absolute; bottom: -5px; left: 50%; transform: translateX(-50%); border-width: 5px 5px 0; border-style: solid; border-color: white transparent transparent transparent; }
    
    /* --- 6. ZMANIM STYLES --- */
    .z-header { background: #fff; padding: 40px 20px 15px; border-bottom: 1px solid #eee; position: sticky; top: 0; z-index: 20; }
    .z-title { font-size: 32px; font-weight: 800; color: var(--primary); margin: 0 0 10px 0; display:flex; justify-content:space-between; align-items:center;}
    .z-loc-badge { font-size: 12px; background: #E3F2FD; color: var(--primary); padding: 5px 12px; border-radius: 15px; font-weight: 700; }
    
    .date-nav { display: flex; align-items: center; justify-content: space-between; background: #f8f9fa; padding: 6px; border-radius: 12px; margin-top: 10px; border: 1px solid #eee; cursor: pointer; }
    .date-btn { background: none; border: none; font-size: 24px; color: var(--primary); cursor: pointer; display:flex; align-items:center; }
    .date-center { text-align: center; }
    .date-civ { font-weight: 800; font-size: 15px; color: #333; }
    .date-heb { font-size: 12px; color: #666; }
    
    .z-list { list-style: none; padding: 20px 15px; margin: 0; display: flex; flex-direction: column; gap: 10px; }
    .z-card { background: #fff; border-radius: 14px; padding: 12px 16px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); border: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; }
    .z-label { font-size: 15px; font-weight: 700; color: #333; }
    .z-time { font-size: 18px; font-weight: 800; color: var(--primary); font-family: monospace; }
    .z-select { display: block; margin-top: 2px; font-size: 10px; background: #f1f5f9; border: none; padding: 2px 6px; border-radius: 4px; color: #555; font-weight: 700; }

    /* --- 7. DETAILS DRAWER --- */
    #details-drawer { position: fixed; bottom: -100%; left: 10px; right: 10px; height: 75vh; background: #fff; border-radius: 25px; z-index: 3000; box-shadow: 0 5px 30px rgba(0,0,0,0.3); transition: transform 0.3s ease-out; display: flex; flex-direction: column; }
    #details-drawer.open { bottom: 0; transform: translateY(0); }
    .drawer-head { padding: 15px 20px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; }
    .drawer-title { font-size: 20px; font-weight: 800; color: var(--primary); line-height: 1.1; margin-bottom: 4px; }
    .drawer-addr { font-size: 13px; color: #666; }
    .drawer-actions { display: flex; gap: 8px; }
    .drawer-body { flex: 1; overflow-y: auto; padding: 20px; }
    
    .drawer-info-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .rabbi-label { font-size: 13px; font-weight: 600; color: #555; display: flex; align-items: center; gap: 4px; }
    
    .contact-row { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: nowrap; overflow-x: auto; }
    .contact-pill { background: #f5f5f5; border: 1px solid #ddd; padding: 8px 12px; border-radius: 20px; font-size: 11px; font-weight: 700; color: #333; text-decoration: none; display: flex; align-items: center; gap: 4px; white-space: nowrap; }

    .schedule-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .schedule-block { margin-bottom: 8px; }
    .schedule-label { font-size: 10px; font-weight: 700; color: #999; text-transform: uppercase; margin-bottom: 4px; }
    .schedule-pill { display: inline-block; padding: 2px 8px; border-radius: 6px; font-size: 12px; font-weight: 700; margin-right: 4px; margin-bottom: 4px; }

    /* --- 8. FILTER DRAWER --- */
    #filter-drawer { display: none; position: fixed; top: 80px; left: 12px; right: 12px; background: #fff; border-radius: 20px; padding: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.25); z-index: 2000; }
    .filter-label { font-size: 10px; font-weight: 800; color: #bbb; text-transform: uppercase; display: block; margin-bottom: 5px; }
    .chip-container { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 15px; }
    .chip { padding: 6px 12px; border-radius: 15px; border: 1px solid #ddd; background: #fff; font-size: 12px; font-weight: 600; cursor: pointer; }
    .chip.active { box-shadow: 0 2px 4px rgba(0,0,0,0.15); transform: scale(1.05); }
    .time-row { display: flex; gap: 8px; margin-bottom: 8px; }
    .time-input { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 12px; font-weight: 600; font-family: inherit; }
    .action-btn { flex: 1; padding: 10px; border-radius: 12px; border: none; background: #eee; font-weight: 700; font-size: 12px; cursor: pointer; }
    .primary-btn { background: var(--primary); color: white; width: 100%; padding: 12px; border: none; border-radius: 12px; font-size: 14px; font-weight: 700; cursor: pointer; }

    /* --- 9. NAVIGATION & UTILS --- */
    .floating-toolbar { position: fixed; bottom: 30px; left: 20px; right: 20px; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(0,0,0,0.05); display: flex; justify-content: space-between; padding: 10px 15px; z-index: 1500; border-radius: 40px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
    .nav-item { display: flex; flex-direction: column; align-items: center; border: none; background: none; color: #999; font-size: 10px; font-weight: 600; flex: 1; cursor: pointer; }
    .nav-item.active { color: var(--primary); transform: translateY(-2px); }
    .nav-item i { font-size: 24px; margin-bottom: 2px; }
    #nav-toggle { font-weight: 800; color: var(--primary); }

    .fab-location { position: fixed; bottom: 100px; right: 20px; width: 50px; height: 50px; background: #fff; border-radius: 50%; box-shadow: 0 4px 15px rgba(0,0,0,0.2); border: none; color: var(--primary); display: flex; align-items: center; justify-content: center; z-index: 900; }
    
    .sticky-header { position: fixed; top: 0; left: 0; right: 0; height: 60px; background: rgba(242, 244, 248, 0.9); backdrop-filter: blur(20px); border-bottom: 1px solid rgba(0,0,0,0.05); z-index: 900; display: flex; align-items: flex-end; justify-content: center; padding-bottom: 12px; font-weight: 800; font-size: 17px; color: var(--primary); opacity: 0; pointer-events: none; transition: opacity 0.2s; }
    .sticky-header.visible { opacity: 1; pointer-events: auto; }
    .page-title { padding: 40px 20px 15px; font-size: 34px; font-weight: 800; color: var(--primary); }
    .empty-state { text-align: center; color: #777; margin-top: 50px; }
    
    /* MODALS */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 4000; align-items: center; justify-content: center; }
    .modal.active { display: flex; }
    .modal-card { background: #fff; width: 85%; padding: 20px; border-radius: 16px; }
    .modal-input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px; box-sizing: border-box; font-size: 16px; }
</style>
</head>
<body>

    <div class="floating-header" id="filter-header">
        <div class="search-container">
            <div id="autocomplete-container" style="flex:1; height:100%;"></div>
        </div>
        <button class="circle-btn" onclick="toggleFilters()"><i class="material-icons">tune</i></button>
    </div>

    <div class="status-area">
        <div id="status-pill"></div>
        <div id="count-pill"></div>
        <div id="map-radius-pill"></div>
    </div>

    <div id="filter-drawer">
        <div class="filter-section">
            <label class="filter-label">Date</label>
            <div class="date-nav" onclick="openDateModal()">
                <i class="material-icons" onclick="event.stopPropagation(); changeDate(-1)">chevron_left</i>
                <div class="date-center">
                    <div class="date-civ" id="filter-date-civ">Today</div>
                    <div class="date-heb" id="filter-date-heb">Loading...</div>
                </div>
                <i class="material-icons" onclick="event.stopPropagation(); changeDate(1)">chevron_right</i>
            </div>
        </div>
        <div class="filter-section">
            <label class="filter-label">Radius (Miles)</label>
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                <input type="range" min="1" max="50" value="20" style="flex:1" oninput="manualRadiusUpdate(this.value)">
                <span id="rad-val" style="font-weight:700;">20</span>
            </div>
            <div class="chip-container" style="display:flex;gap:6px;">
                <div class="chip" onclick="manualRadiusUpdate(1)">1</div>
                <div class="chip" onclick="manualRadiusUpdate(5)">5</div>
                <div class="chip" onclick="manualRadiusUpdate(20)">20</div>
                <div class="chip" onclick="manualRadiusUpdate(50)">50</div>
            </div>
        </div>
        <div class="filter-section">
            <label class="filter-label">Nusach</label>
            <div class="chip-container" id="nusach-group" style="display:flex;gap:6px;flex-wrap:wrap;">
                <div class="chip active" onclick="setFilter('nusach','',this)">All</div>
            </div>
        </div>
        <div class="filter-section">
            <label class="filter-label">Time</label>
            <div class="time-inputs-row">
                <input type="time" id="time-start" class="time-input" onchange="onTimeChange()">
                <input type="time" id="time-end" class="time-input" onchange="applyFilters()">
            </div>
            <div style="display:flex;gap:6px;margin-top:6px;">
                <button class="action-btn" onclick="setAllDay()">All Day</button>
                <button class="action-btn" style="background:var(--primary);color:white;" onclick="setNextHour()">Next Hour</button>
            </div>
        </div>
        <button class="primary-btn" style="margin-top:15px;" onclick="toggleFilters()">Done</button>
    </div>

    <div id="map-view" class="view-container"></div>
    <div id="list-view" class="view-container" style="padding-top:110px;"></div>
    
    <div id="zmanim-view" class="view-container" style="padding:0; padding-bottom:120px;">
        <div class="z-header">
            <div class="z-title">
                <span>Zmanim</span>
                <button class="z-loc-btn" id="z-loc-label" onclick="openLocModal()">Lakewood, NJ</button>
            </div>
            <div class="date-nav" onclick="openDateModal()">
                <i class="material-icons" onclick="event.stopPropagation(); changeDate(-1)">chevron_left</i>
                <div class="date-center">
                    <div class="date-civ" id="z-date-civ"></div>
                    <div class="date-heb" id="z-date-heb"></div>
                </div>
                <i class="material-icons" onclick="event.stopPropagation(); changeDate(1)">chevron_right</i>
            </div>
        </div>
        <ul class="z-list" id="z-list"></ul>
        <div class="z-glossary" id="z-glossary"></div>
    </div>

    <div id="settings-view" class="view-container" style="padding:0; padding-bottom:120px;">
        <div class="page-title">Settings</div>
        <div style="padding:0 20px;">
            <input type="text" id="p-name" class="modal-input" placeholder="Name" oninput="saveProfile()">
            <input type="tel" id="p-phone" class="modal-input" placeholder="Phone" oninput="saveProfile()">
        </div>
    </div>

    <div id="details-drawer">
        <div class="drawer-header">
            <div class="drawer-title-container">
                <div class="drawer-title" id="drawer-title"></div>
                <div class="drawer-addr" id="drawer-addr"></div>
            </div>
            <div class="drawer-actions">
                <button class="circle-btn" style="width:40px;height:40px;border:1px solid #eee;" onclick="toggleFavorite()"><i class="material-icons" id="bookmark-icon">bookmark_border</i></button>
                <button class="circle-btn" style="width:40px;height:40px;border:1px solid #eee;" onclick="shareShul()"><i class="material-icons">ios_share</i></button>
                <button class="circle-btn" style="width:40px;height:40px;border:1px solid #eee;" onclick="closeDetails()"><i class="material-icons">close</i></button>
            </div>
        </div>
        <div id="drawer-content" class="drawer-body"></div>
    </div>

    <div class="modal" id="dateModal">
        <div class="modal-card">
            <h3>Select Date</h3>
            <input type="date" id="datePicker" class="modal-input">
            <button class="primary-btn" onclick="setDateFromPicker()">Go</button>
            <button class="action-btn" style="width:100%;margin-top:8px;" onclick="document.getElementById('dateModal').classList.remove('active')">Cancel</button>
        </div>
    </div>

    <div class="modal" id="locModal">
        <div class="modal-card">
            <h3>Location</h3>
            <input type="text" id="loc-search" class="modal-input" placeholder="City">
            <button class="primary-btn" onclick="ZmanimApp.searchCity()">Search</button>
            <div id="loc-results" style="margin-top:10px;"></div>
            <button class="action-btn" style="width:100%;margin-top:8px;" onclick="document.getElementById('locModal').classList.remove('active')">Close</button>
        </div>
    </div>

    <div id="center-marker"></div>
    <div id="scrim" onclick="closeDetails()" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.3);z-index:2500;"></div>
    <div id="sticky-header" class="sticky-header"></div>
    <button class="fab-location" id="fab-location" onclick="useMyLocation()"><i class="material-icons">my_location</i></button>

    <div class="floating-toolbar">
        <button class="nav-item" id="nav-recent" onclick="switchTab('recent')"><i class="material-icons">history</i>Recent</button>
        <button class="nav-item" id="nav-zmanim" onclick="switchTab('zmanim')"><i class="material-icons">access_time</i>Zmanim</button>
        <button class="nav-item active" id="nav-toggle" onclick="toggleView()"><i class="material-icons" id="nav-toggle-icon">list</i><span id="nav-toggle-text">List</span></button>
        <button class="nav-item" id="nav-saved" onclick="switchTab('saved')"><i class="material-icons">bookmark_border</i>Saved</button>
        <button class="nav-item" id="nav-settings" onclick="switchTab('settings')"><i class="material-icons">settings</i>Settings</button>
    </div>

    <script>
        // --- 1. CORE VARIABLES ---
        let map, allMinyanim=[], searchCenter=null, currentRadius=20, currentTab='map';
        let filters = { tefillah: '', nusach: '' };
        let markers = [], allNusachs = new Set();
        let selectedShul = null;
        let currentDate = new Date();

        // --- 2. ZMANIM MODULE (Isolated) ---
        const ZmanimApp = {
            date: new Date(),
            loc: { lat: 40.096, lng: -74.222, name: 'Lakewood, NJ', elev: 30 },
            opts: { alot:'16.1', mish:'10.2', sunrise:'elev', shema:'gra', tefila:'gra', mincha:'gra', plag:'gra', candles:'18', tzais:'8.5', shaa:'gra', sunset:'elev' },
            config: [
                {id:"alot", label:"Alos", desc:"Dawn", opts:[['16.1','16.1°'],['72','72m']]},
                {id:"sunrise", label:"Sunrise", desc:"Netz", opts:[['elev','Elev']]},
                {id:"shema", label:"Shema", desc:"Sof Zman", opts:[['gra','Gra'],['mga','MGA']]},
                {id:"tefila", label:"Tefila", desc:"Sof Zman", opts:[['gra','Gra']]},
                {id:"chatzos", label:"Chatzos", desc:"Midday"},
                {id:"mincha", label:"Mincha", desc:"Gedola"},
                {id:"candles", label:"Candles", desc:"18m"},
                {id:"sunset", label:"Sunset", desc:"Shkia", opts:[['elev','Elev']]},
                {id:"tzais", label:"Tzais", desc:"Nightfall", opts:[['8.5','8.5°'],['72','72m']]}
            ],
            // Engines
            Heb: { get: (d) => new Intl.DateTimeFormat('en-US-u-ca-hebrew',{day:'numeric',month:'long',year:'numeric'}).format(d) },
            Solar: { calc: (d, lat, lng) => {
                const base = new Date(d).setHours(6,0,0,0);
                const add = m => new Date(base + m*60000).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
                return { alot:add(0), sun:add(60), noon:add(360), set:add(720), tzais:add(760) }; // Mock for Demo
            }},
            init: function() { this.render(); },
            setDate: function(d) { this.date = d; this.render(); },
            updateLoc: function(l) { this.loc = l; this.render(); },
            changeOpt: function(id, val) { this.opts[id] = val; this.render(); },
            render: function() {
                document.getElementById('z-loc-label').innerText = this.loc.name;
                const dateStr = this.date.toLocaleDateString('en-US',{weekday:'short', month:'short', day:'numeric'});
                document.getElementById('z-date-civ').innerText = dateStr;
                document.getElementById('z-date-heb').innerText = this.Heb.get(this.date);
                
                const t = this.Solar.calc(this.date, this.loc.lat, this.loc.lng);
                let h = "";
                this.config.forEach(z => {
                    let time = t.noon;
                    if(z.id==='alot') time=t.alot; if(z.id==='sunrise') time=t.sun; if(z.id==='sunset') time=t.set;
                    let sel = z.opts ? `<select class="z-select" onchange="ZmanimApp.changeOpt('${z.id}',this.value)">${z.opts.map(o=>`<option>${o[1]}</option>`).join('')}</select>` : "";
                    h += `<li class="z-card"><div class="z-left"><span class="z-label">${z.label}</span><span class="z-desc">${z.desc}</span>${sel}</div><div class="z-time">${time}</div></li>`;
                });
                document.getElementById('z-list').innerHTML = h;
            },
            searchCity: function() {
                const r = document.getElementById('loc-results');
                r.innerHTML = "Searching...";
                setTimeout(() => { r.innerHTML = `<div onclick="ZmanimApp.updateLoc({lat:51.5,lng:-0.1,name:'London'});document.getElementById('locModal').classList.remove('active')" style="padding:10px;cursor:pointer;">London, UK</div>`; }, 500);
            }
        };

        // --- 3. INIT ---
        document.addEventListener("DOMContentLoaded", async () => {
            ZmanimApp.init(); 
            document.getElementById('time-start').value="00:00"; document.getElementById('time-end').value="23:59";
            updateDateDisplay();
            loadProfile();

            document.getElementById('list-view').addEventListener('scroll', function() {
                const h = document.getElementById('sticky-header');
                if(this.scrollTop>40 && (currentTab==='recent'||currentTab==='saved')) { h.classList.add('visible'); h.innerText = currentTab.charAt(0).toUpperCase()+currentTab.slice(1); }
                else h.classList.remove('visible');
            });

            try {
                const res = await fetch("database.json");
                if(!res.ok) throw new Error("x");
                const data = await res.json();
                processData(data);
            } catch(e) {
                processData([
                    {id:1, name:"Bais Medrash Govoah", address:"617 6th St", city:"Lakewood", state:"NJ", lat:40.093, lng:-74.222, nusach:"Ashkenaz", rabbi:"Rabbi Olshin", phone:"7323671060", email:"info@bmg.edu", shacharis:{week:["7:00a"]}, mincha:{week:["1:45p"]}, maariv:{week:["9:30p"]}},
                    {id:2, name:"Satmar", address:"Forest Ave", city:"Lakewood", state:"NJ", lat:40.080, lng:-74.210, nusach:"Sefard", rabbi:"Rabbi Teitelbaum", shacharis:{week:["8:00a"]}, mincha:{week:["2:00p"]}, maariv:{week:["9:00p"]}},
                    {id:3, name:"Ohr Chaim", address:"123 Main", city:"Lakewood", state:"NJ", lat:40.085, lng:-74.219, nusach:"Edot HaMizrach", rabbi:"Rabbi Cohen", shacharis:{week:["6:30a"]}, mincha:{week:["3:00p"]}, maariv:{week:["8:00p"]}}
                ]);
            }
        });

        // --- 4. LOGIC ---
        function processData(data) {
            allMinyanim = []; allNusachs = new Set();
            data.forEach(s => {
                if(s.nusach) allNusachs.add(s.nusach);
                const add = (l,t) => { if(l) l.forEach(tm => allMinyanim.push({...s, tefillah:t, timeDisplay:tm})) };
                add(s.shacharis?.week, 'Shacharis'); add(s.mincha?.week, 'Mincha'); add(s.maariv?.week, 'Maariv');
            });
            populateNusachFilter();
            if(map) applyFilters();
        }

        function populateNusachFilter() {
            const g = document.getElementById('nusach-group');
            g.innerHTML = `<div class="chip active" onclick="setFilter('nusach', '', this)">All</div>`;
            Array.from(allNusachs).forEach(n => {
                const c = document.createElement('div');
                c.className = `chip chip-${n.replace(/ /g,'-')}`; c.innerText = n;
                c.onclick = () => setFilter('nusach', n, c);
                g.appendChild(c);
            });
        }

        async function initApp() {
            const { Map } = await google.maps.importLibrary("maps");
            const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");
            const { PlaceAutocompleteElement } = await google.maps.importLibrary("places");
            const auto = new PlaceAutocompleteElement();
            document.getElementById("autocomplete-container").appendChild(auto);

            map = new Map(document.getElementById("map-view"), {
                center: { lat: 40.091, lng: -74.218 }, zoom: 13,
                disableDefaultUI: true, mapId: "DEMO_MAP_ID",
                styles: [{ featureType: "poi", stylers: [{ visibility: "off" }] }]
            });

            map.addListener('idle', () => {
                const c = map.getCenter();
                searchCenter = { lat: c.lat(), lng: c.lng() };
                document.getElementById('status-pill').innerText = "Near: Map Center";
                ZmanimApp.updateLoc({lat:c.lat(), lng:c.lng(), name:"Map Location"});
                applyFilters();
            });
            
            auto.addEventListener("gmp-select", async (e) => {
                const p = e.placePrediction.toPlace();
                await p.fetchFields({ fields: ["location"] });
                map.setCenter(p.location);
            });
        }

        function applyFilters() {
            if(!searchCenter || !allMinyanim.length) return;
            let res = allMinyanim.map(m => { m.dist = getDist(searchCenter.lat, searchCenter.lng, m.lat, m.lng); return m; });
            const isMap = document.getElementById('map-view').style.display !== 'none';
            
            if(filters.tefillah) res = res.filter(m => m.tefillah === filters.tefillah);
            if(filters.nusach) res = res.filter(m => m.nusach === filters.nusach);
            res = res.filter(m => m.dist <= currentRadius);
            
            const count = new Set(res.map(r=>r.id)).size;
            document.getElementById('count-pill').innerText = isMap ? `${count} Shuls` : `${count} Shuls / ${res.length} Minyanim`;
            document.getElementById('map-radius-pill').innerText = `Radius: ${currentRadius}mi`;

            if(isMap) updateMarkers(res);
            else renderList(res);
        }

        function updateMarkers(res) {
            markers.forEach(m => m.map = null); markers = [];
            const locs = {};
            res.forEach(r => locs[r.lat+","+r.lng] = r); 
            Object.values(locs).forEach(m => {
                const el = document.createElement('div');
                const nSafe = m.nusach.replace(/ /g,'-');
                el.className = `custom-marker marker-${nSafe}`;
                el.textContent = m.timeDisplay;
                const mk = new google.maps.marker.AdvancedMarkerElement({
                    map: map, position: {lat:m.lat, lng:m.lng}, content: el
                });
                mk.element.addEventListener('click', () => openDetails(m));
                markers.push(mk);
            });
        }

        function renderList(res) {
            const list = document.getElementById('list-view');
            list.innerHTML = "";
            res.forEach(m => {
                const nSafe = m.nusach.replace(/ /g,'-');
                const d = document.createElement('div');
                d.className = `minyan-card n-${nSafe} type-${m.tefillah}`;
                d.innerHTML = `
                <div class="info-zone" onclick='openDetails(${JSON.stringify(m)})'>
                    <div class="shul-name">${m.name}</div><div class="shul-address">${m.address}</div><div class="nusach-tag n-${nSafe}">${m.nusach}</div>
                </div>
                <div class="map-zone" onclick="window.open('http://maps.google.com/?q=${m.lat},${m.lng}')">
                    <div class="tefillah-label">${m.tefillah}</div>
                    <div class="time-val-card n-${nSafe}">${m.timeDisplay}</div>
                    <div class="dist-row"><span>${m.dist ? m.dist.toFixed(1) : 0}mi</span><div class="map-circle"><i class="material-icons google-maps-icon">place</i></div></div>
                </div>`;
                list.appendChild(d);
            });
        }

        // --- UTILS ---
        function switchTab(t) {
            currentTab = t;
            document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
            ['map-view','list-view','zmanim-view','settings-view'].forEach(id=>document.getElementById(id).style.display='none');
            document.getElementById('filter-header').style.display = (t==='map'||t==='list') ? 'flex' : 'none';
            document.querySelector('.status-area').style.display = (t==='map'||t==='list') ? 'flex' : 'none';
            document.getElementById('fab-location').style.display = (t==='map'||t==='list') ? 'flex' : 'none';
            
            if(t==='map') { document.getElementById('map-view').style.display='block'; document.getElementById('nav-toggle').classList.add('active'); updateToggle('List','list'); applyFilters(); }
            else if(t==='list') { document.getElementById('list-view').style.display='block'; document.getElementById('nav-toggle').classList.add('active'); updateToggle('Map','map'); applyFilters(); }
            else if(t==='zmanim') { document.getElementById('zmanim-view').style.display='block'; document.getElementById('nav-zmanim').classList.add('active'); }
            else if(t==='recent') { document.getElementById('list-view').style.display='block'; document.getElementById('nav-recent').classList.add('active'); renderRecents(); }
            else if(t==='saved') { document.getElementById('list-view').style.display='block'; document.getElementById('nav-saved').classList.add('active'); renderFavorites(); }
            else if(t==='settings') { document.getElementById('settings-view').style.display='block'; document.getElementById('nav-settings').classList.add('active'); }
        }

        function toggleView() { if(document.getElementById('map-view').style.display==='block') switchTab('list'); else switchTab('map'); }
        function toggleFilters() { const d=document.getElementById('filter-drawer'); d.style.display=d.style.display==='block'?'none':'block'; }
        function setFilter(t, v, btn) { filters[t] = v; btn.parentElement.querySelectorAll('.chip').forEach(c => c.classList.remove('active')); btn.classList.add('active'); applyFilters(); }
        function updateToggle(t,i) { document.getElementById('nav-toggle-text').innerText=t; document.getElementById('nav-toggle-icon').innerText=i; }
        function manualRadiusUpdate(v) { currentRadius=v; document.getElementById('rad-val').innerText=v; applyFilters(); }
        function openLocModal() { document.getElementById('locModal').classList.add('active'); }
        function useMyLocation() { navigator.geolocation.getCurrentPosition(p=>{ map.setCenter({lat:p.coords.latitude, lng:p.coords.longitude}); map.setZoom(14); }); }
        function getDist(lat1,lon1,lat2,lon2) { return 3958.8 * 2 * Math.atan2(Math.sqrt(Math.sin((lat2-lat1)*Math.PI/360)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin((lon2-lon1)*Math.PI/360)**2), Math.sqrt(1-Math.sin((lat2-lat1)*Math.PI/360)**2)); }
        
        // --- DETAILS DRAWER & SAVED LOGIC ---
        function openDetails(m) {
            selectedShul = m;
            addToRecents(m);
            document.getElementById('details-drawer').classList.add('open');
            document.getElementById('scrim').style.display = 'block';
            document.getElementById('drawer-title').innerText = m.name;
            document.getElementById('drawer-addr').innerText = m.address + ", " + m.city;
            checkFavoriteStatus();
            
            // Colored Schedule
            let sched = "";
            const nSafe = m.nusach.replace(/ /g,'-');
            const nClass = `n-${nSafe}`;
            const row = (lbl, arr) => { if(arr) sched += `<div class="schedule-item"><div class="schedule-day">${lbl}</div>${arr.map(t=>`<span class="schedule-pill ${nClass}">${t}</span>`).join('')}</div>`; };
            row("Shacharis", m.shacharis?.week); row("Mincha", m.mincha?.week); row("Maariv", m.maariv?.week);
            
            // Contact
            let contact = "";
            if(m.phone) contact += `<a href="tel:${m.phone}" class="contact-btn"><i class="material-icons" style="font-size:14px">call</i> Call</a>`;
            if(m.email) contact += `<a href="mailto:${m.email}" class="contact-btn"><i class="material-icons" style="font-size:14px">email</i> Email</a>`;
            contact += `<a href="#" class="contact-btn"><i class="material-icons" style="font-size:14px">open_in_new</i> GoDaven</a>`;

            document.getElementById('drawer-content').innerHTML = `
                <div class="drawer-info-row">
                    <div class="drawer-rabbi"><i class="material-icons" style="font-size:16px">person</i> ${m.rabbi || "N/A"}</div>
                    <div class="nusach-tag n-${nSafe}">${m.nusach}</div>
                </div>
                <div class="contact-row">${contact}</div>
                <div class="schedule-grid">${sched}</div>`;
        }
        
        function closeDetails() { document.getElementById('details-drawer').classList.remove('open'); document.getElementById('scrim').style.display = 'none'; }
        function shareShul() { if(navigator.share) navigator.share({title:selectedShul.name, text:selectedShul.address}); }
        function saveProfile() { localStorage.setItem('shultime_profile', JSON.stringify({name:document.getElementById('p-name').value, phone:document.getElementById('p-phone').value})); }
        function loadProfile() { const p = JSON.parse(localStorage.getItem('shultime_profile') || "{}"); if(p.name) document.getElementById('p-name').value = p.name; if(p.phone) document.getElementById('p-phone').value = p.phone; }
        function showComingSoon() { alert("Coming soon!"); }

        // --- STORAGE ---
        function addToRecents(m) {
            let r = JSON.parse(localStorage.getItem("shultime_recents") || "[]");
            r = r.filter(i => i.id !== m.id); r.unshift(m); if(r.length > 20) r.pop();
            localStorage.setItem("shultime_recents", JSON.stringify(r));
        }
        function toggleFavorite() {
            let f = JSON.parse(localStorage.getItem("shultime_favs") || "[]");
            const idx = f.findIndex(x => x.id === selectedShul.id);
            if(idx > -1) { f.splice(idx,1); document.getElementById('bookmark-icon').innerText = 'bookmark_border'; }
            else { f.push(selectedShul); document.getElementById('bookmark-icon').innerText = 'bookmark'; }
            localStorage.setItem("shultime_favs", JSON.stringify(f));
            if(currentTab==='saved') renderFavorites();
        }
        function checkFavoriteStatus() {
            let f = JSON.parse(localStorage.getItem("shultime_favs") || "[]");
            document.getElementById('bookmark-icon').innerText = f.some(x=>x.id===selectedShul.id) ? 'bookmark' : 'bookmark_border';
        }
        function renderFavorites() {
            let f = JSON.parse(localStorage.getItem("shultime_favs") || "[]");
            const l = document.getElementById('list-view');
            l.innerHTML = '<div class="page-title">Saved</div>';
            if(f.length===0) l.innerHTML += '<div class="empty-state">No saved shuls.</div>'; else renderListCards(f, l);
        }
        function renderRecents() {
            let r = JSON.parse(localStorage.getItem("shultime_recents") || "[]");
            const l = document.getElementById('list-view');
            l.innerHTML = '<div class="page-title">Recent</div>';
            if(r.length===0) l.innerHTML += '<div class="empty-state">No history.</div>'; else renderListCards(r, l);
        }

        // --- DATE LOGIC ---
        function changeDate(days) {
            currentDate.setDate(currentDate.getDate() + days);
            updateDateDisplay();
            ZmanimApp.setDate(currentDate);
            processMinyanim(allMinyanim); // Refresh list for day of week
        }
        function updateDateDisplay() {
            const str = currentDate.toLocaleDateString('en-US', {weekday:'short', month:'short', day:'numeric'});
            document.getElementById('filter-date-civ').innerText = str;
            document.getElementById('filter-date-heb').innerText = ZmanimApp.Heb.get(currentDate);
            document.getElementById('datePicker').value = currentDate.toISOString().split('T')[0];
        }
        function openDateModal() { document.getElementById('dateModal').classList.add('active'); }
        function setDateFromPicker() {
            currentDate = new Date(document.getElementById('datePicker').value);
            updateDateDisplay();
            ZmanimApp.setDate(currentDate);
            document.getElementById('dateModal').classList.remove('active');
        }
        
        function setAllDay() { document.getElementById('time-start').value="00:00"; document.getElementById('time-end').value="23:59"; applyFilters(); }
        function setNextHour() { 
            const d=new Date(); const pad=n=>String(n).padStart(2,'0'); 
            document.getElementById('time-start').value=`${pad(d.getHours())}:${pad(d.getMinutes())}`;
            d.setHours(d.getHours()+1);
            document.getElementById('time-end').value=`${pad(d.getHours())}:${pad(d.getMinutes())}`;
            applyFilters();
        }
        function onStartTimeChange() {
            const [h,m] = document.getElementById('time-start').value.split(':').map(Number);
            document.getElementById('time-end').value = `${String(h+1).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
            applyFilters();
        }
    </script>
    <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAOpNebt0dPJUmiEw-i1W-Dx_UezLpIvxI&loading=async&libraries=places,maps,marker&callback=initApp"></script>
</body>
</html>
