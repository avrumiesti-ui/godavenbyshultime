<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>ShulTime</title>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<style>
    :root { 
        --primary: #0D2B4F; 
        --bg: #F2F4F8; 
        --ad-bg: #FFF8E1; 
        --ad-border: #FBC02D; 

        /* TEFILLAH COLORS */
        --color-Shacharis: #2E7D32; 
        --color-Mincha: #E65100;    
        --color-Maariv: #1565C0;    

        /* NUSACH BACKGROUNDS */
        --bg-Ashkenaz: #E3F2FD;       
        --bg-Sefard: #E8F5E9;         
        --bg-Ari: #F3E5F5;            
        --bg-Edot-HaMizrach: #FFF3E0; 
        --bg-Chabad: #FFF8E1;         
        --bg-Other: #F5F5F5;          
        
        /* NUSACH TEXT */
        --text-Ashkenaz: #1565C0;
        --text-Sefard: #2E7D32;
        --text-Ari: #7B1FA2;
        --text-Edot-HaMizrach: #E65100;
        --text-Chabad: #F57F17;
        --text-Other: #616161;
    }
    
    html, body { margin: 0; padding: 0; height: 100%; overscroll-behavior-y: contain; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Roboto", sans-serif; background: var(--bg); overflow: hidden; }
    
    /* FLOATING HEADER (Search) - Only visible on Map/List tab */
    .floating-header {
        position: fixed; top: 15px; left: 12px; right: 12px;
        z-index: 1000; display: flex; gap: 10px; align-items: center; pointer-events: auto;
    }
    .search-container {
        flex: 1; pointer-events: auto; display: flex; align-items: center;
        background: #fff; height: 50px; border-radius: 25px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.15); padding: 0 15px;
        overflow: hidden; 
    }

    gmp-place-autocomplete { width: 100%; height: 100%; background-color: #fff !important; }
    gmp-place-autocomplete::part(input) { background-color: #fff !important; padding: 0; font-size: 16px; height: 100%; width: 100%; color: #111; font-weight: 500; }
    .pac-container { background-color: #fff !important; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.15); border: none; }

    .circle-btn {
        width: 50px; height: 50px; flex-shrink: 0; pointer-events: auto;
        border-radius: 50%; background: #fff; border: none;
        box-shadow: 0 4px 15px rgba(0,0,0,0.15); display: flex; align-items: center; justify-content: center;
        cursor: pointer; color: var(--primary); transition: all 0.2s;
    }
    .circle-btn.active { background: var(--primary); color: #fff; }

    /* STATUS PILLS */
    .status-area {
        position: fixed; top: 75px; left: 0; right: 0;
        display: flex; justify-content: center; align-items: center; gap: 8px;
        z-index: 800; pointer-events: none; padding: 0 10px;
    }
    #status-pill, #count-pill, #map-radius-pill {
        padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: 700;
        display: none; box-shadow: 0 2px 8px rgba(0,0,0,0.1); white-space: nowrap;
        max-width: 45%; overflow: hidden; text-overflow: ellipsis;
    }
    #status-pill { background: rgba(13, 43, 79, 0.95); color: #fff; }
    #count-pill { background: #fff; color: var(--primary); border: 1px solid var(--primary); }
    #map-radius-pill { background: #2E7D32; color: #fff; display: none; }

    /* STICKY LIQUID HEADER (For Recent/Saved) */
    .sticky-header {
        position: fixed; top: 0; left: 0; right: 0; height: 60px;
        background: rgba(242, 244, 248, 0.85);
        backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
        border-bottom: 1px solid rgba(0,0,0,0.05);
        z-index: 900; 
        display: flex; align-items: flex-end; justify-content: center;
        padding-bottom: 12px;
        font-weight: 800; font-size: 17px; color: var(--primary);
        opacity: 0; transition: opacity 0.2s ease-in-out; pointer-events: none;
    }
    .sticky-header.visible { opacity: 1; pointer-events: auto; }

    /* VIEWS */
    #list-view { position: absolute; inset: 0; padding-bottom: 120px; overflow-y: auto; background: var(--bg); z-index: 10; display: none; }
    #map-view { position: absolute; inset: 0; z-index: 5; }
    #zmanim-view { position: absolute; inset: 0; background: var(--bg); z-index: 15; overflow-y: auto; display: none; padding-bottom: 120px; }
    #settings-view { position: absolute; inset: 0; padding: 20px 12px 120px; overflow-y: auto; background: var(--bg); z-index: 10; display: none; }

    /* PAGE HEADERS */
    .list-page-header { font-size: 34px; font-weight: 800; color: var(--primary); margin-top: 10px; margin-bottom: 15px; padding-left: 5px; }

    /* --- ZMANIM SPECIFIC STYLES (From your code) --- */
    .zman-sticky-header { background: #fff; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.05); padding: 10px 15px; border-bottom: 1px solid #e2e8f0; }
    .zman-top-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .zman-app-title { font-size: 18px; font-weight: 800; color: #2c5282; margin: 0; display: flex; align-items: center; gap: 8px; }
    .zman-loc-btn { font-size: 11px; color: #4a5568; background: #edf2f7; padding: 6px 12px; border-radius: 20px; border: 1px solid #e2e8f0; font-weight: 600; cursor: pointer; max-width: 180px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: flex; align-items: center; gap: 4px; }
    .zman-date-nav { display: flex; align-items: center; justify-content: space-between; background: #f1f5f9; border-radius: 8px; padding: 4px; }
    .zman-nav-btn { width: 36px; height: 36px; border: none; background: #fff; border-radius: 6px; font-size: 18px; color: #2c5282; box-shadow: 0 1px 2px rgba(0,0,0,0.05); cursor: pointer; }
    .zman-date-display { text-align: center; line-height: 1.2; flex-grow: 1; }
    .zman-civ-date { font-size: 14px; font-weight: 700; display: block; }
    .zman-heb-date { font-size: 12px; color: #718096; display: block; }
    .zman-info-bar { display: flex; gap: 10px; padding: 15px 15px 0 15px; }
    .zman-info-pill { flex: 1; background: #fff; border: 1px solid #e2e8f0; padding: 8px; border-radius: 8px; text-align: center; font-size: 12px; font-weight: 600; color: #4a5568; }
    .zman-info-pill span { display: block; font-size: 10px; color: #a0aec0; text-transform: uppercase; margin-bottom: 2px; }
    .zmanim-list { list-style: none; padding: 15px; margin: 0; display: flex; flex-direction: column; gap: 10px; }
    .zman-card { background: #fff; border-radius: 12px; padding: 12px 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); border: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
    .zman-left { display: flex; flex-direction: column; gap: 2px; }
    .zman-label { font-size: 14px; font-weight: 700; color: #2d3748; }
    .zman-desc { font-size: 11px; color: #718096; }
    .zman-right { text-align: right; display: flex; flex-direction: column; align-items: flex-end; }
    .zman-time { font-size: 20px; font-weight: 700; color: #2c5282; font-family: "SF Mono", monospace; letter-spacing: -0.5px; line-height: 1; }
    .zman-time .sec { font-size: 12px; color: #a0aec0; }
    .zman-card-select { display: block; margin-top: 4px; font-size: 10px; background: #edf2f7; border: none; padding: 2px 6px; border-radius: 4px; color: #4a5568; font-weight: 600; appearance: none; }
    /* ------------------------------------------- */

    #center-marker {
        position: fixed; top: 50%; left: 50%; width: 16px; height: 16px;
        background: #2196F3; border: 3px solid #fff; border-radius: 50%;
        transform: translate(-50%, -50%); z-index: 20; box-shadow: 0 2px 6px rgba(0,0,0,0.4);
        pointer-events: none; display: none;
    }

    /* FLOATING PILL TOOLBAR */
    .floating-toolbar {
        position: fixed; bottom: 30px; left: 20px; right: 20px;
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
        border: 1px solid rgba(255,255,255,0.3);
        display: flex; justify-content: space-between; align-items: center;
        padding: 10px 15px;
        z-index: 1500;
        box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        border-radius: 40px; 
    }
    .nav-item {
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        border: none; background: none; color: #999;
        font-size: 10px; font-weight: 600; gap: 3px;
        flex: 1; cursor: pointer; transition: all 0.2s; position: relative;
    }
    .nav-item.active { color: var(--primary); transform: translateY(-2px); }
    .nav-item i { font-size: 24px; }
    
    #nav-toggle { font-weight: 800; color: var(--primary); }
    
    /* SETTINGS STYLES */
    .settings-card { background: #fff; border-radius: 16px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .settings-header { font-size: 34px; font-weight: 800; color: var(--primary); margin-top: 10px; margin-bottom: 20px; padding-left: 5px; }
    .input-group { margin-bottom: 15px; }
    .input-label { display: block; font-size: 12px; font-weight: 700; color: #666; margin-bottom: 5px; text-transform: uppercase; }
    .settings-input { width: 100%; padding: 12px; border: 1px solid #eee; border-radius: 12px; font-size: 16px; background: #fafafa; box-sizing: border-box; font-family: inherit; }
    .settings-input:focus { outline: none; border-color: var(--primary); background: #fff; }
    .settings-link { display: flex; align-items: center; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid #f0f0f0; color: #333; text-decoration: none; cursor: pointer; }
    .settings-link:last-child { border-bottom: none; }
    .settings-link-text { font-size: 16px; font-weight: 600; }

    /* CARDS */
    .minyan-card {
        background: #fff; border-radius: 12px; margin-bottom: 8px;
        display: flex; justify-content: space-between; align-items: stretch;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05); overflow: hidden; 
        height: 85px; 
        box-sizing: border-box;
    }
    .info-zone { 
        width: 60%; flex-basis: 60%; flex-shrink: 0;
        padding: 8px 12px; 
        cursor: pointer; 
        display: flex; flex-direction: column; justify-content: flex-start;
        min-width: 0; border-right: 1px solid #f0f0f0;
    }
    .map-zone { 
        width: 40%; flex-basis: 40%; flex-shrink: 0;
        position: relative; 
        cursor: pointer; background: #fafafa; 
        box-sizing: border-box; 
    }
    
    .shul-name { font-weight: 800; font-size: 17px; color: #333; line-height: 1.1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 2px; }
    .shul-address { font-size: 12px; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.2; }
    .shul-city { font-size: 11px; color: #999; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 4px; line-height: 1.2; }
    .nusach-tag-list { font-size: 10px; padding: 2px 8px; border-radius: 8px; display: inline-block; font-weight: 700; text-transform: uppercase; width: fit-content; }

    /* RIGHT SIDE LAYOUT - 40px BUFFER (To fix cutoff) */
    .tefillah-label { 
        position: absolute; top: 8px; right: 40px; text-align: right;
        font-size: 11px; font-weight: 900; text-transform: uppercase; letter-spacing: 0.5px; line-height: 1; color: #555; 
        margin: 0;
    } 
    .time-val-card { 
        position: absolute; top: calc(50% - 10px); right: 40px; transform: translateY(-50%);
        padding: 4px 8px; border-radius: 8px; font-weight: 800; font-size: 16px; white-space: nowrap;
    }
    .dist-row { 
        position: absolute; bottom: 8px; right: 40px;
        display: flex; align-items: center; justify-content: flex-end; gap: 6px; margin: 0;
    }
    .dist-label { font-size: 11px; font-weight: 800; color: #666; line-height: 1; }
    .map-circle { width: 28px; height: 28px; border-radius: 50%; background: #fff; display: flex; align-items: center; justify-content: center; border: 1px solid #eee; }
    .google-maps-icon { background: linear-gradient(135deg, #4285F4 25%, #34A853 25% 50%, #FBBC05 50% 75%, #EA4335 75%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 18px !important; font-weight: bold; }
    
    /* AD CARD */
    .ad-card {
        background: #fff; border-radius: 12px; margin-bottom: 8px;
        display: flex; align-items: center; justify-content: space-between;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05); overflow: hidden;
        min-height: 45px; padding: 0 15px; cursor: pointer; border-left: 5px solid var(--ad-border);
    }
    .ad-badge { 
        font-size: 10px; font-weight: 900; color: var(--ad-border); text-transform: uppercase; 
        letter-spacing: 1px; margin-right: 12px; background: var(--ad-bg); padding: 2px 6px; border-radius: 4px;
    }
    .ad-content { flex: 1; font-weight: 700; color: #444; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .ad-arrow { color: #ccc; }

    /* AD DRAWER */
    .ad-hero { width: 100%; height: 160px; background: #eee; border-radius: 12px; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; overflow: hidden; }
    .ad-hero img { width: 100%; height: 100%; object-fit: cover; }
    .ad-desc { font-size: 15px; color: #555; line-height: 1.5; margin-bottom: 20px; padding: 0 5px; }

    /* STYLES */
    .nusach-bg-Ashkenaz { background-color: var(--bg-Ashkenaz) !important; color: var(--text-Ashkenaz) !important; }
    .nusach-bg-Sefard { background-color: var(--bg-Sefard) !important; color: var(--text-Sefard) !important; }
    .nusach-bg-Ari { background-color: var(--bg-Ari) !important; color: var(--text-Ari) !important; }
    .nusach-bg-Edot-HaMizrach { background-color: var(--bg-Edot-HaMizrach) !important; color: var(--text-Edot-HaMizrach) !important; }
    .nusach-bg-Chabad { background-color: var(--bg-Chabad) !important; color: var(--text-Chabad) !important; }
    .nusach-bg-Other { background-color: var(--bg-Other) !important; color: var(--text-Other) !important; }

    .nusach-tag-drawer { font-size: 11px; padding: 3px 9px; border-radius: 12px; display: inline-block; font-weight: 700; text-transform: uppercase; width: fit-content; margin-top: 6px; }

    /* CHIP COLORS */
    .chip { padding: 6px 12px; border-radius: 15px; border: 1px solid #ddd; background: #fff; font-size: 12px; font-weight: 600; color: #444; cursor: pointer; transition: all 0.1s; }
    .chip.active { box-shadow: 0 2px 5px rgba(0,0,0,0.1); transform: scale(1.05); }

    .chip-Shacharis { border: 2px solid var(--color-Shacharis); color: var(--color-Shacharis); }
    .chip-Mincha { border: 2px solid var(--color-Mincha); color: var(--color-Mincha); }
    .chip-Maariv { border: 2px solid var(--color-Maariv); color: var(--color-Maariv); }
    .chip-Shacharis.active { background: var(--color-Shacharis); color: white; }
    .chip-Mincha.active { background: var(--color-Mincha); color: white; }
    .chip-Maariv.active { background: var(--color-Maariv); color: white; }

    .chip-Ashkenaz { background: var(--bg-Ashkenaz); color: var(--text-Ashkenaz); border: 1px solid var(--bg-Ashkenaz); }
    .chip-Sefard { background: var(--bg-Sefard); color: var(--text-Sefard); border: 1px solid var(--bg-Sefard); }
    .chip-Ari { background: var(--bg-Ari); color: var(--text-Ari); border: 1px solid var(--bg-Ari); }
    .chip-Edot-HaMizrach { background: var(--bg-Edot-HaMizrach); color: var(--text-Edot-HaMizrach); border: 1px solid var(--bg-Edot-HaMizrach); }
    .chip-Chabad { background: var(--bg-Chabad); color: var(--text-Chabad); border: 1px solid var(--bg-Chabad); }
    .chip-Ashkenaz.active { border: 2px solid var(--text-Ashkenaz); }
    .chip-Sefard.active { border: 2px solid var(--text-Sefard); }
    .chip-Ari.active { border: 2px solid var(--text-Ari); }
    .chip-Edot-HaMizrach.active { border: 2px solid var(--text-Edot-HaMizrach); }
    .chip-Chabad.active { border: 2px solid var(--text-Chabad); }

    /* MAP MARKERS */
    .custom-marker { 
        padding: 4px 9px; border-radius: 12px; font-size: 13px; font-weight: 800; 
        box-shadow: 0 3px 8px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; 
        position: relative; top: 10px; cursor: pointer; transition: transform 0.1s; background: #fff; 
    }
    .custom-marker::after { content: ''; position: absolute; bottom: -5px; left: 50%; transform: translateX(-50%); border-width: 5px 5px 0; border-style: solid; border-color: inherit transparent transparent transparent; }

    /* FILTER DRAWER */
    #filter-drawer {
        display: none; position: fixed; top: 80px; left: 12px; right: 12px;
        background: #fff; border-radius: 20px; padding: 15px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.25); z-index: 2000;
        max-width: 500px; margin: 0 auto;
    }
    .filter-section { margin-bottom: 15px; } 
    .filter-label { font-size: 10px; font-weight: 800; color: #bbb; text-transform: uppercase; margin-bottom: 5px; display: block; }
    .chip-group { display: flex; flex-wrap: wrap; gap: 6px; }
    
    .date-nav { display: flex; align-items: center; justify-content: space-between; background: #f5f5f5; padding: 8px; border-radius: 12px; }
    .date-btn { background: none; border: none; font-size: 24px; color: var(--primary); cursor: pointer; padding: 0 15px; display: flex; align-items: center; }
    .date-display-container { text-align: center; }
    .date-display { font-weight: 800; color: #333; font-size: 16px; line-height: 1.2; }
    .hebrew-date { font-weight: 600; color: var(--primary); font-size: 13px; opacity: 0.8; }

    .radius-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
    .radius-row input[type=range] { flex: 1; accent-color: var(--primary); }
    .radius-input { width: 50px; padding: 5px; border: 1px solid #ddd; border-radius: 8px; text-align: center; font-weight: bold; font-family: inherit; }

    .time-inputs-row { display: flex; gap: 8px; }
    .time-input { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 15px; text-align: center; font-family: inherit; font-size: 12px; font-weight: 600; }
    .action-btn { width: 100%; background: #eee; color: #333; border: none; padding: 10px; border-radius: 15px; font-size: 12px; font-weight: 700; cursor: pointer; margin-top: 6px; }
    .primary-action { background: var(--primary); color: white; }

    /* DETAILS DRAWER */
    #details-drawer {
        position: fixed; bottom: -100%; left: 10px; right: 10px; height: 75vh;
        background: #fff; border-radius: 25px; 
        z-index: 3000; margin-bottom: 15px;
        box-shadow: 0 5px 30px rgba(0,0,0,0.3); transition: transform 0.3s ease-out;
        padding: 0; display: flex; flex-direction: column;
    }
    #details-drawer.open { bottom: 0; transform: translateY(0); }
    
    .drawer-header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 1px solid #f0f0f0; }
    .drawer-title-container { flex: 1; padding-right: 10px; }
    .drawer-title { font-size: 18px; font-weight: 800; color: var(--primary); line-height: 1.1; margin-bottom: 2px; } 
    .drawer-address-locked { font-size: 13px; color: #777; margin: 0; font-weight: 500; }
    .drawer-city-locked { font-size: 12px; color: #999; margin: 0; }
    
    .drawer-actions { display: flex; gap: 12px; flex-shrink: 0; }
    .circle-action-btn { width: 40px; height: 40px; border-radius: 50%; background: #f0f0f0; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #555; }
    
    .drawer-body { flex: 1; overflow-y: auto; padding: 20px; }
    
    .drawer-top-info { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .rabbi-info { font-size: 15px; color: #555; font-weight: 600; display: flex; align-items: center; gap: 6px; text-align: right; }

    .schedule-section { margin-top: 15px; }
    .schedule-title { font-weight:800; font-size:15px; margin-bottom:10px; color:#333; border-bottom:1px solid #eee; padding-bottom:5px; }
    .schedule-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 14px; }
    .schedule-item { margin-bottom: 6px; }
    .schedule-day { font-weight: 700; color: #666; font-size: 12px; text-transform: uppercase; margin-bottom: 4px;}
    
    .contact-row { display: flex; gap: 8px; margin-top: 20px; flex-wrap: wrap; }
    .contact-btn { 
        background: #f5f5f5; border: 1px solid #ddd; 
        padding: 6px 12px; border-radius: 20px; 
        font-weight: 700; font-size: 11px; 
        text-align: center; text-decoration: none; color: #333; 
        display: flex; align-items: center; justify-content: center; gap: 4px; 
        white-space: nowrap; flex: none;
    }
    .contact-btn:active { background: #eee; }
    .contact-btn.disabled { opacity: 0.5; cursor: default; background: #eee; color: #aaa; pointer-events: none; }
    .missing-info-text { font-size: 11px; color: #999; text-align: center; margin-top: 8px; font-style: italic; width: 100%; }

    .drawer-nav-row { 
        display: flex; justify-content: space-between; align-items: center; 
        margin-top: 5px; background: #fafafa; 
        padding: 8px 12px; 
        border-radius: 12px; border: 1px solid #f0f0f0; 
    }
    .drawer-nav-left { display: flex; align-items: center; gap: 8px; }
    .static-chip { padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 700; background: #fff; display: inline-block; }
    .map-circle-lg { width: 32px; height: 32px; border-radius: 50%; background: #fff; display: flex; align-items: center; justify-content: center; border: 1px solid #eee; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer; flex-shrink: 0; }
    .google-maps-icon-lg { font-size: 20px !important; }

    /* COMING SOON OVERLAY */
    .coming-soon-overlay {
        position: fixed; bottom: 120px; left: 50%; transform: translateX(-50%);
        background: rgba(0,0,0,0.8); color: #fff; padding: 12px 24px; border-radius: 30px;
        font-weight: 700; font-size: 14px; z-index: 2000;
        display: none; animation: fadeInOut 2s forwards; pointer-events: none;
    }
    @keyframes fadeInOut { 0% {opacity:0; bottom:110px;} 20% {opacity:1; bottom:120px;} 80% {opacity:1; bottom:120px;} 100% {opacity:0; bottom:130px;} }

    .fab-location {
        position: fixed; bottom: 100px; right: 20px; width: 50px; height: 50px;
        background: #fff; border-radius: 50%; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        border: none; color: var(--primary); display: flex; align-items: center; justify-content: center; z-index: 900;
    }

    .empty-state { text-align: center; color: #555; margin-top: 50px; padding: 0 30px; line-height: 1.6; }
    .empty-state strong { color: var(--primary); font-size: 1.2em; }
    
    /* TIME PILLS (NUSACH COLORED) */
    .time-pill {
        display: inline-block; padding: 4px 12px; border-radius: 14px;
        font-weight: 800; font-size: 16px; white-space: nowrap; margin: 2px;
        border: 1px solid rgba(0,0,0,0.08); 
    }
</style>
</head>
<body>

    <div id="sticky-header" class="sticky-header"></div>

    <div class="floating-header" id="filter-header">
        <div class="search-container" onclick="event.stopPropagation()">
            <div id="autocomplete-container" style="flex:1; height:100%;"></div>
        </div>
        <button class="circle-btn" onclick="toggleFilters(); event.stopPropagation()">
            <i class="material-icons">tune</i>
        </button>
    </div>

    <div class="status-area">
        <div id="status-pill"></div>
        <div id="count-pill"></div>
        <div id="map-radius-pill"></div>
    </div>

    <div id="center-marker"></div>
    <div id="scrim" onclick="closeDetails()"></div>

    <div id="coming-soon-toast" class="coming-soon-overlay">Feature Coming Soon</div>

    <div id="details-drawer">
        <div class="drawer-header">
            <div class="drawer-title-container">
                <div class="drawer-title" id="drawer-title"></div>
                <div class="drawer-address-locked" id="drawer-address-line1"></div>
                <div class="drawer-city-locked" id="drawer-address-line2"></div>
            </div>
            <div class="drawer-actions">
                <button class="circle-action-btn" id="bookmark-btn" onclick="toggleFavorite()">
                    <i class="material-icons" id="bookmark-icon" style="font-size:20px;">bookmark_border</i>
                </button>
                <button class="circle-action-btn" id="share-btn">
                    <i class="material-icons" style="font-size:20px;">ios_share</i>
                </button>
                <button class="circle-action-btn" onclick="closeDetails()">
                    <i class="material-icons" style="font-size:20px;">close</i>
                </button>
            </div>
        </div>
        <div id="drawer-content" class="drawer-body"></div>
    </div>

    <div id="filter-drawer">
        <div class="filter-section">
            <label class="filter-label">Date</label>
            <div class="date-nav">
                <button class="date-btn" onclick="changeDate(-1)"><i class="material-icons">chevron_left</i></button>
                <div class="date-display-container">
                    <div class="date-display" id="date-display">Today</div>
                    <div class="hebrew-date" id="hebrew-date"></div>
                </div>
                <button class="date-btn" onclick="changeDate(1)"><i class="material-icons">chevron_right</i></button>
            </div>
        </div>

        <div class="filter-section">
            <label class="filter-label">Radius (Miles)</label>
            <div class="radius-row">
                <input type="range" min="0.1" max="99" step="0.1" value="20" id="radius-slider" oninput="manualRadiusUpdate(this.value)">
                <input type="number" id="radius-input" class="radius-input" value="20" onchange="manualRadiusUpdate(this.value)">
            </div>
            <div class="chip-group">
                <div class="chip" onclick="manualRadiusUpdate(1)">1</div>
                <div class="chip" onclick="manualRadiusUpdate(2)">2</div>
                <div class="chip" onclick="manualRadiusUpdate(3)">3</div>
                <div class="chip" onclick="manualRadiusUpdate(5)">5</div>
                <div class="chip" onclick="manualRadiusUpdate(20)">20</div>
                <div class="chip" onclick="manualRadiusUpdate(99)">99</div>
            </div>
        </div>
        
        <div class="filter-section">
            <label class="filter-label">Sort By</label>
            <div class="chip-group">
                <div class="chip active" onclick="setFilter('sort', 'time_asc', this)">Earliest</div>
                <div class="chip" onclick="setFilter('sort', 'distance', this)">Distance</div>
            </div>
        </div>

        <div class="filter-section">
            <label class="filter-label">Tefillah</label>
            <div class="chip-group">
                <div class="chip active" onclick="setFilter('tefillah', '', this)">All</div>
                <div class="chip chip-Shacharis" onclick="setFilter('tefillah', 'Shacharis', this)">Shacharis</div>
                <div class="chip chip-Mincha" onclick="setFilter('tefillah', 'Mincha', this)">Mincha</div>
                <div class="chip chip-Maariv" onclick="setFilter('tefillah', 'Maariv', this)">Maariv</div>
            </div>
        </div>

        <div class="filter-section">
            <label class="filter-label">Nusach</label>
            <div class="chip-group" id="nusach-group">
                <div class="chip active" onclick="setFilter('nusach', '', this)">All</div>
            </div>
        </div>

        <div class="filter-section">
            <label class="filter-label">Time Range</label>
            <div class="time-inputs-row">
                <input type="time" id="time-start" class="time-input" onchange="onStartTimeChange()">
                <input type="time" id="time-end" class="time-input" onchange="applyFilters()">
            </div>
            <div style="display:flex; gap:6px;">
                <button class="action-btn" onclick="setAllDay()">All Day</button>
                <button class="action-btn primary-action" onclick="setNextHour()">Next Hour</button>
            </div>
        </div>
        <button class="action-btn primary-action" onclick="toggleFilters()" style="margin-top:10px;">Done</button>
    </div>

    <div id="list-view"></div>
    <div id="map-view"></div>
    
    <div id="zmanim-view">
        <div class="zman-sticky-header">
            <div class="zman-top-row">
                <h1 class="zman-app-title">Zmanim</h1>
                <div class="zman-loc-btn" id="zman-loc-label">Lakewood, NJ</div>
            </div>
            <div class="zman-date-nav">
                <button class="zman-nav-btn" onclick="changeDate(-1)">&#8249;</button>
                <div class="zman-date-display">
                    <span class="zman-civ-date" id="zman-civ-date"></span>
                    <span class="zman-heb-date" id="zman-heb-date"></span>
                </div>
                <button class="zman-nav-btn" onclick="changeDate(1)">&#8250;</button>
            </div>
        </div>
        <div class="zman-info-bar">
            <div class="zman-info-pill"><span>Day</span><div id="zman-day-name"></div></div>
            <div class="zman-info-pill"><span>Daf Yomi</span><div id="zman-daf-name"></div></div>
        </div>
        <ul class="zmanim-list" id="zmanimList" style="margin-bottom:100px;"></ul>
    </div>
    
    <div id="settings-view">
        <div class="settings-header">Settings</div>
        
        <div class="settings-card">
            <div class="input-group">
                <label class="input-label">Name</label>
                <input type="text" class="settings-input" id="profile-name" placeholder="Your Name" oninput="saveProfile()">
            </div>
            <div class="input-group">
                <label class="input-label">Phone</label>
                <input type="tel" class="settings-input" id="profile-phone" placeholder="Phone Number" oninput="saveProfile()">
            </div>
        </div>

        <div class="settings-card" style="padding: 0 20px;">
            <a class="settings-link" onclick="showComingSoon()">
                <span class="settings-link-text">Privacy Policy</span>
                <i class="material-icons">chevron_right</i>
            </a>
            <a class="settings-link" onclick="showComingSoon()">
                <span class="settings-link-text">Rate App</span>
                <i class="material-icons">star_rate</i>
            </a>
            <a class="settings-link" onclick="shareApp()">
                <span class="settings-link-text">Share App</span>
                <i class="material-icons">ios_share</i>
            </a>
            <a class="settings-link" href="mailto:support@shultime.com">
                <span class="settings-link-text">Contact Us</span>
                <i class="material-icons">email</i>
            </a>
            <a class="settings-link" href="mailto:support@shultime.com?subject=Support">
                <span class="settings-link-text">Support</span>
                <i class="material-icons">help_outline</i>
            </a>
        </div>
    </div>
    
    <button class="fab-location" onclick="useMyLocation()">
        <i class="material-icons" style="font-size:24px;">my_location</i>
    </button>

    <div class="floating-toolbar">
        <button class="nav-item" id="nav-recent" onclick="switchTab('recent')">
            <i class="material-icons">history</i>Recent
        </button>
        <button class="nav-item" id="nav-zmanim" onclick="switchTab('zmanim')">
            <i class="material-icons">access_time</i>Zmanim
        </button>
        <button class="nav-item active" id="nav-toggle" onclick="toggleView()">
            <i class="material-icons" id="nav-toggle-icon">list</i><span id="nav-toggle-text">List</span>
        </button>
        <button class="nav-item" id="nav-saved" onclick="switchTab('saved')">
            <i class="material-icons">bookmark_border</i>Saved
        </button>
        <button class="nav-item" id="nav-settings" onclick="switchTab('settings')">
            <i class="material-icons">settings</i>Settings
        </button>
    </div>

    <script>
        const ADS_DB = [
          { "id": 1, "name": "The Hat Box", "address": "470 Oberlin Ave South, Lakewood, NJ 08701", "phone": "732-961-2262", "website": "https://hatboxmenswear.com", "description": "The finest selection of hats and menswear.", "image_url": "https://via.placeholder.com/600x300/0D2B4F/FFFFFF?text=The+Hat+Box" },
          { "id": 2, "name": "Seasons Supermarket", "address": "711 Cedarbridge Ave, Lakewood, NJ 08701", "phone": "732-813-7700", "website": "https://www.seasonskosher.com", "description": "Premium kosher supermarket.", "image_url": "https://via.placeholder.com/600x300/2E7D32/FFFFFF?text=Seasons+Supermarket" },
          { "id": 3, "name": "Aurum Jewelers USA", "address": "Lakewood, NJ (Online & Appt Only)", "phone": "1-323-316-8676", "website": "https://aurumjewelersusa.com", "description": "Exquisite jewelry for every occasion.", "image_url": "https://via.placeholder.com/600x300/F57F17/FFFFFF?text=Aurum+Jewelers" }
        ];

        let map, allMinyanim = [], processedMinyanim = [], ads = ADS_DB, searchCenter = null, currentRadius = 20;
        let filters = { sort: 'time_asc', tefillah: '', nusach: '' };
        let selectedShul = null;
        let markers = [];
        let isProgrammaticMove = false;
        let allNusachs = new Set();
        let fullDbData = [];
        let currentFilterDate = new Date();
        let isFirstIdle = true; 
        let currentTab = 'map';
        // Zmanim Location Defaults
        let zmanLoc = { lat: 40.096, lng: -74.222, name: 'Lakewood, NJ', elev: 30, tz: 'America/New_York' };

        // --- DAF ENGINE ---
        const DafEngine = {
            masechtot: [{n:"Berachos",p:63},{n:"Shabbos",p:156},{n:"Eruvin",p:104},{n:"Pesachim",p:120},{n:"Shekalim",p:21},{n:"Yoma",p:87},{n:"Sukkah",p:55},{n:"Beitzah",p:39},{n:"Rosh Hashana",p:34},{n:"Taanis",p:30},{n:"Megillah",p:31},{n:"Moed Katan",p:28},{n:"Chagigah",p:26},{n:"Yevamos",p:121},{n:"Kesubos",p:111},{n:"Nedarim",p:90},{n:"Nazir",p:65},{n:"Sotah",p:48},{n:"Gittin",p:89},{n:"Kiddushin",p:81},{n:"Bava Kamma",p:118},{n:"Bava Metzia",p:118},{n:"Bava Basra",p:175},{n:"Sanhedrin",p:112},{n:"Makkos",p:23},{n:"Shevuos",p:48},{n:"Avodah Zarah",p:75},{n:"Horayos",p:13},{n:"Zevachim",p:119},{n:"Menachos",p:109},{n:"Chullin",p:141},{n:"Bechoros",p:60},{n:"Arachin",p:33},{n:"Temurah",p:33},{n:"Kerisus",p:27},{n:"Meilah",p:21},{n:"Kinnim",p:4},{n:"Tamid",p:9},{n:"Middos",p:4},{n:"Niddah",p:72}],
            get: (date) => {
                const start = new Date(2020, 0, 5); const diff = Math.floor((date - start) / 86400000); if(diff < 0) return "";
                let count = diff; for(let m of DafEngine.masechtot) { if(count < m.p) return `${m.n} ${count + 2}`; count -= m.p; } return "";
            }
        };

        // --- SOLAR MATH (NOAA) ---
        const Solar = {
            rad: d => d * (Math.PI/180), deg: r => r * (180/Math.PI),
            calc: (date, lat, lng, elev) => {
                // Approximate solar Calc
                const n = (Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()) - 946728000000) / 86400000.0;
                const L = (280.460 + 0.9856474 * n) % 360;
                const g = (357.528 + 0.9856003 * n) % 360;
                const lambda = L + 1.915 * Math.sin(Solar.rad(g)) + 0.020 * Math.sin(Solar.rad(2 * g));
                const epsilon = 23.439 - 0.0000004 * n;
                const sinDelta = Math.sin(Solar.rad(epsilon)) * Math.sin(Solar.rad(lambda));
                const cosDelta = Math.sqrt(1 - sinDelta * sinDelta);
                const y = Math.tan(Solar.rad(epsilon/2)) * Math.tan(Solar.rad(epsilon/2));
                const E_rad = y * Math.sin(2 * Solar.rad(L)) - 2 * 0.0167 * Math.sin(Solar.rad(g)) + 4 * 0.0167 * y * Math.sin(Solar.rad(g)) * Math.cos(2 * Solar.rad(L)) - 0.5 * y * y * Math.sin(4 * Solar.rad(L)) - 1.25 * 0.0167 * 0.0167 * Math.sin(2 * Solar.rad(g));
                const E_min = Solar.deg(E_rad) * 4;
                const noonUTC = 720 - (4 * lng) - E_min;
                const noonMs = Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()) + (noonUTC * 60000);
                
                const getEvent = (zenithDeg, rise) => {
                    const alt = 90 - zenithDeg;
                    const top = Math.sin(Solar.rad(alt)) - Math.sin(Solar.rad(lat)) * sinDelta;
                    const bot = Math.cos(Solar.rad(lat)) * cosDelta;
                    const cosH = top / bot;
                    if(cosH > 1 || cosH < -1) return null;
                    const H_min = Solar.deg(Math.acos(cosH)) * 4; 
                    return rise ? noonMs - (H_min * 60000) : noonMs + (H_min * 60000);
                };
                return {
                    noon: noonMs,
                    alot: getEvent(90+16.1, true),
                    sunrise: getEvent(90.833, true),
                    sunset: getEvent(90.833, false),
                    tzais: getEvent(90+8.5, false)
                };
            }
        };

        document.addEventListener("DOMContentLoaded", async () => {
            document.getElementById('time-start').value = "00:00";
            document.getElementById('time-end').value = "23:59";
            updateDateDisplay();
            renderWelcome();
            loadProfile();

            // SCROLL LISTENER FOR STICKY HEADER
            document.getElementById('list-view').addEventListener('scroll', function() {
                const header = document.getElementById('sticky-header');
                if(this.scrollTop > 40 && (currentTab === 'recent' || currentTab === 'saved')) {
                    header.classList.add('visible');
                    header.innerText = currentTab === 'recent' ? "Recent" : "Saved";
                } else {
                    header.classList.remove('visible');
                }
            });

            try {
                const res = await fetch("database.json");
                if (!res.ok) throw new Error("DB Fetch Failed");
                fullDbData = await res.json();
                processMinyanim(fullDbData);
                populateNusachFilter();
            } catch(e) { console.error("Data Load Error", e); }
            
            initPullToDismiss();
        });

        // --- NAVIGATION LOGIC ---
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
            const list = document.getElementById('list-view');
            const zmanim = document.getElementById('zmanim-view');
            const settings = document.getElementById('settings-view');
            const sticky = document.getElementById('sticky-header');
            sticky.classList.remove('visible'); // Reset
            
            if(tab !== 'map' && tab !== 'list') {
                document.getElementById(`nav-${tab}`).classList.add('active');
                document.getElementById('filter-header').style.display = 'none'; 
                document.getElementById('status-pill').style.display = 'none';
                document.getElementById('count-pill').style.display = 'none';
                document.getElementById('map-radius-pill').style.display = 'none';
                
                // Remove dead space padding
                list.style.paddingTop = '20px';
                zmanim.style.paddingTop = '0px'; // Zmanim handles its own header
                settings.style.paddingTop = '20px';
            } else {
                document.getElementById('nav-toggle').classList.add('active');
                document.getElementById('filter-header').style.display = 'flex';
                // Add search padding
                list.style.paddingTop = '110px';
            }

            // Hide All
            document.getElementById('map-view').style.display = 'none';
            list.style.display = 'none';
            zmanim.style.display = 'none';
            settings.style.display = 'none';
            document.getElementById('center-marker').style.display = 'none';
            document.querySelector('.fab-location').style.display = 'none'; 

            if(tab === 'map') {
                document.getElementById('map-view').style.display = 'block';
                document.getElementById('center-marker').style.display = 'block';
                document.querySelector('.fab-location').style.display = 'flex';
                updateToggleButton('List', 'list');
                applyFilters(); 
            }
            else if(tab === 'list') {
                list.style.display = 'block';
                document.querySelector('.fab-location').style.display = 'flex';
                updateToggleButton('Map', 'map');
                applyFilters();
            }
            else if(tab === 'recent') {
                list.style.display = 'block';
                updateToggleButton('Map', 'map'); 
                renderRecents();
            }
            else if(tab === 'saved') {
                list.style.display = 'block';
                updateToggleButton('Map', 'map');
                renderFavorites();
            }
            else if(tab === 'zmanim') {
                zmanim.style.display = 'block';
                renderZmanim();
            }
            else if(tab === 'settings') {
                settings.style.display = 'block';
            }
        }

        function toggleView() {
            document.getElementById('filter-drawer').style.display = 'none';
            const mapVisible = document.getElementById('map-view').style.display === 'block';
            if (mapVisible) { switchTab('list'); } else { switchTab('map'); }
        }

        function updateToggleButton(text, iconName) {
            document.getElementById('nav-toggle-icon').innerText = iconName;
            document.getElementById('nav-toggle-text').innerText = text;
        }

        // --- ZMANIM (LOCAL CALCULATION) ---
        function renderZmanim() {
            // Update Zmanim Header
            document.getElementById('zman-loc-label').innerText = zmanLoc.name;
            const options = { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' };
            document.getElementById('zman-civ-date').innerText = currentFilterDate.toLocaleDateString('en-US', options);
            
            // Hebrew Date
            try {
                const hDate = new Intl.DateTimeFormat('en-US-u-ca-hebrew', {day:'numeric', month:'long', year:'numeric'}).format(currentFilterDate);
                document.getElementById('zman-heb-date').innerText = hDate;
            } catch(e) { document.getElementById('zman-heb-date').innerText = ""; }

            document.getElementById('zman-day-name').innerText = currentFilterDate.toLocaleDateString('en-US', {weekday:'long'});
            document.getElementById('zman-daf-name').innerText = DafEngine.get(currentFilterDate);

            // Calculate Solar
            const data = Solar.calc(currentFilterDate, zmanLoc.lat, zmanLoc.lng, zmanLoc.elev);
            
            const fmt = (ms) => {
                if(!ms) return "--:--";
                return new Date(ms).toLocaleTimeString('en-US', {hour:'numeric',minute:'2-digit', timeZone: zmanLoc.tz});
            };
            
            // Simple List based on your provided structure
            const zList = [
                { l: "Alos Hashachar (16.1°)", t: data.alot },
                { l: "Sunrise (Netz)", t: data.sunrise },
                { l: "Chatzos", t: data.noon },
                { l: "Sunset (Shkia)", t: data.sunset },
                { l: "Tzais (8.5°)", t: data.tzais }
            ];

            let html = "";
            zList.forEach(z => {
                html += `<li class="zman-card">
                    <div class="zman-left"><span class="zman-label">${z.l}</span></div>
                    <div class="zman-right"><span class="zman-time">${fmt(z.t)}</span></div>
                </li>`;
            });
            document.getElementById('zmanimList').innerHTML = html;
        }

        // --- SETTINGS & PROFILE ---
        function saveProfile() {
            const name = document.getElementById('profile-name').value;
            const phone = document.getElementById('profile-phone').value;
            localStorage.setItem('shultime_profile', JSON.stringify({ name, phone }));
        }
        function loadProfile() {
            const p = JSON.parse(localStorage.getItem('shultime_profile') || "{}");
            if(p.name) document.getElementById('profile-name').value = p.name;
            if(p.phone) document.getElementById('profile-phone').value = p.phone;
        }
        function shareApp() {
            if(navigator.share) navigator.share({title: 'ShulTime', text: 'Find Minyanim near you!', url: window.location.href});
            else alert("Share feature not supported on this browser.");
        }

        // --- LOCAL STORAGE & LISTS ---
        function addToRecents(m) {
            let recents = JSON.parse(localStorage.getItem("shultime_recents") || "[]");
            recents = recents.filter(id => id !== m.id);
            recents.unshift(m.id);
            if(recents.length > 20) recents.pop(); 
            localStorage.setItem("shultime_recents", JSON.stringify(recents));
        }

        function toggleFavorite() {
            if(!selectedShul) return;
            let favs = JSON.parse(localStorage.getItem("shultime_favs") || "[]");
            const index = favs.indexOf(selectedShul.id);
            const icon = document.getElementById("bookmark-icon");
            if (index > -1) { favs.splice(index, 1); icon.innerText = "bookmark_border"; } 
            else { favs.push(selectedShul.id); icon.innerText = "bookmark"; }
            localStorage.setItem("shultime_favs", JSON.stringify(favs));
        }

        function checkFavoriteStatus(id) {
            let favs = JSON.parse(localStorage.getItem("shultime_favs") || "[]");
            const icon = document.getElementById("bookmark-icon");
            icon.innerText = favs.includes(id) ? "bookmark" : "bookmark_border";
        }

        function renderFavorites() {
            let favs = JSON.parse(localStorage.getItem("shultime_favs") || "[]");
            const uniqueResults = []; const seen = new Set();
            processedMinyanim.forEach(m => {
                if(favs.includes(m.id) && !seen.has(m.id)) { uniqueResults.push(m); seen.add(m.id); }
            });
            const list = document.getElementById('list-view');
            
            if(uniqueResults.length === 0) {
                list.innerHTML = '<div class="list-page-header">Saved</div><div class="empty-state">No saved shuls.</div>';
            } else {
                list.innerHTML = '<div class="list-page-header">Saved</div>'; 
                renderListCards(uniqueResults, list); 
            }
        }

        function renderRecents() {
            let recents = JSON.parse(localStorage.getItem("shultime_recents") || "[]");
            const uniqueResults = []; const seen = new Set();
            recents.forEach(id => {
                const match = processedMinyanim.find(r => r.id === id);
                if(match && !seen.has(id)) { uniqueResults.push(match); seen.add(id); }
            });
            const list = document.getElementById('list-view');
            
            if(uniqueResults.length === 0) {
                list.innerHTML = '<div class="list-page-header">Recent</div><div class="empty-state">No recent activity.</div>';
            } else {
                list.innerHTML = '<div class="list-page-header">Recent</div>'; 
                renderListCards(uniqueResults, list); 
            }
        }

        // Helper to render cards without wiping innerHTML
        function renderListCards(results, container) {
            results.forEach((m) => {
                let nCls = `nusach-bg-${(m.nusach || 'Other').replace(/\s+/g, '-')}`;
                let nusachTagClass = `nusach-bg-${(m.nusach || 'Other').replace(/\s+/g, '-')}`;
                const link = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(m.name + " " + m.address)}`;
                
                const card = document.createElement("div");
                card.className = "minyan-card";
                
                let rightSide = (m.timeValue === 9999) 
                    ? `<div class="map-zone" onclick="window.open('${link}','_blank')">
                        <div class="map-footer"><div class="dist-label">${m.distance ? m.distance.toFixed(1) : '0.0'}mi</div><div class="map-circle"><i class="material-icons google-maps-icon">place</i></div></div></div>`
                    : `<div class="map-zone" onclick="window.open('${link}','_blank')">
                        <div class="tefillah-label">${m.tefillah}</div>
                        <div class="time-val-card ${nCls}">${m.timeDisplay}</div>
                        <div class="dist-row"><span class="dist-label">${m.distance ? m.distance.toFixed(1) : '0.0'}mi</span><div class="map-circle"><i class="material-icons google-maps-icon">place</i></div></div>
                    </div>`;

                card.innerHTML = `
                    <div class="info-zone" onclick='openDetails(${JSON.stringify(m).replace(/'/g, "'")})'>
                        <div class="shul-name">${m.name}</div>
                        <div class="shul-address">${m.address}</div>
                        <div class="shul-city">${m.city || ''}, ${m.state || ''} ${m.zip || ''}</div>
                        <div class="nusach-tag-list ${nusachTagClass}">${m.nusach}</div>
                    </div>
                    ${rightSide}`;
                container.appendChild(card);
            });
        }

        async function updateMapMarkers(results) {
            if (!map) return;
            const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");
            markers.forEach(m => m.map = null); markers = [];
            const groups = {};
            results.forEach(r => {
                const key = r.lat + "," + r.lng;
                if (!groups[key] || r.timeValue < groups[key].timeValue) groups[key] = r;
            });
            Object.values(groups).forEach(m => {
                const pinDiv = document.createElement("div");
                let nCls = `nusach-bg-${(m.nusach || 'Other').replace(/\s+/g, '-')}`;
                pinDiv.className = `custom-marker ${nCls}`;
                pinDiv.textContent = (m.timeValue === 9999) ? "None" : `${m.timeDisplay}`; 
                const marker = new AdvancedMarkerElement({
                    map: map, position: { lat: m.lat, lng: m.lng },
                    content: pinDiv, title: m.name
                });
                marker.element.addEventListener("click", () => openDetails(m));
                markers.push(marker);
            });
        }

        function onMapIdle() {
            if (isProgrammaticMove) { isProgrammaticMove = false; return; }
            if(!map) return;
            if (isFirstIdle) { isFirstIdle = false; return; }
            const center = map.getCenter();
            const bounds = map.getBounds();
            if(!center || !bounds) return;
            searchCenter = { lat: center.lat(), lng: center.lng() };
            
            // Sync Zmanim Location
            zmanLoc.lat = searchCenter.lat;
            zmanLoc.lng = searchCenter.lng;
            zmanLoc.name = "Map Location"; // Simplified

            document.getElementById("status-pill").innerText = `Near: Map Center`;
            const ne = bounds.getNorthEast();
            const r = getDistance(center.lat(), center.lng(), ne.lat(), ne.lng());
            
            document.getElementById("radius-input").value = r.toFixed(1);
            document.getElementById("radius-slider").value = r.toFixed(1);
            document.getElementById("map-radius-pill").innerText = `Radius: ${r.toFixed(1)} mi`;
            currentRadius = r;
            applyFilters();
        }

        function formatListPills(list, nusach) {
            if(!list || list.length === 0) return 'None';
            let nCls = `nusach-bg-${(nusach || 'Other').replace(/\s+/g, '-')}`;
            return list.map(t => {
                let clean = t.split(' ')[0];
                let [h, m] = clean.split(':').map(Number);
                if(isNaN(h)) return t;
                let formatted = formatTime(h, m || 0);
                return `<span class="time-pill ${nCls}" style="border:1px solid #ddd; font-size:14px;">${formatted}</span>`;
            }).join(" ");
        }

        function openDetails(m) {
            selectedShul = m;
            addToRecents(m);
            checkFavoriteStatus(m.id);
            const godavenId = m.godaven_link ? m.godaven_link.split('/').pop() : m.id;
            const link = `https://www.godaven.com/shul-details/${godavenId}`;
            const nCls = `nusach-bg-${(m.nusach || 'Other').replace(/\s+/g, '-')}`;
            document.getElementById("drawer-title").innerText = m.name;
            document.getElementById("drawer-address-line1").innerText = m.address; 
            document.getElementById("drawer-address-line2").innerText = `${m.city}, ${m.state} ${m.zip}`; 
            
            let rabbiText = m.rabbi ? `<i class="material-icons" style="font-size:16px;">person</i> ${m.rabbi}` : '';
            let nusachTag = `<span class="nusach-tag-drawer ${nCls}" style="margin:0;">${m.nusach}</span>`;
            
            let tefillahChipClass = `chip-${m.tefillah}`;
            let timePillClass = `nusach-bg-${(m.nusach || 'Other').replace(/\s+/g, '-')}`;
            
            const shareBtn = document.getElementById("share-btn");
            shareBtn.onclick = () => shareShul(m);

            let phoneBtn = m.phone ? `<a href="tel:${m.phone}" class="contact-btn"><i class="material-icons" style="font-size:14px">call</i> Call</a>` : `<div class="contact-btn disabled"><i class="material-icons" style="font-size:14px">call</i> Call</div>`;
            let emailBtn = m.email ? `<a href="mailto:${m.email}" class="contact-btn"><i class="material-icons" style="font-size:14px">email</i> Email</a>` : `<div class="contact-btn disabled"><i class="material-icons" style="font-size:14px">email</i> Email</div>`;
            let goDavenBtn = `<a href="${link}" target="_blank" rel="noopener noreferrer" class="contact-btn"><i class="material-icons" style="font-size:14px">open_in_new</i> GoDaven</a>`;
            let missingInfoText = (!m.phone || !m.email) ? `<div class="missing-info-text">Please update GoDaven as we don’t have this information</div>` : '';

            document.getElementById("drawer-content").innerHTML = `
                <div class="drawer-top-info">${nusachTag}${rabbiText}</div>
                <div class="drawer-nav-row">
                    <div class="drawer-nav-left"><span class="static-chip ${tefillahChipClass}">${m.tefillah}</span><span class="time-pill ${timePillClass}">${m.timeDisplay}</span></div>
                    <div style="display:flex; align-items:center; gap:8px;"><div style="font-size:14px; font-weight:700; color:#666;">${m.distance.toFixed(1)}mi</div><div class="map-circle-lg" onclick="window.open('https://www.google.com/maps/dir/?api=1&destination=${m.lat},${m.lng}','_blank')"><i class="material-icons google-maps-icon google-maps-icon-lg">place</i></div></div>
                </div>
                <div class="contact-row">${phoneBtn}${emailBtn}${goDavenBtn}</div>${missingInfoText}
                <div class="schedule-section">
                    <div class="schedule-title">Weekday Schedule</div>
                    <div class="schedule-grid">
                        <div class="schedule-item"><div class="schedule-day">Shacharis Sun</div>${formatListPills(m.shacharis?.sun, m.nusach)}</div>
                        <div class="schedule-item"><div class="schedule-day">Shacharis M/Th</div>${formatListPills(m.shacharis?.mon_thu, m.nusach)}</div>
                        <div class="schedule-item"><div class="schedule-day">Shacharis T/W/F</div>${formatListPills(m.shacharis?.tue_wed_fri, m.nusach)}</div>
                        <div class="schedule-item"><div class="schedule-day">Mincha</div>${formatListPills(m.mincha?.week, m.nusach)}</div>
                        <div class="schedule-item"><div class="schedule-day">Maariv</div>${formatListPills(m.maariv?.week, m.nusach)}</div>
                    </div>
                </div>`;
            const drawer = document.getElementById("details-drawer");
            drawer.classList.add("open");
            drawer.style.transform = "translateY(0)";
            document.getElementById("scrim").style.display = "block";
        }

        function openAdDetails(ad) {
            document.getElementById("drawer-title").innerText = ad.name;
            document.getElementById("drawer-address-line1").innerText = ""; 
            document.getElementById("drawer-address-line2").innerText = ""; 
            const shareBtn = document.getElementById("share-btn");
            shareBtn.onclick = () => { if(navigator.share) navigator.share({title: ad.name, text: `Check out ${ad.name} on ShulTime!`, url: ad.website}); };
            let phoneBtn = ad.phone ? `<a href="tel:${ad.phone}" class="contact-btn"><i class="material-icons" style="font-size:14px">call</i> Call</a>` : '';
            let webBtn = ad.website ? `<a href="${ad.website}" target="_blank" class="contact-btn"><i class="material-icons" style="font-size:14px">public</i> Website</a>` : '';
            let mapBtn = `<a href="http://maps.google.com/?q=${encodeURIComponent(ad.address)}" target="_blank" class="contact-btn"><i class="material-icons" style="font-size:14px">place</i> Map</a>`;
            document.getElementById("drawer-content").innerHTML = `<div class="ad-hero"><img src="${ad.image_url}" alt="${ad.name}"></div><div class="ad-desc">${ad.description}</div><p class="address-info" style="margin-top:0;">${ad.address}</p><div class="contact-row">${phoneBtn}${webBtn}${mapBtn}</div>`;
            const drawer = document.getElementById("details-drawer");
            drawer.classList.add("open");
            drawer.style.transform = "translateY(0)";
            document.getElementById("scrim").style.display = "block";
        }

        async function shareShul(m) {
            if(!m) return;
            const godavenId = m.godaven_link ? m.godaven_link.split('/').pop() : m.id;
            const link = `https://www.godaven.com/shul-details/${godavenId}`;
            const text = `Shared by ShulTime:\n\n${m.name}\n${m.address}\n\nNusach: ${m.nusach}\nLink: ${link}`;
            if(navigator.share) { try { await navigator.share({ title: m.name, text: text, url: link }); } catch(e) { console.log('Share failed', e); } } else { navigator.clipboard.writeText(text + "\n" + link); alert("Copied to clipboard!"); }
        }

        function closeDetails() {
            const drawer = document.getElementById("details-drawer");
            drawer.classList.remove("open");
            drawer.style.transform = "translateY(100%)";
            document.getElementById("scrim").style.display = "none";
        }

        function initPullToDismiss() {}

        function toggleFilters() {
            const d = document.getElementById('filter-drawer');
            d.style.display = (d.style.display==='block') ? 'none' : 'block';
        }

        function setFilter(type, val, btn) {
            filters[type] = val;
            const group = btn.parentElement;
            group.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
            btn.classList.add('active');
            applyFilters();
        }

        function setAllDay() { document.getElementById('time-start').value = "00:00"; document.getElementById('time-end').value = "23:59"; applyFilters(); }
        
        function setNextHour() {
            const now = new Date(); const pad = n => String(n).padStart(2,'0');
            document.getElementById('time-start').value = `${pad(now.getHours())}:${pad(now.getMinutes())}`;
            const next = new Date(now.getTime() + 60*60*1000);
            document.getElementById('time-end').value = `${pad(next.getHours())}:${pad(next.getMinutes())}`;
            applyFilters();
        }

        function onStartTimeChange() {
            const [h,m] = document.getElementById('time-start').value.split(':').map(Number);
            let endH = h + 1; if(endH > 23) endH = 23;
            document.getElementById('time-end').value = `${String(endH).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
            applyFilters();
        }

        function useMyLocation() {
            navigator.geolocation.getCurrentPosition(pos => {
                setSearchLocation(pos.coords.latitude, pos.coords.longitude, "Current Location");
            }, e => alert("Please enable GPS/Location services."));
        }

        function clearSearch(){
            searchCenter = null;
            document.getElementById("status-pill").style.display = "none";
            document.getElementById("count-pill").style.display = "none";
            document.getElementById("map-radius-pill").style.display = "none";
            renderWelcome();
            const el = document.querySelector('gmp-place-autocomplete');
            if(el) el.value = null;
            if(map) { markers.forEach(m => m.map = null); }
        }

        function getDistance(lat1, lon1, lat2, lon2){
            const R = 3958.8; const dLat = (lat2 - lat1) * Math.PI / 180; const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2)**2;
            return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
        }

        async function initApp(){
            const { Map } = await google.maps.importLibrary("maps");
            const { PlaceAutocompleteElement } = await google.maps.importLibrary("places");
            const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");

            const autocomplete = new PlaceAutocompleteElement();
            autocomplete.setAttribute("types", "(cities)");
            autocomplete.placeholder = "Search City...";
            const container = document.getElementById("autocomplete-container");
            container.appendChild(autocomplete);

            map = new Map(document.getElementById("map-view"), {
                center: { lat: 40.091, lng: -74.218 },
                zoom: 12, disableDefaultUI: true, clickableIcons: false, mapId: "DEMO_MAP_ID",
                styles: [ { featureType: "poi", elementType: "labels", stylers: [{ visibility: "off" }] } ]
            });

            map.addListener('idle', onMapIdle);

            autocomplete.addEventListener('input', () => { if (!autocomplete.value) clearSearch(); });

            autocomplete.addEventListener("gmp-select", async (event) => {
                if (event.placePrediction) {
                    if (document.activeElement) document.activeElement.blur();
                    setTimeout(() => { if (document.activeElement) document.activeElement.blur(); }, 200);
                    const place = event.placePrediction.toPlace();
                    await place.fetchFields({ fields: ["displayName", "location"] });
                    setSearchLocation(place.location.lat(), place.location.lng(), place.displayName);
                }
            });
        }
        
        function scrollToTop(e) {
            if(e) e.stopPropagation();
            document.getElementById('list-view').scrollTo({ top: 0, behavior: 'smooth' });
        }
    </script>
    <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAOpNebt0dPJUmiEw-i1W-Dx_UezLpIvxI&loading=async&libraries=places,maps,marker&callback=initApp"></script>
</body>
</html>
