<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>ShulTime v3.4</title>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<style>
    :root { 
        --primary: #0D2B4F; 
        --bg: #F2F4F8; 

        /* TEFILLAH COLORS */
        --color-Shacharis: #2E7D32; 
        --color-Mincha: #E65100;    
        --color-Maariv: #1565C0;    

        /* NUSACH BACKGROUNDS */
        --bg-Ashkenaz: #E3F2FD;         
        --bg-Sefard: #E8F5E9;           
        --bg-Ari: #F3E5F5;              
        --bg-Edot-HaMizrach: #FFF3E0;  
        --bg-Chabad: #FFF8E1;           
        --bg-Other: #F5F5F5;            
        
        /* NUSACH TEXT */
        --text-Ashkenaz: #1565C0;
        --text-Sefard: #2E7D32;
        --text-Ari: #7B1FA2;
        --text-Edot-HaMizrach: #E65100;
        --text-Chabad: #F57F17;
        --text-Other: #616161;
    }
    
    html, body { margin: 0; padding: 0; height: 100%; overscroll-behavior-y: contain; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Roboto", sans-serif; background: var(--bg); overflow: hidden; }
    
    /* FLOATING HEADER & DISPLAY SEARCH */
    .floating-header {
        position: fixed; top: 15px; left: 10px; right: 10px;
        z-index: 1000; display: flex; gap: 10px; align-items: center; pointer-events: none;
    }
    .search-container {
        flex: 1; display: flex; align-items: center; pointer-events: auto;
        background: #fff; height: 50px; border-radius: 25px; cursor: pointer;
        box-shadow: 0 4px 15px rgba(0,0,0,0.15); padding: 0 20px;
        overflow: hidden; transition: all 0.2s;
    }
    .search-container:active { transform: scale(0.98); background: #fafafa; }
    
    #dummy-search-text {
        font-size: 16px; font-weight: 500; color: #888; width: 100%;
        white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }

    .circle-btn {
        width: 50px; height: 50px; flex-shrink: 0; pointer-events: auto;
        border-radius: 50%; background: #fff; border: none;
        box-shadow: 0 4px 15px rgba(0,0,0,0.15); display: flex; align-items: center; justify-content: center;
        cursor: pointer; color: var(--primary); transition: all 0.2s;
    }

    /* SEARCH OVERLAY */
    #search-overlay {
        position: fixed; top: 100%; left: 0; right: 0; height: 100%;
        background: var(--bg); z-index: 5000; 
        transition: top 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex; flex-direction: column;
    }
    #search-overlay.open { top: 0; }
    
    .search-overlay-header {
        display: flex; align-items: center; gap: 10px; padding: 15px 12px; 
        background: #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        padding-top: max(15px, env(safe-area-inset-top));
    }
    .search-overlay-input-wrap {
        flex: 1; height: 45px; background: #f0f2f5; border-radius: 22px; 
        overflow: visible; padding: 0 15px; display: flex; align-items: center;
    }
    gmp-place-autocomplete { width: 100%; height: 100%; background-color: transparent !important; }
    gmp-place-autocomplete::part(input) { background-color: transparent !important; padding: 0; font-size: 16px; height: 100%; width: 100%; color: #111; font-weight: 500; outline: none; border: none; }
    .pac-container { border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.15); border: none; margin-top: 5px; font-family: inherit; z-index: 6000 !important; }

    .search-now-btn {
        width: 100%; background: var(--primary); color: #fff; border: none; 
        padding: 16px; border-radius: 25px; font-size: 16px; font-weight: 800; 
        cursor: pointer; box-shadow: 0 4px 15px rgba(13, 43, 79, 0.2); 
        display: flex; align-items: center; justify-content: center; gap: 8px;
        transition: transform 0.1s;
    }
    .search-now-btn:active { transform: scale(0.98); }

    /* STATUS PILLS */
    .status-area {
        position: fixed; top: 75px; left: 0; right: 0;
        display: flex; justify-content: center; align-items: center; flex-wrap: wrap; gap: 6px;
        z-index: 800; pointer-events: none; padding: 0 10px;
    }
    #status-pill, #count-pill, #map-radius-pill {
        padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 700;
        display: none; box-shadow: 0 2px 8px rgba(0,0,0,0.1); white-space: nowrap;
        max-width: 45%; overflow: hidden; text-overflow: ellipsis; pointer-events: auto;
    }
    #status-pill { background: rgba(13, 43, 79, 0.95); color: #fff; }
    #count-pill { background: #fff; color: var(--primary); border: 1px solid var(--primary); }
    #map-radius-pill { background: #2E7D32; color: #fff; }

    /* STICKY HEADER */
    .sticky-header {
        position: fixed; top: 0; left: 0; right: 0; height: 60px;
        background: rgba(242, 244, 248, 0.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
        border-bottom: 1px solid rgba(0,0,0,0.05); z-index: 900; 
        display: flex; align-items: flex-end; justify-content: center;
        padding-bottom: 12px; font-weight: 800; font-size: 17px; color: var(--primary);
        opacity: 0; transition: opacity 0.2s ease-in-out; pointer-events: none;
    }
    .sticky-header.visible { opacity: 1; pointer-events: auto; }

    /* VIEWS */
    #list-view { position: absolute; inset: 0; padding: 110px 10px 120px 10px; overflow-y: auto; background: var(--bg); z-index: 10; display: none; }
    #settings-view, #zmanim-view { position: absolute; inset: 0; padding: 20px 10px 120px 10px; overflow-y: auto; background: var(--bg); z-index: 10; display: none; }
    #map-view { position: absolute; inset: 0; z-index: 5; }

    .list-page-header { font-size: 34px; font-weight: 800; color: var(--primary); margin-top: 10px; margin-bottom: 15px; padding-left: 5px; }

    /* MAP MARKERS */
    #center-marker {
        position: fixed; top: 50%; left: 50%; width: 16px; height: 16px;
        background: #2196F3; border: 3px solid #fff; border-radius: 50%;
        transform: translate(-50%, -50%); z-index: 20; box-shadow: 0 2px 6px rgba(0,0,0,0.4);
        pointer-events: none; display: none;
    }
    .custom-marker { 
        padding: 5px 9px; border-radius: 12px; font-size: 12.5px; font-weight: 800; 
        box-shadow: 0 3px 8px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; 
        position: relative; top: 10px; cursor: pointer; background: #fff; border: 2px solid #fff;
    }
    .custom-marker::after { content: ''; position: absolute; bottom: -5px; left: 50%; transform: translateX(-50%); border-width: 5px 5px 0; border-style: solid; border-color: inherit transparent transparent transparent; }

    /* CARDS & SLIDE-TO-DELETE */
    .list-item-wrapper { position: relative; margin-bottom: 8px; border-radius: 12px; background: #FFEBEE; overflow: hidden; }
    .delete-bg { position: absolute; left: 0; top: 0; bottom: 0; width: 60px; display: flex; align-items: center; justify-content: center; color: #D32F2F; cursor: pointer; z-index: 1; }
    
    .minyan-card {
        background: #fff; border-radius: 12px; margin-bottom: 8px;
        display: flex; justify-content: space-between; align-items: stretch;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05); overflow: hidden; height: 95px;
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative; z-index: 2;
    }
    .minyan-card.edit-slide { transform: translateX(60px); pointer-events: none; }
    
    .info-zone { 
        flex: 1; padding: 10px 12px; cursor: pointer; display: flex; flex-direction: column; 
        justify-content: flex-start; min-width: 0; border-right: 1px solid #f0f0f0; 
    }
    .map-zone { 
        width: 110px; flex-shrink: 0; display: flex; flex-direction: column; 
        justify-content: space-between; align-items: flex-end; padding: 8px 10px; 
        background: #fafafa; cursor: pointer; box-sizing: border-box;
    }
    
    .shul-name { font-weight: 800; font-size: 17px; color: #333; line-height: 1.1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 2px; }
    .shul-address { font-size: 12px; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.2; }
    .shul-city-state { font-size: 11px; color: #999; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 2px; line-height: 1.2; }
    .nusach-tag-list { font-size: 10px; padding: 2px 8px; border-radius: 8px; display: inline-block; font-weight: 700; text-transform: uppercase; width: fit-content; }

    .tefillah-label { font-size: 11px; font-weight: 900; text-transform: uppercase; color: #555; text-align: right; line-height: 1; } 
    .time-val-card { padding: 4px 8px; border-radius: 8px; font-weight: 800; font-size: 13px; white-space: nowrap; margin-top: auto; margin-bottom: auto; }
    .dist-row { display: flex; align-items: center; justify-content: flex-end; gap: 4px; }
    .dist-label { font-size: 11px; font-weight: 800; color: #666; }
    .map-circle { width: 26px; height: 26px; border-radius: 50%; background: #fff; display: flex; align-items: center; justify-content: center; border: 1px solid #eee; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .google-maps-icon { background: linear-gradient(135deg, #4285F4 25%, #34A853 25% 50%, #FBBC05 50% 75%, #EA4335 75%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 16px !important; font-weight: bold; }

    /* FILTERS */
    #filter-drawer { display: none; position: fixed; top: 80px; left: 12px; right: 12px; background: #fff; border-radius: 20px; padding: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.25); z-index: 2000; max-width: 500px; margin: 0 auto; max-height: 75vh; overflow-y: auto;}
    .filter-section { margin-bottom: 15px; } 
    .filter-label { font-size: 10px; font-weight: 800; color: #bbb; text-transform: uppercase; margin-bottom: 5px; display: block; }
    .chip-group { display: flex; flex-wrap: wrap; gap: 6px; }
    
    /* DEFAULT CHIP */
    .chip { padding: 6px 12px; border-radius: 15px; border: 1px solid #ddd; background: #fff; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.1s; color: #555; }
    .chip.active { box-shadow: 0 2px 5px rgba(0,0,0,0.1); transform: scale(1.05); }
    .chip-all.active { background: var(--primary) !important; color: #fff !important; border-color: var(--primary) !important; }

    /* NUSACH CHIPS */
    .n-chip-Ashkenaz { background: var(--bg-Ashkenaz) !important; color: var(--text-Ashkenaz) !important; border-color: var(--bg-Ashkenaz) !important; }
    .n-chip-Ashkenaz.active { border: 2px solid var(--text-Ashkenaz) !important; font-weight: 800; }
    .n-chip-Sefard { background: var(--bg-Sefard) !important; color: var(--text-Sefard) !important; border-color: var(--bg-Sefard) !important; }
    .n-chip-Sefard.active { border: 2px solid var(--text-Sefard) !important; font-weight: 800; }
    .n-chip-Ari { background: var(--bg-Ari) !important; color: var(--text-Ari) !important; border-color: var(--bg-Ari) !important; }
    .n-chip-Ari.active { border: 2px solid var(--text-Ari) !important; font-weight: 800; }
    .n-chip-Edot-HaMizrach { background: var(--bg-Edot-HaMizrach) !important; color: var(--text-Edot-HaMizrach) !important; border-color: var(--bg-Edot-HaMizrach) !important; }
    .n-chip-Edot-HaMizrach.active { border: 2px solid var(--text-Edot-HaMizrach) !important; font-weight: 800; }
    .n-chip-Chabad { background: var(--bg-Chabad) !important; color: var(--text-Chabad) !important; border-color: var(--bg-Chabad) !important; }
    .n-chip-Chabad.active { border: 2px solid var(--text-Chabad) !important; font-weight: 800; }
    .n-chip-Other { background: var(--bg-Other) !important; color: var(--text-Other) !important; border-color: var(--bg-Other) !important; }
    .n-chip-Other.active { border: 2px solid var(--text-Other) !important; font-weight: 800; }
    
    /* v3.4 DATE NAV (Circular buttons & 1 line text) */
    .date-nav { display: flex; align-items: center; justify-content: space-between; background: #f5f5f5; padding: 10px 12px; border-radius: 16px; }
    .date-btn { 
        background: #fff; border: none; border-radius: 50%; width: 34px; height: 34px; 
        color: var(--primary); cursor: pointer; display: flex; align-items: center; justify-content: center;
        box-shadow: 0 2px 6px rgba(0,0,0,0.08); flex-shrink: 0; transition: transform 0.1s;
    }
    .date-btn:active { transform: scale(0.92); }
    .date-text-wrapper { flex: 1; min-width: 0; text-align: center; padding: 0 8px; display: flex; flex-direction: column; align-items: center;}
    .date-main-text { font-weight: 800; font-size: 15px; color: #333; width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .date-sub-text { font-size: 12px; font-weight: 600; color: var(--primary); opacity: 0.8; width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    /* DETAILS DRAWER */
    #details-drawer { position: fixed; bottom: -100%; left: 10px; right: 10px; height: 75vh; background: #fff; border-radius: 25px; z-index: 3000; margin-bottom: 15px; box-shadow: 0 5px 30px rgba(0,0,0,0.3); transition: transform 0.3s ease-out; display: flex; flex-direction: column; padding: 0; }
    #details-drawer.open { bottom: 0; transform: translateY(0); }
    #scrim { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 2500; display: none; }
    .drawer-header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 1px solid #f0f0f0; }
    .drawer-body { flex: 1; overflow-y: auto; padding: 20px; }
    .schedule-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 14px; margin-top: 10px; }
    .contact-row { display: flex; gap: 8px; margin-top: 15px; flex-wrap: wrap; }
    .contact-btn { background: #f5f5f5; border: 1px solid #ddd; padding: 8px 12px; border-radius: 20px; font-weight: 700; font-size: 12px; text-decoration: none; color: #333; display: flex; align-items: center; justify-content: center; gap: 4px; white-space: nowrap; flex: 1; }
    .contact-btn.disabled { opacity: 0.5; pointer-events: none; background: #eee; }
    
    /* TOOLBAR */
    .floating-toolbar { position: fixed; bottom: 20px; left: 20px; right: 20px; background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); border: 1px solid rgba(255,255,255,0.3); display: flex; justify-content: space-between; align-items: center; padding: 5px 10px; z-index: 1500; border-radius: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
    .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: #999; font-size: 10px; font-weight: 600; gap: 3px; border: none; background: transparent; flex: 1; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative; padding: 6px 4px; margin: 0 2px; border-radius: 20px; border: 1px solid transparent; }
    .nav-item.active { 
        color: var(--primary); font-weight: 900; 
        background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.9);
        box-shadow: 0 4px 12px rgba(0,0,0,0.08), inset 0 0 0 1px rgba(255,255,255,0.5);
        transform: translateY(-3px); 
    }
    .nav-item i { font-size: 22px; }

    /* NUSACH UTILS FOR CARDS */
    .nusach-bg-Ashkenaz { background-color: var(--bg-Ashkenaz) !important; color: var(--text-Ashkenaz) !important; border-color: var(--bg-Ashkenaz) !important; }
    .nusach-bg-Sefard { background-color: var(--bg-Sefard) !important; color: var(--text-Sefard) !important; border-color: var(--bg-Sefard) !important; }
    .nusach-bg-Ari { background-color: var(--bg-Ari) !important; color: var(--text-Ari) !important; border-color: var(--bg-Ari) !important; }
    .nusach-bg-Edot-HaMizrach { background-color: var(--bg-Edot-HaMizrach) !important; color: var(--text-Edot-HaMizrach) !important; border-color: var(--bg-Edot-HaMizrach) !important; }
    .nusach-bg-Chabad { background-color: var(--bg-Chabad) !important; color: var(--text-Chabad) !important; border-color: var(--bg-Chabad) !important; }
    .nusach-bg-Other { background-color: var(--bg-Other) !important; color: var(--text-Other) !important; border-color: var(--bg-Other) !important; }

    .fab-location { position: fixed; bottom: 90px; right: 20px; width: 50px; height: 50px; background: #fff; border-radius: 50%; box-shadow: 0 4px 15px rgba(0,0,0,0.2); border: none; color: var(--primary); display: flex; align-items: center; justify-content: center; z-index: 900; }
    .time-pill { display: inline-block; padding: 4px 10px; border-radius: 12px; font-weight: 800; font-size: 14px; margin: 2px; border: 1px solid rgba(0,0,0,0.08); }

    /* ZMANIM & SETTINGS */
    .zman-header-section { background: #fff; padding: 15px 15px 10px 15px; border-radius: 15px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
    .zman-card { background: #fff; border-radius: 12px; padding: 12px 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; border-left: 4px solid var(--primary); }
    .zman-label { font-size: 15px; font-weight: 700; color: #333; }
    .zman-time { font-size: 16px; font-weight: 800; color: var(--primary); font-family: monospace; }
    
    .settings-card { background: #fff; border-radius: 16px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .input-group { margin-bottom: 15px; }
    .input-label { display: block; font-size: 12px; font-weight: 700; color: #666; margin-bottom: 5px; text-transform: uppercase; }
    .settings-input { width: 100%; padding: 12px; border: 1px solid #eee; border-radius: 12px; font-size: 16px; background: #fafafa; box-sizing: border-box; font-family: inherit; }
    .settings-link { display: flex; align-items: center; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid #f0f0f0; color: #333; text-decoration: none; cursor: pointer; }
    .settings-link:last-child { border-bottom: none; }
    .settings-link-text { font-size: 16px; font-weight: 600; }
</style>
</head>
<body>

    <div id="sticky-header" class="sticky-header"></div>

    <div class="floating-header" id="filter-header">
        <div class="search-container" onclick="openSearchOverlay()">
            <div id="dummy-search-text">Search City...</div>
        </div>
        <button class="circle-btn" onclick="toggleFilters()"><i class="material-icons">tune</i></button>
    </div>

    <div id="search-overlay">
        <div class="search-overlay-header">
            <button class="circle-btn" style="width:40px; height:40px; background:#f0f0f0; box-shadow:none;" onclick="closeSearchOverlay()">
                <i class="material-icons" style="color:#555;">arrow_back</i>
            </button>
            <div class="search-overlay-input-wrap">
                <gmp-place-autocomplete id="gmp-autocomplete" placeholder="Search City, Zip Code..."></gmp-place-autocomplete>
            </div>
        </div>
        
        <div style="padding: 20px;">
            <button class="search-now-btn" onclick="executeManualSearch()">
                <i class="material-icons">search</i> Search Now
            </button>
        </div>

        <div style="flex:1; display:flex; align-items:flex-start; justify-content:center; padding:20px; text-align:center;">
            <div style="color:#999; margin-top: 20px;">
                <i class="material-icons" style="font-size:48px; margin-bottom:10px; opacity:0.5;">travel_explore</i><br>
                Search for a city, zip code, or address.
            </div>
        </div>
    </div>

    <div class="status-area">
        <div id="status-pill"></div>
        <div id="count-pill"></div>
        <div id="map-radius-pill"></div>
    </div>

    <div id="center-marker"></div>
    <div id="scrim" onclick="closeDetails()"></div>

    <div id="details-drawer">
        <div class="drawer-header">
            <div style="flex:1; padding-right: 10px;">
                <div id="drawer-title" style="font-weight:800; font-size:18px; color:var(--primary); line-height: 1.1; margin-bottom: 2px;"></div>
                <div id="drawer-address" style="font-size:13px; color:#777; font-weight: 500;"></div>
            </div>
            <div style="display:flex; gap:12px; flex-shrink: 0;">
                <button class="circle-btn" style="width:40px; height:40px; background:#f0f0f0;" onclick="toggleFavorite()"><i class="material-icons" id="drawer-fav-icon" style="color:#555; font-size: 20px;">bookmark_border</i></button>
                <button class="circle-btn" style="width:40px; height:40px; background:#f0f0f0;" onclick="closeDetails()"><i class="material-icons" style="color:#555; font-size: 20px;">close</i></button>
            </div>
        </div>
        <div id="drawer-content" class="drawer-body"></div>
    </div>

    <div id="filter-drawer">
        <div class="filter-section">
            <label class="filter-label">Date</label>
            <div class="date-nav">
                <button class="date-btn" onclick="changeDate(-1)"><i class="material-icons">chevron_left</i></button>
                <div class="date-text-wrapper">
                    <div id="date-display" class="date-main-text">Today</div>
                    <div id="hebrew-date" class="date-sub-text"></div>
                </div>
                <button class="date-btn" onclick="changeDate(1)"><i class="material-icons">chevron_right</i></button>
            </div>
        </div>
        <div class="filter-section">
            <label class="filter-label">Sort By</label>
            <div class="chip-group" id="sort-group">
                <div class="chip active chip-all" onclick="setFilter('sort', 'time', this)">Time</div>
                <div class="chip" onclick="setFilter('sort', 'distance', this)">Distance</div>
                <div class="chip" onclick="setFilter('sort', 'abc', this)">A-Z</div>
            </div>
        </div>
        <div class="filter-section">
            <label class="filter-label">Radius (Miles)</label>
            <div style="display:flex; align-items:center; gap:10px;">
                <input type="range" min="0.1" max="99" step="0.1" value="20" id="radius-slider" style="flex:1; accent-color: var(--primary);" oninput="manualRadiusUpdate(this.value)">
                <input type="number" id="radius-input" value="20" style="width:50px; padding:5px; border:1px solid #ddd; border-radius:8px; text-align:center; font-weight:bold; font-family:inherit;" onchange="manualRadiusUpdate(this.value)">
            </div>
            <div class="chip-group" id="radius-group" style="margin-top:10px;">
                <div class="chip" onclick="manualRadiusUpdate(1)">1</div>
                <div class="chip" onclick="manualRadiusUpdate(2)">2</div>
                <div class="chip" onclick="manualRadiusUpdate(3)">3</div>
                <div class="chip" onclick="manualRadiusUpdate(5)">5</div>
                <div class="chip active chip-all" onclick="manualRadiusUpdate(20)">20</div>
                <div class="chip" onclick="manualRadiusUpdate(99)">99</div>
            </div>
        </div>
        <div class="filter-section">
            <label class="filter-label">Tefillah</label>
            <div class="chip-group" id="tefillah-group">
                <div class="chip active chip-all" onclick="setFilter('tefillah', '', this)">All</div>
                <div class="chip" onclick="setFilter('tefillah', 'Shacharis', this)">Shacharis</div>
                <div class="chip" onclick="setFilter('tefillah', 'Mincha', this)">Mincha</div>
                <div class="chip" onclick="setFilter('tefillah', 'Maariv', this)">Maariv</div>
            </div>
        </div>
        <div class="filter-section">
            <label class="filter-label">Nusach</label>
            <div class="chip-group" id="nusach-group">
                <div class="chip active chip-all" onclick="setFilter('nusach', '', this)">All</div>
            </div>
        </div>
        <div class="filter-section">
            <label class="filter-label">Time Range</label>
            <div style="display:flex; gap:8px;">
                <input type="time" id="time-start" value="00:00" style="flex:1; padding:8px; border-radius:15px; border:1px solid #ddd; text-align:center; font-weight:600;" onchange="applyFilters()">
                <input type="time" id="time-end" value="23:59" style="flex:1; padding:8px; border-radius:15px; border:1px solid #ddd; text-align:center; font-weight:600;" onchange="applyFilters()">
            </div>
            <div style="display:flex; gap:6px; margin-top:6px;">
                <button style="flex:1; background:#eee; color:#333; border:none; padding:10px; border-radius:15px; font-weight:700;" onclick="resetTime()">All Day</button>
                <button style="flex:1; background:var(--primary); color:#fff; border:none; padding:10px; border-radius:15px; font-weight:700;" onclick="setNextTwoHours()">Next 2 Hours</button>
            </div>
        </div>
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button style="flex:1; background:#f0f0f0; color:#555; border:none; padding:12px; border-radius:15px; font-weight:800; cursor:pointer;" onclick="resetFilters()">Reset</button>
            <button style="flex:2; background:var(--primary); color:#fff; border:none; padding:12px; border-radius:15px; font-weight:800; cursor:pointer;" onclick="toggleFilters()">Done</button>
        </div>
    </div>

    <div id="list-view"></div>
    <div id="map-view"></div>
    
    <div id="zmanim-view">
        <div class="list-page-header">Zmanim</div>
        <div class="zman-header-section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <div style="font-size:18px; font-weight:800; color:var(--primary);">Location</div>
                <div id="zman-loc-badge" style="font-size:12px; background:#f0f0f0; padding:4px 10px; border-radius:12px; color:#555; font-weight:600;">Lakewood, NJ</div>
            </div>
            <div class="date-nav">
                <button class="date-btn" onclick="changeDate(-1)"><i class="material-icons">chevron_left</i></button>
                <div class="date-text-wrapper">
                    <div id="zman-date-display" class="date-main-text">Today</div>
                    <div id="zman-hebrew-date" class="date-sub-text"></div>
                </div>
                <button class="date-btn" onclick="changeDate(1)"><i class="material-icons">chevron_right</i></button>
            </div>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <div style="flex:1; background:#f9f9f9; border:1px solid #eee; padding:8px; border-radius:8px; text-align:center; font-size:13px; font-weight:700; color:#333;">
                    <span style="display:block; font-size:10px; color:#888; text-transform:uppercase; font-weight:600; margin-bottom:2px;">Day</span>
                    <div id="zman-day"></div>
                </div>
                <div style="flex:1; background:#f9f9f9; border:1px solid #eee; padding:8px; border-radius:8px; text-align:center; font-size:13px; font-weight:700; color:#333;">
                    <span style="display:block; font-size:10px; color:#888; text-transform:uppercase; font-weight:600; margin-bottom:2px;">Daf Yomi</span>
                    <div id="zman-daf"></div>
                </div>
            </div>
        </div>
        <div id="zmanim-content" style="padding-top: 10px;"></div>
    </div>
    
    <div id="settings-view">
        <div class="list-page-header">Settings</div>
        <p style="padding-left: 5px; color:#666; font-weight:600; margin-top:-10px; margin-bottom: 20px;">ShulTime v3.4</p>
        <div class="settings-card">
            <div class="input-group">
                <label class="input-label">Name</label>
                <input type="text" class="settings-input" id="profile-name" placeholder="Your Name" oninput="saveProfile()">
            </div>
            <div class="input-group">
                <label class="input-label">Phone</label>
                <input type="tel" class="settings-input" id="profile-phone" placeholder="Phone Number" oninput="saveProfile()">
            </div>
        </div>
        <div class="settings-card" style="padding: 0 20px;">
            <a class="settings-link" onclick="alert('Feature Coming Soon')"><span class="settings-link-text">Privacy Policy</span><i class="material-icons">chevron_right</i></a>
            <a class="settings-link" onclick="alert('Feature Coming Soon')"><span class="settings-link-text">Rate App</span><i class="material-icons">star_rate</i></a>
            <a class="settings-link" onclick="if(navigator.share) navigator.share({title: 'ShulTime', text: 'Find Minyanim near you!', url: window.location.href});"><span class="settings-link-text">Share App</span><i class="material-icons">ios_share</i></a>
            <a class="settings-link" href="mailto:support@shultime.com"><span class="settings-link-text">Contact Us</span><i class="material-icons">email</i></a>
            <a class="settings-link" href="mailto:support@shultime.com?subject=Support"><span class="settings-link-text">Support</span><i class="material-icons">help_outline</i></a>
        </div>
    </div>

    <button class="fab-location" id="fab-location" onclick="useMyLocation()"><i class="material-icons">my_location</i></button>

    <div class="floating-toolbar">
        <button class="nav-item" id="nav-recent" onclick="switchTab('recent')"><i class="material-icons">history</i>Recent</button>
        <button class="nav-item" id="nav-zmanim" onclick="switchTab('zmanim')"><i class="material-icons">access_time</i>Zmanim</button>
        <button class="nav-item active" id="nav-toggle" onclick="toggleView()"><i class="material-icons" id="nav-toggle-icon">list</i><span id="nav-toggle-text">List</span></button>
        <button class="nav-item" id="nav-saved" onclick="switchTab('saved')"><i class="material-icons">bookmark_border</i>Saved</button>
        <button class="nav-item" id="nav-settings" onclick="switchTab('settings')"><i class="material-icons">settings</i>Settings</button>
    </div>

    <script>
        // --- DATA ENGINES ---
        const DafEngine={masechtot:[{n:"Berachos",p:63},{n:"Shabbos",p:156},{n:"Eruvin",p:104},{n:"Pesachim",p:120},{n:"Shekalim",p:21},{n:"Yoma",p:87},{n:"Sukkah",p:55},{n:"Beitzah",p:39},{n:"Rosh Hashana",p:34},{n:"Taanis",p:30},{n:"Megillah",p:31},{n:"Moed Katan",p:28},{n:"Chagigah",p:26},{n:"Yevamos",p:121},{n:"Kesubos",p:111},{n:"Nedarim",p:90},{n:"Nazir",p:65},{n:"Sotah",p:48},{n:"Gittin",p:89},{n:"Kiddushin",p:81},{n:"Bava Kamma",p:118},{n:"Bava Metzia",p:118},{n:"Bava Basra",p:175},{n:"Sanhedrin",p:112},{n:"Makkos",p:23},{n:"Shevuos",p:48},{n:"Avodah Zarah",p:75},{n:"Horayos",p:13},{n:"Zevachim",p:119},{n:"Menachos",p:109},{n:"Chullin",p:141},{n:"Bechoros",p:60},{n:"Arachin",p:33},{n:"Temurah",p:33},{n:"Kerisus",p:27},{n:"Meilah",p:21},{n:"Kinnim",p:4},{n:"Tamid",p:9},{n:"Middos",p:4},{n:"Niddah",p:72}],get:(e)=>{const t=new Date(2020,0,5),a=Math.floor((e-t)/864e5);if(a<0)return"";let n=a;for(let r of DafEngine.masechtot){if(n<r.p)return r.n+" "+(n+2);n-=r.p}return""}};
        const HebCal={mapMonth:e=>{const t={Tishri:"Tishrei",Cheshvan:"Cheshvan",Kislev:"Kislev",Tevet:"Teves",Shevat:"Shevat",Adar:"Adar","Adar I":"Adar I","Adar II":"Adar II",Nisan:"Nisan",Iyar:"Iyar",Sivan:"Sivan",Tamuz:"Tamuz",Av:"Av",Elul:"Elul"};return t[e]||e},getHebrewStr:e=>{try{const t=new Intl.DateTimeFormat("en-US-u-ca-hebrew",{day:"numeric",month:"long",year:"numeric"}).formatToParts(e);return t.find(e=>"day"===e.type).value+" "+HebCal.mapMonth(t.find(e=>"month"===e.type).value)+" "+t.find(e=>"year"===e.type).value.split(" ")[0]}catch(e){return""}}};
        const Solar={rad:e=>e*(Math.PI/180),deg:e=>e*(180/Math.PI),calc:(e,t,a,n)=>{const r=(Date.UTC(e.getFullYear(),e.getMonth(),e.getDate())-946728e6)/864e5,l=(280.46+0.9856474*r)%360,c=(357.528+0.9856003*r)%360,o=l+1.915*Math.sin(Solar.rad(c))+.02*Math.sin(Solar.rad(2*c)),i=23.439-4e-7*r,s=Math.sin(Solar.rad(i))*Math.sin(Solar.rad(o)),u=Math.sqrt(1-s*s),d=Math.tan(Solar.rad(i/2))*Math.tan(Solar.rad(i/2)),h=d*Math.sin(2*Solar.rad(l))-2*.0167*Math.sin(Solar.rad(c))+4*.0167*d*Math.sin(Solar.rad(c))*Math.cos(2*Solar.rad(l))-.5*d*d*Math.sin(4*Solar.rad(l))-1.25*.0167*.0167*Math.sin(2*Solar.rad(c)),m=Solar.deg(h)*4,g=720-4*a-m,p=Date.UTC(e.getFullYear(),e.getMonth(),e.getDate())+6e4*g,f=(e,n)=>{const r=90-e,l=Math.sin(Solar.rad(r))-Math.sin(Solar.rad(t))*s,c=Math.cos(Solar.rad(t))*u,o=l/c;if(o>1||o<-1)return null;const i=Solar.deg(Math.acos(o))*4;return n?p-6e4*i:p+6e4*i};return{noon:p,alot:f(106.1,!0),misheyakir:f(101.5,!0),sunrise:f(90.833,!0),sunset:f(90.833,!1),tzais:f(98.5,!1)}}};

        let map, geocoder, fullDbData = [], allMinyanim = [], searchCenter = null, currentRadius = 20;
        let filters = { tefillah: '', nusach: '', sort: 'time' };
        let markers = [];
        let currentTab = 'map';
        let currentFilterDate = new Date();
        let isFirstIdle = true;
        let isProgrammaticMove = false;
        let selectedShul = null;
        let zmanLoc = { lat: 40.096, lng: -74.222, name: 'Lakewood, NJ' };
        
        // --- STORAGE & EDIT STATE ---
        let currentStorageKey = null;
        let isEditingList = false;

        // --- APP FLOW ---
        document.addEventListener("DOMContentLoaded", async () => {
            updateDateDisplay();
            loadProfile();
            
            document.getElementById('list-view').addEventListener('scroll', function() {
                const header = document.getElementById('sticky-header');
                if(this.scrollTop > 40 && (currentTab === 'recent' || currentTab === 'saved')) {
                    header.classList.add('visible');
                    const title = currentTab === 'recent' ? "Recent Shuls" : "Saved Shuls";
                    // Embed edit feature inside the sticky header
                    header.innerHTML = `
                        <div style="display:flex; justify-content:space-between; align-items:center; width:100%; padding: 0 15px;">
                            <span>${title}</span>
                            <button onclick="toggleEditList()" style="background:transparent; color:var(--primary); border:none; font-weight:800; font-size:15px; cursor:pointer; padding:0;">
                                ${isEditingList ? 'Done' : 'Edit'}
                            </button>
                        </div>
                    `;
                } else { 
                    header.classList.remove('visible'); 
                    header.innerHTML = '';
                }
            });

            try {
                const res = await fetch("database.json");
                if(!res.ok) throw new Error();
                fullDbData = await res.json();
                processMinyanim();
                populateNusachFilter();
            } catch(e) { console.error("Database fetch error"); }
        });

        // Overlay Search functions
        function openSearchOverlay() {
            document.getElementById('search-overlay').classList.add('open');
            setTimeout(() => {
                const ac = document.getElementById('gmp-autocomplete');
                if(ac) ac.focus();
            }, 300);
        }
        function closeSearchOverlay() {
            document.getElementById('search-overlay').classList.remove('open');
            if (document.activeElement) document.activeElement.blur();
        }

        async function executeManualSearch() {
            const autocompleteEl = document.getElementById("gmp-autocomplete");
            const query = autocompleteEl.inputValue || autocompleteEl.value; 
            
            if (!query || query.trim() === "") {
                closeSearchOverlay();
                return;
            }

            try {
                const res = await geocoder.geocode({ address: query });
                if (res.results && res.results[0]) {
                    const loc = res.results[0].geometry.location;
                    let cityResult = res.results[0].address_components.find(c => c.types.includes("locality"));
                    if (!cityResult) cityResult = res.results[0].address_components.find(c => c.types.includes("neighborhood"));
                    let name = cityResult ? cityResult.long_name : res.results[0].formatted_address.split(',')[0];
                    
                    setSearchLocation(loc.lat(), loc.lng(), name);
                    closeSearchOverlay();
                    autocompleteEl.inputValue = ''; 
                    autocompleteEl.value = ''; 
                } else {
                    alert("Location not found. Please try a different search.");
                }
            } catch (e) {
                console.error("Geocode failed: ", e);
                alert("Could not find that location. Please try again.");
            }
        }

        function processMinyanim() {
            allMinyanim = [];
            const dayKey = getDayKey(currentFilterDate);
            const isFri = currentFilterDate.getDay() === 5;
            const isSat = currentFilterDate.getDay() === 6;

            fullDbData.forEach(shul => {
                if(!shul.name) return;
                let hasTimes = false;
                const add = (type, times) => {
                    if(times) times.forEach(t => {
                        let raw = t.trim().replace(/[^0-9:]/g,"");
                        if(!raw) return;
                        let [h,m] = raw.split(':').map(Number);
                        let sortVal = (h*60)+m;
                        if(type==='Mincha' && h<9) sortVal += 720;
                        if(type==='Maariv' && h<12) sortVal += 720;
                        if(type==='Mincha' && h===12) sortVal = 12*60+m;
                        allMinyanim.push({...shul, tefillah:type, timeDisplay: formatTime(h,m), timeValue: sortVal});
                        hasTimes = true;
                    });
                };

                if(!isSat) add('Shacharis', shul.shacharis?.[dayKey]);
                if(isFri) add('Mincha', shul.mincha?.fri);
                else if(isSat) add('Mincha', shul.mincha?.shabbos);
                else add('Mincha', shul.mincha?.week);
                
                if(isSat) add('Maariv', shul.maariv?.shabbos);
                else add('Maariv', shul.maariv?.week);

                if(!hasTimes) allMinyanim.push({...shul, tefillah:'Info', timeDisplay:'Info', timeValue:9999});
            });
            if(searchCenter && (currentTab === 'list' || currentTab === 'map')) applyFilters();
            else if(!searchCenter) renderWelcome();
        }

        function populateNusachFilter() {
            const set = new Set();
            fullDbData.forEach(s => { if(s.nusach && s.nusach !== "Unspecified") set.add(s.nusach.trim()); });
            const group = document.getElementById('nusach-group');
            Array.from(set).sort().forEach(n => {
                if(!n) return;
                const safeClass = `n-chip-${n.replace(/\s+/g, '-')}`;
                const chip = document.createElement('div');
                chip.className = `chip ${safeClass}`;
                chip.innerText = n;
                chip.onclick = () => setFilter('nusach', n, chip);
                group.appendChild(chip);
            });
        }

        function applyFilters() {
            if(!searchCenter || !allMinyanim.length) return;
            const sVal = timeToVal(document.getElementById('time-start').value);
            const eVal = timeToVal(document.getElementById('time-end').value);

            let results = allMinyanim.map(m => {
                m.distance = getDistance(searchCenter.lat, searchCenter.lng, m.lat, m.lng);
                return m;
            });

            // Dual view filtering
            if(currentTab === 'map' && map && !isProgrammaticMove) {
                const bounds = map.getBounds();
                if(bounds) results = results.filter(m => bounds.contains({lat:m.lat, lng:m.lng}));
            } else {
                results = results.filter(m => m.distance <= currentRadius);
            }

            if(filters.tefillah) results = results.filter(m => m.tefillah === filters.tefillah);
            if(filters.nusach) results = results.filter(m => m.nusach === filters.nusach);
            results = results.filter(m => m.timeValue === 9999 || (m.timeValue >= sVal && m.timeValue <= eVal));
            
            // Apply Sorting
            if (filters.sort === 'abc') {
                results.sort((a,b) => (a.name || "").localeCompare(b.name || ""));
            } else if (filters.sort === 'distance') {
                results.sort((a,b) => a.distance - b.distance);
            } else { // default: time
                results.sort((a,b) => a.timeValue - b.timeValue);
            }
            
            updateStatusPills(results);
            if(currentTab === 'map' || currentTab === 'list') renderList(results, null);
            if(currentTab === 'map') updateMapMarkers(results);
        }

        function updateStatusPills(results) {
            const shulCount = new Set(results.map(r => r.name + r.address)).size;
            const validCount = results.filter(r => r.timeValue < 9999).length;
            document.getElementById('status-pill').style.display = 'block';
            document.getElementById('count-pill').innerText = `${shulCount} Shuls / ${validCount} Minyanim`;
            document.getElementById('count-pill').style.display = 'block';
            document.getElementById('map-radius-pill').innerText = `${currentRadius} mi Radius`;
            document.getElementById('map-radius-pill').style.display = 'block';
        }

        // Updated renderList to handle slide-to-delete wrapper for saved/recent views
        function renderList(results, storageKey = null) {
            const container = document.getElementById('list-view');
            
            if(!storageKey && results.length === 0) { 
                container.innerHTML = '<div class="empty-state" style="margin-top:80px">No minyanim found matching filters.</div>'; 
                return; 
            }
            
            let html = "";
            results.forEach(m => {
                let nCls = `nusach-bg-${(m.nusach || 'Other').replace(/\s+/g, '-')}`;
                const mapLink = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(m.name + " " + m.address)}`;
                
                let timeZoneHtml = m.timeValue === 9999 ? 
                    `<div class="map-zone" onclick="window.open('${mapLink}','_blank')">
                        <div class="dist-row"><span class="dist-label">${m.distance ? m.distance.toFixed(1) : 0}mi</span><div class="map-circle"><i class="material-icons google-maps-icon">place</i></div></div>
                    </div>` : 
                    `<div class="map-zone" onclick="window.open('${mapLink}','_blank')">
                        <div class="tefillah-label">${m.tefillah}</div>
                        <div class="time-val-card ${nCls}">${m.timeDisplay}</div>
                        <div class="dist-row"><span class="dist-label">${m.distance ? m.distance.toFixed(1) : 0}mi</span><div class="map-circle"><i class="material-icons google-maps-icon">place</i></div></div>
                    </div>`;

                // Safe escaping for the onClick handler
                const safeJson = JSON.stringify(m).replace(/'/g, "'").replace(/"/g, '&quot;');

                let cardHtml = `
                <div class="minyan-card ${storageKey && isEditingList ? 'edit-slide' : ''}" style="${storageKey ? 'margin-bottom:0;' : ''}">
                    <div class="info-zone" onclick="openDetails(${safeJson})">
                        <div class="shul-name">${m.name}</div>
                        <div class="shul-address">${m.address}</div>
                        <div class="shul-city-state">${m.city || ''}, ${m.state || ''}</div>
                        <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-top:auto;">
                            <div class="nusach-tag-list ${nCls}" style="margin-top:0;">${m.nusach || 'Info'}</div>
                            <div style="font-size:11px; font-weight:700; color:var(--primary); opacity:0.7; display:flex; align-items:center;">
                                More Details <i class="material-icons" style="font-size:14px; margin-left:2px;">chevron_right</i>
                            </div>
                        </div>
                    </div>
                    ${timeZoneHtml}
                </div>`;

                // If rendering for Recent/Saved, wrap with delete functionality
                if (storageKey) {
                    html += `
                    <div class="list-item-wrapper">
                        <div class="delete-bg" onclick="deleteStorageItem('${m.id}')">
                            <i class="material-icons">delete</i>
                        </div>
                        ${cardHtml}
                    </div>`;
                } else {
                    html += cardHtml;
                }
            });
            
            if (storageKey) container.innerHTML += html;
            else container.innerHTML = html;
        }

        async function updateMapMarkers(results) {
            if(!map) return;
            const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");
            markers.forEach(m => m.map = null); markers = [];
            
            const unique = {};
            const now = new Date();
            const nowVal = now.getHours() * 60 + now.getMinutes();

            // Intelligent "Next Minyan" grouping
            results.forEach(r => { 
                const k = r.lat+','+r.lng; 
                if(!unique[k]) {
                    unique[k] = r;
                } else {
                    const curr = unique[k];
                    const rFuture = r.timeValue >= nowVal && r.timeValue !== 9999;
                    const cFuture = curr.timeValue >= nowVal && curr.timeValue !== 9999;
                    if (rFuture && !cFuture) unique[k] = r;
                    else if (rFuture && cFuture && r.timeValue < curr.timeValue) unique[k] = r;
                    else if (!rFuture && !cFuture && r.timeValue < curr.timeValue) unique[k] = r;
                }
            });

            Object.values(unique).forEach(m => {
                const pin = document.createElement('div');
                pin.className = `custom-marker nusach-bg-${(m.nusach || 'Other').replace(/\s+/g, '-')}`;
                pin.innerText = m.timeDisplay;
                const marker = new AdvancedMarkerElement({ map, position: {lat:m.lat, lng:m.lng}, content: pin });
                marker.addListener('click', () => openDetails(m));
                markers.push(marker);
            });
        }

        // --- NAVIGATION ---
        function switchTab(tab) {
            currentTab = tab;
            isEditingList = false; // Reset edit state whenever switching tabs
            
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('list-view').style.display = 'none';
            document.getElementById('map-view').style.display = 'none';
            document.getElementById('zmanim-view').style.display = 'none';
            document.getElementById('settings-view').style.display = 'none';
            document.getElementById('center-marker').style.display = 'none';
            document.getElementById('filter-header').style.display = 'none';
            document.getElementById('status-pill').style.display = 'none';
            document.getElementById('count-pill').style.display = 'none';
            document.getElementById('map-radius-pill').style.display = 'none';
            document.getElementById('fab-location').style.display = 'none';
            document.getElementById('sticky-header').classList.remove('visible');

            if(tab === 'map' || tab === 'list') {
                document.getElementById('filter-header').style.display = 'flex';
                document.getElementById('nav-toggle').classList.add('active');
                document.getElementById('fab-location').style.display = 'flex';
                document.getElementById('list-view').style.paddingTop = '110px';
                if(searchCenter) {
                    document.getElementById('status-pill').style.display = 'block';
                    document.getElementById('count-pill').style.display = 'block';
                    document.getElementById('map-radius-pill').style.display = 'block';
                }
                if(tab === 'map') { 
                    document.getElementById('map-view').style.display = 'block'; 
                    document.getElementById('center-marker').style.display = 'block';
                    updateToggleBtn('List', 'list');
                } else { 
                    document.getElementById('list-view').style.display = 'block'; 
                    updateToggleBtn('Map', 'map');
                }
                if(searchCenter) applyFilters();
            } else if(tab === 'recent') {
                document.getElementById('nav-recent').classList.add('active');
                document.getElementById('list-view').style.display = 'block';
                document.getElementById('list-view').style.paddingTop = '20px';
                renderStorageList('shultime_recents', 'Recent Shuls');
            } else if(tab === 'saved') {
                document.getElementById('nav-saved').classList.add('active');
                document.getElementById('list-view').style.display = 'block';
                document.getElementById('list-view').style.paddingTop = '20px';
                renderStorageList('shultime_favs', 'Saved Shuls');
            } else {
                document.getElementById('nav-' + tab).classList.add('active');
                document.getElementById(tab + '-view').style.display = 'block';
                if(tab === 'zmanim') renderZmanim();
            }
        }

        function toggleView() { if(currentTab === 'map') switchTab('list'); else switchTab('map'); }
        function updateToggleBtn(txt, icon) { document.getElementById('nav-toggle-text').innerText = txt; document.getElementById('nav-toggle-icon').innerText = icon; }

        // --- DETAILS & STORAGE ---
        function openDetails(m) {
            selectedShul = m;
            const nCls = `nusach-bg-${(m.nusach || 'Other').replace(/\s+/g, '-')}`;
            const godavenId = m.godaven_link ? m.godaven_link.split('/').pop() : m.id;
            const goDavenUrl = `https://www.godaven.com/shul-details/${godavenId}`;
            
            const mapLink = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(m.name + " " + m.address)}`;
            const dist = searchCenter ? getDistance(searchCenter.lat, searchCenter.lng, m.lat, m.lng).toFixed(1) : 0;
            
            document.getElementById('drawer-title').innerText = m.name;
            document.getElementById('drawer-address').innerText = m.address + ', ' + (m.city||'') + ', ' + (m.state||'') + ' ' + (m.zip||'');
            
            const updateBody = `Dear GoDaven,\n\nI would like to update the following Shul with these updates:\n\n[Type your updates here]\n\nThank you\n\nShul Info:\nName: ${m.name}\nAddress: ${m.address}\nLink: ${goDavenUrl}`;
            const updateMailto = `mailto:support@godaven.com?subject=Update Listing: ${encodeURIComponent(m.name)}&body=${encodeURIComponent(updateBody)}`;

            let notesHtml = "";
            if (m.notes || m.contact_info) {
                notesHtml = `
                    ${m.notes ? `<div style="margin-bottom:8px;"><strong>Notes:</strong> ${m.notes}</div>` : ''}
                    ${m.contact_info ? `<div style="margin-bottom:8px;"><strong>Contact:</strong> ${m.contact_info}</div>` : ''}
                `;
            } else {
                notesHtml = `<i>No additional notes available.</i>`;
            }

            document.getElementById('drawer-content').innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span class="nusach-tag-list ${nCls}" style="margin:0; font-size:12px; padding:4px 10px; border-radius:12px;">${m.nusach || 'Info'}</span>
                    <div style="font-weight:600; color:#555; font-size:15px; display:flex; align-items:center; gap:6px;"><i class="material-icons" style="font-size:16px;">person</i> ${m.rabbi || 'Not Listed'}</div>
                </div>
                
                <div onclick="window.open('${mapLink}','_blank')" style="display:flex; align-items:center; justify-content:space-between; background:#fafafa; border:1px solid #eee; padding:10px 15px; border-radius:16px; margin-top:15px; cursor:pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.02);">
                    <div style="display:flex; align-items:center; gap:12px;">
                        <div class="map-circle" style="width:36px; height:36px;"><i class="material-icons google-maps-icon" style="font-size:20px !important;">place</i></div>
                        <div>
                            <div style="font-weight:800; font-size:15px; color:#333;">Directions</div>
                            <div style="font-size:13px; color:#777; font-weight:600;">${dist} mi away</div>
                        </div>
                    </div>
                    <i class="material-icons" style="color:#bbb;">chevron_right</i>
                </div>

                <div class="contact-row">
                    <a href="tel:${m.phone || ''}" class="contact-btn ${!m.phone?'disabled':''}" ${!m.phone?'onclick="return false;"':''}><i class="material-icons" style="font-size:14px">call</i> Call</a>
                    <a href="${m.email ? 'mailto:'+m.email : '#'}" class="contact-btn ${!m.email?'disabled':''}" ${!m.email?'onclick="return false;"':''}><i class="material-icons" style="font-size:14px">email</i> Email</a>
                    <a href="${goDavenUrl}" target="_blank" class="contact-btn"><i class="material-icons" style="font-size:14px">open_in_new</i> GoDaven</a>
                    <button class="contact-btn" onclick="shareShul()"><i class="material-icons" style="font-size:14px">ios_share</i> Share</button>
                    <a href="${updateMailto}" class="contact-btn" style="flex-basis:100%; justify-content:center; background:#E3F2FD; color:#1565C0; border-color:#2196F3;"><i class="material-icons" style="font-size:14px">edit</i> Update Listing</a>
                </div>

                <div style="margin-top:20px; font-weight:800; border-bottom:1px solid #eee; padding-bottom:5px; font-size:16px; color:#333;">Weekday Schedule</div>
                <div class="schedule-grid">
                    <div><div style="font-weight:700; color:#666; font-size:12px; text-transform:uppercase; margin-bottom:4px;">Shacharis Sun</div>${formatPills(m.shacharis?.sun, m.nusach)}</div>
                    <div><div style="font-weight:700; color:#666; font-size:12px; text-transform:uppercase; margin-bottom:4px;">Shacharis M/Th</div>${formatPills(m.shacharis?.mon_thu, m.nusach)}</div>
                    <div><div style="font-weight:700; color:#666; font-size:12px; text-transform:uppercase; margin-bottom:4px;">Shacharis T/W/F</div>${formatPills(m.shacharis?.tue_wed_fri, m.nusach)}</div>
                    <div><div style="font-weight:700; color:#666; font-size:12px; text-transform:uppercase; margin-bottom:4px;">Mincha</div>${formatPills(m.mincha?.week, m.nusach)}</div>
                    <div><div style="font-weight:700; color:#666; font-size:12px; text-transform:uppercase; margin-bottom:4px;">Maariv</div>${formatPills(m.maariv?.week, m.nusach)}</div>
                </div>

                <div style="margin-top:20px; font-weight:800; border-bottom:1px solid #eee; padding-bottom:5px; font-size:16px; color:#333;">Shabbos Schedule</div>
                <div class="schedule-grid">
                    <div><div style="font-weight:700; color:#666; font-size:12px; text-transform:uppercase; margin-bottom:4px;">Friday Night</div>${formatPills(m.mincha?.fri, m.nusach)}</div>
                    <div><div style="font-weight:700; color:#666; font-size:12px; text-transform:uppercase; margin-bottom:4px;">Shabbos Shacharis</div>${formatPills(m.shacharis?.shabbos, m.nusach)}</div>
                    <div><div style="font-weight:700; color:#666; font-size:12px; text-transform:uppercase; margin-bottom:4px;">Mincha Shabbos</div>${formatPills(m.mincha?.shabbos, m.nusach)}</div>
                    <div><div style="font-weight:700; color:#666; font-size:12px; text-transform:uppercase; margin-bottom:4px;">Motzai Maariv</div>${formatPills(m.maariv?.shabbos, m.nusach)}</div>
                </div>

                <div style="margin-top:20px; font-weight:800; border-bottom:1px solid #eee; padding-bottom:5px; font-size:16px; color:#333;">Notes & Contacts</div>
                <div style="font-size:13px; color:#555; margin-top:8px; line-height:1.4;">
                    ${notesHtml}
                </div>
            `;
            
            addToStorage('shultime_recents', m.id);
            checkFavIcon(m.id);
            document.getElementById('details-drawer').classList.add('open');
            document.getElementById('scrim').style.display = 'block';
        }

        async function shareShul() {
            if(!selectedShul) return;
            const m = selectedShul;
            const godavenId = m.godaven_link ? m.godaven_link.split('/').pop() : m.id;
            const link = `https://www.godaven.com/shul-details/${godavenId}`;
            
            let timesText = "Schedule:\n";
            if(m.shacharis?.sun) timesText += `Shacharis Sun: ${m.shacharis.sun.join(', ')}\n`;
            if(m.shacharis?.mon_thu) timesText += `Shacharis M/Th: ${m.shacharis.mon_thu.join(', ')}\n`;
            if(m.mincha?.week) timesText += `Mincha: ${m.mincha.week.join(', ')}\n`;
            if(m.maariv?.week) timesText += `Maariv: ${m.maariv.week.join(', ')}\n`;

            const text = `Shared via ShulTime:\n\n*${m.name}*\n${m.address}\n\nNusach: ${m.nusach}\n\n${timesText}\nLink: ${link}`;
            
            if(navigator.share) { try { await navigator.share({ title: m.name, text: text }); } catch(e) {} } 
            else { navigator.clipboard.writeText(text); alert("Copied to clipboard!"); }
        }

        function addToStorage(key, id) {
            let data = JSON.parse(localStorage.getItem(key) || "[]");
            data = [id, ...data.filter(x => x !== id)].slice(0, 20);
            localStorage.setItem(key, JSON.stringify(data));
        }

        function toggleFavorite() {
            if(!selectedShul) return;
            const id = selectedShul.id;
            let favs = JSON.parse(localStorage.getItem('shultime_favs') || "[]");
            if(favs.includes(id)) favs = favs.filter(x => x !== id); else favs.push(id);
            localStorage.setItem('shultime_favs', JSON.stringify(favs));
            checkFavIcon(id);
        }

        function checkFavIcon(id) {
            const favs = JSON.parse(localStorage.getItem('shultime_favs') || "[]");
            document.getElementById('drawer-fav-icon').innerText = favs.includes(id) ? 'bookmark' : 'bookmark_border';
        }

        function renderStorageList(key, title) {
            currentStorageKey = key;
            const container = document.getElementById('list-view');
            
            const headerHtml = `
                <div class="list-page-header" style="display:flex; justify-content:space-between; align-items:center;">
                    <span>${title}</span>
                    <button onclick="toggleEditList()" style="background:var(--primary); color:#fff; border:none; padding:6px 16px; border-radius:12px; font-weight:800; font-size:13px; cursor:pointer;">
                        ${isEditingList ? 'Done' : 'Edit'}
                    </button>
                </div>
            `;

            const ids = JSON.parse(localStorage.getItem(key) || "[]");
            if(ids.length === 0) { 
                container.innerHTML = headerHtml + `<div class="empty-state">No ${title.toLowerCase()}.</div>`; 
                return; 
            }

            const now = new Date(); const nowVal = now.getHours() * 60 + now.getMinutes();
            const shuls = [];
            ids.forEach(id => {
                const matches = allMinyanim.filter(m => m.id === id);
                if(matches.length) {
                    let best = matches.find(m => m.timeValue >= nowVal && m.timeValue !== 9999) || matches.find(m => m.timeValue !== 9999) || matches[0];
                    shuls.push({...best, distance: searchCenter ? getDistance(searchCenter.lat, searchCenter.lng, best.lat, best.lng) : 0});
                }
            });
            
            container.innerHTML = headerHtml;
            renderList(shuls, key);
        }

        function toggleEditList() {
            isEditingList = !isEditingList;
            const title = currentStorageKey === 'shultime_recents' ? 'Recent Shuls' : 'Saved Shuls';
            renderStorageList(currentStorageKey, title);
            
            // Sync with sticky header if it is currently visible
            const header = document.getElementById('sticky-header');
            if(header.classList.contains('visible')) {
                header.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center; width:100%; padding: 0 15px;">
                        <span>${title}</span>
                        <button onclick="toggleEditList()" style="background:transparent; color:var(--primary); border:none; font-weight:800; font-size:15px; cursor:pointer; padding:0;">
                            ${isEditingList ? 'Done' : 'Edit'}
                        </button>
                    </div>
                `;
            }
        }

        function deleteStorageItem(id) {
            let items = JSON.parse(localStorage.getItem(currentStorageKey) || "[]");
            items = items.filter(x => x !== id);
            localStorage.setItem(currentStorageKey, JSON.stringify(items));
            
            const title = currentStorageKey === 'shultime_recents' ? 'Recent Shuls' : 'Saved Shuls';
            renderStorageList(currentStorageKey, title);
        }

        // --- UTILS & FILTERS ---
        function formatTime(h, m) { return `${h > 12 ? h - 12 : (h === 0 ? 12 : h)}:${String(m).padStart(2, "0")}${h >= 12 ? 'pm' : 'am'}`; }
        function timeToVal(t) { const [h,m] = t.split(':').map(Number); return (h*60)+m; }
        function getDistance(lat1, lon1, lat2, lon2){
            const R = 3958.8; const dLat = (lat2-lat1)*Math.PI/180; const dLon = (lon2-lon1)*Math.PI/180;
            const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
            return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
        }
        function getDayKey(d) { const wk = d.getDay(); if(wk===0) return 'sun'; if(wk===1||wk===4) return 'mon_thu'; return 'tue_wed_fri'; }
        
        function formatPills(list, nusach) {
            if(!list || list.length === 0) return "<span style='font-size:12px; color:#999; font-weight:600;'>None</span>";
            const nCls = `nusach-bg-${(nusach || 'Other').replace(/\s+/g, '-')}`;
            return list.map(t => {
                let clean = t.split(' ')[0]; let [h, m] = clean.split(':').map(Number);
                if(isNaN(h)) return t;
                return `<span class="time-pill ${nCls}">${formatTime(h, m || 0)}</span>`;
            }).join("");
        }

        function manualRadiusUpdate(val) {
            currentRadius = parseFloat(val);
            document.getElementById('radius-slider').value = val;
            document.getElementById('radius-input').value = val;
            
            const chips = document.getElementById('radius-group').querySelectorAll('.chip');
            chips.forEach(c => c.classList.remove('active', 'chip-all'));
            chips.forEach(c => { 
                if(c.innerText === String(val)) c.classList.add('active', 'chip-all'); 
            });

            if(map && searchCenter) {
                isProgrammaticMove = true;
                map.setZoom(val > 10 ? 11 : (val > 3 ? 13 : 15));
                setTimeout(() => { isProgrammaticMove = false; applyFilters(); }, 500);
            } else { applyFilters(); }
        }

        function setNextTwoHours() {
            const now = new Date();
            document.getElementById('time-start').value = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
            const next = new Date(now.getTime() + 7200000); // 2 hours
            document.getElementById('time-end').value = `${String(next.getHours()).padStart(2,'0')}:${String(next.getMinutes()).padStart(2,'0')}`;
            applyFilters();
        }

        function resetTime() { document.getElementById('time-start').value="00:00"; document.getElementById('time-end').value="23:59"; applyFilters(); }
        
        function resetFilters() {
            filters = { tefillah: '', nusach: '', sort: 'time' };
            manualRadiusUpdate(20);
            document.getElementById('time-start').value="00:00";
            document.getElementById('time-end').value="23:59";
            
            // Reset visual active state for chips
            document.querySelectorAll('.chip-group').forEach(group => {
                group.querySelectorAll('.chip').forEach(c => c.classList.remove('active', 'chip-all'));
                const firstChip = group.querySelector('.chip'); 
                if(firstChip) firstChip.classList.add('active', 'chip-all');
            });
            applyFilters();
        }

        function toggleFilters() { const d = document.getElementById('filter-drawer'); d.style.display = (d.style.display==='block'?'none':'block'); }
        
        function setFilter(k,v,btn) { 
            filters[k]=v; 
            const group = btn.parentElement;
            group.querySelectorAll('.chip').forEach(c => c.classList.remove('active', 'chip-all')); 
            btn.classList.add('active'); 
            if(v === '' || k === 'sort') { btn.classList.add('chip-all'); }
            applyFilters(); 
        }

        function closeDetails() { document.getElementById('details-drawer').classList.remove('open'); document.getElementById('scrim').style.display='none'; }

        function changeDate(n) { currentFilterDate.setDate(currentFilterDate.getDate()+n); updateDateDisplay(); processMinyanim(); if(currentTab==='zmanim') renderZmanim(); }
        
        function updateDateDisplay() {
            const dStr = currentFilterDate.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric', year: 'numeric' });
            const hStr = HebCal.getHebrewStr(currentFilterDate);
            document.getElementById('date-display').innerText = dStr; document.getElementById('hebrew-date').innerText = hStr;
            document.getElementById('zman-date-display').innerText = dStr; document.getElementById('zman-hebrew-date').innerText = hStr;
            document.getElementById('zman-day').innerText = currentFilterDate.toLocaleDateString('en-US', {weekday:'long'});
            document.getElementById('zman-daf').innerText = DafEngine.get(currentFilterDate);
        }

        // FULL 10-ITEM ZMANIM CALCULATION WITH SHAOT ZMANIYOT & SECONDS
        function renderZmanim() {
            if(searchCenter) { zmanLoc.lat = searchCenter.lat; zmanLoc.lng = searchCenter.lng; zmanLoc.name = document.getElementById('status-pill').innerText.replace('Near: ', ''); }
            document.getElementById('zman-loc-badge').innerText = zmanLoc.name;
            const data = Solar.calc(currentFilterDate, zmanLoc.lat, zmanLoc.lng, 30);
            
            const fmt = ms => ms ? new Date(ms).toLocaleTimeString([], {hour:'numeric', minute:'2-digit', second:'2-digit'}) : "--:--:--";
            const shaahZmanit = (data.sunset - data.sunrise) / 12;
            
            const zList = [
                { l: "Alos Hashachar (16.1)", t: data.alot },
                { l: "Misheyakir (11.5)", t: data.misheyakir },
                { l: "Sunrise (Netz)", t: data.sunrise },
                { l: "Sof Zman Krias Shema (GRA)", t: data.sunrise + (shaahZmanit * 3) },
                { l: "Sof Zman Tefillah (GRA)", t: data.sunrise + (shaahZmanit * 4) },
                { l: "Chatzos (Midday)", t: data.noon },
                { l: "Mincha Gedolah", t: data.noon + (shaahZmanit * 0.5) },
                { l: "Mincha Ketanah", t: data.sunrise + (shaahZmanit * 9.5) },
                { l: "Plag HaMincha", t: data.sunrise + (shaahZmanit * 10.75) },
                { l: "Sunset (Shkia)", t: data.sunset },
                { l: "Tzais (8.5)", t: data.tzais }
            ];

            let html = "";
            zList.forEach(z => {
                html += `<div class="zman-card">
                    <span class="zman-label">${z.l}</span>
                    <span class="zman-time">${fmt(z.t)}</span>
                </div>`;
            });
            document.getElementById('zmanim-content').innerHTML = html;
        }

        function useMyLocation() {
            navigator.geolocation.getCurrentPosition(p => {
                setSearchLocation(p.coords.latitude, p.coords.longitude, "Current Location");
            }, e => alert("Please enable GPS."));
        }

        function setSearchLocation(lat, lng, name) {
            searchCenter = {lat, lng};
            document.getElementById('status-pill').innerText = "Near: " + name;
            
            const dummyInput = document.getElementById("dummy-search-text");
            if (dummyInput) { dummyInput.innerText = name; dummyInput.style.color = '#111'; }

            if(map) { 
                isProgrammaticMove = true;
                map.setCenter(searchCenter); 
                map.setZoom(13); 
                // Increased timeout to prevent idle event collision with recenter
                setTimeout(() => { isProgrammaticMove = false; applyFilters(); }, 600);
            } else {
                applyFilters();
            }
            if(currentTab !== 'list' && currentTab !== 'map') {
                switchTab('map');
            }
        }

        function renderWelcome() {
            document.getElementById('list-view').innerHTML = `<div class="empty-state" style="margin-top:80px;"><i class="material-icons" style="font-size:54px; color:var(--primary); margin-bottom:15px;">explore</i><br><strong style="font-size:18px;">Welcome to ShulTime</strong><br><br>Search for a city or zip code to begin.</div>`;
        }

        function saveProfile() {
            const name = document.getElementById('profile-name').value;
            const phone = document.getElementById('profile-phone').value;
            localStorage.setItem('shultime_profile', JSON.stringify({ name, phone }));
        }
        function loadProfile() {
            const p = JSON.parse(localStorage.getItem('shultime_profile') || "{}");
            if(p.name) document.getElementById('profile-name').value = p.name;
            if(p.phone) document.getElementById('profile-phone').value = p.phone;
        }

        async function initApp(){
            const { Map } = await google.maps.importLibrary("maps");
            const { Place } = await google.maps.importLibrary("places");
            geocoder = new google.maps.Geocoder();

            map = new Map(document.getElementById("map-view"), {
                center: { lat: 40.091, lng: -74.218 }, zoom: 12, mapId: "DEMO_MAP_ID", disableDefaultUI: true, clickableIcons: false
            });

            // Map Drag / Reverse Geocoding updates Dummy Search Bar
            map.addListener('idle', () => {
                if(isProgrammaticMove) return;
                const c = map.getCenter();
                const bounds = map.getBounds();
                if(!c || !bounds) return;

                searchCenter = {lat: c.lat(), lng: c.lng()};
                
                geocoder.geocode({ location: c }).then(res => {
                    if(res.results[0]) {
                        let cityResult = res.results.find(r => r.types.includes("locality"));
                        let name = cityResult ? cityResult.formatted_address.split(',')[0] : res.results[0].formatted_address.split(',')[0];
                        document.getElementById('status-pill').innerText = "Near: " + name;
                        
                        // Push text to Dummy Search Bar
                        const dummyInput = document.getElementById("dummy-search-text");
                        if (dummyInput) { dummyInput.innerText = name; dummyInput.style.color = '#111'; }
                    }
                }).catch(e => { document.getElementById('status-pill').innerText = "Near: Map Center"; });
                
                const ne = bounds.getNorthEast();
                const r = getDistance(c.lat(), c.lng(), ne.lat(), ne.lng());
                updateRadiusUI(r.toFixed(1));
                applyFilters();
            });

            // Handle the modern Web Component inside the overlay
            const autocompleteEl = document.getElementById("gmp-autocomplete");
            if(autocompleteEl) {
                autocompleteEl.addEventListener("gmp-placeselect", async (e) => {
                    if (e.place) {
                        if (document.activeElement) document.activeElement.blur();
                        
                        try {
                            // NEW: Await explicit fetching of location fields
                            await e.place.fetchFields({ fields: ["location", "displayName", "formattedAddress"] });
                            
                            if (e.place.location) {
                                const lat = e.place.location.lat();
                                const lng = e.place.location.lng();
                                const name = e.place.displayName || e.place.formattedAddress || 'Selected Location';
                                
                                setSearchLocation(lat, lng, name);
                            }
                            
                            closeSearchOverlay();
                            
                            // Clear out the search overlay input so it is fresh next time
                            autocompleteEl.inputValue = '';
                            autocompleteEl.value = '';
                        } catch(err) {
                            console.error("Place fetch error: ", err);
                        }
                    }
                });
            }
        }

        function updateRadiusUI(r) {
            currentRadius = parseFloat(r);
            document.getElementById('radius-slider').value = currentRadius;
            document.getElementById('radius-input').value = currentRadius;
        }

    </script>
    <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAOpNebt0dPJUmiEw-i1W-Dx_UezLpIvxI&loading=async&libraries=places,maps,marker&callback=initApp"></script>
</body>
</html>
