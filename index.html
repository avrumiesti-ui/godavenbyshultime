<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ShulTime Diagnostic</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        :root { --primary: #0D2B4F; --bg: #F2F4F8; }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Roboto", sans-serif; background: var(--bg); color: #111; padding-bottom: 200px; }
        
        /* FLOATING HEADER */
        .floating-header {
            position: fixed; top: 10px; left: 10px; right: 10px; z-index: 1000;
            display: flex; flex-direction: column; gap: 8px; pointer-events: none;
        }

        .top-row { display: flex; gap: 8px; width: 100%; pointer-events: auto; }

        /* SEARCH CONTAINER */
        .search-container {
            flex-grow: 1; background: white; height: 50px; border-radius: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15); display: flex; align-items: center;
            padding-left: 15px; padding-right: 5px; overflow: hidden;
        }

        /* GOOGLE INPUT OVERRIDE */
        gmp-place-autocomplete { width: 100%; display: inline-block; }
        gmp-place-autocomplete::part(input) {
            border: none; background: transparent; padding: 0; font-size: 16px; color: #111; outline: none; height: 100%;
        }

        /* BUTTONS */
        .circle-btn {
            width: 50px; height: 50px; border-radius: 50%; background: white; border: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15); display: flex; align-items: center; justify-content: center;
            cursor: pointer; color: var(--primary); font-weight: bold; font-size: 12px;
        }
        .apply-btn { background: #4CAF50; color: white; border-radius: 12px; width: auto; padding: 0 15px; }

        /* DEBUG CONSOLE */
        #debug-console {
            position: fixed; bottom: 0; left: 0; right: 0; height: 150px;
            background: black; color: #0f0; font-family: monospace; font-size: 11px;
            padding: 10px; overflow-y: scroll; z-index: 9999; opacity: 0.9;
            border-top: 2px solid #0f0;
        }

        /* LIST & CARD STYLES */
        #list-view { padding: 12px; padding-top: 130px; } /* Extra padding for header */
        .minyan-card {
            background: white; border-radius: 12px; padding: 16px; margin-bottom: 10px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.04);
            border-left: 5px solid #ccc;
        }
        .type-Shacharis { border-left-color: #4CAF50; } 
        .type-Mincha { border-left-color: #FF9800; }    
        .type-Maariv { border-left-color: #3F51B5; }    

        .card-left h3 { margin: 0; font-size: 16px; color: var(--primary); }
        .distance-tag { font-size: 11px; color: #fff; background: #666; padding: 2px 6px; border-radius: 8px; margin-left: 5px; }
        .time-display { font-size: 20px; font-weight: 800; color: var(--primary); }
        
        /* MAP */
        #map-view { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 150px; z-index: 0; }
        
        /* STATUS PILL */
        #status-pill {
            background: rgba(255, 255, 255, 0.95); padding: 8px 16px; border-radius: 20px;
            text-align: center; font-size: 12px; font-weight: 600; color: #333;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); pointer-events: auto;
            align-self: center; border: 1px solid #ddd;
        }
    </style>
</head>
<body>

    <div class="floating-header">
        <div class="top-row">
            <div class="search-container">
                <i class="material-icons" style="color:#888; margin-right:8px;">search</i>
                <div id="place-autocomplete-container" style="flex-grow:1;"></div>
            </div>

            <button class="circle-btn apply-btn" onclick="manualApply()">
                APPLY
            </button>
        </div>
        
        <div class="top-row" style="justify-content: center;">
            <div id="status-pill">System Ready.</div>
        </div>

        <div class="top-row" style="justify-content: center; gap:15px;">
            <button class="circle-btn" onclick="useMyLocation()"><i class="material-icons">my_location</i></button>
            <button class="circle-btn" onclick="toggleView()"><i class="material-icons">map</i></button>
            <button class="circle-btn" onclick="location.reload()"><i class="material-icons">refresh</i></button>
        </div>
    </div>

    <div id="list-view"></div>
    <div id="map-view"></div>

    <div id="debug-console">Initializing Diagnostic Mode...<br></div>

    <script>
        // --- DIAGNOSTIC LOGGER ---
        function log(msg) {
            const consoleDiv = document.getElementById('debug-console');
            const time = new Date().toLocaleTimeString();
            consoleDiv.innerHTML += `[${time}] ${msg}<br>`;
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
            console.log(msg);
        }

        // --- GLOBAL STATE ---
        let map, allMinyanim = [];
        let searchCenter = null; 
        const DEFAULT_RADIUS = 20; 

        // 1. INIT
        log("Fetching database...");
        fetch('database.json')
            .then(r => r.json())
            .then(data => {
                log(`Database loaded: ${data.length} shuls.`);
                processMinyanim(data);
            })
            .catch(e => log("DB ERROR: " + e.message));

        function processMinyanim(data) {
            allMinyanim = [];
            data.forEach(shul => {
                ['Shacharis','Mincha','Maariv'].forEach(type => {
                    if(!shul[type.toLowerCase()]) return;
                    shul[type.toLowerCase()].split(',').forEach(t => {
                        let raw = t.trim().replace(/[^0-9:]/g, '');
                        let [h, m] = raw.split(':').map(Number);
                        let isPM = (type==='Maariv' || (type==='Mincha' && h<9));
                        let sortH = (isPM && h<12) ? h+12 : ((!isPM && h===12) ? 0 : h);
                        allMinyanim.push({
                            name: shul.name, address: shul.address,
                            lat: shul.lat, lng: shul.lng, nusach: shul.nusach,
                            tefillah: type, timeDisplay: `${h}:${String(m).padStart(2,'0')}`,
                            ampm: isPM ? "PM" : "AM", timeValue: (sortH*60)+m, distance: null
                        });
                    });
                });
            });
            log(`Processed ${allMinyanim.length} minyanim times.`);
        }

        // 2. GOOGLE MAPS INIT
        async function initApp() {
            log("Google API Loaded. Importing libraries...");
            try {
                const { PlaceAutocompleteElement } = await google.maps.importLibrary("places");
                const { Map } = await google.maps.importLibrary("maps");

                // Setup Search Input
                const container = document.getElementById('place-autocomplete-container');
                if(!container) { log("ERROR: Container missing!"); return; }

                const autocomplete = new PlaceAutocompleteElement();
                autocomplete.id = "place-input";
                autocomplete.placeholder = "Search City...";
                container.appendChild(autocomplete);
                log("Search Input Created.");

                // LISTENER
                autocomplete.addEventListener('gmp-places-select', async ({ place }) => {
                    log("EVENT FIRED: Place Selected!");
                    try {
                        await place.fetchFields({ fields: ['displayName', 'location'] });
                        
                        const lat = place.location.lat();
                        const lng = place.location.lng();
                        const name = place.displayName;
                        
                        log(`Location Found: ${name} (${lat.toFixed(4)}, ${lng.toFixed(4)})`);
                        
                        // SET CENTER
                        searchCenter = { lat, lng, name };
                        updateStatus(`Selected: ${name}`);
                        
                        // RUN SEARCH
                        runSearch();

                    } catch(err) {
                        log("ERROR fetching place details: " + err.message);
                    }
                });

                // Setup Hidden Map
                map = new Map(document.getElementById("map-view"), { 
                    center: {lat:40, lng:-74}, zoom: 14, disableDefaultUI: true, mapId: "DEMO_MAP_ID" 
                });
                log("Map Initialized.");

            } catch (e) {
                log("INIT CRITICAL FAILURE: " + e.message);
            }
        }

        // 3. MANUAL APPLY BUTTON (The fallback)
        function manualApply() {
            log("Button Clicked: Checking Status...");
            if(searchCenter) {
                log(`Center exists: ${searchCenter.name}. Re-running search.`);
                runSearch();
            } else {
                log("No location selected yet. Trying to force read...");
                const el = document.querySelector('gmp-place-autocomplete');
                if(el && el.value) {
                    log(`Input has text: "${el.value.name || el.value}". But no event fired.`);
                    alert("Diagnostic: Input has value but event didn't fire. Try clicking the dropdown item again slowly.");
                } else {
                    log("Input is empty.");
                    alert("Please select a city from the dropdown first.");
                }
            }
        }

        // 4. SEARCH LOGIC
        function runSearch() {
            if(!searchCenter) { log("Aborting search: No center."); return; }
            
            log(`Running Radius Search (${DEFAULT_RADIUS} mi)...`);
            
            // Calc Distances
            let results = allMinyanim.map(m => {
                m.distance = getDistance(searchCenter.lat, searchCenter.lng, m.lat, m.lng);
                return m;
            }).filter(m => m.distance <= DEFAULT_RADIUS);

            results.sort((a,b) => a.distance - b.distance);
            
            log(`Found ${results.length} results.`);
            renderList(results);
            
            if(map) {
                map.setCenter(searchCenter);
                map.setZoom(13);
            }
        }

        function renderList(results) {
            const list = document.getElementById('list-view');
            list.innerHTML = '';
            if(results.length === 0) {
                list.innerHTML = `<div style="text-align:center; padding:20px; color:#888;">No results found near ${searchCenter.name}.</div>`;
                return;
            }
            results.forEach(m => {
                const card = document.createElement('div');
                card.className = `minyan-card type-${m.tefillah}`;
                card.innerHTML = `
                    <div class="card-left">
                        <h3>${m.name} <span class="distance-tag">${m.distance.toFixed(1)} mi</span></h3>
                        <span style="font-size:12px; color:#666;">${m.address}</span>
                    </div>
                    <div class="card-right">
                        <div class="time-display">${m.timeDisplay}<span style="font-size:12px;">${m.ampm}</span></div>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        // 5. UTILS
        function useMyLocation() {
            log("Requesting GPS...");
            navigator.geolocation.getCurrentPosition(pos => {
                log("GPS Success.");
                searchCenter = { lat: pos.coords.latitude, lng: pos.coords.longitude, name: "GPS Location" };
                updateStatus("Using GPS Location");
                runSearch();
            }, err => log("GPS Error: " + err.message));
        }

        function updateStatus(msg) {
            document.getElementById('status-pill').innerText = msg;
        }

        function toggleView() {
            const list = document.getElementById('list-view');
            const mapV = document.getElementById('map-view');
            if(list.style.display !== 'none') {
                list.style.display='none'; mapV.style.display='block';
            } else {
                list.style.display='block'; mapV.style.display='none';
            }
        }

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 3958.8; 
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2); 
            return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a))); 
        }

    </script>
    <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAOpNebt0dPJUmiEw-i1W-Dx_UezLpIvxI&loading=async&libraries=places,maps,marker&callback=initApp"></script>
</body>
</html>
