<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>ShulTime</title>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<style>
    /* --- 1. GLOBAL VARIABLES & COLORS --- */
    :root { 
        --primary: #0D2B4F; 
        --bg: #F2F4F8; 
        
        /* NUSACH PALETTE */
        --ashkenaz-bg: #E3F2FD; --ashkenaz-text: #1565C0;
        --sefard-bg: #E8F5E9;   --sefard-text: #2E7D32;
        --ari-bg: #F3E5F5;      --ari-text: #7B1FA2;
        --chabad-bg: #FFF3E0;   --chabad-text: #E65100;
        --edot-bg: #FBE9E7;     --edot-text: #D84315;
        --other-bg: #EEEEEE;    --other-text: #616161;
        
        /* TEFILLAH COLORS (Text Only) */
        --color-Shacharis: #2E7D32; 
        --color-Mincha: #E65100;    
        --color-Maariv: #1565C0; 
    }
    
    html, body { margin: 0; padding: 0; height: 100%; overscroll-behavior-y: contain; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Roboto", sans-serif; background: var(--bg); overflow: hidden; color: #333; -webkit-tap-highlight-color: transparent; }
    
    /* --- 2. HEADER & SEARCH --- */
    .floating-header {
        position: fixed; top: 15px; left: 12px; right: 12px;
        z-index: 1000; display: flex; gap: 10px; align-items: center; pointer-events: auto;
    }
    .search-container {
        flex: 1; display: flex; align-items: center;
        background: #fff; height: 50px; border-radius: 25px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.12); padding: 0 15px; overflow: hidden; 
    }
    gmp-place-autocomplete { width: 100%; height: 100%; background-color: #fff !important; }
    
    .circle-btn {
        width: 50px; height: 50px; flex-shrink: 0;
        border-radius: 50%; background: #fff; border: none;
        box-shadow: 0 4px 15px rgba(0,0,0,0.12); display: flex; align-items: center; justify-content: center;
        cursor: pointer; color: var(--primary); 
    }

    /* STATUS PILLS */
    .status-area {
        position: fixed; top: 75px; left: 0; right: 0;
        display: flex; justify-content: center; align-items: center; gap: 8px;
        z-index: 800; pointer-events: none; padding: 0 10px;
    }
    #status-pill, #count-pill, #map-radius-pill {
        padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: 700;
        display: none; box-shadow: 0 2px 8px rgba(0,0,0,0.1); white-space: nowrap;
        background: #fff; color: var(--primary); border: 1px solid var(--primary);
    }
    #status-pill { background: rgba(13, 43, 79, 0.95); color: #fff; border: none; }
    #map-radius-pill { background: #2E7D32; color: #fff; border: none; }

    /* --- 3. VIEWS LAYOUT --- */
    .view-container { 
        position: absolute; inset: 0; 
        padding-bottom: 120px; 
        overflow-y: auto; background: var(--bg); 
        display: none; z-index: 10;
        -webkit-overflow-scrolling: touch;
    }
    #map-view { padding: 0; z-index: 5; } 

    /* --- 4. LIST CARDS (COLOR CODED) --- */
    .minyan-card {
        background: #fff; border-radius: 12px; margin-bottom: 8px;
        display: flex; justify-content: space-between; align-items: stretch;
        box-shadow: 0 2px 5px rgba(0,0,0,0.03); overflow: hidden; 
        height: 85px; box-sizing: border-box; position: relative;
    }
    .info-zone { 
        width: 60%; padding: 8px 12px; display: flex; flex-direction: column; justify-content: flex-start; 
        border-right: 1px solid #f0f0f0; cursor:pointer; 
    }
    .map-zone { 
        width: 40%; background: #fafafa; position: relative; cursor:pointer; 
    }
    
    .shul-name { font-weight: 800; font-size: 16px; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 2px; }
    .shul-address { font-size: 12px; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.2; }
    .shul-city { font-size: 11px; color: #999; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 4px; line-height: 1.2; }
    
    .nusach-tag { 
        font-size: 10px; padding: 2px 8px; border-radius: 6px; 
        display: inline-block; font-weight: 700; text-transform: uppercase; width: fit-content; 
    }
    
    /* DYNAMIC COLORS */
    .n-Ashkenaz { background: var(--ashkenaz-bg) !important; color: var(--ashkenaz-text) !important; border-color: var(--ashkenaz-text) !important; }
    .n-Sefard { background: var(--sefard-bg) !important; color: var(--sefard-text) !important; border-color: var(--sefard-text) !important; }
    .n-Ari { background: var(--ari-bg) !important; color: var(--ari-text) !important; border-color: var(--ari-text) !important; }
    .n-Chabad { background: var(--chabad-bg) !important; color: var(--chabad-text) !important; border-color: var(--chabad-text) !important; }
    .n-Edot-HaMizrach { background: var(--edot-bg) !important; color: var(--edot-text) !important; border-color: var(--edot-text) !important; }
    .n-Other { background: var(--other-bg) !important; color: var(--other-text) !important; border-color: var(--other-text) !important; }

    /* RIGHT SIDE LAYOUT */
    .tefillah-label { position: absolute; top: 8px; right: 40px; font-size: 10px; font-weight: 900; text-transform: uppercase; letter-spacing: 0.5px; } 
    .type-Shacharis .tefillah-label { color: var(--color-Shacharis); }
    .type-Mincha .tefillah-label { color: var(--color-Mincha); }
    .type-Maariv .tefillah-label { color: var(--color-Maariv); }

    .time-val-card { 
        position: absolute; top: 50%; right: 40px; transform: translateY(-50%); 
        padding: 4px 8px; border-radius: 8px; font-weight: 800; font-size: 16px; white-space: nowrap; 
    }
    .dist-row { position: absolute; bottom: 8px; right: 40px; display: flex; align-items: center; gap: 4px; font-size: 11px; font-weight: 800; color: #666; }
    
    .map-circle { 
        position: absolute; top: 50%; right: 8px; transform: translateY(-50%);
        width: 26px; height: 26px; border-radius: 50%; background: #fff; 
        display: flex; align-items: center; justify-content: center; border: 1px solid #eee; 
        box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
    }
    .google-maps-icon { font-size: 16px !important; color: #4285F4; }

    /* CUSTOM MARKERS */
    .custom-marker { 
        padding: 4px 8px; border-radius: 8px; background: white; 
        font-weight: 800; font-size: 12px; box-shadow: 0 3px 6px rgba(0,0,0,0.3); 
        border: 2px solid #555; position: relative; top: -10px; cursor: pointer;
    }
    .custom-marker::after { content: ""; position: absolute; bottom: -5px; left: 50%; transform: translateX(-50%); border-width: 5px 5px 0; border-style: solid; border-color: white transparent transparent transparent; }
    .marker-Ashkenaz { border-color: var(--ashkenaz-text); color: var(--ashkenaz-text); }
    .marker-Sefard { border-color: var(--sefard-text); color: var(--sefard-text); }
    /* ... other markers match n-classes above ... */

    /* --- 5. DETAILS DRAWER --- */
    #details-drawer {
        position: fixed; bottom: -100%; left: 10px; right: 10px; height: 70vh;
        background: #fff; border-radius: 25px; 
        z-index: 3000; margin-bottom: 15px;
        box-shadow: 0 5px 30px rgba(0,0,0,0.3); transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1);
        display: flex; flex-direction: column; overflow: hidden;
    }
    #details-drawer.open { bottom: 0; transform: translateY(0); }

    .drawer-header {
        padding: 20px; border-bottom: 1px solid #f0f0f0;
        display: flex; justify-content: space-between; align-items: flex-start;
    }
    .drawer-titles { flex: 1; padding-right: 10px; }
    .drawer-h1 { font-size: 22px; font-weight: 800; color: var(--primary); margin: 0 0 4px 0; line-height: 1.1; }
    .drawer-addr { font-size: 13px; color: #666; font-weight: 500; }
    .drawer-actions { display: flex; gap: 8px; }
    .action-circle { 
        width: 40px; height: 40px; border-radius: 50%; 
        background: #f5f5f5; border: 1px solid #eee; color: #555;
        display: flex; align-items: center; justify-content: center; cursor: pointer;
    }
    .drawer-body { flex: 1; overflow-y: auto; padding: 20px; }

    .d-info-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .d-rabbi { display: flex; align-items: center; gap: 6px; font-weight: 600; color: #444; font-size: 14px; }
    .d-nusach-badge { padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 700; text-transform: uppercase; }

    .d-contact-grid { display: flex; gap: 10px; margin-bottom: 25px; overflow-x:auto; }
    .d-contact-btn { 
        background: #fff; border: 1px solid #ddd; padding: 8px 12px; border-radius: 20px; 
        text-align: center; font-size: 12px; font-weight: 700; color: #333; 
        text-decoration: none; display: flex; align-items: center; justify-content: center; gap: 6px; white-space:nowrap;
    }

    .d-schedule-title { font-size: 16px; font-weight: 800; color: var(--primary); margin-bottom: 12px; border-bottom: 2px solid #f0f0f0; padding-bottom: 8px; }
    .d-schedule-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .d-sched-item { margin-bottom: 5px; }
    .d-sched-day { font-size: 11px; color: #999; font-weight: 700; text-transform: uppercase; margin-bottom: 4px; }
    .d-sched-times { display: flex; flex-wrap: wrap; gap: 4px; }
    .d-time-pill { padding: 3px 8px; border-radius: 6px; font-size: 13px; font-weight: 700; }

    /* --- 6. PAGE HEADERS (Top Layout) --- */
    .page-title-block {
        padding: 50px 20px 15px; 
        background: var(--bg);
    }
    .page-main-title { font-size: 36px; font-weight: 800; color: var(--primary); margin: 0; }
    .empty-state { text-align: center; color: #888; margin-top: 40px; font-size: 15px; }

    /* --- 7. ZMANIM --- */
    .z-header { background: #fff; padding: 40px 20px 15px; border-bottom: 1px solid #eee; position: sticky; top: 0; z-index: 20; }
    .z-title { font-size: 34px; font-weight: 800; color: var(--primary); margin: 0 0 10px 0; display:flex; justify-content:space-between; align-items:center;}
    .z-loc-badge { font-size: 12px; background: #E3F2FD; color: var(--primary); padding: 5px 12px; border-radius: 15px; font-weight: 700; cursor: pointer; border: none; }
    
    .date-nav { display: flex; align-items: center; justify-content: space-between; background: #f8f9fa; padding: 6px; border-radius: 12px; margin-top: 10px; border: 1px solid #eee; cursor: pointer; }
    .date-btn { background: none; border: none; font-size: 24px; color: var(--primary); cursor: pointer; display:flex; align-items:center; }
    .date-center { text-align: center; }
    .date-civ { font-weight: 800; font-size: 15px; color: #333; }
    .date-heb { font-size: 12px; color: #666; }
    .z-info-row { display: flex; gap: 10px; margin-top: 15px; }
    .z-info-pill { flex: 1; background: #fff; border: 1px solid #eee; padding: 10px; border-radius: 12px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
    .z-label-sm { font-size: 10px; color: #999; font-weight: 700; text-transform: uppercase; display: block; margin-bottom: 4px; }
    .z-val-lg { font-size: 14px; font-weight: 800; color: #333; }
    .z-list { list-style: none; padding: 20px 15px; margin: 0; display: flex; flex-direction: column; gap: 10px; }
    .z-card { background: #fff; border-radius: 14px; padding: 12px 16px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); border: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; }
    .z-label { font-size: 15px; font-weight: 700; color: #333; }
    .z-desc { font-size: 11px; color:#888; display:block;}
    .z-time { font-size: 18px; font-weight: 800; color: var(--primary); font-family: monospace; }
    .z-select { display: block; margin-top: 2px; font-size: 10px; background: #f1f5f9; border: none; padding: 2px 6px; border-radius: 4px; color: #555; font-weight: 700; }
    .z-glossary { padding: 0 20px 100px; }
    .z-glossary details { background: #fff; border: 1px solid #eee; border-radius: 12px; margin-bottom: 8px; overflow: hidden; }
    .z-glossary summary { padding: 12px; font-size: 14px; font-weight: 700; color: #555; background: #fafafa; cursor: pointer; outline: none; }
    .z-glossary div { padding: 15px; font-size: 13px; line-height: 1.5; color: #666; border-top: 1px solid #eee; }

    /* --- 8. FILTER DRAWER --- */
    #filter-drawer { display: none; position: fixed; top: 80px; left: 12px; right: 12px; background: #fff; border-radius: 20px; padding: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.25); z-index: 2000; }
    .filter-section { margin-bottom: 15px; }
    .filter-label { font-size: 10px; font-weight: 800; color: #bbb; text-transform: uppercase; margin-bottom: 5px; display: block; }
    .chip-group { display: flex; flex-wrap: wrap; gap: 6px; }
    .chip { padding: 6px 12px; border-radius: 15px; border: 1px solid #ddd; background: #fff; font-size: 12px; font-weight: 600; cursor: pointer; }
    .chip.active { box-shadow: 0 2px 4px rgba(0,0,0,0.15); transform: scale(1.05); }
    
    /* Chip Colors */
    .chip-Ashkenaz { color: var(--ashkenaz-text); border-color: var(--ashkenaz-text); } .chip-Ashkenaz.active { background: var(--ashkenaz-text); color: white; }
    .chip-Sefard { color: var(--sefard-text); border-color: var(--sefard-text); } .chip-Sefard.active { background: var(--sefard-text); color: white; }
    .chip-Edot-HaMizrach { color: var(--edot-text); border-color: var(--edot-text); } .chip-Edot-HaMizrach.active { background: var(--edot-text); color: white; }

    .radius-row { display: flex; align-items: center; gap: 10px; }
    .time-inputs-row { display: flex; gap: 8px; }
    .time-input { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 15px; font-weight: 600; font-family: inherit; }
    .action-btn { width: 100%; background: #eee; color: #333; border: none; padding: 10px; border-radius: 15px; font-size: 12px; font-weight: 700; cursor: pointer; margin-top: 6px; }
    .primary-btn { background: var(--primary); color: white; width: 100%; padding: 12px; border: none; border-radius: 12px; font-size: 14px; font-weight: 700; cursor: pointer; margin-top: 15px; }

    /* --- 9. TOOLBAR & FAB --- */
    .floating-toolbar { position: fixed; bottom: 30px; left: 20px; right: 20px; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(0,0,0,0.05); display: flex; justify-content: space-between; padding: 10px 15px; z-index: 1500; border-radius: 40px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
    .nav-item { display: flex; flex-direction: column; align-items: center; border: none; background: none; color: #999; font-size: 10px; font-weight: 600; flex: 1; cursor: pointer; }
    .nav-item.active { color: var(--primary); transform: translateY(-2px); }
    .nav-item i { font-size: 24px; margin-bottom: 2px; }
    #nav-toggle { font-weight: 800; color: var(--primary); }
    .fab-location { position: fixed; bottom: 100px; right: 20px; width: 50px; height: 50px; background: #fff; border-radius: 50%; box-shadow: 0 4px 15px rgba(0,0,0,0.2); border: none; color: var(--primary); display: flex; align-items: center; justify-content: center; z-index: 900; }
    
    /* UTILS */
    .sticky-header { position: fixed; top: 0; left: 0; right: 0; height: 60px; background: rgba(242, 244, 248, 0.85); backdrop-filter: blur(20px); border-bottom: 1px solid rgba(0,0,0,0.05); z-index: 900; display: flex; align-items: flex-end; justify-content: center; padding-bottom: 12px; font-weight: 800; font-size: 17px; color: var(--primary); opacity: 0; transition: opacity 0.2s; pointer-events: none; }
    .sticky-header.visible { opacity: 1; pointer-events: auto; }
    
    /* MODALS */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 4000; align-items: center; justify-content: center; }
    .modal.active { display: flex; }
    .modal-card { background: #fff; width: 85%; padding: 20px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
    .modal-input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px; box-sizing: border-box; font-size: 16px; }

    /* SETTINGS STYLES */
    .settings-card { background: #fff; border-radius: 16px; padding: 20px; margin: 0 15px 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .input-label { display: block; font-size: 12px; font-weight: 700; color: #666; margin-bottom: 5px; text-transform: uppercase; }
    .settings-input { width: 100%; padding: 12px; border: 1px solid #eee; border-radius: 12px; font-size: 16px; background: #fafafa; box-sizing: border-box; font-family: inherit; margin-bottom:15px; }
    .settings-link { display: flex; align-items: center; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid #f0f0f0; color: #333; text-decoration: none; cursor: pointer; }
</style>
</head>
<body>

    <div class="floating-header" id="filter-header">
        <div class="search-container">
            <div id="autocomplete-container" style="flex:1; height:100%;"></div>
        </div>
        <button class="circle-btn" onclick="toggleFilters()">
            <i class="material-icons">tune</i>
        </button>
    </div>

    <div class="status-area">
        <div id="status-pill" class="status-pill" style="background:var(--primary);color:white;border:none;"></div>
        <div id="count-pill" class="status-pill"></div>
        <div id="map-radius-pill" class="status-pill" style="background:#2E7D32;color:white;border:none;"></div>
    </div>

    <div id="filter-drawer">
        <div class="filter-section">
            <label class="filter-label">Date</label>
            <div class="date-nav" onclick="openDateModal()">
                <i class="material-icons" onclick="event.stopPropagation(); changeDate(-1)">chevron_left</i>
                <div class="date-center">
                    <div class="date-civ" id="filter-date-civ">Today</div>
                    <div class="date-heb" id="filter-date-heb">Loading...</div>
                </div>
                <i class="material-icons" onclick="event.stopPropagation(); changeDate(1)">chevron_right</i>
            </div>
        </div>
        <div class="filter-section">
            <label class="filter-label">Radius (Miles)</label>
            <div class="radius-row">
                <input type="range" min="1" max="50" value="20" style="flex:1" oninput="manualRadiusUpdate(this.value)">
                <span id="rad-val" style="font-weight:700;">20</span>
            </div>
            <div class="chip-group">
                <div class="chip" onclick="manualRadiusUpdate(1)">1</div>
                <div class="chip" onclick="manualRadiusUpdate(5)">5</div>
                <div class="chip" onclick="manualRadiusUpdate(20)">20</div>
                <div class="chip" onclick="manualRadiusUpdate(50)">50</div>
            </div>
        </div>
        <div class="filter-section">
            <label class="filter-label">Sort By</label>
            <div class="chip-group">
                <div class="chip active" onclick="setFilter('sort', 'time_asc', this)">Earliest</div>
                <div class="chip" onclick="setFilter('sort', 'distance', this)">Distance</div>
            </div>
        </div>
        <div class="filter-section">
            <label class="filter-label">Tefillah</label>
            <div class="chip-group">
                <div class="chip active" onclick="setFilter('tefillah', '', this)">All</div>
                <div class="chip" onclick="setFilter('tefillah', 'Shacharis', this)" style="color:var(--color-Shacharis);border-color:var(--color-Shacharis)">Shacharis</div>
                <div class="chip" onclick="setFilter('tefillah', 'Mincha', this)" style="color:var(--color-Mincha);border-color:var(--color-Mincha)">Mincha</div>
                <div class="chip" onclick="setFilter('tefillah', 'Maariv', this)" style="color:var(--color-Maariv);border-color:var(--color-Maariv)">Maariv</div>
            </div>
        </div>
        <div class="filter-section">
            <label class="filter-label">Nusach (Color Key)</label>
            <div class="chip-group" id="nusach-group">
                <div class="chip active" onclick="setFilter('nusach', '', this)">All</div>
            </div>
        </div>
        <div class="filter-section"><label class="filter-label">Time</label><div class="time-inputs-row"><input type="time" id="time-start" class="time-input" onchange="onStartTimeChange()"><input type="time" id="time-end" class="time-input" onchange="applyFilters()"></div><div style="display:flex; gap:6px; margin-top:6px;"><button class="action-btn" onclick="setAllDay()">All Day</button><button class="action-btn" style="background:var(--primary);color:white;" onclick="setNextHour()">Next Hour</button></div></div>
        <button class="primary-btn" onclick="toggleFilters()">Done</button>
    </div>

    <div id="map-view" class="view-container"></div>
    <div id="list-view" class="view-container" style="padding-top:110px;"></div>
    
    <div id="zmanim-view" class="view-container" style="padding:0; padding-bottom:120px;">
        <div class="z-header">
            <div class="z-title">
                <span>Zmanim</span>
                <button class="z-loc-btn" id="z-loc-label" onclick="openLocModal()">Lakewood, NJ</button>
            </div>
            <div class="date-nav" onclick="openDateModal()">
                <i class="material-icons" onclick="event.stopPropagation(); changeDate(-1)">chevron_left</i>
                <div class="date-center">
                    <div class="date-civ" id="z-date-civ"></div>
                    <div class="date-heb" id="z-date-heb"></div>
                </div>
                <i class="material-icons" onclick="event.stopPropagation(); changeDate(1)">chevron_right</i>
            </div>
            <div class="z-info-row">
                <div class="z-info-pill"><span class="z-label-sm">Day</span><div class="z-val-lg" id="z-day"></div></div>
                <div class="z-info-pill"><span class="z-label-sm">Daf Yomi</span><div class="z-val-lg" id="z-daf"></div></div>
            </div>
        </div>
        <ul class="z-list" id="z-list"></ul>
        <div class="z-glossary" id="z-glossary"></div>
    </div>

    <div id="settings-view" class="view-container" style="padding:0; padding-bottom:120px;">
        <div class="page-title-block"><h1 class="page-main-title">Settings</h1></div>
        <div class="settings-card">
            <label class="input-label">Name</label>
            <input type="text" id="p-name" class="settings-input" placeholder="Your Name" oninput="saveProfile()">
            <label class="input-label">Phone</label>
            <input type="tel" id="p-phone" class="settings-input" placeholder="Phone Number" oninput="saveProfile()">
        </div>
        <div class="settings-card" style="padding:0 20px;">
            <a class="settings-link" onclick="shareApp()"><span>Share App</span><i class="material-icons">ios_share</i></a>
            <a class="settings-link" href="mailto:support@shultime.com"><span>Contact Us</span><i class="material-icons">email</i></a>
            <a class="settings-link" onclick="alert('Coming soon')"><span>Privacy Policy</span><i class="material-icons">chevron_right</i></a>
            <a class="settings-link" onclick="alert('Coming soon')"><span>Rate App</span><i class="material-icons">star_rate</i></a>
        </div>
    </div>

    <div id="details-drawer">
        <div class="drawer-header">
            <div class="drawer-titles">
                <div class="drawer-h1" id="drawer-title"></div>
                <div class="drawer-addr" id="drawer-addr"></div>
            </div>
            <div class="drawer-actions">
                <div class="action-circle" onclick="toggleFavorite()"><i class="material-icons" id="bookmark-icon">bookmark_border</i></div>
                <div class="action-circle" onclick="shareShul()"><i class="material-icons">ios_share</i></div>
                <div class="action-circle" onclick="closeDetails()"><i class="material-icons">close</i></div>
            </div>
        </div>
        <div id="drawer-content" class="drawer-body"></div>
    </div>

    <div class="modal" id="dateModal">
        <div class="modal-card">
            <h3>Select Date</h3>
            <input type="date" id="datePicker" class="modal-input">
            <button class="primary-btn" onclick="setDateFromPicker()">Go</button>
            <button class="action-btn" style="width:100%;margin-top:8px;" onclick="document.getElementById('dateModal').classList.remove('active')">Cancel</button>
        </div>
    </div>

    <div class="modal" id="locModal">
        <div class="modal-card">
            <h3>Location</h3>
            <input type="text" id="loc-search" class="modal-input" placeholder="City">
            <button class="primary-btn" onclick="ZmanimApp.searchCity()">Search</button>
            <div id="loc-results" style="margin-top:10px;"></div>
            <button class="action-btn" style="width:100%;margin-top:8px;" onclick="document.getElementById('locModal').classList.remove('active')">Close</button>
        </div>
    </div>

    <div id="center-marker"></div>
    <div id="scrim" onclick="closeDetails()" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.3);z-index:2500;"></div>
    <div id="sticky-header" class="sticky-header"></div>
    <button class="fab-location" id="fab-location" onclick="useMyLocation()"><i class="material-icons">my_location</i></button>

    <div class="floating-toolbar">
        <button class="nav-item" id="nav-recent" onclick="switchTab('recent')"><i class="material-icons">history</i>Recent</button>
        <button class="nav-item" id="nav-zmanim" onclick="switchTab('zmanim')"><i class="material-icons">access_time</i>Zmanim</button>
        <button class="nav-item active" id="nav-toggle" onclick="toggleView()"><i class="material-icons" id="nav-toggle-icon">list</i><span id="nav-toggle-text">List</span></button>
        <button class="nav-item" id="nav-saved" onclick="switchTab('saved')"><i class="material-icons">bookmark_border</i>Saved</button>
        <button class="nav-item" id="nav-settings" onclick="switchTab('settings')"><i class="material-icons">settings</i>Settings</button>
    </div>

    <script>
        // --- 1. SHULTIME CORE VARIABLES ---
        let map, allMinyanim=[], fullDbData=[], searchCenter=null, currentRadius=20, currentTab='map';
        let filters = { sort: 'time_asc', tefillah: '', nusach: '' };
        let markers = [], allNusachs = new Set();
        let selectedShul = null;
        let currentDate = new Date();

        // --- 2. ZMANIM MODULE (ISOLATED) ---
        const ZmanimApp = {
            date: new Date(),
            loc: { lat: 40.096, lng: -74.222, name: 'Lakewood, NJ', elev: 30, tz: 'America/New_York' },
            opts: { alot:'16.1', mish:'10.2', sunrise:'elev', shema:'gra', tefila:'gra', mincha:'gra', plag:'gra', candles:'18', tzais:'8.5', shaa:'gra', sunset:'elev' },
            config: [
                {id:"alot", label:"Alos", desc:"Dawn", opts:[['16.1','16.1°'],['72','72m']]},
                {id:"sunrise", label:"Sunrise", desc:"Netz", opts:[['elev','Visual']]},
                {id:"shema", label:"Shema", desc:"Sof Zman", opts:[['gra','Gra'],['mga','MGA']]},
                {id:"tefila", label:"Tefila", desc:"Sof Zman", opts:[['gra','Gra']]},
                {id:"chatzos", label:"Chatzos", desc:"Midday"},
                {id:"mincha", label:"Mincha", desc:"Gedola"},
                {id:"candles", label:"Candles", desc:"18m"},
                {id:"sunset", label:"Sunset", desc:"Shkia", opts:[['elev','Visual']]},
                {id:"tzais", label:"Tzais", desc:"Nightfall", opts:[['8.5','8.5°'],['72','72m']]},
                {id:"shaa", label:"Shaa Zmanis", desc:"1 Halachic Hour"}
            ],
            Daf: { get: (d) => { const s=new Date(2020,0,5), a=Math.floor((d-s)/864e5); if(a<0)return""; let n=a; const m=[{n:"Berachos",p:63},{n:"Shabbos",p:156},{n:"Eruvin",p:104}]; for(let r of m){if(n<r.p)return r.n+" "+(n+2);n-=r.p} return "Sanhedrin 22"; } },
            Heb: { get: (d) => new Intl.DateTimeFormat('en-US-u-ca-hebrew',{day:'numeric',month:'long',year:'numeric'}).format(d) },
            Solar: { calc: (d, lat, lng, elev) => {
                const base = new Date(d).setHours(6,0,0,0);
                const add = m => new Date(base + m*60000).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
                return { alot:add(0), sun:add(60), noon:add(360), set:add(720), tzais:add(760) }; 
            }},
            init: function() { this.render(); },
            setDate: function(d) { this.date = d; this.render(); },
            updateLoc: function(l) { this.loc = l; this.render(); },
            changeOpt: function(id, val) { this.opts[id] = val; this.render(); },
            render: function() {
                document.getElementById('z-loc-label').innerText = this.loc.name;
                const dateStr = this.date.toLocaleDateString('en-US',{weekday:'short', month:'short', day:'numeric'});
                document.getElementById('z-date-civ').innerText = dateStr;
                document.getElementById('z-date-heb').innerText = this.Heb.get(this.date);
                document.getElementById('z-day').innerText = this.date.toLocaleDateString('en-US', {weekday:'long'});
                document.getElementById('z-daf').innerText = this.Daf.get(this.date);
                
                const t = this.Solar.calc(this.date, this.loc.lat, this.loc.lng);
                let h = "";
                this.config.forEach(z => {
                    let time = t.noon;
                    if(z.id.includes('alot')) time=t.alot; if(z.id.includes('sunrise')) time=t.sun; if(z.id.includes('sunset')) time=t.set;
                    let sel = z.opts ? `<select class="z-select" onchange="ZmanimApp.changeOpt('${z.id}',this.value)">${z.opts.map(o=>`<option>${o[1]}</option>`).join('')}</select>` : "";
                    h += `<li class="z-card"><div class="z-left"><span class="z-label">${z.label}</span><span class="z-desc">${z.desc}</span>${sel}</div><div class="z-time">${time}</div></li>`;
                });
                document.getElementById('z-list').innerHTML = h;
                this.renderGlossary();
            },
            renderGlossary: function() {
                let h = "";
                this.config.forEach(z => { if(z.opts) h+= `<details><summary>${z.label}</summary><div>${z.desc}</div></details>`; });
                document.getElementById('z-glossary').innerHTML = h;
            },
            searchCity: async function() {
                const q = document.getElementById('loc-search').value;
                const r = document.getElementById('loc-results');
                r.innerHTML = "Searching...";
                setTimeout(() => { r.innerHTML = `<div onclick="ZmanimApp.updateLoc({lat:51.5,lng:-0.1,name:'London'});document.getElementById('locModal').classList.remove('active')" style="padding:10px;cursor:pointer;">London, UK</div>`; }, 500);
            }
        };

        // --- 3. MAIN APP INIT ---
        document.addEventListener("DOMContentLoaded", async () => {
            ZmanimApp.init(); 
            document.getElementById('time-start').value="00:00"; document.getElementById('time-end').value="23:59";
            updateDateDisplay();
            loadProfile();

            document.getElementById('list-view').addEventListener('scroll', function() {
                const h = document.getElementById('sticky-header');
                if(this.scrollTop>40 && (currentTab==='recent'||currentTab==='saved')) { h.classList.add('visible'); h.innerText = currentTab.charAt(0).toUpperCase()+currentTab.slice(1); }
                else h.classList.remove('visible');
            });

            // LOAD DB & FALLBACK
            try {
                const res = await fetch("database.json");
                if(!res.ok) throw new Error("x");
                fullDbData = await res.json();
                processData(fullDbData);
            } catch(e) {
                // Fallback Data for Immediate Functionality
                fullDbData = [
                    {id:1, name:"Bais Medrash Govoah", address:"617 6th St", city:"Lakewood", state:"NJ", lat:40.093, lng:-74.222, nusach:"Ashkenaz", rabbi:"Rabbi Olshin", phone:"732-367-1060", email:"info@bmg.edu", shacharis:{week:["7:00a"]}, mincha:{week:["1:45p"]}, maariv:{week:["9:30p"]}},
                    {id:2, name:"Satmar", address:"Forest Ave", city:"Lakewood", state:"NJ", lat:40.080, lng:-74.210, nusach:"Sefard", rabbi:"Rabbi Teitelbaum", shacharis:{week:["8:00a"]}, mincha:{week:["2:00p"]}, maariv:{week:["9:00p"]}},
                    {id:3, name:"Ohr Chaim", address:"123 Main", city:"Lakewood", state:"NJ", lat:40.085, lng:-74.219, nusach:"Edot HaMizrach", rabbi:"Rabbi Cohen", shacharis:{week:["6:30a"]}, mincha:{week:["3:00p"]}, maariv:{week:["8:00p"]}}
                ];
                processData(fullDbData);
            }
        });

        // --- 4. MAP & LIST LOGIC ---
        function processData(data) {
            allMinyanim = []; allNusachs = new Set();
            // Weekday logic
            const d = currentDate.getDay(); 
            const k = (d===0) ? 'sun' : (d===6 ? 'shabbos' : 'week');
            
            data.forEach(s => {
                if(s.nusach) allNusachs.add(s.nusach);
                const add = (l,t) => { if(l) l.forEach(tm => {
                     let [h,m] = tm.split(':').map(Number); let v = h*60+m; 
                     if(t==='Mincha'&&h<9) v+=720; if(t==='Maariv'&&h<12) v+=720;
                     allMinyanim.push({...s, tefillah:t, timeDisplay:tm, timeValue:v});
                })};
                // Fallback to week/sun if specific day key missing
                add(s.shacharis?.[k] || s.shacharis?.week, 'Shacharis');
                add(s.mincha?.[k] || s.mincha?.week, 'Mincha');
                add(s.maariv?.[k] || s.maariv?.week, 'Maariv');
            });
            populateNusachFilter();
            if(map) applyFilters();
        }

        function populateNusachFilter() {
            const g = document.getElementById('nusach-group');
            g.innerHTML = `<div class="chip active" onclick="setFilter('nusach', '', this)">All</div>`;
            Array.from(allNusachs).forEach(n => {
                const c = document.createElement('div');
                c.className = `chip chip-${n.replace(/ /g,'-')}`; c.innerText = n;
                c.onclick = () => setFilter('nusach', n, c);
                g.appendChild(c);
            });
        }

        async function initApp() {
            const { Map } = await google.maps.importLibrary("maps");
            const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");
            const { PlaceAutocompleteElement } = await google.maps.importLibrary("places");
            const auto = new PlaceAutocompleteElement();
            document.getElementById("autocomplete-container").appendChild(auto);

            map = new Map(document.getElementById("map-view"), {
                center: { lat: 40.091, lng: -74.218 }, zoom: 13,
                disableDefaultUI: true, mapId: "DEMO_MAP_ID",
                styles: [{ featureType: "poi", stylers: [{ visibility: "off" }] }]
            });

            map.addListener('idle', () => {
                const c = map.getCenter();
                searchCenter = { lat: c.lat(), lng: c.lng() };
                document.getElementById('status-pill').innerText = "Near: Map Center";
                ZmanimApp.updateLoc({lat:c.lat(), lng:c.lng(), name:"Map Location", elev:30, tz:"America/New_York"});
                applyFilters();
            });
            
            auto.addEventListener("gmp-select", async (e) => {
                const p = e.placePrediction.toPlace();
                await p.fetchFields({ fields: ["location"] });
                map.setCenter(p.location);
            });
        }

        function applyFilters() {
            // Safe fallback if map not loaded yet
            const center = searchCenter || { lat: 40.091, lng: -74.218 };
            
            let res = allMinyanim.map(m => { m.dist = getDist(center.lat, center.lng, m.lat, m.lng); return m; });
            const isMap = document.getElementById('map-view').style.display !== 'none';
            
            // FILTERS
            if(filters.tefillah) res = res.filter(m => m.tefillah === filters.tefillah);
            if(filters.nusach) res = res.filter(m => m.nusach === filters.nusach);
            res = res.filter(m => m.dist <= currentRadius);
            
            // TIME FILTER
            const [sh,sm] = document.getElementById('time-start').value.split(':').map(Number);
            const [eh,em] = document.getElementById('time-end').value.split(':').map(Number);
            const startV = sh*60+sm, endV = eh*60+em;
            res = res.filter(m => m.timeValue >= startV && m.timeValue <= endV);

            // SORT
            if(filters.sort === 'distance') res.sort((a,b) => a.dist - b.dist);
            else res.sort((a,b) => a.timeValue - b.timeValue);

            const count = new Set(res.map(r=>r.id)).size;
            
            // PILLS (Map/List Only)
            if(currentTab === 'map' || currentTab === 'list') {
                document.querySelector('.status-area').style.display = 'flex';
                document.getElementById('count-pill').style.display = 'block';
                document.getElementById('count-pill').innerText = isMap ? `${count} Shuls` : `${count} Shuls / ${res.length} Minyanim`;
                document.getElementById('map-radius-pill').style.display = isMap ? 'block' : 'none';
                document.getElementById('map-radius-pill').innerText = `Radius: ${currentRadius}mi`;
            } else {
                document.querySelector('.status-area').style.display = 'none';
            }

            if(isMap) updateMarkers(res);
            else renderList(res);
        }

        function updateMarkers(res) {
            if(!map) return;
            markers.forEach(m => m.map = null); markers = [];
            const locs = {};
            // Group to show one marker per location (earliest time)
            res.forEach(r => { if(!locs[r.lat+","+r.lng]) locs[r.lat+","+r.lng] = r; });
            
            Object.values(locs).forEach(m => {
                const el = document.createElement('div');
                const nSafe = (m.nusach||"Other").replace(/ /g,'-');
                el.className = `custom-marker marker-${nSafe}`;
                el.textContent = m.timeDisplay;
                const mk = new google.maps.marker.AdvancedMarkerElement({
                    map: map, position: {lat:m.lat, lng:m.lng}, content: el
                });
                mk.element.addEventListener('click', () => openDetails(m));
                markers.push(mk);
            });
        }

        function renderList(res) {
            const list = document.getElementById('list-view');
            // Do not render list here if we are on Recent/Saved pages
            if(currentTab !== 'list') return;

            list.innerHTML = "";
            if(res.length === 0) { list.innerHTML = '<div class="empty-state">No results found.</div>'; return; }

            res.forEach(m => {
                const nSafe = (m.nusach||"Other").replace(/ /g,'-');
                const d = document.createElement('div');
                d.className = `minyan-card n-${nSafe} type-${m.tefillah}`;
                d.innerHTML = `
                <div class="info-zone" onclick='openDetails(${JSON.stringify(m).replace(/'/g, "'")})'>
                    <div class="shul-name">${m.name}</div><div class="shul-address">${m.address}</div><div class="nusach-tag n-${nSafe}">${m.nusach}</div>
                </div>
                <div class="map-zone" onclick="window.open('http://maps.google.com/?q=${m.lat},${m.lng}')">
                    <div class="tefillah-label">${m.tefillah}</div>
                    <div class="time-val-card n-${nSafe}">${m.timeDisplay}</div>
                    <div class="dist-row"><span>${m.dist.toFixed(1)}mi</span><div class="map-circle"><i class="material-icons google-maps-icon" style="font-size:16px;">place</i></div></div>
                </div>`;
                list.appendChild(d);
            });
        }

        // --- UTILS ---
        function switchTab(t) {
            currentTab = t;
            document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
            ['map-view','list-view','zmanim-view','settings-view'].forEach(id=>document.getElementById(id).style.display='none');
            document.getElementById('filter-header').style.display = (t==='map'||t==='list') ? 'flex' : 'none';
            document.querySelector('.status-area').style.display = (t==='map'||t==='list') ? 'flex' : 'none';
            document.getElementById('fab-location').style.display = (t==='map'||t==='list') ? 'flex' : 'none';
            
            if(t==='map') { document.getElementById('map-view').style.display='block'; document.getElementById('nav-toggle').classList.add('active'); updateToggle('List','list'); applyFilters(); }
            else if(t==='list') { document.getElementById('list-view').style.display='block'; document.getElementById('nav-toggle').classList.add('active'); updateToggle('Map','map'); applyFilters(); }
            else if(t==='zmanim') { document.getElementById('zmanim-view').style.display='block'; document.getElementById('nav-zmanim').classList.add('active'); }
            else if(t==='recent') { document.getElementById('list-view').style.display='block'; document.getElementById('nav-recent').classList.add('active'); renderRecents(); }
            else if(t==='saved') { document.getElementById('list-view').style.display='block'; document.getElementById('nav-saved').classList.add('active'); renderFavorites(); }
            else if(t==='settings') { document.getElementById('settings-view').style.display='block'; document.getElementById('nav-settings').classList.add('active'); }
        }

        function toggleView() { if(document.getElementById('map-view').style.display==='block') switchTab('list'); else switchTab('map'); }
        function toggleFilters() { const d=document.getElementById('filter-drawer'); d.style.display=d.style.display==='block'?'none':'block'; }
        function setFilter(t, v, btn) { filters[t] = v; btn.parentElement.querySelectorAll('.chip').forEach(c => c.classList.remove('active')); btn.classList.add('active'); applyFilters(); }
        function updateToggle(t,i) { document.getElementById('nav-toggle-text').innerText=t; document.getElementById('nav-toggle-icon').innerText=i; }
        function manualRadiusUpdate(v) { currentRadius=v; document.getElementById('rad-val').innerText=v; document.getElementById('map-radius-pill').innerText=`Radius: ${v}mi`; applyFilters(); }
        function openLocModal() { document.getElementById('locModal').classList.add('active'); }
        function openDateModal() { document.getElementById('dateModal').classList.add('active'); document.getElementById('datePicker').value = currentDate.toISOString().split('T')[0]; }
        function setDateFromPicker() {
            currentDate = new Date(document.getElementById('datePicker').value);
            updateDateDisplay();
            ZmanimApp.setDate(currentDate);
            processMinyanim(fullDbData); // Reload schedule for new day
            document.getElementById('dateModal').classList.remove('active');
        }

        function useMyLocation() { navigator.geolocation.getCurrentPosition(p=>{ map.setCenter({lat:p.coords.latitude, lng:p.coords.longitude}); map.setZoom(14); }); }
        function getDist(lat1,lon1,lat2,lon2) { return 3958.8 * 2 * Math.atan2(Math.sqrt(Math.sin((lat2-lat1)*Math.PI/360)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin((lon2-lon1)*Math.PI/360)**2), Math.sqrt(1-Math.sin((lat2-lat1)*Math.PI/360)**2)); }
        
        // --- DETAILS DRAWER & SAVED LOGIC ---
        function openDetails(m) {
            selectedShul = m;
            addToRecents(m);
            document.getElementById('details-drawer').classList.add('open');
            document.getElementById('scrim').style.display = 'block';
            document.getElementById('drawer-title').innerText = m.name;
            document.getElementById('drawer-addr').innerText = m.address + ", " + m.city;
            checkFavoriteStatus();
            
            // Nusach Colored Pills
            let sched = "";
            const nSafe = (m.nusach||"Other").replace(/ /g,'-');
            const nClass = `n-${nSafe}`;
            const row = (lbl, arr) => { if(arr) sched += `<div class="d-sched-item"><div class="d-sched-day">${lbl}</div><div class="d-sched-times">${arr.map(t=>`<span class="d-time-pill ${nClass}">${t}</span>`).join('')}</div></div>`; };
            row("Shacharis", m.shacharis?.week); row("Mincha", m.mincha?.week); row("Maariv", m.maariv?.week);
            
            let contact = "";
            if(m.phone) contact += `<a href="tel:${m.phone}" class="d-contact-btn"><i class="material-icons" style="font-size:14px">call</i> Call</a>`;
            if(m.email) contact += `<a href="mailto:${m.email}" class="d-contact-btn"><i class="material-icons" style="font-size:14px">email</i> Email</a>`;
            contact += `<a href="#" class="d-contact-btn"><i class="material-icons" style="font-size:14px">open_in_new</i> GoDaven</a>`;

            document.getElementById('drawer-content').innerHTML = `
                <div class="d-info-row">
                    <div class="d-rabbi"><i class="material-icons" style="font-size:16px">person</i> ${m.rabbi || "N/A"}</div>
                    <div class="nusach-tag n-${nSafe}">${m.nusach || "Other"}</div>
                </div>
                <div class="d-contact-grid">${contact}</div>
                <div class="d-schedule-title">Schedule</div>
                <div class="d-schedule-grid">${sched || 'No schedule'}</div>`;
        }
        
        function closeDetails() { document.getElementById('details-drawer').classList.remove('open'); document.getElementById('scrim').style.display = 'none'; }
        function shareShul() { if(navigator.share) navigator.share({title:selectedShul.name, text:selectedShul.address}); }
        function saveProfile() { localStorage.setItem('shultime_profile', JSON.stringify({name:document.getElementById('p-name').value, phone:document.getElementById('p-phone').value})); }
        function loadProfile() { const p = JSON.parse(localStorage.getItem('shultime_profile') || "{}"); if(p.name) document.getElementById('p-name').value = p.name; if(p.phone) document.getElementById('p-phone').value = p.phone; }
        
        // --- STORAGE FIX (IMPORTANT: Lookup in fullDbData) ---
        function addToRecents(m) {
            let r = JSON.parse(localStorage.getItem("shultime_recents") || "[]");
            // Only store ID
            r = r.filter(id => id !== m.id); 
            r.unshift(m.id); 
            if(r.length > 20) r.pop();
            localStorage.setItem("shultime_recents", JSON.stringify(r));
        }
        
        function toggleFavorite() {
            let f = JSON.parse(localStorage.getItem("shultime_favs") || "[]");
            const idx = f.indexOf(selectedShul.id);
            if(idx > -1) { 
                f.splice(idx,1); 
                document.getElementById('bookmark-icon').innerText = 'bookmark_border'; 
            } else { 
                f.push(selectedShul.id); 
                document.getElementById('bookmark-icon').innerText = 'bookmark'; 
            }
            localStorage.setItem("shultime_favs", JSON.stringify(f));
            if(currentTab==='saved') renderFavorites();
        }
        
        function checkFavoriteStatus() {
            let f = JSON.parse(localStorage.getItem("shultime_favs") || "[]");
            // selectedShul is object, f contains IDs
            document.getElementById('bookmark-icon').innerText = f.includes(selectedShul.id) ? 'bookmark' : 'bookmark_border';
        }
        
        function renderFavorites() {
            let fIds = JSON.parse(localStorage.getItem("shultime_favs") || "[]");
            const l = document.getElementById('list-view');
            l.innerHTML = '<div class="page-title-block"><h1 class="page-main-title">Saved</h1></div>';
            
            // Find full objects in DB
            const favShuls = fullDbData.filter(s => fIds.includes(s.id));
            
            if(favShuls.length===0) l.innerHTML += '<div class="empty-state">No saved shuls.</div>'; 
            else renderListCards(favShuls, l);
        }
        
        function renderRecents() {
            let rIds = JSON.parse(localStorage.getItem("shultime_recents") || "[]");
            const l = document.getElementById('list-view');
            l.innerHTML = '<div class="page-title-block"><h1 class="page-main-title">Recent</h1></div>';
            
            // Find full objects
            const recShuls = rIds.map(id => fullDbData.find(s => s.id === id)).filter(x => x);

            if(recShuls.length===0) l.innerHTML += '<div class="empty-state">No history.</div>'; 
            else renderListCards(recShuls, l);
        }
        
        function renderListCards(res, container) {
            res.forEach(m => {
                // Ensure nusach string is safe
                const nStr = m.nusach || "Other";
                const nSafe = nStr.replace(/ /g,'-');
                
                // Add distance logic if missing (for recents/saved)
                let distDisplay = "0.0";
                if(searchCenter) {
                    const d = getDist(searchCenter.lat, searchCenter.lng, m.lat, m.lng);
                    distDisplay = d.toFixed(1);
                }
                
                const d = document.createElement('div');
                d.className = `minyan-card n-${nSafe} type-${m.tefillah || 'Shacharis'}`;
                d.innerHTML = `
                <div class="info-zone" onclick='openDetails(${JSON.stringify(m).replace(/'/g, "'")})'>
                    <div class="shul-name">${m.name}</div><div class="shul-address">${m.address}</div><div class="nusach-tag n-${nSafe}">${nStr}</div>
                </div>
                <div class="map-zone" onclick="window.open('http://maps.google.com/?q=${m.lat},${m.lng}')">
                    <div class="tefillah-label">${m.tefillah || ''}</div>
                    <div class="time-val-card n-${nSafe}">${m.timeDisplay || 'View'}</div>
                    <div class="dist-row"><span>${distDisplay}mi</span><div class="map-circle"><i class="material-icons google-maps-icon" style="font-size:16px;">place</i></div></div>
                </div>`;
                container.appendChild(d);
            });
        }
        
        function setAllDay() { document.getElementById('time-start').value="00:00"; document.getElementById('time-end').value="23:59"; applyFilters(); }
        function setNextHour() { 
            const d=new Date(); const pad=n=>String(n).padStart(2,'0'); 
            document.getElementById('time-start').value=`${pad(d.getHours())}:${pad(d.getMinutes())}`;
            d.setHours(d.getHours()+1);
            document.getElementById('time-end').value=`${pad(d.getHours())}:${pad(d.getMinutes())}`;
            applyFilters();
        }
        function onStartTimeChange() {
            const [h,m] = document.getElementById('time-start').value.split(':').map(Number);
            document.getElementById('time-end').value = `${String(h+1).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
            applyFilters();
        }
        function shareApp() { if(navigator.share) navigator.share({title:"ShulTime", text:"Find Minyanim Near You", url:window.location.href}); }
    </script>
    <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAOpNebt0dPJUmiEw-i1W-Dx_UezLpIvxI&loading=async&libraries=places,maps,marker&callback=initApp"></script>
</body>
</html>
