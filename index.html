<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>ShulTime</title>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<style>
    :root { 
        --primary: #0D2B4F; 
        --bg: #F2F4F8; 
        --ad-bg: #FFF8E1; 
        --ad-border: #FBC02D; 

        /* TEFILLAH COLORS */
        --color-Shacharis: #2E7D32; 
        --color-Mincha: #E65100;    
        --color-Maariv: #1565C0;    

        /* NUSACH BACKGROUNDS */
        --bg-Ashkenaz: #E3F2FD;       
        --bg-Sefard: #E8F5E9;         
        --bg-Ari: #F3E5F5;            
        --bg-Edot-HaMizrach: #FFF3E0; 
        --bg-Chabad: #FFF8E1;         
        --bg-Other: #F5F5F5;          
        
        /* NUSACH TEXT */
        --text-Ashkenaz: #1565C0;
        --text-Sefard: #2E7D32;
        --text-Ari: #7B1FA2;
        --text-Edot-HaMizrach: #E65100;
        --text-Chabad: #F57F17;
        --text-Other: #616161;
    }
    
    html, body { margin: 0; padding: 0; height: 100%; overscroll-behavior-y: contain; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Roboto", sans-serif; background: var(--bg); overflow: hidden; }
    
    /* FLOATING HEADER */
    .floating-header {
        position: fixed; top: 15px; left: 12px; right: 12px;
        z-index: 1000; display: flex; gap: 10px; align-items: center; pointer-events: auto;
    }
    .search-container {
        flex: 1; pointer-events: auto; display: flex; align-items: center;
        background: #fff; height: 50px; border-radius: 25px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.15); padding: 0 15px;
        overflow: hidden; 
    }

    gmp-place-autocomplete { width: 100%; height: 100%; background-color: #fff !important; }
    gmp-place-autocomplete::part(input) { background-color: #fff !important; padding: 0; font-size: 16px; height: 100%; width: 100%; color: #111; font-weight: 500; }
    .pac-container { background-color: #fff !important; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.15); border: none; }

    .circle-btn {
        width: 50px; height: 50px; flex-shrink: 0; pointer-events: auto;
        border-radius: 50%; background: #fff; border: none;
        box-shadow: 0 4px 15px rgba(0,0,0,0.15); display: flex; align-items: center; justify-content: center;
        cursor: pointer; color: var(--primary); transition: all 0.2s;
    }
    .circle-btn.active { background: var(--primary); color: #fff; }

    /* STATUS PILLS */
    .status-area {
        position: fixed; top: 75px; left: 0; right: 0;
        display: flex; justify-content: center; align-items: center; gap: 8px;
        z-index: 800; pointer-events: none; padding: 0 10px;
    }
    #status-pill, #count-pill, #map-radius-pill {
        padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: 700;
        display: none; box-shadow: 0 2px 8px rgba(0,0,0,0.1); white-space: nowrap;
        max-width: 45%; overflow: hidden; text-overflow: ellipsis;
    }
    #status-pill { background: rgba(13, 43, 79, 0.95); color: #fff; }
    #count-pill { background: #fff; color: var(--primary); border: 1px solid var(--primary); }
    #map-radius-pill { background: #2E7D32; color: #fff; display: none; }

    /* VIEWS */
    #list-view, #zmanim-view, #settings-view { 
        position: absolute; inset: 0; 
        padding-bottom: 120px; 
        overflow-y: auto; background: var(--bg); 
        z-index: 10; display: none;
    }
    #map-view { position: absolute; inset: 0; z-index: 5; }

    /* STICKY LIQUID HEADER */
    .sticky-header {
        position: fixed; top: 0; left: 0; right: 0; height: 60px;
        background: rgba(242, 244, 248, 0.85);
        backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
        border-bottom: 1px solid rgba(0,0,0,0.05);
        z-index: 900; 
        display: flex; align-items: flex-end; justify-content: center;
        padding-bottom: 12px;
        font-weight: 800; font-size: 17px; color: var(--primary);
        opacity: 0; transition: opacity 0.2s ease-in-out; pointer-events: none;
    }
    .sticky-header.visible { opacity: 1; pointer-events: auto; }

    /* PAGE HEADERS */
    .page-header {
        padding: 40px 20px 15px;
        font-size: 34px; font-weight: 800; color: var(--primary);
    }

    /* ZMANIM PROFESSIONAL STYLES */
    .zman-header-section {
        background: #fff; padding: 40px 20px 15px;
        border-bottom: 1px solid #eee; position: sticky; top: 0; z-index: 20;
    }
    .zman-top-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .zman-title { font-size: 34px; font-weight: 800; color: var(--primary); margin: 0; }
    .zman-loc-badge { font-size: 11px; background: #E3F2FD; color: var(--primary); padding: 6px 12px; border-radius: 15px; font-weight: 700; cursor: pointer; border: none; }
    .zman-info-bar { display: flex; gap: 10px; margin-top: 15px; }
    .zman-info-pill { flex: 1; background: #f8f9fa; border: 1px solid #eee; padding: 10px; border-radius: 12px; text-align: center; }
    .zman-info-pill span { display: block; font-size: 10px; color: #999; text-transform: uppercase; font-weight: 700; margin-bottom: 4px; }
    .zman-info-val { font-size: 14px; font-weight: 700; color: #333; }
    .zmanim-list { list-style: none; padding: 15px; margin: 0; display: flex; flex-direction: column; gap: 10px; }
    .zman-card { background: #fff; border-radius: 16px; padding: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); border: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; }
    .zman-label { font-size: 16px; font-weight: 700; color: #333; }
    .zman-desc { font-size: 11px; color: #999; }
    .zman-right { text-align: right; }
    .zman-time { font-size: 20px; font-weight: 800; color: var(--primary); font-family: monospace; }
    .card-select { display: block; margin-top: 4px; font-size: 10px; background: #f0f0f0; border: none; padding: 2px 6px; border-radius: 4px; color: #555; font-weight: 600; }

    #center-marker {
        position: fixed; top: 50%; left: 50%; width: 16px; height: 16px;
        background: #2196F3; border: 3px solid #fff; border-radius: 50%;
        transform: translate(-50%, -50%); z-index: 20; box-shadow: 0 2px 6px rgba(0,0,0,0.4);
        pointer-events: none; display: none;
    }

    /* FLOATING PILL TOOLBAR (iOS Liquid Style) */
    .floating-toolbar {
        position: fixed; bottom: 30px; left: 20px; right: 20px;
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
        border: 1px solid rgba(255,255,255,0.3);
        display: flex; justify-content: space-between; align-items: center;
        padding: 10px 15px;
        z-index: 1500;
        box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        border-radius: 40px; 
    }
    .nav-item {
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        border: none; background: none; color: #999;
        font-size: 10px; font-weight: 600; gap: 3px;
        flex: 1; cursor: pointer; transition: all 0.2s; position: relative;
    }
    .nav-item.active { color: var(--primary); transform: translateY(-2px); }
    .nav-item i { font-size: 24px; }
    #nav-toggle { font-weight: 800; color: var(--primary); }
    
    /* SETTINGS STYLES */
    .settings-card { background: #fff; border-radius: 16px; padding: 20px; margin: 0 15px 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .input-group { margin-bottom: 15px; }
    .input-label { display: block; font-size: 12px; font-weight: 700; color: #666; margin-bottom: 5px; text-transform: uppercase; }
    .settings-input { width: 100%; padding: 12px; border: 1px solid #eee; border-radius: 12px; font-size: 16px; background: #fafafa; box-sizing: border-box; font-family: inherit; }
    .settings-input:focus { outline: none; border-color: var(--primary); background: #fff; }
    .settings-link { display: flex; align-items: center; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid #f0f0f0; color: #333; text-decoration: none; cursor: pointer; }
    .settings-link:last-child { border-bottom: none; }
    .settings-link i { color: #ccc; }
    .settings-link-text { font-size: 16px; font-weight: 600; }

    /* CARDS - 60/40 SPLIT */
    .minyan-card {
        background: #fff; border-radius: 12px; margin-bottom: 8px;
        display: flex; justify-content: space-between; align-items: stretch;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05); overflow: hidden; 
        height: 85px; box-sizing: border-box;
    }
    .info-zone { 
        width: 60%; flex-basis: 60%; flex-shrink: 0;
        padding: 8px 12px; cursor: pointer; 
        display: flex; flex-direction: column; justify-content: flex-start;
        min-width: 0; border-right: 1px solid #f0f0f0;
    }
    .map-zone { 
        width: 40%; flex-basis: 40%; flex-shrink: 0;
        position: relative; cursor: pointer; background: #fafafa; 
        box-sizing: border-box; 
    }
    
    .shul-name { font-weight: 800; font-size: 17px; color: #333; line-height: 1.1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 2px; }
    .shul-address { font-size: 12px; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.2; }
    .shul-city { font-size: 11px; color: #999; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 4px; line-height: 1.2; }
    .nusach-tag-list { font-size: 10px; padding: 2px 8px; border-radius: 8px; display: inline-block; font-weight: 700; text-transform: uppercase; width: fit-content; }

    /* RIGHT SIDE LAYOUT - 40px BUFFER */
    .tefillah-label { 
        position: absolute; top: 8px; right: 40px; text-align: right;
        font-size: 11px; font-weight: 900; text-transform: uppercase; letter-spacing: 0.5px; line-height: 1; color: #555; margin: 0;
    } 
    .time-val-card { 
        position: absolute; top: calc(50% - 10px); right: 40px; transform: translateY(-50%);
        padding: 4px 8px; border-radius: 8px; font-weight: 800; font-size: 16px; white-space: nowrap;
    }
    .dist-row { 
        position: absolute; bottom: 8px; right: 40px;
        display: flex; align-items: center; justify-content: flex-end; gap: 6px; margin: 0;
    }
    .dist-label { font-size: 11px; font-weight: 800; color: #666; line-height: 1; }
    .map-circle { width: 28px; height: 28px; border-radius: 50%; background: #fff; display: flex; align-items: center; justify-content: center; border: 1px solid #eee; }
    .google-maps-icon { background: linear-gradient(135deg, #4285F4 25%, #34A853 25% 50%, #FBBC05 50% 75%, #EA4335 75%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 18px !important; font-weight: bold; }
</style>
</head>
<body>

    <div id="sticky-header" class="sticky-header"></div>

    <div class="floating-header" id="filter-header">
        <div class="search-container" onclick="event.stopPropagation()">
            <div id="autocomplete-container" style="flex:1; height:100%;"></div>
        </div>
        <button class="circle-btn" onclick="toggleFilters(); event.stopPropagation()">
            <i class="material-icons">tune</i>
        </button>
    </div>

    <div class="status-area">
        <div id="status-pill"></div>
        <div id="count-pill"></div>
        <div id="map-radius-pill"></div>
    </div>

    <div id="center-marker"></div>
    <div id="scrim" onclick="closeDetails()"></div>

    <div id="coming-soon-toast" class="coming-soon-overlay">Feature Coming Soon</div>

    <div id="details-drawer">
        <div class="drawer-header">
            <div class="drawer-title-container">
                <div class="drawer-title" id="drawer-title"></div>
                <div class="drawer-address-locked" id="drawer-address-line1"></div>
                <div class="drawer-city-locked" id="drawer-address-line2"></div>
            </div>
            <div class="drawer-actions">
                <button class="circle-action-btn" id="bookmark-btn" onclick="toggleFavorite()">
                    <i class="material-icons" id="bookmark-icon" style="font-size:20px;">bookmark_border</i>
                </button>
                <button class="circle-action-btn" id="share-btn">
                    <i class="material-icons" style="font-size:20px;">ios_share</i>
                </button>
                <button class="circle-action-btn" onclick="closeDetails()">
                    <i class="material-icons" style="font-size:20px;">close</i>
                </button>
            </div>
        </div>
        <div id="drawer-content" class="drawer-body"></div>
    </div>

    <div id="filter-drawer">
        <div class="filter-section">
            <label class="filter-label">Date</label>
            <div class="date-nav">
                <button class="date-btn" onclick="changeDate(-1)"><i class="material-icons">chevron_left</i></button>
                <div class="date-display-container">
                    <div class="date-display" id="date-display">Today</div>
                    <div class="hebrew-date" id="hebrew-date"></div>
                </div>
                <button class="date-btn" onclick="changeDate(1)"><i class="material-icons">chevron_right</i></button>
            </div>
        </div>
        <div class="filter-section">
            <label class="filter-label">Radius (Miles)</label>
            <div class="radius-row">
                <input type="range" min="0.1" max="99" step="0.1" value="20" id="radius-slider" oninput="manualRadiusUpdate(this.value)">
                <input type="number" id="radius-input" class="radius-input" value="20" onchange="manualRadiusUpdate(this.value)">
            </div>
            <div class="chip-group">
                <div class="chip" onclick="manualRadiusUpdate(1)">1</div>
                <div class="chip" onclick="manualRadiusUpdate(2)">2</div>
                <div class="chip" onclick="manualRadiusUpdate(3)">3</div>
                <div class="chip" onclick="manualRadiusUpdate(5)">5</div>
                <div class="chip" onclick="manualRadiusUpdate(20)">20</div>
                <div class="chip" onclick="manualRadiusUpdate(99)">99</div>
            </div>
        </div>
        <div class="filter-section"><label class="filter-label">Sort By</label><div class="chip-group"><div class="chip active" onclick="setFilter('sort', 'time_asc', this)">Earliest</div><div class="chip" onclick="setFilter('sort', 'distance', this)">Distance</div></div></div>
        <div class="filter-section"><label class="filter-label">Tefillah</label><div class="chip-group"><div class="chip active" onclick="setFilter('tefillah', '', this)">All</div><div class="chip chip-Shacharis" onclick="setFilter('tefillah', 'Shacharis', this)">Shacharis</div><div class="chip chip-Mincha" onclick="setFilter('tefillah', 'Mincha', this)">Mincha</div><div class="chip chip-Maariv" onclick="setFilter('tefillah', 'Maariv', this)">Maariv</div></div></div>
        <div class="filter-section"><label class="filter-label">Nusach</label><div class="chip-group" id="nusach-group"><div class="chip active" onclick="setFilter('nusach', '', this)">All</div></div></div>
        <div class="filter-section"><label class="filter-label">Time Range</label><div class="time-inputs-row"><input type="time" id="time-start" class="time-input" onchange="onStartTimeChange()"><input type="time" id="time-end" class="time-input" onchange="applyFilters()"></div><div style="display:flex; gap:6px;"><button class="action-btn" onclick="setAllDay()">All Day</button><button class="action-btn primary-action" onclick="setNextHour()">Next Hour</button></div></div>
        <button class="action-btn primary-action" onclick="toggleFilters()" style="margin-top:10px;">Done</button>
    </div>

    <div id="list-view"></div>
    <div id="map-view"></div>
    <div id="zmanim-view"></div>
    
    <div id="settings-view">
        <div class="page-header">Settings</div>
        <div class="settings-card">
            <div class="input-group"><label class="input-label">Name</label><input type="text" class="settings-input" id="profile-name" placeholder="Your Name" oninput="saveProfile()"></div>
            <div class="input-group"><label class="input-label">Phone</label><input type="tel" class="settings-input" id="profile-phone" placeholder="Phone Number" oninput="saveProfile()"></div>
        </div>
        <div class="settings-card" style="padding: 0 20px;">
            <a class="settings-link" onclick="showComingSoon()"><span class="settings-link-text">Privacy Policy</span><i class="material-icons">chevron_right</i></a>
            <a class="settings-link" onclick="showComingSoon()"><span class="settings-link-text">Rate App</span><i class="material-icons">star_rate</i></a>
            <a class="settings-link" onclick="shareApp()"><span class="settings-link-text">Share App</span><i class="material-icons">ios_share</i></a>
            <a class="settings-link" href="mailto:support@shultime.com"><span class="settings-link-text">Contact Us</span><i class="material-icons">email</i></a>
            <a class="settings-link" href="mailto:support@shultime.com?subject=Support"><span class="settings-link-text">Support</span><i class="material-icons">help_outline</i></a>
        </div>
    </div>

    <div class="modal" id="locModal">
        <div class="modal-card">
            <h2>Change Location</h2>
            <button class="modal-btn" onclick="useMyLocationForZmanim()">üìç Use My GPS</button>
            <div style="margin:10px 0; border-bottom:1px solid #eee;"></div>
            <label style="font-size:12px;color:#777;font-weight:700;">SEARCH CITY:</label>
            <div style="display:flex;gap:5px;margin-top:5px;">
                <input type="text" id="citySearchInput" class="settings-input" placeholder="e.g. London" style="margin:0;">
                <button class="modal-btn" onclick="searchCity()" style="width:auto;margin:0;background:#0D2B4F;">Go</button>
            </div>
            <div id="citySearchResults" style="max-height:200px; overflow-y:auto; margin-top:10px;"></div>
            <button class="modal-btn close-btn" onclick="document.getElementById('locModal').classList.remove('active')">Close</button>
        </div>
    </div>
    
    <button class="fab-location" onclick="useMyLocation()">
        <i class="material-icons" style="font-size:24px;">my_location</i>
    </button>

    <div class="floating-toolbar">
        <button class="nav-item" id="nav-recent" onclick="switchTab('recent')"><i class="material-icons">history</i>Recent</button>
        <button class="nav-item" id="nav-zmanim" onclick="switchTab('zmanim')"><i class="material-icons">access_time</i>Zmanim</button>
        <button class="nav-item active" id="nav-toggle" onclick="toggleView()"><i class="material-icons" id="nav-toggle-icon">list</i><span id="nav-toggle-text">List</span></button>
        <button class="nav-item" id="nav-saved" onclick="switchTab('saved')"><i class="material-icons">bookmark_border</i>Saved</button>
        <button class="nav-item" id="nav-settings" onclick="switchTab('settings')"><i class="material-icons">settings</i>Settings</button>
    </div>

    <script>
        // --- DATA ENGINES ---
        const DafEngine={masechtot:[{n:"Berachos",p:63},{n:"Shabbos",p:156},{n:"Eruvin",p:104},{n:"Pesachim",p:120},{n:"Shekalim",p:21},{n:"Yoma",p:87},{n:"Sukkah",p:55},{n:"Beitzah",p:39},{n:"Rosh Hashana",p:34},{n:"Taanis",p:30},{n:"Megillah",p:31},{n:"Moed Katan",p:28},{n:"Chagigah",p:26},{n:"Yevamos",p:121},{n:"Kesubos",p:111},{n:"Nedarim",p:90},{n:"Nazir",p:65},{n:"Sotah",p:48},{n:"Gittin",p:89},{n:"Kiddushin",p:81},{n:"Bava Kamma",p:118},{n:"Bava Metzia",p:118},{n:"Bava Basra",p:175},{n:"Sanhedrin",p:112},{n:"Makkos",p:23},{n:"Shevuos",p:48},{n:"Avodah Zarah",p:75},{n:"Horayos",p:13},{n:"Zevachim",p:119},{n:"Menachos",p:109},{n:"Chullin",p:141},{n:"Bechoros",p:60},{n:"Arachin",p:33},{n:"Temurah",p:33},{n:"Kerisus",p:27},{n:"Meilah",p:21},{n:"Kinnim",p:4},{n:"Tamid",p:9},{n:"Middos",p:4},{n:"Niddah",p:72}],get:(e)=>{const t=new Date(2020,0,5),a=Math.floor((e-t)/864e5);if(a<0)return"";let n=a;for(let r of DafEngine.masechtot){if(n<r.p)return r.n+" "+(n+2);n-=r.p}return""}};
        const HebCal={mapMonth:e=>{const t={Tishri:"Tishrei",Cheshvan:"Cheshvan",Kislev:"Kislev",Tevet:"Teves",Shevat:"Shevat",Adar:"Adar","Adar I":"Adar I","Adar II":"Adar II",Nisan:"Nisan",Iyar:"Iyar",Sivan:"Sivan",Tamuz:"Tamuz",Av:"Av",Elul:"Elul"};return t[e]||e},getHebrewStr:e=>{const t=new Intl.DateTimeFormat("en-US-u-ca-hebrew",{day:"numeric",month:"long",year:"numeric"}).formatToParts(e);return t.find(e=>"day"===e.type).value+" "+HebCal.mapMonth(t.find(e=>"month"===e.type).value)+" "+t.find(e=>"year"===e.type).value.split(" ")[0]}};
        const Solar={rad:e=>e*(Math.PI/180),deg:e=>e*(180/Math.PI),calc:(e,t,a,n)=>{const r=(Date.UTC(e.getFullYear(),e.getMonth(),e.getDate())-946728e6)/864e5,l=(280.46+0.9856474*r)%360,c=(357.528+0.9856003*r)%360,o=l+1.915*Math.sin(Solar.rad(c))+.02*Math.sin(Solar.rad(2*c)),i=23.439-4e-7*r,s=Math.sin(Solar.rad(i))*Math.sin(Solar.rad(o)),u=Math.sqrt(1-s*s),d=Math.tan(Solar.rad(i/2))*Math.tan(Solar.rad(i/2)),h=d*Math.sin(2*Solar.rad(l))-2*.0167*Math.sin(Solar.rad(c))+4*.0167*d*Math.sin(Solar.rad(c))*Math.cos(2*Solar.rad(l))-.5*d*d*Math.sin(4*Solar.rad(l))-1.25*.0167*.0167*Math.sin(2*Solar.rad(c)),m=Solar.deg(h)*4,g=720-4*a-m,p=Date.UTC(e.getFullYear(),e.getMonth(),e.getDate())+6e4*g,f=(e,n)=>{const r=90-e,l=Math.sin(Solar.rad(r))-Math.sin(Solar.rad(t))*s,c=Math.cos(Solar.rad(t))*u,o=l/c;if(o>1||o<-1)return null;const i=Solar.deg(Math.acos(o))*4;return n?p-6e4*i:p+6e4*i};const E=90.833+.0293*Math.sqrt(n);return{noon:p,alot16:f(106.1,!0),mish10:f(100.2,!0),mish11:f(101,!0),mish115:f(101.5,!0),sunLevel:{rise:f(90.833,!0),set:f(90.833,!1)},sunElev:{rise:f(E,!0),set:f(E,!1)},tzais85:f(98.5,!1),tzais16:f(106.1,!1)}}};

        const zmanimConfig = [
            { id: "alot", label: "Alos Hashachar", desc: "Dawn. Fast begins.", opts: [['16.1','16.1¬∞'],['72','72m']] },
            { id: "mish", label: "Misheyakir", desc: "Earliest Talis & Tefillin.", opts: [['10.2','10.2¬∞'],['11','11¬∞']] },
            { id: "sunrise", label: "Netz Hachama", desc: "Sunrise.", opts: [['elev','Visual'],['level','Sea Level']] },
            { id: "shema", label: "Sof Zman Shema", desc: "Latest Shema.", opts: [['gra','Gra'],['mga','MGA']] },
            { id: "tefila", label: "Sof Zman Tefila", desc: "Latest Shacharis.", opts: [['gra','Gra'],['mga','MGA']] },
            { id: "chatzos", label: "Chatzos Hayom", desc: "Midday (Solar Noon)." },
            { id: "mincha", label: "Mincha Gedola", desc: "Earliest Mincha." },
            { id: "plag", label: "Plag Hamincha", desc: "1.25h before night." },
            { id: "candles", label: "Candle Lighting", desc: "18m before Sunset." },
            { id: "sunset", label: "Shkia", desc: "Sunset.", opts: [['elev','Visual'],['level','Sea Level']] },
            { id: "tzais", label: "Tzais / Motzaei", desc: "Nightfall.", opts: [['8.5','8.5¬∞'],['72','72m']] },
            { id: "shaa", label: "Shaa Zmanis", desc: "1 Halachic Hour." }
        ];

        let map, allMinyanim = [], processedMinyanim = [], ads = [], searchCenter = null, currentRadius = 20;
        let filters = { sort: 'time_asc', tefillah: '', nusach: '' };
        let selectedShul = null;
        let markers = [];
        let isProgrammaticMove = false;
        let allNusachs = new Set();
        let fullDbData = [];
        let currentFilterDate = new Date();
        let isFirstIdle = true; 
        let currentTab = 'map';
        let zmanLoc = { lat: 40.096, lng: -74.222, name: 'Lakewood, NJ', elev: 30, tz: 'America/New_York' };
        let zmanOpts = { alot:'16.1', mish:'10.2', sunrise:'elev', shema:'gra', tefila:'gra', mincha:'gra', plag:'gra', candles:'18', tzais:'8.5', shaa:'gra', sunset:'elev' };

        document.addEventListener("DOMContentLoaded", async () => {
            updateDateDisplay();
            loadProfile();

            document.getElementById('list-view').addEventListener('scroll', function() {
                const header = document.getElementById('sticky-header');
                if(this.scrollTop > 40 && (currentTab === 'recent' || currentTab === 'saved')) {
                    header.classList.add('visible');
                    header.innerText = currentTab === 'recent' ? "Recent" : "Saved";
                } else header.classList.remove('visible');
            });

            try {
                const res = await fetch("database.json");
                fullDbData = await res.json();
                processMinyanim(fullDbData);
                populateNusachFilter();
            } catch(e) { console.error("Data Load Error", e); }
        });

        // --- NAVIGATION ---
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
            const list = document.getElementById('list-view');
            const zmanim = document.getElementById('zmanim-view');
            const settings = document.getElementById('settings-view');
            const sticky = document.getElementById('sticky-header');
            sticky.classList.remove('visible');
            
            if(tab !== 'map' && tab !== 'list') {
                document.getElementById(`nav-${tab}`).classList.add('active');
                document.getElementById('filter-header').style.display = 'none'; 
                document.getElementById('status-pill').style.display = 'none';
                document.getElementById('count-pill').style.display = 'none';
                document.getElementById('map-radius-pill').style.display = 'none';
                list.style.paddingTop = '0px'; 
                zmanim.style.paddingTop = '0px';
                settings.style.paddingTop = '0px'; 
            } else {
                document.getElementById('nav-toggle').classList.add('active');
                document.getElementById('filter-header').style.display = 'flex';
                list.style.paddingTop = '110px';
            }

            document.getElementById('map-view').style.display = 'none';
            list.style.display = 'none';
            zmanim.style.display = 'none';
            settings.style.display = 'none';
            document.getElementById('center-marker').style.display = 'none';

            if(tab === 'map') {
                document.getElementById('map-view').style.display = 'block';
                document.getElementById('center-marker').style.display = 'block';
                updateToggleButton('List', 'list');
                applyFilters(); 
            } else if(tab === 'list') {
                list.style.display = 'block';
                updateToggleButton('Map', 'map');
                applyFilters();
            } else if(tab === 'recent') {
                list.style.display = 'block';
                renderRecents();
            } else if(tab === 'saved') {
                list.style.display = 'block';
                renderFavorites();
            } else if(tab === 'zmanim') {
                zmanim.style.display = 'block';
                renderZmanim();
            } else if(tab === 'settings') {
                settings.style.display = 'block';
            }
        }

        function toggleFilters() {
            const d = document.getElementById('filter-drawer');
            d.style.display = (d.style.display === 'block') ? 'none' : 'block';
        }

        function toggleView() {
            document.getElementById('filter-drawer').style.display = 'none';
            const mapVisible = document.getElementById('map-view').style.display === 'block';
            if (mapVisible) switchTab('list'); else switchTab('map');
        }

        function updateToggleButton(text, iconName) {
            document.getElementById('nav-toggle-icon').innerText = iconName;
            document.getElementById('nav-toggle-text').innerText = text;
        }

        // --- ZMANIM RENDER ---
        function renderZmanim() {
            if(searchCenter && typeof searchCenter.lat === 'function') {
                zmanLoc.lat = searchCenter.lat();
                zmanLoc.lng = searchCenter.lng();
                zmanLoc.name = document.getElementById('status-pill').innerText.replace('Near: ', '') || "Map Location";
            }
            const dateStr = currentFilterDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
            const hebDateStr = HebCal.getHebrewStr(currentFilterDate);
            const data = Solar.calc(currentFilterDate, zmanLoc.lat, zmanLoc.lng, zmanLoc.elev);
            const fmt = (ms) => (!ms || isNaN(ms)) ? "--:--" : new Date(ms).toLocaleTimeString('en-US', {hour:'numeric',minute:'2-digit'});
            const mins = m => m*60000;
            const rise = (zmanOpts.sunrise==='elev') ? data.sunElev.rise : data.sunLevel.rise; 
            const set = (zmanOpts.sunset==='elev') ? data.sunElev.set : data.sunLevel.set;

            let html = `
            <div class="zman-header-section">
                <div class="zman-top-row">
                    <div class="zman-title">Zmanim</div>
                    <button class="zman-loc-badge" onclick="openLocModal()">${zmanLoc.name}</button>
                </div>
                <div class="date-nav">
                    <button class="date-btn" onclick="changeDate(-1)"><i class="material-icons">chevron_left</i></button>
                    <div class="date-display-container">
                        <div class="date-display">${dateStr}</div>
                        <div class="hebrew-date">${hebDateStr}</div>
                    </div>
                    <button class="date-btn" onclick="changeDate(1)"><i class="material-icons">chevron_right</i></button>
                </div>
                <div class="zman-info-bar">
                    <div class="zman-info-pill"><span>Day</span><div class="zman-info-val">${currentFilterDate.toLocaleDateString('en-US',{weekday:'long'})}</div></div>
                    <div class="zman-info-pill"><span>Daf Yomi</span><div class="zman-info-val">${DafEngine.get(currentFilterDate)}</div></div>
                </div>
            </div>
            <ul class="zmanim-list" style="padding-top:10px;">`;

            zmanimConfig.forEach(z => {
                let val = ""; let sKey = zmanOpts[z.id]; let sub = "";
                if(z.id === "alot") val = fmt(sKey==='16.1' ? data.alot16 : rise - mins(72));
                if(z.id === "mish") val = fmt(sKey==='10.2' ? data.mish10 : data.mish11);
                if(z.id === "sunrise") val = fmt(rise);
                if(z.id === "chatzos") val = fmt(data.noon);
                if(z.id === "sunset") val = fmt(set);
                if(z.id === "shema" || z.id === "tefila") {
                    let factor = z.id==="shema"?3:4;
                    val = fmt(rise + ((set - rise)/12)*factor);
                }
                if(z.id === "mincha") val = fmt(data.noon + mins(30));
                if(z.id === "plag") val = fmt(rise + ((set - rise)/12)*10.75);
                if(z.id === "candles") val = fmt(set - mins(18));
                if(z.id === "tzais") val = fmt(sKey==='8.5' ? data.tzais85 : set+mins(72));
                if(z.id === "shaa") { val = ((set-rise)/720).toFixed(1); sub="min"; }

                html += `<li class="zman-card">
                    <div class="zman-left"><span class="zman-label">${z.label}</span><span class="zman-desc">${z.desc}</span></div>
                    <div class="zman-right"><span class="zman-time">${val}</span>${sub?`<span class="zman-sub">${sub}</span>`:''}</div>
                </li>`;
            });
            document.getElementById('zmanim-view').innerHTML = html + "</ul>";
        }

        // --- CORE FUNCTIONS ---
        function changeDate(days) {
            currentFilterDate.setDate(currentFilterDate.getDate() + days);
            updateDateDisplay();
            if(currentTab === 'zmanim') renderZmanim();
            else { processMinyanim(fullDbData); applyFilters(); }
        }

        function updateDateDisplay() {
            const options = { weekday: 'long', month: 'short', day: 'numeric', year: 'numeric' };
            document.getElementById('date-display').innerText = currentFilterDate.toLocaleDateString('en-US', options);
            document.getElementById('hebrew-date').innerText = HebCal.getHebrewStr(currentFilterDate);
        }

        function processMinyanim(data){
            processedMinyanim = [];
            allNusachs = new Set();
            const d = currentFilterDate.getDay();
            const key = (d===0)?'sun':((d===1||d===4)?'mon_thu':'tue_wed_fri');
            data.forEach(shul => {
                if(shul.nusach) allNusachs.add(shul.nusach.trim());
                let hasTimes = false;
                const add = (list, type) => { if(list) list.forEach(t => { 
                    let [h,m] = t.split(':').map(Number); let v = (h*60)+m;
                    if(type==='Mincha' && h<9) v+=720; if(type==='Maariv' && h<12) v+=720;
                    processedMinyanim.push({...shul, tefillah: type, timeDisplay: t, timeValue: v}); hasTimes = true; 
                })};
                add(shul.shacharis?.[key], 'Shacharis');
                add(shul.mincha?.week, 'Mincha');
                add(shul.maariv?.week, 'Maariv');
                if(!hasTimes) processedMinyanim.push({...shul, tefillah: 'None', timeDisplay: 'None', timeValue: 9999});
            });
            allMinyanim = processedMinyanim;
        }

        function applyFilters(){
            if(!searchCenter || !allMinyanim.length) return;
            let results = allMinyanim.map(m => { m.distance = getDistance(searchCenter.lat, searchCenter.lng, m.lat, m.lng); return m; });
            const isMapMode = (currentTab === 'map' && document.getElementById("list-view").style.display === 'none');
            if(!isMapMode) results = results.filter(m => m.distance <= currentRadius);
            else if(map) { const b = map.getBounds(); if(b) results = results.filter(m => b.contains({lat:m.lat, lng:m.lng})); }
            
            const uniqueShuls = new Set(results.map(r => r.name + r.address)).size;
            if(isMapMode) {
                document.getElementById('map-radius-pill').style.display = 'block';
                document.getElementById('count-pill').innerText = `${uniqueShuls} Shuls`;
            } else {
                document.getElementById('map-radius-pill').style.display = 'none';
                document.getElementById('count-pill').innerText = `${uniqueShuls} Shuls / ${results.length} Minyanim`;
            }
            renderList(results);
            if(isMapMode) updateMapMarkers(results);
        }

        function renderList(results){
            const list = document.getElementById("list-view");
            list.innerHTML = (currentTab==='recent'||currentTab==='saved') ? `<div class="page-header">${currentTab.charAt(0).toUpperCase()+currentTab.slice(1)}</div>` : "";
            results.forEach(m => {
                const card = document.createElement("div");
                card.className = "minyan-card";
                card.innerHTML = `
                    <div class="info-zone" onclick='openDetails(${JSON.stringify(m)})'>
                        <div class="shul-name">${m.name}</div>
                        <div class="shul-address">${m.address}</div>
                        <div class="shul-city">${m.city}, ${m.state}</div>
                        <div class="nusach-tag-list">${m.nusach}</div>
                    </div>
                    <div class="map-zone">
                        <div class="tefillah-label">${m.tefillah}</div>
                        <div class="time-val-card">${m.timeDisplay}</div>
                        <div class="dist-row"><span class="dist-label">${m.distance.toFixed(1)}mi</span><div class="map-circle"><i class="material-icons google-maps-icon">place</i></div></div>
                    </div>`;
                list.appendChild(card);
            });
        }

        function getDistance(lat1, lon1, lat2, lon2){
            const R = 3958.8; const dLat = (lat2-lat1)*Math.PI/180; const dLon = (lon2-lon1)*Math.PI/180;
            const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function openLocModal() { document.getElementById('locModal').classList.add('active'); }
        function useMyLocation() { navigator.geolocation.getCurrentPosition(p => setSearchLocation(p.coords.latitude, p.coords.longitude, "My Location")); }
        function useMyLocationForZmanim() { navigator.geolocation.getCurrentPosition(p => selectZmanCity(p.coords.latitude, p.coords.longitude, "My Location")); }

        async function searchCity() {
            const q = document.getElementById('citySearchInput').value;
            const res = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(q)}&count=5&language=en&format=json`);
            const data = await res.json();
            if(!data.results) return;
            let html = '';
            data.results.forEach(c => {
                html += `<div style="padding:10px;border-bottom:1px solid #eee;cursor:pointer;" onclick="selectZmanCity(${c.latitude}, ${c.longitude}, '${c.name}')"><b>${c.name}</b>, ${c.country}</div>`;
            });
            document.getElementById('citySearchResults').innerHTML = html;
        }

        function selectZmanCity(lat, lng, name) {
            zmanLoc = { lat, lng, name, elev: 30, tz: 'America/New_York' };
            renderZmanim();
            document.getElementById('locModal').classList.remove('active');
        }

        function saveProfile() { localStorage.setItem('shultime_profile', JSON.stringify({name:document.getElementById('profile-name').value, phone:document.getElementById('profile-phone').value})); }
        function loadProfile() { const p = JSON.parse(localStorage.getItem('shultime_profile') || "{}"); if(p.name) document.getElementById('profile-name').value = p.name; if(p.phone) document.getElementById('profile-phone').value = p.phone; }

        async function initApp(){
            const { Map } = await google.maps.importLibrary("maps");
            const { PlaceAutocompleteElement } = await google.maps.importLibrary("places");
            const autocomplete = new PlaceAutocompleteElement();
            document.getElementById("autocomplete-container").appendChild(autocomplete);
            map = new Map(document.getElementById("map-view"), { center: { lat: 40.091, lng: -74.218 }, zoom: 12, disableDefaultUI: true, mapId: "DEMO_MAP_ID" });
            map.addListener('idle', () => {
                const center = map.getCenter();
                searchCenter = { lat: center.lat(), lng: center.lng() };
                document.getElementById('status-pill').innerText = "Near: Map Center";
                applyFilters();
            });
            autocomplete.addEventListener("gmp-select", async (e) => {
                const place = e.placePrediction.toPlace();
                await place.fetchFields({ fields: ["displayName", "location"] });
                setSearchLocation(place.location.lat(), place.location.lng(), place.displayName);
            });
        }
    </script>
    <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAOpNebt0dPJUmiEw-i1W-Dx_UezLpIvxI&loading=async&libraries=places,maps,marker&callback=initApp"></script>
</body>
</html>
