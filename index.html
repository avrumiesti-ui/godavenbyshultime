<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>ShulTime</title>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<style>
    :root { 
        --primary: #007AFF; /* iOS Blue */
        --bg: #F2F4F8; 
        --glass: rgba(255, 255, 255, 0.85);
        --shadow: 0 10px 40px rgba(0,0,0,0.1);
    }
    
    html, body { margin: 0; padding: 0; height: 100%; overscroll-behavior-y: contain; }
    body { font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif; background: var(--bg); overflow: hidden; -webkit-font-smoothing: antialiased; }
    
    /* --- LIQUID HEADER --- */
    .floating-header {
        position: fixed; top: 0; left: 0; right: 0;
        padding: 15px 15px 15px;
        z-index: 1000; display: flex; gap: 12px; align-items: center; 
        background: linear-gradient(180deg, rgba(242,244,248,1) 0%, rgba(242,244,248,0.9) 80%, rgba(242,244,248,0) 100%);
        pointer-events: none;
    }
    .floating-header > * { pointer-events: auto; }

    .search-container {
        flex: 1; display: flex; align-items: center;
        background: #fff; height: 50px; border-radius: 25px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.08); padding: 0 15px;
        overflow: hidden; transition: transform 0.2s ease;
    }
    .search-container:active { transform: scale(0.98); }

    /* GOOGLE COMPONENT OVERRIDES */
    gmp-place-autocomplete { width: 100%; }
    gmp-place-autocomplete::part(input) { background: transparent; padding: 0; font-size: 17px; font-weight: 500; color: #111; }
    .pac-container { border-radius: 16px; box-shadow: 0 15px 40px rgba(0,0,0,0.15); border: none; margin-top: 10px; font-family: inherit; }
    .pac-item { padding: 12px; font-size: 15px; border-top: 1px solid #f5f5f5; }

    .circle-btn {
        width: 50px; height: 50px; flex-shrink: 0;
        border-radius: 50%; background: #fff; border: none;
        box-shadow: 0 4px 15px rgba(0,0,0,0.08); 
        display: flex; align-items: center; justify-content: center;
        cursor: pointer; color: #333; transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
    }
    .circle-btn:active { transform: scale(0.9); }
    .circle-btn.active { background: #333; color: #fff; }

    /* STATUS PILLS */
    .status-area {
        position: fixed; top: 85px; left: 0; right: 0;
        display: flex; justify-content: center; gap: 8px; z-index: 800; pointer-events: none;
    }
    .status-pill {
        padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 700;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08); backdrop-filter: blur(10px);
        background: rgba(255,255,255,0.95); color: #333; display: none;
    }
    #map-radius-pill { background: #34C759; color: #fff; }

    /* LIST VIEW */
    #list-view { 
        position: absolute; inset: 0; 
        padding: 120px 15px 100px;
        overflow-y: auto; -webkit-overflow-scrolling: touch;
        z-index: 10;
    }
    #map-view { position: absolute; inset: 0; z-index: 5; }

    #center-marker {
        position: fixed; top: 50%; left: 50%; width: 12px; height: 12px;
        background: #007AFF; border: 3px solid #fff; border-radius: 50%;
        transform: translate(-50%, -50%); z-index: 20; 
        box-shadow: 0 4px 10px rgba(0,0,0,0.3); display: none; pointer-events: none;
    }

    /* CARD DESIGN - COMPACT */
    .minyan-card {
        background: #fff; border-radius: 18px; margin-bottom: 10px;
        display: flex; justify-content: space-between; align-items: stretch;
        box-shadow: 0 4px 12px rgba(0,0,0,0.04); overflow: hidden; 
        min-height: 85px; transition: transform 0.1s;
    }
    .minyan-card:active { transform: scale(0.98); }

    .info-zone { 
        flex: 1; padding: 12px 15px; cursor: pointer; 
        display: flex; flex-direction: column; justify-content: center; min-width: 0;
    }
    .shul-name { font-weight: 700; font-size: 17px; color: #000; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .shul-address { font-size: 14px; color: #8E8E93; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; } /* Larger Address */
    
    .map-zone { 
        width: 110px; background: #FAFAFA; border-left: 1px solid #F0F0F0;
        display: flex; flex-direction: column; align-items: flex-end; justify-content: space-between;
        padding: 10px 12px; flex-shrink: 0; cursor: pointer;
    }
    
    .tefillah-label { font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; }
    .time-val { font-weight: 700; font-size: 18px; color: #007AFF; margin: auto 0; }
    
    .map-footer { display: flex; align-items: flex-end; gap: 6px; }
    .dist-label { font-size: 12px; font-weight: 600; color: #999; margin-bottom: 2px; }
    .map-circle {
        width: 26px; height: 26px; border-radius: 50%; background: #fff;
        display: flex; align-items: center; justify-content: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.08); border: 1px solid #eee;
        color: #007AFF;
    }

    /* TAGS & COLORS */
    .nusach-tag { 
        font-size: 10px; padding: 4px 10px; border-radius: 12px; 
        display: inline-block; font-weight: 700; text-transform: uppercase; margin-top: 6px; 
    }
    
    .cls-Ashkenaz { background: #E3F2FD; color: #1565C0; }
    .cls-Sefard { background: #E8F5E9; color: #2E7D32; }
    .cls-Ari { background: #F3E5F5; color: #7B1FA2; }
    .cls-Edot-HaMizrach { background: #FFF3E0; color: #E65100; }
    .cls-Chabad { background: #FFF8E1; color: #F9A825; }
    .cls-Other { background: #F5F5F5; color: #616161; }

    .txt-Shacharis { color: #34C759; } 
    .txt-Mincha { color: #FF9500; } 
    .txt-Maariv { color: #5856D6; }

    /* FILTERS - iOS GLASS */
    #filter-drawer {
        display: none; position: fixed; top: 85px; left: 15px; right: 15px;
        background: rgba(255,255,255,0.95); border-radius: 24px; padding: 20px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.15); z-index: 2000;
        backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
        max-width: 500px; margin: 0 auto;
        border: 1px solid rgba(255,255,255,0.5);
    }
    .filter-group { margin-bottom: 20px; }
    .f-label { font-size: 11px; font-weight: 700; color: #8E8E93; text-transform: uppercase; margin-bottom: 8px; display: block; letter-spacing: 0.5px; }
    
    .chip-container { display: flex; flex-wrap: wrap; gap: 8px; }
    .chip { 
        padding: 8px 14px; border-radius: 18px; border: 1px solid #E5E5EA; 
        background: #fff; font-size: 13px; font-weight: 600; color: #1C1C1E; 
        cursor: pointer; transition: all 0.2s;
    }
    .chip.active { transform: scale(1.05); border-color: transparent !important; color: #fff !important; }
    
    /* Filter Colors */
    .chip.active.c-Ashkenaz { background: #007AFF; }
    .chip.active.c-Sefard { background: #34C759; }
    .chip.active.c-Ari { background: #AF52DE; }
    .chip.active.c-Edot-HaMizrach { background: #FF9500; }
    .chip.active.c-Chabad { background: #FFCC00; color: #000 !important; }
    .chip.active.c-Other { background: #8E8E93; }
    
    .chip.active.c-Shacharis { background: #34C759; }
    .chip.active.c-Mincha { background: #FF9500; }
    .chip.active.c-Maariv { background: #5856D6; }
    .chip.active.c-All { background: #1C1C1E; }

    /* DATE PICKER */
    .date-row { display: flex; align-items: center; justify-content: space-between; background: #F2F2F7; padding: 6px; border-radius: 18px; }
    .date-btn { background: #fff; border: none; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05); cursor: pointer; color: #007AFF; }
    .date-text { font-weight: 700; font-size: 15px; color: #000; }

    /* DRAWER */
    #details-drawer {
        position: fixed; bottom: -100%; left: 10px; right: 10px; height: 80vh;
        background: #fff; border-radius: 32px 32px 32px 32px;
        z-index: 3000; margin-bottom: 15px;
        box-shadow: 0 10px 50px rgba(0,0,0,0.25);
        transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1);
        display: flex; flex-direction: column; overflow: hidden;
    }
    #details-drawer.open { bottom: 0; transform: translateY(0); }
    
    .drawer-sticky-header {
        padding: 20px 25px 15px; background: #fff; border-bottom: 1px solid #f2f2f7;
        position: sticky; top: 0; z-index: 10;
    }
    .dh-top-row { display: flex; justify-content: space-between; align-items: flex-start; gap: 15px; }
    .dh-info { flex: 1; }
    .dh-title { font-size: 22px; font-weight: 800; color: #000; line-height: 1.1; margin-bottom: 4px; }
    .dh-actions { display: flex; gap: 10px; flex-shrink: 0; }
    
    .action-icon { 
        width: 36px; height: 36px; border-radius: 50%; background: #F2F2F7; 
        border: none; display: flex; align-items: center; justify-content: center; 
        cursor: pointer; color: #333; 
    }
    
    .dh-subtitle { font-size: 14px; color: #8E8E93; font-weight: 500; }
    .dh-rabbi { font-size: 14px; font-weight: 600; color: #007AFF; margin-top: 4px; display: flex; align-items: center; gap: 4px; }

    .drawer-content { flex: 1; overflow-y: auto; padding: 20px 25px 40px; }
    
    .contact-grid { display: flex; gap: 10px; margin-bottom: 25px; }
    .contact-item { 
        flex: 1; background: #F2F2F7; border-radius: 14px; padding: 12px; 
        text-align: center; color: #007AFF; text-decoration: none; font-weight: 600; font-size: 13px;
        display: flex; flex-direction: column; align-items: center; gap: 5px;
    }
    
    .sched-block { margin-bottom: 25px; }
    .sched-header { font-size: 12px; font-weight: 800; color: #8E8E93; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; border-bottom: 1px solid #f0f0f0; padding-bottom: 5px; }
    .sched-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 15px; }
    .sched-label { font-weight: 600; color: #333; }
    .sched-times { font-weight: 400; color: #000; text-align: right; max-width: 60%; }

    #scrim { position: fixed; inset: 0; background: rgba(0,0,0,0.3); z-index: 2500; display: none; backdrop-filter: blur(2px); }

    .fab {
        position: fixed; bottom: 30px; right: 20px; width: 60px; height: 60px;
        background: #fff; border-radius: 50%; box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        display: flex; align-items: center; justify-content: center; color: #007AFF;
        z-index: 900; cursor: pointer; transition: transform 0.2s;
    }
    .fab:active { transform: scale(0.9); }

    /* Map Markers */
    .custom-marker { color: white; padding: 4px 9px; border-radius: 12px; font-size: 13px; font-weight: 800; box-shadow: 0 2px 6px rgba(0,0,0,0.3); border: 2px solid #fff; display: flex; align-items: center; justify-content: center; position: relative; top: 10px; cursor: pointer; transition: transform 0.1s; }
    .marker-Ashkenaz { background: #007AFF; }
    .marker-Sefard { background: #34C759; }
    .marker-Ari { background: #AF52DE; }
    .marker-Edot-HaMizrach { background: #FF9500; }
    .marker-Chabad { background: #FFCC00; color: black; }
    .marker-Other { background: #8E8E93; }
    .custom-marker::after { content: ''; position: absolute; bottom: -5px; left: 50%; transform: translateX(-50%); border-width: 5px 5px 0; border-style: solid; border-color: inherit transparent transparent transparent; }
</style>
</head>
<body>

    <div class="floating-header" onclick="scrollToTop()">
        <div class="search-container" onclick="event.stopPropagation()">
            <div id="autocomplete-container" style="flex:1; height:100%;"></div>
        </div>
        <button class="circle-btn" onclick="toggleFilters(); event.stopPropagation()">
            <i class="material-icons">tune</i>
        </button>
        <button class="circle-btn" id="view-toggle-btn" onclick="toggleView(); event.stopPropagation()">
            <i class="material-icons" id="view-icon">map</i>
        </button>
    </div>

    <div class="status-area">
        <div id="status-pill" class="status-pill"></div>
        <div id="count-pill" class="status-pill"></div>
        <div id="map-radius-pill" class="status-pill"></div>
    </div>

    <div id="filter-drawer">
        <div class="filter-group">
            <label class="f-label">Date</label>
            <div class="date-row">
                <button class="date-btn" onclick="changeDate(-1)"><i class="material-icons">chevron_left</i></button>
                <div class="date-text" id="date-display">Today</div>
                <button class="date-btn" onclick="changeDate(1)"><i class="material-icons">chevron_right</i></button>
            </div>
        </div>

        <div class="filter-group">
            <label class="f-label">Radius (Miles)</label>
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                <input type="range" min="0.5" max="50" step="0.5" id="radius-slider" style="flex:1; accent-color:#007AFF" oninput="manualRadius(this.value)">
                <input type="number" id="radius-input" style="width:50px; padding:8px; border-radius:10px; border:1px solid #ddd; text-align:center; font-weight:bold;" value="20" onchange="manualRadius(this.value)">
            </div>
            <div class="chip-container">
                <div class="chip" onclick="manualRadius(1)">1m</div>
                <div class="chip" onclick="manualRadius(2)">2m</div>
                <div class="chip" onclick="manualRadius(3)">3m</div>
                <div class="chip" onclick="manualRadius(5)">5m</div>
                <div class="chip" onclick="manualRadius(20)">20m</div>
                <div class="chip" onclick="manualRadius(99)">99m</div>
            </div>
        </div>

        <div class="filter-group">
            <label class="f-label">Tefillah</label>
            <div class="chip-container">
                <div class="chip active c-All" onclick="setFilter('tefillah', '', this)">All</div>
                <div class="chip c-Shacharis" onclick="setFilter('tefillah', 'Shacharis', this)">Shacharis</div>
                <div class="chip c-Mincha" onclick="setFilter('tefillah', 'Mincha', this)">Mincha</div>
                <div class="chip c-Maariv" onclick="setFilter('tefillah', 'Maariv', this)">Maariv</div>
            </div>
        </div>

        <div class="filter-group">
            <label class="f-label">Nusach</label>
            <div class="chip-container" id="nusach-group"></div>
        </div>

        <button onclick="toggleFilters()" style="width:100%; padding:14px; background:#007AFF; color:white; border:none; border-radius:16px; font-weight:700; font-size:16px; margin-top:10px;">Done</button>
    </div>

    <div id="list-view">
        <div class="empty-state">
            <i class="material-icons" style="font-size:60px; margin-bottom:20px; color: #007AFF; opacity: 0.3;">temple_buddhist</i><br>
            <strong>Welcome to ShulTime</strong><br><br>
            Start by searching for a city<br>or tapping the location button.
        </div>
    </div>
    
    <div id="map-view"></div>
    <div id="center-marker"></div>

    <div class="fab" onclick="useMyLocation()">
        <i class="material-icons">my_location</i>
    </div>

    <div id="scrim" onclick="closeDetails()"></div>

    <div id="details-drawer">
        <div class="drawer-sticky-header">
            <div class="dh-top-row">
                <div class="dh-info">
                    <div class="dh-title" id="d-name"></div>
                    <div class="dh-rabbi" id="d-rabbi"></div>
                    <div class="dh-subtitle" id="d-address" style="margin-top:6px;"></div>
                </div>
                <div class="dh-actions">
                    <button class="action-icon" onclick="shareShul()">
                        <i class="material-icons" style="font-size:18px">ios_share</i>
                    </button>
                    <button class="action-icon" onclick="closeDetails()">
                        <i class="material-icons">close</i>
                    </button>
                </div>
            </div>
        </div>
        <div class="drawer-content">
            <div class="contact-grid" id="d-contacts"></div>
            <div class="sched-block">
                <div class="sched-header">Weekday Schedule</div>
                <div id="d-sched-week"></div>
            </div>
            <div class="sched-block">
                <div class="sched-header">Shabbos Schedule</div>
                <div id="d-sched-shab"></div>
            </div>
        </div>
    </div>

    <script src="database.js"></script>

    <script>
        let map, allMinyanim = [], processedMinyanim = [], searchCenter = null, currentRadius = 20;
        let filters = { sort: 'time_asc', tefillah: '', nusach: '' };
        let selectedShul = null;
        let markers = [];
        let isProgrammaticMove = false;
        let allNusachs = new Set();
        let currentDate = new Date();

        document.addEventListener("DOMContentLoaded", async () => {
            updateDateUI();
            if(typeof RAW_DB !== 'undefined') {
                processMinyanim(RAW_DB);
                populateNusachFilter();
            } else {
                alert("Error: database.js not found. Please ensure it is in the same folder as index.html");
            }
        });

        // DATE & SCHEDULE LOGIC
        function getTodayKey() {
            const d = currentDate.getDay(); 
            if (d === 0) return 'sun';
            if (d === 1 || d === 4) return 'mon_thu';
            return 'tue_wed_fri';
        }

        function updateDateUI() {
            const options = { weekday: 'long', month: 'short', day: 'numeric' };
            document.getElementById("date-display").innerText = currentDate.toLocaleDateString('en-US', options);
        }

        function changeDate(days) {
            currentDate.setDate(currentDate.getDate() + days);
            updateDateUI();
            if(typeof RAW_DB !== 'undefined') {
                processMinyanim(RAW_DB);
                if(searchCenter) applyFilters();
            }
        }

        function formatTimeShort(tStr) {
            if(!tStr) return "";
            let clean = tStr.replace(/[^0-9:]/g, "");
            let [h,m] = clean.split(":").map(Number);
            let suffix = "a";
            if (h >= 12) suffix = "p";
            // Heuristic for late night maariv/mincha
            
            let h12 = h > 12 ? h - 12 : (h === 0 ? 12 : h);
            let mStr = String(m).padStart(2,"0");
            return `${h12}:${mStr}${suffix}`;
        }

        function processMinyanim(data){
            processedMinyanim = [];
            allNusachs = new Set();
            const todayKey = getTodayKey();

            data.forEach(shul => {
                if(!shul.name) return;
                if(shul.nusach) allNusachs.add(shul.nusach.trim());

                let hasTimes = false;
                
                // Add Today's times
                if (shul.shacharis && shul.shacharis[todayKey]) {
                    shul.shacharis[todayKey].forEach(t => { addMinyan(shul, 'Shacharis', t); hasTimes = true; });
                }
                if (shul.mincha && shul.mincha.week) {
                    shul.mincha.week.forEach(t => { addMinyan(shul, 'Mincha', t); hasTimes = true; });
                }
                if (shul.maariv && shul.maariv.week) {
                    shul.maariv.week.forEach(t => { addMinyan(shul, 'Maariv', t); hasTimes = true; });
                }

                if (!hasTimes) {
                    processedMinyanim.push({
                        ...shul, tefillah: 'Info', timeDisplay: '--:--', ampm: '', timeValue: 9999
                    });
                }
            });
            allMinyanim = processedMinyanim;
        }

        function addMinyan(shul, type, tStr) {
            if(!tStr) return;
            let raw = tStr.trim().replace(/[^0-9:]/g,"");
            if(!raw) return;
            let [h,m] = raw.split(":").map(Number);
            
            // Sort Logic
            let sortH = h;
            if(type === "Mincha" && h < 9) sortH += 12;
            if(type === "Maariv" && h < 4) sortH += 24; 

            // Format Logic (7:00a)
            let suffix = (h >= 12) ? "p" : "a";
            // Correct logic based on type if ambiguous
            if(type === "Shacharis" && h < 11) suffix = "a";
            if(type === "Mincha") suffix = "p";
            if(type === "Maariv") suffix = "p";
            if(type === "Maariv" && h < 4) suffix = "a";

            let h12 = h > 12 ? h - 12 : (h === 0 ? 12 : h);
            let mStr = String(m).padStart(2,"0");
            
            processedMinyanim.push({
                ...shul, tefillah: type, timeDisplay: `${h12}:${mStr}${suffix}`, timeValue: (sortH * 60) + m
            });
        }

        function manualRadius(val) {
            currentRadius = parseFloat(val);
            document.getElementById("radius-input").value = currentRadius;
            document.getElementById("radius-slider").value = currentRadius;
            // Don't refit map to avoid jumping
            applyFilters();
        }

        function applyFilters(){
            if(!searchCenter || !allMinyanim.length) return;
            
            let results = allMinyanim.map(m => {
                m.distance = getDistance(searchCenter.lat, searchCenter.lng, m.lat, m.lng);
                return m;
            }).filter(m => m.distance <= currentRadius);

            if(filters.tefillah) results = results.filter(m => m.tefillah === filters.tefillah);
            if(filters.nusach) results = results.filter(m => m.nusach === filters.nusach);
            
            if(filters.sort === 'distance') results.sort((a,b) => a.distance - b.distance);
            else results.sort((a,b) => a.timeValue - b.timeValue);
            
            const unique = new Set(results.map(r => r.id)).size;
            document.getElementById("status-pill").innerText = `${unique} Shuls Found`;
            document.getElementById("status-pill").style.display = "block";
            document.getElementById("map-radius-pill").innerText = `Radius: ${currentRadius}mi`;
            document.getElementById("map-radius-pill").style.display = "block";

            renderList(results);
            updateMapMarkers(results);
        }

        function renderList(results){
            const list = document.getElementById("list-view");
            list.innerHTML = results.length ? "" : '<div class="empty-state">No minyanim found.<br>Try increasing the radius.</div>';
            
            results.forEach(m => {
                let nCls = `cls-${(m.nusach || 'Other').replace(/\s+/g, '-')}`;
                let tCls = `txt-${m.tefillah}`;
                const godavenId = m.godaven_link ? m.godaven_link.split('/').pop() : m.id;
                const link = `https://www.godaven.com/shul-details/${godavenId}`;
                
                const card = document.createElement("div");
                card.className = "minyan-card";
                
                let rightSide = '';
                if(m.timeValue === 9999) {
                    rightSide = `<div class="map-zone" onclick="window.open('${link}','_blank')">
                        <div class="map-footer">
                            <div class="dist-label">${m.distance.toFixed(1)}mi</div>
                            <div class="map-circle"><i class="material-icons google-maps-icon">place</i></div>
                        </div>
                    </div>`;
                } else {
                    rightSide = `<div class="map-zone" onclick="window.open('${link}','_blank')">
                        <div class="tefillah-label ${tCls}">${m.tefillah}</div>
                        <div class="time-val">${m.timeDisplay}</div>
                        <div class="map-footer">
                            <div class="dist-label">${m.distance.toFixed(1)}mi</div>
                            <div class="map-circle"><i class="material-icons google-maps-icon">place</i></div>
                        </div>
                    </div>`;
                }

                card.innerHTML = `
                    <div class="info-zone" onclick='openDetails(${JSON.stringify(m).replace(/'/g, "&#39;")})'>
                        <div class="shul-name">${m.name}</div>
                        <div class="shul-address">${m.address}</div>
                        <div class="nusach-tag ${nCls}">${m.nusach}</div>
                    </div>
                    ${rightSide}`;
                list.appendChild(card);
            });
        }

        async function updateMapMarkers(results) {
            if (!map) return;
            const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");
            markers.forEach(m => m.map = null); markers = [];
            
            const groups = {};
            results.forEach(r => {
                const key = r.lat + "," + r.lng;
                if (!groups[key] || r.timeValue < groups[key].timeValue) groups[key] = r;
            });

            Object.values(groups).forEach(m => {
                const pin = document.createElement("div");
                let nCls = `marker-${(m.nusach || 'Other').replace(/\s+/g, '-')}`;
                pin.className = `custom-marker ${nCls}`;
                pin.textContent = (m.timeValue === 9999) ? "?" : m.timeDisplay; 

                const marker = new AdvancedMarkerElement({
                    map: map, position: { lat: m.lat, lng: m.lng },
                    content: pin, title: m.name
                });
                marker.element.addEventListener("click", () => openDetails(m));
                markers.push(marker);
            });
        }

        function onMapIdle() {
            if (isProgrammaticMove) { isProgrammaticMove = false; return; }
            if(!map) return;
            const center = map.getCenter();
            searchCenter = { lat: center.lat(), lng: center.lng() };
            const bounds = map.getBounds();
            const ne = bounds.getNorthEast();
            const r = getDistance(center.lat(), center.lng(), ne.lat(), ne.lng());
            
            document.getElementById("radius-input").value = r.toFixed(1);
            document.getElementById("radius-slider").value = r.toFixed(1);
            currentRadius = r;
            applyFilters();
        }

        function openDetails(m) {
            selectedShul = m;
            document.getElementById("d-name").innerText = m.name;
            document.getElementById("d-address").innerText = m.address + ", " + m.city;
            
            const rDiv = document.getElementById("d-rabbi");
            if(m.rabbi && m.rabbi !== "Rabbi Not Listed") {
                rDiv.innerHTML = `<i class="material-icons" style="font-size:16px;">person</i> ${m.rabbi}`;
            } else { rDiv.innerHTML = ""; }

            // Contacts
            const cDiv = document.getElementById("d-contacts");
            cDiv.innerHTML = "";
            const godavenId = m.godaven_link ? m.godaven_link.split('/').pop() : m.id;
            
            if(m.phone) cDiv.innerHTML += `<a href="tel:${m.phone}" class="contact-item"><i class="material-icons">call</i>Call</a>`;
            if(m.email) cDiv.innerHTML += `<a href="mailto:${m.email}" class="contact-item"><i class="material-icons">email</i>Email</a>`;
            cDiv.innerHTML += `<a href="https://www.godaven.com/shul-details/${godavenId}" target="_blank" class="contact-item"><i class="material-icons">open_in_new</i>GoDaven</a>`;

            // Formatter helper
            const f = (list) => (!list || list.length===0) ? "-" : list.map(t => formatTimeShort(t)).join(", ");

            // Schedule
            document.getElementById("d-sched-week").innerHTML = `
                <div class="sched-row"><span class="sched-label">Sun Shacharis</span><span class="sched-times">${f(m.shacharis?.sun)}</span></div>
                <div class="sched-row"><span class="sched-label">M/Th Shacharis</span><span class="sched-times">${f(m.shacharis?.mon_thu)}</span></div>
                <div class="sched-row"><span class="sched-label">T/W/F Shacharis</span><span class="sched-times">${f(m.shacharis?.tue_wed_fri)}</span></div>
                <div class="sched-row"><span class="sched-label">Mincha</span><span class="sched-times">${f(m.mincha?.week)}</span></div>
                <div class="sched-row"><span class="sched-label">Maariv</span><span class="sched-times">${f(m.maariv?.week)}</span></div>
            `;
            
            document.getElementById("d-sched-shab").innerHTML = `
                <div class="sched-row"><span class="sched-label">Fri Mincha</span><span class="sched-times">${f(m.mincha?.fri)}</span></div>
                <div class="sched-row"><span class="sched-label">Shab Mincha</span><span class="sched-times">${f(m.mincha?.shabbos)}</span></div>
                <div class="sched-row"><span class="sched-label">Motzei Maariv</span><span class="sched-times">${f(m.maariv?.shabbos)}</span></div>
            `;

            document.getElementById("details-drawer").classList.add("open");
            document.getElementById("scrim").style.display = "block";
        }

        function closeDetails() {
            document.getElementById("details-drawer").classList.remove("open");
            document.getElementById("scrim").style.display = "none";
        }

        async function shareShul() {
            if(!selectedShul) return;
            const godavenId = selectedShul.godaven_link ? selectedShul.godaven_link.split('/').pop() : selectedShul.id;
            const link = `https://www.godaven.com/shul-details/${godavenId}`;
            const text = `Shared by ShulTime:\n${selectedShul.name}\n${selectedShul.address}\nLink: ${link}`;
            if(navigator.share) {
                try { await navigator.share({ title: selectedShul.name, text: text, url: link }); } 
                catch(e) {}
            } else {
                navigator.clipboard.writeText(text + " " + link);
                alert("Copied to clipboard!");
            }
        }

        function scrollToTop() {
            document.getElementById('list-view').scrollTo({ top: 0, behavior: 'smooth' });
        }

        function toggleFilters() {
            const d = document.getElementById('filter-drawer');
            d.style.display = (d.style.display === 'block') ? 'none' : 'block';
        }

        function populateNusachFilter() {
            const group = document.getElementById("nusach-group");
            group.innerHTML = `<div class="chip active c-All" onclick="setFilter('nusach', '', this)">All</div>`;
            Array.from(allNusachs).sort().forEach(n => {
                if(!n) return;
                const safe = n.replace(/\s+/g, '-');
                const div = document.createElement("div");
                div.className = `chip c-${safe}`;
                div.innerText = n;
                div.onclick = function() { setFilter('nusach', n, this); };
                group.appendChild(div);
            });
        }

        function setFilter(type, val, btn) {
            filters[type] = val;
            const group = btn.parentElement;
            group.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
            btn.classList.add('active');
            applyFilters();
        }

        function toggleView() {
            document.getElementById('filter-drawer').style.display = 'none';
            const list = document.getElementById("list-view");
            const btn = document.getElementById("view-toggle-btn");
            const icon = document.getElementById("view-icon");
            const mapPill = document.getElementById("map-radius-pill");
            const dot = document.getElementById("center-marker");

            if (list.style.display === "none") {
                list.style.display = "block";
                icon.innerText = "map";
                btn.classList.remove("active");
                mapPill.style.display = "none";
                dot.style.display = "none";
            } else {
                list.style.display = "none";
                icon.innerText = "list";
                btn.classList.add("active");
                mapPill.style.display = "block";
                dot.style.display = "block";
                if(map && searchCenter && !isProgrammaticMove) {
                    isProgrammaticMove = true;
                    map.panTo(searchCenter);
                }
            }
        }

        function getDistance(lat1, lon1, lat2, lon2){
            const R = 3958.8; const dLat = (lat2 - lat1) * Math.PI / 180; const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2)**2;
            return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
        }

        function setSearchLocation(lat, lng, name) {
            searchCenter = { lat, lng };
            document.getElementById("status-pill").innerText = `Near: ${name}`;
            document.getElementById("status-pill").style.display = "block";
            
            if(map) {
                isProgrammaticMove = true;
                map.setCenter({ lat, lng });
                map.setZoom(13);
            }
            applyFilters();
        }

        function useMyLocation() {
            navigator.geolocation.getCurrentPosition(pos => {
                setSearchLocation(pos.coords.latitude, pos.coords.longitude, "Current Location");
            }, e => alert("Please enable Location Services."));
        }

        function clearSearch(){
            searchCenter = null;
            document.getElementById("list-view").innerHTML = `<div class="empty-state">Start by searching...</div>`;
        }

        async function initApp(){
            const { Map } = await google.maps.importLibrary("maps");
            const { PlaceAutocompleteElement } = await google.maps.importLibrary("places");
            
            const autocomplete = new PlaceAutocompleteElement();
            autocomplete.setAttribute("types", "(cities)");
            document.getElementById("autocomplete-container").appendChild(autocomplete);

            map = new Map(document.getElementById("map-view"), {
                center: { lat: 40.091, lng: -74.218 },
                zoom: 12, disableDefaultUI: true, mapId: "DEMO_MAP_ID"
            });
            map.addListener('idle', onMapIdle);

            autocomplete.addEventListener('gmp-select', async (e) => {
                if (e.placePrediction) {
                    const place = e.placePrediction.toPlace();
                    await place.fetchFields({ fields: ["displayName", "location"] });
                    setSearchLocation(place.location.lat(), place.location.lng(), place.displayName);
                }
            });
        }
    </script>
    <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAOpNebt0dPJUmiEw-i1W-Dx_UezLpIvxI&loading=async&libraries=places,maps,marker&callback=initApp"></script>
</body>
</html>
