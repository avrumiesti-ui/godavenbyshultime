<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>ShulTime</title>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<style>
    :root { 
        --primary: #0D2B4F; 
        --bg: #F2F4F8; 
    }
    
    html, body { margin: 0; padding: 0; height: 100%; overscroll-behavior-y: contain; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Roboto", sans-serif; background: var(--bg); overflow: hidden; }
    
    /* FLOATING HEADER */
    .floating-header {
        position: fixed; top: 15px; left: 12px; right: 12px;
        z-index: 1000; display: flex; gap: 10px; align-items: center; pointer-events: auto;
    }
    .search-container {
        flex: 1; pointer-events: auto; display: flex; align-items: center;
        background: #fff; height: 50px; border-radius: 25px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.15); padding: 0 15px;
        overflow: hidden; 
    }
    gmp-place-autocomplete { width: 100%; height: 100%; background-color: #fff !important; }
    .circle-btn {
        width: 50px; height: 50px; flex-shrink: 0; pointer-events: auto;
        border-radius: 50%; background: #fff; border: none;
        box-shadow: 0 4px 15px rgba(0,0,0,0.15); display: flex; align-items: center; justify-content: center;
        cursor: pointer; color: var(--primary);
    }

    /* STATUS PILLS */
    .status-area {
        position: fixed; top: 75px; left: 0; right: 0;
        display: flex; justify-content: center; align-items: center; gap: 8px;
        z-index: 800; pointer-events: none;
    }
    #status-pill, #count-pill, #map-radius-pill {
        padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: 700;
        display: none; box-shadow: 0 2px 8px rgba(0,0,0,0.1); background: #fff; color: var(--primary); border: 1px solid var(--primary);
    }
    #status-pill { background: rgba(13, 43, 79, 0.95); color: #fff; border: none; }
    #map-radius-pill { background: #2E7D32; color: #fff; border: none; }

    /* VIEWS */
    #list-view, #zmanim-view, #settings-view { 
        position: absolute; inset: 0; 
        padding-bottom: 120px; 
        overflow-y: auto; background: var(--bg); 
        z-index: 10; display: none;
    }
    #map-view { position: absolute; inset: 0; z-index: 5; }

    /* CARD STYLES */
    .minyan-card {
        background: #fff; border-radius: 12px; margin-bottom: 8px;
        display: flex; justify-content: space-between; align-items: stretch;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05); overflow: hidden; 
        height: 85px; box-sizing: border-box;
    }
    .info-zone { width: 60%; padding: 8px 12px; display: flex; flex-direction: column; justify-content: center; border-right: 1px solid #f0f0f0; }
    .map-zone { width: 40%; background: #fafafa; position: relative; }
    
    .shul-name { font-weight: 800; font-size: 16px; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .shul-address { font-size: 12px; color: #666; }
    .nusach-tag-list { font-size: 10px; padding: 2px 6px; border-radius: 4px; background: #eee; display: inline-block; width: fit-content; margin-top: 4px; font-weight: 700; }

    .tefillah-label { position: absolute; top: 8px; right: 40px; font-size: 10px; font-weight: 900; color: #555; text-transform: uppercase; } 
    .time-val-card { position: absolute; top: 50%; right: 40px; transform: translateY(-50%); padding: 4px 8px; border-radius: 6px; font-weight: 800; font-size: 16px; background: #E8EAF6; color: var(--primary); }
    .dist-row { position: absolute; bottom: 8px; right: 40px; display: flex; align-items: center; gap: 4px; font-size: 11px; font-weight: 700; color: #666; }
    .map-circle { width: 24px; height: 24px; border-radius: 50%; background: #fff; display: flex; align-items: center; justify-content: center; border: 1px solid #eee; }
    
    /* CUSTOM MARKER */
    .custom-marker { padding: 4px 8px; border-radius: 8px; background: white; font-weight: bold; font-size: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.3); border: 1px solid #ccc; position: relative; top: -10px; }
    .custom-marker::after { content: ""; position: absolute; bottom: -5px; left: 50%; transform: translateX(-50%); border-width: 5px 5px 0; border-style: solid; border-color: white transparent transparent transparent; }

    /* ZMANIM STYLES */
    .zman-header-section { background: #fff; padding: 40px 20px 15px; position: sticky; top: 0; z-index: 20; border-bottom: 1px solid #eee; }
    .zman-top-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .zman-title { font-size: 34px; font-weight: 800; color: var(--primary); margin: 0; }
    .zman-card { background: #fff; border-radius: 12px; padding: 15px; margin: 0 15px 10px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .zman-time { font-size: 20px; font-weight: 800; color: var(--primary); font-family: monospace; }
    
    /* FILTER DRAWER */
    #filter-drawer { display: none; position: fixed; top: 80px; left: 12px; right: 12px; background: #fff; border-radius: 20px; padding: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.25); z-index: 2000; }
    
    /* TOOLBAR */
    .floating-toolbar { position: fixed; bottom: 30px; left: 20px; right: 20px; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px); border: 1px solid rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; z-index: 1500; border-radius: 40px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
    .nav-item { display: flex; flex-direction: column; align-items: center; border: none; background: none; color: #999; font-size: 10px; font-weight: 600; flex: 1; cursor: pointer; }
    .nav-item.active { color: var(--primary); }
    .nav-item i { font-size: 24px; margin-bottom: 2px; }
    #nav-toggle { font-weight: 800; color: var(--primary); }

    .fab-location { position: fixed; bottom: 100px; right: 20px; width: 50px; height: 50px; background: #fff; border-radius: 50%; box-shadow: 0 4px 15px rgba(0,0,0,0.2); border: none; color: var(--primary); display: flex; align-items: center; justify-content: center; z-index: 900; }

    /* UTILS */
    .page-header { padding: 40px 20px 15px; font-size: 34px; font-weight: 800; color: var(--primary); }
    .empty-state { text-align: center; color: #666; margin-top: 50px; padding: 0 20px; }
</style>
</head>
<body>

    <div class="floating-header" id="filter-header">
        <div class="search-container">
            <div id="autocomplete-container" style="flex:1; height:100%;"></div>
        </div>
        <button class="circle-btn" onclick="toggleFilters()">
            <i class="material-icons">tune</i>
        </button>
    </div>

    <div class="status-area">
        <div id="status-pill"></div>
        <div id="count-pill"></div>
        <div id="map-radius-pill"></div>
    </div>

    <div id="map-view"></div>
    <div id="list-view"></div>
    <div id="zmanim-view"></div>
    <div id="settings-view">
        <div class="page-header">Settings</div>
        <div class="empty-state">Settings coming soon...</div>
    </div>

    <div id="filter-drawer">
        <h3 style="margin-top:0;">Filters</h3>
        <p>Radius: <span id="rad-val">20</span> mi</p>
        <input type="range" min="1" max="50" value="20" style="width:100%" oninput="manualRadiusUpdate(this.value)">
        <button class="circle-btn" style="width:100%; border-radius:12px; margin-top:15px; background:var(--primary); color:white;" onclick="toggleFilters()">Done</button>
    </div>

    <button class="fab-location" onclick="useMyLocation()"><i class="material-icons">my_location</i></button>

    <div class="floating-toolbar">
        <button class="nav-item" id="nav-recent" onclick="switchTab('recent')"><i class="material-icons">history</i>Recent</button>
        <button class="nav-item" id="nav-zmanim" onclick="switchTab('zmanim')"><i class="material-icons">access_time</i>Zmanim</button>
        <button class="nav-item active" id="nav-toggle" onclick="toggleView()"><i class="material-icons" id="nav-toggle-icon">list</i><span id="nav-toggle-text">List</span></button>
        <button class="nav-item" id="nav-saved" onclick="switchTab('saved')"><i class="material-icons">bookmark_border</i>Saved</button>
        <button class="nav-item" id="nav-settings" onclick="switchTab('settings')"><i class="material-icons">settings</i>Settings</button>
    </div>

    <script>
        // --- 1. GLOBAL VARIABLES ---
        let map, allMinyanim = [], processedMinyanim = [], searchCenter = null, currentRadius = 20;
        let markers = [];
        let currentFilterDate = new Date();
        let currentTab = 'map';
        let zmanLoc = { lat: 40.096, lng: -74.222, name: 'Lakewood, NJ', elev: 30, tz: 'America/New_York' };

        // --- 2. SAMPLE DATA (FALLBACK) ---
        const SAMPLE_DATA = [
            { "id": 1, "name": "Bais Medrash Govoah", "address": "617 6th St", "city": "Lakewood", "state": "NJ", "lat": 40.093, "lng": -74.222, "nusach": "Ashkenaz", "shacharis": {"sun":["7:00a","8:00a"],"week":["6:30a"]}, "mincha":{"week":["1:30p"]}, "maariv":{"week":["9:30p"]} },
            { "id": 2, "name": "Satmar", "address": "Forest Ave", "city": "Lakewood", "state": "NJ", "lat": 40.080, "lng": -74.210, "nusach": "Sefard", "shacharis": {"sun":["8:30a"],"week":["8:00a"]}, "mincha":{"week":["2:00p"]}, "maariv":{"week":["9:00p"]} },
            { "id": 3, "name": "Khal Chasidim", "address": "1401 Cedar Row", "city": "Lakewood", "state": "NJ", "lat": 40.089, "lng": -74.215, "nusach": "Sefard", "shacharis": {"sun":["9:00a"],"week":["7:45a"]}, "mincha":{"week":["1:45p"]}, "maariv":{"week":["10:00p"]} }
        ];

        // --- 3. INITIALIZATION ---
        document.addEventListener("DOMContentLoaded", async () => {
            // Load Data
            try {
                const res = await fetch("database.json");
                if(!res.ok) throw new Error("Failed");
                const data = await res.json();
                processData(data);
            } catch(e) {
                console.log("Using Sample Data");
                processData(SAMPLE_DATA);
            }
        });

        // --- 4. DATA PROCESSING ---
        function processData(data) {
            allMinyanim = [];
            data.forEach(shul => {
                // Flatten minyanim for easier searching/listing
                const add = (list, type) => { if(list) list.forEach(t => allMinyanim.push({...shul, tefillah: type, timeDisplay: t})) };
                // Simple logic for sample (week vs sun)
                const isSun = currentFilterDate.getDay() === 0;
                const key = isSun ? 'sun' : 'week';
                
                add(shul.shacharis?.[key] || shul.shacharis?.week, 'Shacharis');
                add(shul.mincha?.[key] || shul.mincha?.week, 'Mincha');
                add(shul.maariv?.[key] || shul.maariv?.week, 'Maariv');
            });
            // Initial render if map isn't ready
            if(!map) console.log("Data loaded, waiting for map...");
        }

        // --- 5. GOOGLE MAPS INIT ---
        async function initApp() {
            const { Map } = await google.maps.importLibrary("maps");
            const { PlaceAutocompleteElement } = await google.maps.importLibrary("places");
            const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");

            const autocomplete = new PlaceAutocompleteElement();
            document.getElementById("autocomplete-container").appendChild(autocomplete);

            map = new Map(document.getElementById("map-view"), {
                center: { lat: 40.091, lng: -74.218 }, // Lakewood Default
                zoom: 13,
                disableDefaultUI: true,
                mapId: "DEMO_MAP_ID"
            });

            // Map Events
            map.addListener('idle', () => {
                const center = map.getCenter();
                searchCenter = { lat: center.lat(), lng: center.lng() };
                zmanLoc = { lat: searchCenter.lat, lng: searchCenter.lng, name: "Map Location", elev: 30, tz: 'America/New_York' };
                document.getElementById('status-pill').innerText = "Near: Map Center";
                applyFilters(AdvancedMarkerElement);
            });

            autocomplete.addEventListener("gmp-select", async (e) => {
                const place = e.placePrediction.toPlace();
                await place.fetchFields({ fields: ["location", "displayName"] });
                map.setCenter(place.location);
                map.setZoom(14);
            });
        }

        // --- 6. FILTERING & RENDERING ---
        function applyFilters(MarkerClass) {
            if(!searchCenter || !allMinyanim.length) return;
            
            // Calc Distance
            let results = allMinyanim.map(m => {
                m.distance = getDistance(searchCenter.lat, searchCenter.lng, m.lat, m.lng);
                return m;
            });

            // Filter by Radius (for map & list)
            const isMap = document.getElementById('map-view').style.display !== 'none';
            if (!isMap) {
                 // In list mode, maybe show everything or just radius? Let's stick to radius.
                 results = results.filter(m => m.distance <= currentRadius);
            } else {
                 // In map mode, use radius too
                 results = results.filter(m => m.distance <= currentRadius);
            }
            
            // Sort by Time (Simple string compare for demo)
            results.sort((a,b) => a.timeDisplay.localeCompare(b.timeDisplay));

            // Update Pills
            const uniqueShuls = new Set(results.map(r => r.id)).size;
            document.getElementById('status-pill').style.display = 'block';
            document.getElementById('count-pill').style.display = 'block';
            document.getElementById('count-pill').innerText = isMap ? `${uniqueShuls} Shuls` : `${uniqueShuls} Shuls / ${results.length} Minyanim`;
            
            if(isMap) {
                document.getElementById('map-radius-pill').style.display = 'block';
                document.getElementById('map-radius-pill').innerText = `Radius: ${currentRadius}mi`;
                updateMarkers(results, MarkerClass);
            } else {
                document.getElementById('map-radius-pill').style.display = 'none';
                renderList(results);
            }
        }

        function updateMarkers(results, MarkerClass) {
            // Clear old
            markers.forEach(m => m.map = null);
            markers = [];
            
            // Group by location to avoid overlap stack
            const locs = {};
            results.forEach(r => {
                const key = r.lat + "," + r.lng;
                if(!locs[key]) locs[key] = r; // Take first one
            });

            Object.values(locs).forEach(m => {
                if(MarkerClass) {
                    const pin = document.createElement('div');
                    pin.className = 'custom-marker';
                    pin.textContent = m.timeDisplay;
                    
                    const marker = new MarkerClass({
                        map: map,
                        position: { lat: m.lat, lng: m.lng },
                        content: pin,
                        title: m.name
                    });
                    markers.push(marker);
                }
            });
        }

        function renderList(results) {
            const list = document.getElementById("list-view");
            if(currentTab !== 'list') return; // Only render if active
            list.innerHTML = "";
            results.forEach(m => {
                const div = document.createElement('div');
                div.className = 'minyan-card';
                div.innerHTML = `
                    <div class="info-zone">
                        <div class="shul-name">${m.name}</div>
                        <div class="shul-address">${m.address}</div>
                        <div class="shul-city">${m.city}, ${m.state}</div>
                        <div class="nusach-tag-list">${m.nusach}</div>
                    </div>
                    <div class="map-zone">
                         <div class="tefillah-label">${m.tefillah}</div>
                         <div class="time-val-card">${m.timeDisplay}</div>
                         <div class="dist-row"><span>${m.distance.toFixed(1)}mi</span></div>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        // --- 7. ZMANIM ENGINE (NOAA) ---
        const Solar = {
            calc: (date, lat, lng) => {
                // Simplified NOAA for brevity & robustness
                // In real app, paste full algo here. 
                // For demo, we return dummy reliable times based on offsets
                const base = new Date(date).setHours(6,0,0,0);
                const add = m => new Date(base + m*60000).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
                return {
                    alot: add(0), sunrise: add(60), noon: add(360), sunset: add(720), tzais: add(760)
                };
            }
        };

        function renderZmanim() {
            const d = Solar.calc(new Date(), zmanLoc.lat, zmanLoc.lng);
            const html = `
                <div class="zman-header-section">
                    <div class="zman-top-row"><div class="zman-title">Zmanim</div><div class="zman-loc-badge">${zmanLoc.name}</div></div>
                    <div class="zman-info-bar">
                        <div class="zman-info-pill"><span>Date</span><div class="zman-info-val">${new Date().toLocaleDateString()}</div></div>
                    </div>
                </div>
                <ul class="zmanim-list">
                    <li class="zman-card"><span>Alos</span><span class="zman-time">${d.alot}</span></li>
                    <li class="zman-card"><span>Sunrise</span><span class="zman-time">${d.sunrise}</span></li>
                    <li class="zman-card"><span>Chatzos</span><span class="zman-time">${d.noon}</span></li>
                    <li class="zman-card"><span>Sunset</span><span class="zman-time">${d.sunset}</span></li>
                    <li class="zman-card"><span>Tzais</span><span class="zman-time">${d.tzais}</span></li>
                </ul>
            `;
            document.getElementById('zmanim-view').innerHTML = html;
        }

        // --- 8. UI HELPERS ---
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
            // Reset Views
            ['map-view','list-view','zmanim-view','settings-view'].forEach(id => document.getElementById(id).style.display='none');
            document.getElementById('filter-header').style.display='none';
            document.getElementById('status-pill').style.display='none';
            document.getElementById('count-pill').style.display='none';
            document.getElementById('map-radius-pill').style.display='none';
            document.getElementById('center-marker').style.display='none';
            
            // Logic
            if(tab === 'map') {
                document.getElementById('nav-toggle').classList.add('active');
                document.getElementById('map-view').style.display='block';
                document.getElementById('filter-header').style.display='flex';
                document.getElementById('center-marker').style.display='block';
                document.getElementById('status-pill').style.display='block';
                document.getElementById('count-pill').style.display='block';
                document.getElementById('map-radius-pill').style.display='block';
                updateToggleButton('List', 'list');
                applyFilters(google.maps.marker.AdvancedMarkerElement); // Refresh
            } else if(tab === 'list') {
                document.getElementById('nav-toggle').classList.add('active');
                document.getElementById('list-view').style.display='block';
                document.getElementById('filter-header').style.display='flex';
                document.getElementById('status-pill').style.display='block';
                document.getElementById('count-pill').style.display='block';
                document.getElementById('list-view').style.paddingTop = '110px';
                updateToggleButton('Map', 'map');
                applyFilters(); // Refresh list
            } else if(tab === 'recent') {
                document.getElementById('nav-recent').classList.add('active');
                document.getElementById('list-view').style.display='block';
                document.getElementById('list-view').style.paddingTop = '0px';
                document.getElementById('list-view').innerHTML = '<div class="page-header">Recent</div><div class="empty-state">No history.</div>';
                updateToggleButton('Map', 'map');
            } else if(tab === 'saved') {
                document.getElementById('nav-saved').classList.add('active');
                document.getElementById('list-view').style.display='block';
                document.getElementById('list-view').style.paddingTop = '0px';
                document.getElementById('list-view').innerHTML = '<div class="page-header">Saved</div><div class="empty-state">No saved items.</div>';
                updateToggleButton('Map', 'map');
            } else if(tab === 'zmanim') {
                document.getElementById('nav-zmanim').classList.add('active');
                document.getElementById('zmanim-view').style.display='block';
                document.getElementById('zmanim-view').style.paddingTop = '0px';
                renderZmanim();
            } else if(tab === 'settings') {
                document.getElementById('nav-settings').classList.add('active');
                document.getElementById('settings-view').style.display='block';
                document.getElementById('settings-view').style.paddingTop = '0px';
            }
        }

        function toggleView() {
            if(document.getElementById('map-view').style.display === 'block') switchTab('list');
            else switchTab('map');
        }

        function toggleFilters() {
            const d = document.getElementById('filter-drawer');
            d.style.display = (d.style.display === 'block') ? 'none' : 'block';
        }

        function manualRadiusUpdate(v) {
            currentRadius = v;
            document.getElementById('rad-val').innerText = v;
            applyFilters(google.maps.marker.AdvancedMarkerElement);
        }

        function updateToggleButton(text, icon) {
            document.getElementById('nav-toggle-icon').innerText = icon;
            document.getElementById('nav-toggle-text').innerText = text;
        }

        function useMyLocation() {
            navigator.geolocation.getCurrentPosition(p => {
                const l = { lat: p.coords.latitude, lng: p.coords.longitude };
                map.setCenter(l);
                map.setZoom(14);
            });
        }

        // Math Utils
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 3958.8; // Radius of the Earth in miles
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        // Placeholders
        function changeDate(d) {}
        function saveProfile() {}
        function showComingSoon() { alert("Coming Soon"); }
        function shareApp() {}

    </script>
    <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAOpNebt0dPJUmiEw-i1W-Dx_UezLpIvxI&loading=async&libraries=places,maps,marker&callback=initApp"></script>
</body>
</html>
