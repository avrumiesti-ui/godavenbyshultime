<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ShulTime Schedule</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Roboto", sans-serif; background: #F2F4F8; color: #111; }
        
        /* HEADER WRAPPER */
        .app-header {
            position: sticky; top: 0; z-index: 1000;
            background: white; padding: 10px 16px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        /* SEARCH ROW: Input + Map Toggle + Gear */
        .search-row { display: flex; gap: 8px; align-items: center; }
        
        .search-pill {
            flex-grow: 1; display: flex; align-items: center;
            background: #F0F2F5; border-radius: 12px; height: 50px; border: 1px solid #ddd;
            overflow: hidden; padding-left: 10px;
        }

        /* BUTTONS */
        .icon-btn {
            width: 50px; height: 50px; border: none; border-radius: 12px; 
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            transition: background 0.2s;
        }
        .map-btn { background: #0D2B4F; color: white; }
        .gear-btn { background: #E3F2FD; color: #1565C0; }
        
        /* GOOGLE INPUT STYLING */
        gmp-place-autocomplete { width: 100%; display: inline-block; }
        gmp-place-autocomplete::part(input) {
            border: none; background: transparent; padding: 0; font-size: 16px; color: #111; outline: none; height: 100%;
        }

        /* LOCATION STATUS BAR */
        #status-bar {
            text-align: center; font-size: 12px; color: #666; margin-top: 8px; font-weight: 500;
        }
        #location-name-display { color: #0D2B4F; font-weight: 700; }

        /* FILTER DRAWER (The "Pull Up" Menu) */
        #filter-drawer {
            display: none; /* Hidden by default */
            background: white; border-top: 1px solid #eee; padding: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            animation: slideDown 0.3s ease-out;
        }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .filter-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        
        .filter-group label { display: block; font-size: 11px; font-weight: bold; color: #888; margin-bottom: 4px; }
        .filter-select {
            width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ddd; background: #f9f9f9;
            font-size: 14px; font-weight: 600; outline: none; appearance: none;
        }
        
        .time-inputs-row { display: flex; gap: 10px; margin-top: 5px; }
        .time-input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-family: inherit; }

        .next-hour-btn {
            width: 100%; background: #0D2B4F; color: white; border: none; padding: 12px; border-radius: 8px;
            font-size: 14px; font-weight: 600; cursor: pointer; margin-top: 10px;
        }

        /* CARD DESIGN */
        .minyan-card {
            background: white; border-radius: 12px; padding: 12px 16px; margin-bottom: 8px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.04); cursor: pointer;
            border-left: 5px solid transparent;
        }
        
        .type-Shacharis { border-left-color: #4CAF50; } 
        .type-Mincha { border-left-color: #FF9800; }    
        .type-Maariv { border-left-color: #3F51B5; }    

        .card-left h3 { margin: 0 0 4px 0; font-size: 16px; color: #0D2B4F; }
        .address { font-size: 12px; color: #777; margin: 0; display:block; margin-bottom:6px;}
        .distance-tag { font-size: 11px; color: #fff; background: #666; padding: 2px 6px; border-radius: 8px; margin-left: 5px; font-weight: normal; }
        .nusach-tag { font-size: 10px; padding: 3px 8px; border-radius: 12px; font-weight: 700; text-transform: uppercase; background:#eee; color:#555; }

        .card-right { text-align: right; }
        .time-display { font-size: 20px; font-weight: 800; color: #0D2B4F; letter-spacing: -0.5px; }
        .tefillah-label { font-size: 10px; font-weight: bold; text-transform: uppercase; color: #999; margin-top: 2px; }
        .ampm-label { font-size: 12px; font-weight: 600; color: #555; margin-left: 2px; }

        /* VIEWS */
        #list-view { padding: 12px; padding-bottom: 80px; }
        #map-view { display: none; height: calc(100vh - 140px); background: #e0e0e0; margin-top: 10px; }
        #empty-state { text-align: center; padding: 50px 20px; color: #888; }
        
        /* FAB */
        .fab-location {
            position: fixed; bottom: 20px; right: 20px; width: 56px; height: 56px;
            background: #fff; border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            border: none; color: #333; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 200;
        }
    </style>
</head>
<body>

    <div id="app-interface">
        <div class="app-header">
            <div class="search-row">
                <div class="search-pill">
                    <div id="place-autocomplete-container" style="flex-grow:1;"></div>
                    <i class="material-icons" onclick="clearSearch()" style="color:#aaa; cursor:pointer; font-size:18px; margin-right:10px;">close</i>
                </div>
                
                <button class="icon-btn gear-btn" onclick="toggleFilters()">
                    <i class="material-icons">tune</i>
                </button>

                <button class="icon-btn map-btn" onclick="toggleView()">
                    <i class="material-icons" id="toggle-icon">map</i>
                </button>
            </div>

            <div id="status-bar">
                <span id="location-name-display">Select Location</span> â€¢ <span id="count-display">Waiting...</span>
            </div>
        </div>

        <div id="filter-drawer">
            <div class="filter-grid">
                <div class="filter-group">
                    <label>SORT BY</label>
                    <select id="filter-sort" class="filter-select" onchange="applyFilters()">
                        <option value="distance">Distance</option>
                        <option value="time_asc">Earliest Time</option>
                        <option value="time_desc">Latest Time</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>TEFILLAH</label>
                    <select id="filter-tefillah" class="filter-select" onchange="applyFilters()">
                        <option value="">All</option>
                        <option value="Shacharis">Shacharis</option>
                        <option value="Mincha">Mincha</option>
                        <option value="Maariv">Maariv</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>NUSACH</label>
                    <select id="filter-nusach" class="filter-select" onchange="applyFilters()">
                        <option value="">All</option>
                        <option value="Ashkenaz">Ashkenaz</option>
                        <option value="Sefard">Sefard</option>
                        <option value="Ari">Ari</option>
                    </select>
                </div>
            </div>

            <div class="filter-group">
                <label>TIME RANGE</label>
                <div class="time-inputs-row">
                    <input type="time" id="time-start" class="time-input" onchange="onStartTimeChange()">
                    <input type="time" id="time-end" class="time-input" onchange="applyFilters()">
                </div>
                <button class="next-hour-btn" onclick="setNextHour()">Show Next Hour Only</button>
            </div>
        </div>

        <div id="list-view">
            <div id="empty-state">
                <i class="material-icons" style="font-size:48px; color:#ddd;">search</i><br><br>
                Use the search bar or<br>click the location button below.
            </div>
        </div>
        <div id="map-view"></div>
    </div>

    <button class="fab-location" onclick="useMyLocation()">
        <i class="material-icons">my_location</i>
    </button>

    <script>
        let map, infoWindow, allMinyanim = []; 
        let googleLoaded = false;
        let searchCenter = null; 
        const DEFAULT_RADIUS_MILES = 10;

        // 1. INIT
        document.getElementById('time-start').value = "00:00";
        document.getElementById('time-end').value = "23:59";

        // Load Database
        fetch('database.json').then(res => res.json()).then(data => {
            processMinyanim(data); 
            document.getElementById('count-display').innerText = "Ready";
        });

        function processMinyanim(shuls) {
            allMinyanim = [];
            shuls.forEach(shul => {
                ['Shacharis','Mincha','Maariv'].forEach(type => {
                    if(!shul[type.toLowerCase()]) return;
                    shul[type.toLowerCase()].split(',').forEach(t => {
                        let raw = t.trim().replace(/[^0-9:]/g, '');
                        let [h, m] = raw.split(':').map(Number);
                        let isPM = (type==='Maariv' || (type==='Mincha' && h<9));
                        let sortH = (isPM && h<12) ? h+12 : ((!isPM && h===12) ? 0 : h);
                        
                        allMinyanim.push({
                            id: shul.name + type + t,
                            name: shul.name, address: shul.address,
                            lat: shul.lat, lng: shul.lng, nusach: shul.nusach,
                            tefillah: type, timeDisplay: `${h}:${String(m).padStart(2,'0')}`,
                            ampm: isPM ? "PM" : "AM", timeValue: (sortH*60)+m, distance: null
                        });
                    });
                });
            });
        }

        // 2. SEARCH LOGIC
        function applyFilters() {
            if (!searchCenter) return;
            
            // UI Update
            document.getElementById('location-name-display').innerText = searchCenter.name;

            const sort = document.getElementById('filter-sort').value;
            const tefillah = document.getElementById('filter-tefillah').value;
            const nusach = document.getElementById('filter-nusach').value;
            const tStart = document.getElementById('time-start').value;
            const tEnd = document.getElementById('time-end').value;
            
            // 1. Calc Distance
            let results = allMinyanim.map(m => {
                m.distance = getDistance(searchCenter.lat, searchCenter.lng, m.lat, m.lng);
                return m;
            }).filter(m => m.distance <= DEFAULT_RADIUS_MILES);

            // 2. Fallback if empty (Find nearest global)
            if(results.length === 0) {
                allMinyanim.sort((a,b) => a.distance - b.distance);
                const closest = allMinyanim[0];
                if(closest) {
                    // Auto-Switch Center
                    searchCenter = { lat: closest.lat, lng: closest.lng, name: "Nearest Shul" };
                    // Recalculate
                    results = allMinyanim.map(m => {
                        m.distance = getDistance(searchCenter.lat, searchCenter.lng, m.lat, m.lng);
                        return m;
                    }).filter(m => m.distance <= DEFAULT_RADIUS_MILES);
                    
                    alert(`No results nearby. Moved search to: ${closest.name}`);
                    if(map) { map.setCenter(searchCenter); map.setZoom(14); }
                }
            }

            // 3. Apply Filters
            if(tefillah) results = results.filter(m => m.tefillah === tefillah);
            if(nusach) results = results.filter(m => m.nusach === nusach);
            
            const [sH, sM] = tStart.split(':').map(Number);
            const [eH, eM] = tEnd.split(':').map(Number);
            const sVal = (sH*60)+sM;
            const eVal = (eH*60)+eM;
            results = results.filter(m => m.timeValue >= sVal && m.timeValue <= eVal);

            // 4. Sort
            if(sort === 'distance') results.sort((a,b) => a.distance - b.distance);
            if(sort === 'time_asc') results.sort((a,b) => a.timeValue - b.timeValue);
            if(sort === 'time_desc') results.sort((a,b) => b.timeValue - a.timeValue);

            document.getElementById('count-display').innerText = `${results.length} Minyanim`;
            renderResults(results);
        }

        function renderResults(results) {
            const list = document.getElementById('list-view');
            list.innerHTML = '';
            
            if(results.length === 0) {
                list.innerHTML = '<div style="text-align:center; padding:40px; color:#888;">No minyanim match these filters.</div>';
                return;
            }

            results.forEach(m => {
                const card = document.createElement('div');
                card.className = `minyan-card type-${m.tefillah}`;
                card.innerHTML = `
                    <div class="card-left">
                        <h3>${m.name} <span class="distance-tag">${m.distance.toFixed(1)} mi</span></h3>
                        <span class="address">${m.address}</span>
                        <span class="nusach-tag">${m.nusach}</span>
                    </div>
                    <div class="card-right">
                        <div class="tefillah-label">${m.tefillah}</div>
                        <div class="time-display">${m.timeDisplay}<span class="ampm-label">${m.ampm}</span></div>
                    </div>
                `;
                card.onclick = () => showOnMap(m);
                list.appendChild(card);
            });
            updateMap(results);
        }

        // 3. MAP & UTILS
        function showOnMap(m) {
            toggleView(true); // force map
            if(map) {
                map.setCenter({ lat: m.lat, lng: m.lng });
                map.setZoom(16);
                infoWindow.setContent(`<strong>${m.name}</strong><br>${m.timeDisplay} ${m.ampm}`);
                infoWindow.setPosition({ lat: m.lat, lng: m.lng });
                infoWindow.open(map);
            }
        }

        async function updateMap(results) {
            if(!map) return;
            // De-dupe locations
            const locs = {};
            results.forEach(m => {
                const k = `${m.lat},${m.lng}`;
                if(!locs[k]) locs[k] = { ...m, count: 1 };
                else locs[k].count++;
            });

            const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");
            // Clear old (simple refresh)
            map = new google.maps.Map(document.getElementById("map-view"), {
                center: searchCenter, zoom: 14, disableDefaultUI: true, mapId: "DEMO_MAP_ID"
            });
            
            Object.values(locs).forEach(l => {
                const marker = new AdvancedMarkerElement({
                    map: map, position: { lat: l.lat, lng: l.lng }, title: l.name
                });
                marker.addListener("click", () => {
                    infoWindow.setContent(`<strong>${l.name}</strong><br>${l.count} Minyanim`);
                    infoWindow.open(map, marker);
                });
            });
        }

        function toggleFilters() {
            const drawer = document.getElementById('filter-drawer');
            drawer.style.display = (drawer.style.display === 'block') ? 'none' : 'block';
        }

        function useMyLocation() {
            document.getElementById('location-name-display').innerText = "Locating...";
            navigator.geolocation.getCurrentPosition(pos => {
                searchCenter = { lat: pos.coords.latitude, lng: pos.coords.longitude, name: "Current Location" };
                applyFilters();
            }, () => alert("Location denied."));
        }
        
        function clearSearch() {
            const el = document.querySelector('gmp-place-autocomplete');
            if(el) el.value = null;
            searchCenter = null;
            document.getElementById('list-view').innerHTML = `
                <div id="empty-state">
                    <i class="material-icons" style="font-size:48px; color:#ddd;">search</i><br><br>
                    Use the search bar or<br>click the location button below.
                </div>
            `;
            document.getElementById('location-name-display').innerText = "Select Location";
            document.getElementById('count-display').innerText = "Waiting...";
        }

        function toggleView(forceMap = false) {
            const list = document.getElementById('list-view');
            const mapDiv = document.getElementById('map-view');
            const icon = document.getElementById('toggle-icon');
            
            if (forceMap || list.style.display !== 'none') {
                list.style.display = 'none'; mapDiv.style.display = 'block'; icon.innerText = 'list';
            } else {
                list.style.display = 'block'; mapDiv.style.display = 'none'; icon.innerText = 'map';
            }
        }
        
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 3958.8; 
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2); 
            return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a))); 
        }

        function onStartTimeChange() {
            const [h,m] = document.getElementById('time-start').value.split(':').map(Number);
            document.getElementById('time-end').value = `${String((h+1)%24).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
            applyFilters();
        }
        
        function setNextHour() {
            const now = new Date();
            const pad = n => String(n).padStart(2,'0');
            document.getElementById('time-start').value = `${pad(now.getHours())}:${pad(now.getMinutes())}`;
            now.setHours(now.getHours()+1);
            document.getElementById('time-end').value = `${pad(now.getHours())}:${pad(now.getMinutes())}`;
            applyFilters();
        }

        // GOOGLE INIT
        async function initApp() {
            const { PlaceAutocompleteElement } = await google.maps.importLibrary("places");
            const { Map } = await google.maps.importLibrary("maps");
            
            // Setup Search
            const autocomplete = new PlaceAutocompleteElement();
            autocomplete.placeholder = "Search City...";
            document.getElementById('place-autocomplete-container').appendChild(autocomplete);
            
            // KEY FIX: Force listener to connect search
            autocomplete.addEventListener('gmp-places-select', async ({ place }) => {
                document.getElementById('location-name-display').innerText = "Loading details...";
                try {
                    await place.fetchFields({ fields: ['displayName', 'location'] });
                    searchCenter = { lat: place.location.lat(), lng: place.location.lng(), name: place.displayName };
                    applyFilters();
                } catch(e) { console.error(e); }
            });
            
            // Init hidden map
            map = new Map(document.getElementById("map-view"), { center: {lat:40, lng:-74}, zoom: 14, disableDefaultUI: true, mapId: "DEMO_MAP_ID" });
            infoWindow = new google.maps.InfoWindow();
        }
    </script>

    <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAOpNebt0dPJUmiEw-i1W-Dx_UezLpIvxI&loading=async&libraries=places,maps,marker&callback=initApp"></script>
</body>
</html>
