<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>ShulTime</title>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<style>
    :root { --primary: #0D2B4F; --bg: #F2F4F8; }
    
    html, body { margin: 0; padding: 0; height: 100%; overscroll-behavior-y: contain; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Roboto", sans-serif; background: var(--bg); overflow: hidden; }
    
    /* FLOATING HEADER */
    .floating-header {
        position: fixed; top: 15px; left: 12px; right: 12px;
        z-index: 1000; display: flex; gap: 10px; align-items: center; pointer-events: auto;
    }
    .search-container {
        flex: 1; pointer-events: auto; display: flex; align-items: center;
        background: #fff; height: 50px; border-radius: 25px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.15); padding: 0 15px;
        overflow: hidden; 
    }

    /* GOOGLE COMPONENT */
    gmp-place-autocomplete { 
        width: 100%; height: 100%;
        --gmp-filled-input-container-color: #fff !important;
        background-color: #fff !important;
    }
    gmp-place-autocomplete::part(input) { 
        background-color: #fff !important; padding: 0; font-size: 16px; 
        height: 100%; width: 100%; color: #111 !important; font-weight: 500 !important;
    }
    .pac-container { background-color: #fff !important; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.15); border: none; }
    .pac-item { background-color: #fff !important; color: #333 !important; }
    .pac-item:hover { background-color: #f2f4f8 !important; }

    .circle-btn {
        width: 50px; height: 50px; flex-shrink: 0; pointer-events: auto;
        border-radius: 50%; background: #fff; border: none;
        box-shadow: 0 4px 15px rgba(0,0,0,0.15); display: flex; align-items: center; justify-content: center;
        cursor: pointer; color: var(--primary); transition: all 0.2s;
    }
    .circle-btn.active { background: var(--primary); color: #fff; }

    /* STATUS PILLS */
    .status-area {
        position: fixed; top: 75px; left: 0; right: 0;
        display: flex; justify-content: center; align-items: center; gap: 8px;
        z-index: 800; pointer-events: none; padding: 0 10px;
    }
    #status-pill, #count-pill, #map-radius-pill {
        padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: 700;
        display: none; box-shadow: 0 2px 8px rgba(0,0,0,0.1); white-space: nowrap;
        max-width: 45%; overflow: hidden; text-overflow: ellipsis;
    }
    #status-pill { background: rgba(13, 43, 79, 0.95); color: #fff; }
    #count-pill { background: #fff; color: var(--primary); border: 1px solid var(--primary); }
    #map-radius-pill { background: #2E7D32; color: #fff; display: none; }

    /* VIEWS */
    #list-view { 
        position: absolute; inset: 0; 
        padding: 110px 12px 0px; 
        overflow-y: auto; background: var(--bg); 
        z-index: 10; padding-bottom: 100px;
    }
    #map-view { position: absolute; inset: 0; z-index: 5; }

    #center-marker {
        position: fixed; top: 50%; left: 50%; width: 16px; height: 16px;
        background: #2196F3; border: 3px solid #fff; border-radius: 50%;
        transform: translate(-50%, -50%); z-index: 20; box-shadow: 0 2px 6px rgba(0,0,0,0.4);
        pointer-events: none; display: none;
    }

    /* CARDS */
    .minyan-card {
        background: #fff; border-radius: 12px; margin-bottom: 8px;
        display: flex; justify-content: space-between; align-items: stretch;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05); overflow: hidden; 
        min-height: 85px; 
    }
    .info-zone { 
        flex: 1; padding: 10px 12px; cursor: pointer; 
        display: flex; flex-direction: column; justify-content: space-between;
        min-width: 0; 
    }
    .map-zone { 
        width: 120px; display: flex; flex-direction: column; align-items: flex-end; justify-content: space-between;
        border-left: 1px solid #f0f0f0; cursor: pointer; background: #fafafa; padding: 10px 12px;
        flex-shrink: 0; text-align: right;
    }
    
    .shul-name { font-weight: 800; font-size: 18px; color: #333; line-height: 1.1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .shul-address { font-size: 15px; color: #777; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    
    .tefillah-label { font-size: 13px; font-weight: 900; text-transform: uppercase; letter-spacing: 0.5px; } 
    .time-val { font-weight: 800; font-size: 20px; color: var(--primary); align-self: center; margin-right: -10px; }
    
    .map-footer { display: flex; align-items: flex-end; gap: 6px; }
    .dist-label { font-size: 13px; font-weight: 800; color: #666; line-height: 1; margin-bottom: 2px; }
    
    .map-circle { width: 28px; height: 28px; border-radius: 50%; background: #fff; display: flex; align-items: center; justify-content: center; border: 1px solid #eee; }
    .google-maps-icon { background: linear-gradient(135deg, #4285F4 25%, #34A853 25% 50%, #FBBC05 50% 75%, #EA4335 75%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 18px !important; font-weight: bold; }
    
    /* TAGS & COLORS */
    .nusach-tag { font-size: 11px; padding: 3px 9px; border-radius: 12px; display: inline-block; font-weight: 700; text-transform: uppercase; width: fit-content; }
    .nusach-Ashkenaz { background: #E3F2FD; color: #1565C0; }
    .nusach-Sefard { background: #E8F5E9; color: #2E7D32; }
    .nusach-Ari { background: #F3E5F5; color: #7B1FA2; }
    .nusach-Edot-HaMizrach { background: #FFF3E0; color: #E65100; }
    .nusach-Chabad { background: #FFF8E1; color: #F57F17; }
    .nusach-Other { background: #F5F5F5; color: #616161; }

    .tef-Shacharis { color: #2E7D32; } .tef-Mincha { color: #E65100; } .tef-Maariv { color: #1565C0; }

    /* CHIP COLORS */
    .chip { padding: 6px 12px; border-radius: 15px; border: 1px solid #ddd; background: #fff; font-size: 12px; font-weight: 600; color: #444; cursor: pointer; transition: all 0.1s; }
    .chip.active { border-width: 2px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transform: scale(1.05); }

    .chip-Shacharis { background: #E8F5E9; color: #2E7D32; border-color: #C8E6C9; }
    .chip-Mincha { background: #FFF3E0; color: #E65100; border-color: #FFE0B2; }
    .chip-Maariv { background: #E3F2FD; color: #1565C0; border-color: #BBDEFB; }
    .chip-Ashkenaz { background: #E3F2FD; color: #1565C0; border-color: #BBDEFB; }
    .chip-Sefard { background: #E8F5E9; color: #2E7D32; border-color: #C8E6C9; }
    .chip-Ari { background: #F3E5F5; color: #7B1FA2; border-color: #E1BEE7; }
    .chip-Edot-HaMizrach { background: #FFF3E0; color: #E65100; border-color: #FFE0B2; }
    .chip-Chabad { background: #FFF8E1; color: #F57F17; border-color: #FFECB3; }

    /* MAP MARKERS */
    .custom-marker { color: white; padding: 4px 9px; border-radius: 12px; font-size: 13px; font-weight: 800; box-shadow: 0 2px 6px rgba(0,0,0,0.3); border: 2px solid #fff; display: flex; align-items: center; justify-content: center; position: relative; top: 10px; cursor: pointer; transition: transform 0.1s; }
    .marker-Ashkenaz { background: #1565C0; }
    .marker-Sefard { background: #2E7D32; }
    .marker-Ari { background: #7B1FA2; }
    .marker-Edot-HaMizrach { background: #E65100; }
    .marker-Chabad { background: #F57F17; }
    .marker-Other { background: #616161; }
    .custom-marker::after { content: ''; position: absolute; bottom: -5px; left: 50%; transform: translateX(-50%); border-width: 5px 5px 0; border-style: solid; border-color: inherit transparent transparent transparent; }

    /* FILTER DRAWER */
    #filter-drawer {
        display: none; position: fixed; top: 80px; left: 12px; right: 12px;
        background: #fff; border-radius: 20px; padding: 15px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.25); z-index: 2000;
        max-width: 500px; margin: 0 auto;
    }
    .filter-section { margin-bottom: 12px; } 
    .filter-label { font-size: 10px; font-weight: 800; color: #bbb; text-transform: uppercase; margin-bottom: 5px; display: block; }
    .chip-group { display: flex; flex-wrap: wrap; gap: 6px; }
    
    .radius-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
    .radius-row input[type=range] { flex: 1; accent-color: var(--primary); }
    .radius-input { width: 50px; padding: 5px; border: 1px solid #ddd; border-radius: 8px; text-align: center; font-weight: bold; font-family: inherit; }

    .time-inputs-row { display: flex; gap: 8px; }
    .time-input { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 15px; text-align: center; font-family: inherit; font-size: 12px; font-weight: 600; }
    .action-btn { width: 100%; background: #eee; color: #333; border: none; padding: 10px; border-radius: 15px; font-size: 12px; font-weight: 700; cursor: pointer; margin-top: 6px; }
    .primary-action { background: var(--primary); color: white; }

    /* DETAILS DRAWER */
    #details-drawer {
        position: fixed; bottom: -100%; left: 10px; right: 10px; height: 75vh;
        background: #fff; border-radius: 25px; 
        z-index: 3000; margin-bottom: 15px;
        box-shadow: 0 5px 30px rgba(0,0,0,0.3); transition: transform 0.3s ease-out;
        padding: 0; display: flex; flex-direction: column;
    }
    #details-drawer.open { bottom: 0; transform: translateY(0); }
    .drawer-header { padding: 20px; display: flex; justify-content: flex-end; align-items: center; }
    .drawer-actions { display: flex; gap: 12px; }
    .circle-action-btn { width: 40px; height: 40px; border-radius: 50%; background: #f0f0f0; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #555; }
    .drawer-body { flex: 1; overflow-y: auto; padding: 0 25px 25px; }
    .drawer-nav-row { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }
    
    .schedule-section { margin-top: 20px; }
    .schedule-title { font-weight:800; font-size:15px; margin-bottom:10px; color:#333; border-bottom:1px solid #eee; padding-bottom:5px; }
    .schedule-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 14px; }
    .schedule-item { margin-bottom: 6px; }
    .schedule-day { font-weight: 700; color: #666; font-size: 12px; text-transform: uppercase; }
    
    .contact-row { display: flex; gap: 10px; margin-top: 20px; }
    .contact-btn { flex: 1; background: #f5f5f5; border: 1px solid #ddd; padding: 12px; border-radius: 12px; font-weight: 600; font-size: 14px; text-align: center; text-decoration: none; color: #333; display: flex; align-items: center; justify-content: center; gap: 6px; }
    .contact-btn:active { background: #eee; }

    #scrim { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 2500; display: none; }

    .fab-location {
        position: fixed; bottom: 30px; right: 20px; width: 60px; height: 60px;
        background: #fff; border-radius: 50%; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        border: none; color: var(--primary); display: flex; align-items: center; justify-content: center; z-index: 900;
    }

    .empty-state { text-align: center; color: #555; margin-top: 50px; padding: 0 30px; line-height: 1.6; }
</style>
</head>
<body>

    <div class="floating-header" onclick="scrollToTop(event)">
        <div class="search-container" onclick="event.stopPropagation()">
            <div id="autocomplete-container" style="flex:1; height:100%;"></div>
        </div>
        <button class="circle-btn" onclick="toggleFilters(); event.stopPropagation()">
            <i class="material-icons">tune</i>
        </button>
        <button class="circle-btn" id="view-toggle-btn" onclick="toggleView(); event.stopPropagation()">
            <i class="material-icons" id="view-icon">map</i>
        </button>
    </div>

    <div class="status-area">
        <div id="status-pill"></div>
        <div id="count-pill"></div>
        <div id="map-radius-pill"></div>
    </div>

    <div id="center-marker"></div>
    <div id="scrim" onclick="closeDetails()"></div>

    <div id="details-drawer">
        <div class="drawer-header" id="drawer-header">
            <div class="drawer-actions">
                <button class="circle-action-btn" onclick="shareShul()">
                    <i class="material-icons" style="font-size:20px;">share</i>
                </button>
                <button class="circle-action-btn" onclick="closeDetails()">
                    <i class="material-icons" style="font-size:20px;">close</i>
                </button>
            </div>
        </div>
        <div id="drawer-content" class="drawer-body"></div>
    </div>

    <div id="filter-drawer">
        <div class="filter-section">
            <label class="filter-label">Radius (Miles)</label>
            <div class="radius-row">
                <input type="range" min="0.1" max="99" step="0.1" value="20" id="radius-slider" oninput="manualRadiusUpdate(this.value)">
                <input type="number" id="radius-input" class="radius-input" value="20" onchange="manualRadiusUpdate(this.value)">
            </div>
            <div class="chip-group">
                <div class="chip" onclick="manualRadiusUpdate(1)">1</div>
                <div class="chip" onclick="manualRadiusUpdate(2)">2</div>
                <div class="chip" onclick="manualRadiusUpdate(3)">3</div>
                <div class="chip" onclick="manualRadiusUpdate(5)">5</div>
                <div class="chip" onclick="manualRadiusUpdate(20)">20</div>
                <div class="chip" onclick="manualRadiusUpdate(99)">99</div>
            </div>
        </div>
        
        <div class="filter-section">
            <label class="filter-label">Tefillah</label>
            <div class="chip-group">
                <div class="chip active" onclick="setFilter('tefillah', '', this)">All</div>
                <div class="chip chip-Shacharis" onclick="setFilter('tefillah', 'Shacharis', this)">Shacharis</div>
                <div class="chip chip-Mincha" onclick="setFilter('tefillah', 'Mincha', this)">Mincha</div>
                <div class="chip chip-Maariv" onclick="setFilter('tefillah', 'Maariv', this)">Maariv</div>
            </div>
        </div>

        <div class="filter-section">
            <label class="filter-label">Nusach</label>
            <div class="chip-group" id="nusach-group">
                <div class="chip active" onclick="setFilter('nusach', '', this)">All</div>
            </div>
        </div>

        <div class="filter-section">
            <label class="filter-label">Time Range</label>
            <div class="time-inputs-row">
                <input type="time" id="time-start" class="time-input" onchange="onStartTimeChange()">
                <input type="time" id="time-end" class="time-input" onchange="applyFilters()">
            </div>
            <div style="display:flex; gap:6px;">
                <button class="action-btn" onclick="setAllDay()">All Day</button>
                <button class="action-btn primary-action" onclick="setNextHour()">Next Hour</button>
            </div>
        </div>
        <button class="action-btn primary-action" onclick="toggleFilters()" style="margin-top:10px;">Done</button>
    </div>

    <div id="list-view">
        <div class="empty-state">
            <i class="material-icons" style="font-size:54px; margin-bottom:15px; color: var(--primary); opacity: 0.8;">explore</i><br>
            <strong>Welcome to ShulTime</strong><br><br>
            <b>1. Search</b> for a city or zip code.<br>
            <b>2. Filter</b> by time or Nusach.<br>
            <b>3. Tap</b> the target to use GPS.
        </div>
    </div>
    
    <div id="map-view"></div>
    
    <button class="fab-location" onclick="useMyLocation()">
        <i class="material-icons" style="font-size:30px;">my_location</i>
    </button>

    <script>
        // --- EMBEDDED DATABASE ---
        // Contains 417 Records
        const RAW_DB = [
          {"id":24,"name":"Ohab Zedek","address":"118 W. 95th St. ","city":"New York","state":"NY","zip":"10025","lat":40.792404,"lng":-73.968576,"nusach":"Ashkenaz","rabbi":"Rabbi Allen Schwartz","phone":"212-749-5150","email":null,"website":"http://www.ozny.org/","shacharis":{"sun":["08:00","09:00"],"mon_thu":["06:05","06:50","07:55"],"tue_wed_fri":["06:15","07:00","08:00"],"rosh_chodesh":["06:00","06:45","07:45"]},"mincha":{"week":[],"fri":[],"shabbos":[]},"maariv":{"week":[],"shabbos":[]},"mincha_txt":"Winter - Bizman,  Summer - Bizman and 7:00pm (from start of DST until approximately Rosh Hashana)","maariv_txt":"Following Mincha.  Late Maarv is Tuesday at 10:00 pm"},
          {"id":27,"name":"Radio City Synagogue","address":"30 W. 47th St.","city":"New York","state":"NY","zip":"10036","lat":40.757217,"lng":-73.979682,"nusach":"Other","rabbi":"Rabbi Shmuel Levitin","phone":"212-819-0839","email":null,"website":null,"shacharis":{"sun":[],"mon_thu":[],"tue_wed_fri":[],"rosh_chodesh":[]},"mincha":{"week":["13:45","17:15"],"fri":[],"shabbos":[]},"maariv":{"week":[],"shabbos":[]},"mincha_txt":"(Daf Yomi at 1:00 PM)","maariv_txt":"Follows late Mincha"},
          {"id":28,"name":"Congregation Beth Israel West Side Jewish Center","address":"347 W. 34th St.","city":"New York","state":"NY","zip":"10001","lat":40.752851,"lng":-73.994894,"nusach":"Other","rabbi":"Rabbi Jason Herman","phone":"212-502-5291","email":"info@westsidejewishcenter.org","website":"http://www.westsidejewishcenter.org","shacharis":{"sun":[],"mon_thu":["06:45","07:55"],"tue_wed_fri":["06:50","08:00"],"rosh_chodesh":["06:30"]},"mincha":{"week":["13:40"],"fri":[],"shabbos":[]},"maariv":{"week":[],"shabbos":[]},"maariv_txt":"Please check our website for accurate times."},
          {"id":30,"name":"Fifth Avenue Synagogue","address":"5 E. 62nd St.","city":"New York","state":"NY","zip":"10021","lat":40.766092,"lng":-73.971611,"nusach":"Ashkenaz","rabbi":"Rabbi Yaakov Kermaier","phone":"212-838-2122","email":"info@5as.org","website":"http://www.5as.org","shacharis":{"sun":["08:30"],"mon_thu":["07:30"],"tue_wed_fri":["07:30"],"rosh_chodesh":[]},"mincha":{"week":[],"fri":["18:30"],"shabbos":[]},"maariv":{"week":[],"shabbos":[]},"mincha_txt":"Just before Plag- call shul for exact time.","maariv_txt":"follows Mincha"},
          {"id":34,"name":"Chinuch Atzmai - Torah Schools","address":"40 Exchange Place","city":"New York","state":"NY","zip":"10005","lat":40.705997,"lng":-74.009035,"nusach":"Other","rabbi":null,"phone":"212-248-6200","email":null,"website":null,"shacharis":{"sun":[],"mon_thu":[],"tue_wed_fri":[],"rosh_chodesh":[]},"mincha":{"week":["12:45","13:40"],"fri":[],"shabbos":[]},"maariv":{"week":[],"shabbos":[]}},
          {"id":1001,"name":"Beth Medrash Govoha (BMG)","address":"617 6th St","city":"Lakewood","state":"NJ","zip":"08701","lat":40.0935,"lng":-74.2158,"nusach":"Ashkenaz","shacharis":{"sun":["07:40","08:45"],"mon_thu":["07:40","08:45"],"tue_wed_fri":["07:40","08:45"],"rosh_chodesh":["07:30","08:30"]},"mincha":{"week":["13:45","15:25"],"fri":[],"shabbos":[]},"maariv":{"week":["22:00","23:00"],"shabbos":[]}},
          {"id":1002,"name":"Kol Shimshon","address":"323 Squankum Rd","city":"Lakewood","state":"NJ","zip":"08701","lat":40.1023,"lng":-74.2012,"nusach":"Ashkenaz","shacharis":{"sun":["07:00","08:00"],"mon_thu":["06:45","08:00"],"tue_wed_fri":["06:45","08:00"],"rosh_chodesh":[]},"mincha":{"week":["12:20","12:40","13:00","13:20","13:40"],"fri":[],"shabbos":[]},"maariv":{"week":["18:00","18:15","18:30","18:45","19:00","19:15","19:30"],"shabbos":[]},"mincha_txt":"Every 20 mins from 12:20 PM"},
          {"id":1003,"name":"Khal Ytev Lev (Satmar)","address":"405 Forest Ave","city":"Lakewood","state":"NJ","zip":"08701","lat":40.0898,"lng":-74.2165,"nusach":"Sefard","shacharis":{"sun":["07:30","08:30","09:30"],"mon_thu":["07:00","08:00","09:00"],"tue_wed_fri":["07:00","08:00","09:00"],"rosh_chodesh":[]},"mincha":{"week":["14:00"],"fri":[],"shabbos":[]},"maariv":{"week":["20:00","21:00"],"shabbos":[]},"mincha_txt":"Continuous minyanim"},
          {"id":1004,"name":"Bais Medrash Lutzk","address":"520 New Egypt Rd","city":"Lakewood","state":"NJ","zip":"08701","lat":40.0839,"lng":-74.2546,"nusach":"Ashkenaz","shacharis":{"sun":["08:00","09:00"],"mon_thu":["06:30","08:00"],"tue_wed_fri":["06:30","08:00"],"rosh_chodesh":[]},"mincha":{"week":["13:45","17:30"],"fri":[],"shabbos":[]},"maariv":{"week":["21:00","22:00"],"shabbos":[]}},
          {"id":1005,"name":"Chestnut Shul","address":"105 Chestnut St","city":"Lakewood","state":"NJ","zip":"08701","lat":40.0526,"lng":-74.2161,"nusach":"Sefard","shacharis":{"sun":["07:00","08:00","09:00"],"mon_thu":["06:30","07:30"],"tue_wed_fri":["06:30","07:30"],"rosh_chodesh":[]},"mincha":{"week":["13:45","17:09"],"fri":[],"shabbos":[]},"maariv":{"week":["19:00","20:45","22:00"],"shabbos":[]}},
          {"id":1006,"name":"Pine River Village Shul","address":"38 Goldcrest Dr","city":"Lakewood","state":"NJ","zip":"08701","lat":40.0585,"lng":-74.2312,"nusach":"Ashkenaz","shacharis":{"sun":["07:30","08:30"],"mon_thu":["07:00","08:00"],"tue_wed_fri":["07:00","08:00"],"rosh_chodesh":[]},"mincha":{"week":["13:40"],"fri":[],"shabbos":[]},"maariv":{"week":["20:15","21:00"],"shabbos":[]}},
          {"id":1007,"name":"Bais Medrash Kol Aryeh","address":"521 Hope Chapel Rd","city":"Lakewood","state":"NJ","zip":"08701","lat":40.1152,"lng":-74.2385,"nusach":"Sefard","shacharis":{"sun":["06:00","06:50","07:50","08:50"],"mon_thu":["06:00","06:50"],"tue_wed_fri":["06:00","06:50"],"rosh_chodesh":[]},"mincha":{"week":["13:30","16:20"],"fri":[],"shabbos":[]},"maariv":{"week":["18:15","19:00","20:30","22:05","23:00"],"shabbos":[]}},
          {"id":1008,"name":"K'hal Ateres Yeshaya","address":"908 E County Line Rd","city":"Lakewood","state":"NJ","zip":"08701","lat":40.0955,"lng":-74.1952,"nusach":"Ashkenaz","shacharis":{"sun":["07:10","08:00","09:45"],"mon_thu":["06:05","07:10"],"tue_wed_fri":["06:10","07:10"],"rosh_chodesh":[]},"mincha":{"week":["17:00"],"fri":[],"shabbos":[]},"maariv":{"week":["20:10","21:45"],"shabbos":[]}},
          {"id":1009,"name":"Lakewood Commons Shul","address":"44 Coles Way","city":"Lakewood","state":"NJ","zip":"08701","lat":40.0385,"lng":-74.2255,"nusach":"Ashkenaz","shacharis":{"sun":["07:20","07:35","07:40","08:00","08:20"],"mon_thu":["07:20","08:00"],"tue_wed_fri":["07:20","08:00"],"rosh_chodesh":[]},"mincha":{"week":["13:15","13:50"],"fri":[],"shabbos":[]},"maariv":{"week":["21:30","22:00","22:20"],"shabbos":[]}},
          {"id":1010,"name":"Ezrat Torah / Lakewood Outreach","address":"401 Madison Ave","city":"Lakewood","state":"NJ","zip":"08701","lat":40.0932,"lng":-74.2125,"nusach":"Edot-HaMizrach","shacharis":{"sun":["08:00"],"mon_thu":["07:00"],"tue_wed_fri":["07:00"],"rosh_chodesh":[]},"mincha":{"week":[],"fri":[],"shabbos":[]},"maariv":{"week":["22:00"],"shabbos":[]}},
          {"id":1011,"name":"Kehilat Etz Hayim","address":"21 Cedar St","city":"Lakewood","state":"NJ","zip":"08701","lat":40.0895,"lng":-74.2185,"nusach":"Edot-HaMizrach","shacharis":{"sun":[],"mon_thu":[],"tue_wed_fri":[],"rosh_chodesh":[]},"mincha":{"week":["16:55"],"fri":[],"shabbos":[]},"maariv":{"week":[],"shabbos":[]}},
          {"id":1012,"name":"Khal Bnei Torah","address":"304 Monmouth Ave","city":"Lakewood","state":"NJ","zip":"08701","lat":40.0945,"lng":-74.2135,"nusach":"Edot-HaMizrach","shacharis":{"sun":[],"mon_thu":[],"tue_wed_fri":[],"rosh_chodesh":[]},"mincha":{"week":[],"fri":[],"shabbos":[]},"maariv":{"week":["21:45"],"shabbos":[]}},
          {"id":1013,"name":"Kollel Ezrat Torah","address":"517 Forest Ave","city":"Lakewood","state":"NJ","zip":"08701","lat":40.0915,"lng":-74.2195,"nusach":"Edot-HaMizrach","shacharis":{"sun":[],"mon_thu":[],"tue_wed_fri":[],"rosh_chodesh":[]},"mincha":{"week":[],"fri":[],"shabbos":[]},"maariv":{"week":["22:00"],"shabbos":[]}},
          {"id":1014,"name":"Shaarey Ezra","address":"13 Ponderosa Dr","city":"Lakewood","state":"NJ","zip":"08701","lat":40.0755,"lng":-74.2255,"nusach":"Edot-HaMizrach","shacharis":{"sun":[],"mon_thu":[],"tue_wed_fri":[],"rosh_chodesh":[]},"mincha":{"week":[],"fri":[],"shabbos":[]},"maariv":{"week":[],"shabbos":[]}},
          {"id":1015,"name":"Sunset Road Sephardic Cong","address":"220 Sunset Rd","city":"Lakewood","state":"NJ","zip":"08701","lat":40.0815,"lng":-74.2285,"nusach":"Edot-HaMizrach","shacharis":{"sun":[],"mon_thu":[],"tue_wed_fri":[],"rosh_chodesh":[]},"mincha":{"week":[],"fri":[],"shabbos":[]},"maariv":{"week":["22:05"],"shabbos":[]}},
          {"id":1016,"name":"Lakewood Sephardic Cong","address":"613 Madison Ave","city":"Lakewood","state":"NJ","zip":"08701","lat":40.0965,"lng":-74.2145,"nusach":"Edot-HaMizrach","shacharis":{"sun":[],"mon_thu":[],"tue_wed_fri":[],"rosh_chodesh":[]},"mincha":{"week":[],"fri":[],"shabbos":[]},"maariv":{"week":[],"shabbos":[]}},
          {"id":1017,"name":"Minyan Avrechim Sefaradi","address":"500 Marc Dr","city":"Lakewood","state":"NJ","zip":"08701","lat":40.0785,"lng":-74.2305,"nusach":"Edot-HaMizrach","shacharis":{"sun":[],"mon_thu":[],"tue_wed_fri":[],"rosh_chodesh":[]},"mincha":{"week":[],"fri":[],"shabbos":[]},"maariv":{"week":["21:20"],"shabbos":[]}},
          {"id":1018,"name":"Cong Zichron Binyamin","address":"701 Princeton Ave","city":"Lakewood","state":"NJ","zip":"08701","lat":40.0995,"lng":-74.2085,"nusach":"Edot-HaMizrach","shacharis":{"sun":[],"mon_thu":[],"tue_wed_fri":[],"rosh_chodesh":[]},"mincha":{"week":[],"fri":[],"shabbos":[]},"maariv":{"week":["21:35"],"shabbos":[]}},
          {"id":1019,"name":"Congregation Ohel Shulamit","address":"38 Spruce St","city":"Lakewood","state":"NJ","zip":"08701","lat":40.0855,"lng":-74.2355,"nusach":"Edot-HaMizrach","shacharis":{"sun":[],"mon_thu":[],"tue_wed_fri":[],"rosh_chodesh":[]},"mincha":{"week":[],"fri":[],"shabbos":[]},"maariv":{"week":["19:00"],"shabbos":[]}},
          {"id":1020,"name":"Khal Tiferes Tzvi","address":"80 Bradhurst Ave","city":"Lakewood","state":"NJ","zip":"08701","lat":40.0985,"lng":-74.2255,"nusach":"Sefard","shacharis":{"sun":["06:00"],"mon_thu":["06:00"],"tue_wed_fri":["06:00"],"rosh_chodesh":[]},"mincha":{"week":[],"fri":[],"shabbos":[]},"maariv":{"week":[],"shabbos":[]}},
          {"id":1021,"name":"Khal Zichron Yaakov","address":"175 Sunset Rd","city":"Lakewood","state":"NJ","zip":"08701","lat":40.0825,"lng":-74.2265,"nusach":"Ashkenaz","shacharis":{"sun":["06:10"],"mon_thu":["06:10"],"tue_wed_fri":["06:10"],"rosh_chodesh":[]},"mincha":{"week":[],"fri":[],"shabbos":[]},"maariv":{"week":[],"shabbos":[]}},
          {"id":1022,"name":"Sharei Tefilah","address":"1176 Coughlin St","city":"Lakewood","state":"NJ","zip":"08701","lat":40.0705,"lng":-74.2385,"nusach":"Sefard","shacharis":{"sun":["06:10"],"mon_thu":["06:10"],"tue_wed_fri":["06:10"],"rosh_chodesh":[]},"mincha":{"week":[],"fri":[],"shabbos":[]},"maariv":{"week":[],"shabbos":[]}},
          {"id":1023,"name":"Madison Title Minyan","address":"1125 Ocean Ave","city":"Lakewood","state":"NJ","zip":"08701","lat":40.0885,"lng":-74.2055,"nusach":"Sefard","shacharis":{"sun":["06:10"],"mon_thu":["06:10"],"tue_wed_fri":["06:10"],"rosh_chodesh":[]},"mincha":{"week":[],"fri":[],"shabbos":[]},"maariv":{"week":[],"shabbos":[]}},
          {"id":1024,"name":"Shemen Lmincha","address":"2 Milano Dr","city":"Lakewood","state":"NJ","zip":"08701","lat":40.0655,"lng":-74.2405,"nusach":"Sefard","shacharis":{"sun":["06:15"],"mon_thu":["06:15"],"tue_wed_fri":["06:15"],"rosh_chodesh":[]},"mincha":{"week":[],"fri":[],"shabbos":[]},"maariv":{"week":[],"shabbos":[]}},
          {"id":1025,"name":"Kahal Rizhin","address":"1132 E County Line Rd","city":"Lakewood","state":"NJ","zip":"08701","lat":40.0965,"lng":-74.1925,"nusach":"Sefard","shacharis":{"sun":["06:15"],"mon_thu":["06:15"],"tue_wed_fri":["06:15"],"rosh_chodesh":[]},"mincha":{"week":[],"fri":[],"shabbos":[]},"maariv":{"week":[],"shabbos":[]}},
          {"id":1026,"name":"Khal M'kadshai Hashem","address":"2461 Whitesville Rd","city":"Toms River","state":"NJ","zip":"08755","lat":40.0555,"lng":-74.2455,"nusach":"Sefard","shacharis":{"sun":["06:15"],"mon_thu":["06:15"],"tue_wed_fri":["06:15"],"rosh_chodesh":[]},"mincha":{"week":[],"fri":[],"shabbos":[]},"maariv":{"week":[],"shabbos":[]}},
          {"id":1027,"name":"Bais Halevy","address":"705 Valley Dr","city":"Lakewood","state":"NJ","zip":"08701","lat":40.0855,"lng":-74.2255,"nusach":"Ashkenaz","shacharis":{"sun":["07:30","08:15"],"mon_thu":["07:30"],"tue_wed_fri":["07:30"],"rosh_chodesh":[]},"mincha":{"week":["13:40"],"fri":[],"shabbos":[]},"maariv":{"week":["21:45"],"shabbos":[]}},
          {"id":1028,"name":"Shefa Chaim Sanz","address":"112 Chestnut St","city":"Lakewood","state":"NJ","zip":"08701","lat":40.0515,"lng":-74.2155,"nusach":"Sefard","shacharis":{"sun":[],"mon_thu":[],"tue_wed_fri":[],"rosh_chodesh":[]},"mincha":{"week":[],"fri":[],"shabbos":[]},"maariv":{"week":[],"shabbos":[]}},
          {"id":1029,"name":"Gur Lakewood","address":"325 10th St","city":"Lakewood","state":"NJ","zip":"08701","lat":40.0955,"lng":-74.2105,"nusach":"Sefard","shacharis":{"sun":[],"mon_thu":[],"tue_wed_fri":[],"rosh_chodesh":[]},"mincha":{"week":[],"fri":[],"shabbos":[]},"maariv":{"week":[],"shabbos":[]}},
          {"id":1030,"name":"Beth Am Shalom","address":"1235 Route 70 West","city":"Lakewood","state":"NJ","zip":"08701","lat":40.0655,"lng":-74.2055,"nusach":"Other","shacharis":{"sun":[],"mon_thu":[],"tue_wed_fri":[],"rosh_chodesh":[]},"mincha":{"week":[],"fri":[],"shabbos":[]},"maariv":{"week":[],"shabbos":[]}},
          {"id":1031,"name":"Chabad of Jackson","address":"645 Cross St","city":"Lakewood","state":"NJ","zip":"08701","lat":40.0555,"lng":-74.2555,"nusach":"Ari","shacharis":{"sun":[],"mon_thu":[],"tue_wed_fri":[],"rosh_chodesh":[]},"mincha":{"week":[],"fri":[],"shabbos":[]},"maariv":{"week":[],"shabbos":[]}},
          {"id":1032,"name":"Chabad of Toms River","address":"2001 Church Rd","city":"Toms River","state":"NJ","zip":"08753","lat":39.9955,"lng":-74.1855,"nusach":"Ari","shacharis":{"sun":[],"mon_thu":[],"tue_wed_fri":[],"rosh_chodesh":[]},"mincha":{"week":[],"fri":[],"shabbos":[]},"maariv":{"week":[],"shabbos":[]}},
          {"id":1033,"name":"Congregation Sons of Israel","address":"590 Madison Ave","city":"Lakewood","state":"NJ","zip":"08701","lat":40.0955,"lng":-74.2125,"nusach":"Ashkenaz","shacharis":{"sun":["08:00","08:15","08:30"],"mon_thu":["07:00","07:50"],"tue_wed_fri":["07:00","07:50"],"rosh_chodesh":[]},"mincha":{"week":["13:35","16:52"],"fri":[],"shabbos":[]},"maariv":{"week":["21:30","22:00"],"shabbos":[]}}
        ];
        // EMBEDDED DATABASE END

        let map, allMinyanim = [], processedMinyanim = [], searchCenter = null, currentRadius = 20;
        let filters = { sort: 'time_asc', tefillah: '', nusach: '' };
        let selectedShul = null;
        let markers = [];
        let isProgrammaticMove = false;
        let allNusachs = new Set();

        document.addEventListener("DOMContentLoaded", async () => {
            document.getElementById('time-start').value = "00:00";
            document.getElementById('time-end').value = "23:59";
            
            processMinyanim(RAW_DB);
            populateNusachFilter();
            initPullToDismiss();
        });

        function scrollToTop(e) {
            if(e) e.stopPropagation();
            document.getElementById('list-view').scrollTo({ top: 0, behavior: 'smooth' });
        }

        function getTodayKey() {
            const d = new Date().getDay(); 
            if (d === 0) return 'sun';
            if (d === 1 || d === 4) return 'mon_thu';
            return 'tue_wed_fri';
        }

        function processMinyanim(data){
            processedMinyanim = [];
            allNusachs = new Set();
            const todayKey = getTodayKey();

            data.forEach(shul => {
                if(!shul.name) return; // Skip nameless
                if(shul.nusach) allNusachs.add(shul.nusach.trim());

                let hasTimes = false;
                if (shul.shacharis && shul.shacharis[todayKey]) {
                    shul.shacharis[todayKey].forEach(t => { addMinyan(shul, 'Shacharis', t); hasTimes = true; });
                }
                if (shul.mincha && shul.mincha.week) {
                    shul.mincha.week.forEach(t => { addMinyan(shul, 'Mincha', t); hasTimes = true; });
                }
                if (shul.maariv && shul.maariv.week) {
                    shul.maariv.week.forEach(t => { addMinyan(shul, 'Maariv', t); hasTimes = true; });
                }

                if (!hasTimes) {
                    processedMinyanim.push({
                        ...shul, tefillah: 'Info', timeDisplay: '--:--', ampm: '', timeValue: 9999
                    });
                }
            });
            allMinyanim = processedMinyanim;
        }

        function addMinyan(shul, type, tStr) {
            if(!tStr) return;
            let raw = tStr.trim().replace(/[^0-9:]/g,"");
            if(!raw) return;
            let [h,m] = raw.split(":").map(Number);
            let isPM = (type === "Maariv" || (type === "Mincha" && h < 9) || (type === "Mincha" && h === 12));
            let sortH = (isPM && h < 12) ? h + 12 : ((!isPM && h === 12) ? 0 : h);
            let dispH = h > 12 ? h - 12 : (h === 0 ? 12 : h);
            let dispM = String(m).padStart(2,"0");
            
            processedMinyanim.push({
                ...shul, tefillah: type, timeDisplay: `${dispH}:${dispM}`, ampm: isPM ? "PM" : "AM", timeValue: (sortH * 60) + m
            });
        }

        function populateNusachFilter() {
            const group = document.getElementById("nusach-group");
            group.innerHTML = `<div class="chip active" onclick="setFilter('nusach', '', this)">All</div>`;
            Array.from(allNusachs).sort().forEach(n => {
                if(!n) return;
                const safeClass = `chip-${n.replace(/\s+/g, '-')}`;
                const chip = document.createElement("div");
                chip.className = `chip ${safeClass}`;
                chip.innerText = n;
                chip.onclick = function() { setFilter('nusach', n, this); };
                group.appendChild(chip);
            });
        }

        function toggleView() {
            // Close filter drawer
            document.getElementById('filter-drawer').style.display = 'none';

            const list = document.getElementById("list-view");
            const btn = document.getElementById("view-toggle-btn");
            const icon = document.getElementById("view-icon");
            const dot = document.getElementById("center-marker");
            const mapPill = document.getElementById("map-radius-pill");
            
            if (list.style.display === "none") {
                list.style.display = "block";
                icon.innerText = "map";
                btn.classList.remove("active");
                dot.style.display = "none";
                mapPill.style.display = "none";
            } else {
                list.style.display = "none";
                icon.innerText = "list";
                btn.classList.add("active");
                dot.style.display = "block";
                mapPill.style.display = "block";
                
                if(map && searchCenter && map.getZoom() === 12 && !markers.length) {
                    isProgrammaticMove = true;
                    map.panTo(searchCenter);
                }
            }
        }

        function setSearchLocation(lat, lng, name){
            searchCenter = { lat, lng };
            document.getElementById("status-pill").style.display = "block";
            document.getElementById("status-pill").innerText = `Near: ${name}`;
            
            if(map) {
                isProgrammaticMove = true;
                map.setCenter({ lat, lng });
                map.setZoom(13);
            }
            applyFilters();
        }

        function manualRadiusUpdate(val) {
            updateRadius(val);
            applyFilters();
        }

        function updateRadius(val) {
            currentRadius = parseFloat(val);
            document.getElementById("radius-input").value = currentRadius;
            document.getElementById("radius-slider").value = currentRadius;
        }

        function applyFilters(){
            if(!searchCenter || !allMinyanim.length) return;
            const [sH, sM] = document.getElementById('time-start').value.split(':').map(Number);
            const [eH, eM] = document.getElementById('time-end').value.split(':').map(Number);
            const startVal = (sH*60)+sM, endVal = (eH*60)+eM;

            let results = allMinyanim.map(m => {
                m.distance = getDistance(searchCenter.lat, searchCenter.lng, m.lat, m.lng);
                return m;
            }).filter(m => m.distance <= currentRadius);

            if(filters.tefillah) results = results.filter(m => m.tefillah === filters.tefillah);
            if(filters.nusach) results = results.filter(m => m.nusach === filters.nusach);
            
            results = results.filter(m => {
                if (m.timeValue === 9999) return true; 
                return m.timeValue >= startVal && m.timeValue <= endVal;
            });

            if(filters.sort === 'distance') results.sort((a,b) => a.distance - b.distance);
            else results.sort((a,b) => a.timeValue - b.timeValue);
            
            const uniqueShuls = new Set(results.map(r => r.name + r.address)).size;
            const countPill = document.getElementById("count-pill");
            countPill.style.display = "block";
            countPill.innerText = `${uniqueShuls} Shuls / ${results.length} Minyanim`;

            renderList(results);
            updateMapMarkers(results);
        }

        function renderList(results){
            const list = document.getElementById("list-view");
            list.innerHTML = results.length ? "" : '<div class="empty-state">No minyanim found matching your filters.</div>';
            results.forEach(m => {
                let nCls = `nusach-${(m.nusach || 'Other').replace(/\s+/g, '-')}`;
                const godavenId = m.godaven_link ? m.godaven_link.split('/').pop() : m.id;
                const link = `https://www.godaven.com/shul-details/${godavenId}`;
                
                const card = document.createElement("div");
                card.className = "minyan-card";
                
                let rightSide = '';
                if(m.timeValue === 9999) {
                    rightSide = `<div class="map-zone" onclick="window.open('${link}','_blank')">
                        <div class="map-footer">
                            <div class="dist-label">${m.distance.toFixed(1)}mi</div>
                            <div class="map-circle"><i class="material-icons google-maps-icon">place</i></div>
                        </div>
                    </div>`;
                } else {
                    rightSide = `<div class="map-zone" onclick="window.open('${link}','_blank')">
                        <div class="tefillah-label tef-${m.tefillah}">${m.tefillah}</div>
                        <div class="time-val">${m.timeDisplay}<small style="font-size:10px; vertical-align:top; margin-left:1px;">${m.ampm}</small></div>
                        <div class="map-footer">
                            <div class="dist-label">${m.distance.toFixed(1)}mi</div>
                            <div class="map-circle"><i class="material-icons google-maps-icon">place</i></div>
                        </div>
                    </div>`;
                }

                card.innerHTML = `
                    <div class="info-zone" onclick='openDetails(${JSON.stringify(m).replace(/'/g, "'")})'>
                        <div class="shul-name">${m.name}</div>
                        <div class="shul-address">${m.address}</div>
                        <div class="nusach-tag ${nCls}">${m.nusach}</div>
                    </div>
                    ${rightSide}`;
                list.appendChild(card);
            });
        }

        async function updateMapMarkers(results) {
            if (!map) return;
            const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");
            markers.forEach(m => m.map = null); markers = [];
            
            const groups = {};
            results.forEach(r => {
                const key = r.lat + "," + r.lng;
                if (!groups[key] || r.timeValue < groups[key].timeValue) groups[key] = r;
            });

            Object.values(groups).forEach(m => {
                const pinDiv = document.createElement("div");
                let nCls = `marker-${(m.nusach || 'Other').replace(/\s+/g, '-')}`;
                pinDiv.className = `custom-marker ${nCls}`;
                pinDiv.textContent = (m.timeValue === 9999) ? "?" : `${m.timeDisplay}`; 

                const marker = new AdvancedMarkerElement({
                    map: map, position: { lat: m.lat, lng: m.lng },
                    content: pinDiv, title: m.name
                });
                marker.element.addEventListener("click", () => openDetails(m));
                markers.push(marker);
            });
        }

        function onMapIdle() {
            if (isProgrammaticMove) { isProgrammaticMove = false; return; }
            if(!map) return;
            const center = map.getCenter();
            const bounds = map.getBounds();
            if(!center || !bounds) return;

            searchCenter = { lat: center.lat(), lng: center.lng() };
            document.getElementById("status-pill").innerText = `Near: Map Center`;

            const ne = bounds.getNorthEast();
            const r = getDistance(center.lat(), center.lng(), ne.lat(), ne.lng());
            
            document.getElementById("radius-input").value = r.toFixed(1);
            document.getElementById("radius-slider").value = r.toFixed(1);
            document.getElementById("map-radius-pill").innerText = `Map Radius: ${r.toFixed(1)} mi`;
            currentRadius = r;
            
            applyFilters();
        }

        function formatList(list) {
            if(!list || list.length === 0) return 'None';
            return list.join(", ");
        }

        function openDetails(m) {
            selectedShul = m;
            const godavenId = m.godaven_link ? m.godaven_link.split('/').pop() : m.id;
            const link = `https://www.godaven.com/shul-details/${godavenId}`;
            const nCls = `nusach-${(m.nusach || 'Other').replace(/\s+/g, '-')}`;
            const content = document.getElementById("drawer-content");
            
            let contacts = [];
            if(m.phone) contacts.push(`<a href="tel:${m.phone}" class="contact-btn"><i class="material-icons">call</i> Call</a>`);
            if(m.email) contacts.push(`<a href="mailto:${m.email}" class="contact-btn"><i class="material-icons">email</i> Email</a>`);
            contacts.push(`<a href="${link}" target="_blank" rel="noopener noreferrer" class="contact-btn"><i class="material-icons">open_in_new</i> GoDaven</a>`);

            let rabbiInfo = m.rabbi ? `<div style="font-size:14px; color:#555; margin-top:4px; font-weight:600;"><i class="material-icons" style="font-size:14px; vertical-align:middle;">person</i> ${m.rabbi}</div>` : '';

            content.innerHTML = `
                <h2 style="margin:0; color:var(--primary); font-size:22px; padding-right:20px;">${m.name}</h2>
                ${rabbiInfo}
                <p style="color:#666; margin:5px 0 10px; font-size:14px;">${m.address}</p>
                <div class="nusach-tag ${nCls}">${m.nusach}</div>
                
                <div class="drawer-nav-row" style="background:#fafafa; padding:15px; border-radius:15px; border:1px solid #f0f0f0;">
                    <div class="tefillah-text tef-${m.tefillah}" style="font-size:14px;">${m.tefillah} â€¢ ${m.timeDisplay}${m.ampm}</div>
                    <div style="display:flex; align-items:center; gap:12px;">
                        <div style="font-size:18px; font-weight:800; color:#444;">${m.distance.toFixed(1)}mi</div>
                        <div class="map-circle-lg" onclick="window.open('${link}','_blank')" style="cursor:pointer;">
                            <i class="material-icons google-maps-icon google-maps-icon-lg">place</i>
                        </div>
                    </div>
                </div>

                <div class="contact-row">${contacts.join('')}</div>

                <div class="schedule-section">
                    <div class="schedule-title">Weekday Schedule</div>
                    <div class="schedule-grid">
                        <div class="schedule-item"><div class="schedule-day">Shacharis Sun</div>${formatList(m.shacharis?.sun)}</div>
                        <div class="schedule-item"><div class="schedule-day">Shacharis M/Th</div>${formatList(m.shacharis?.mon_thu)}</div>
                        <div class="schedule-item"><div class="schedule-day">Shacharis T/W/F</div>${formatList(m.shacharis?.tue_wed_fri)}</div>
                        <div class="schedule-item"><div class="schedule-day">Rosh Chodesh</div>${formatList(m.shacharis?.rosh_chodesh)}</div>
                        <div class="schedule-item"><div class="schedule-day">Mincha</div>${formatList(m.mincha?.week)}</div>
                        <div class="schedule-item"><div class="schedule-day">Maariv</div>${formatList(m.maariv?.week)}</div>
                    </div>
                </div>

                <div class="schedule-section">
                    <div class="schedule-title">Shabbos Schedule</div>
                    <div class="schedule-grid">
                        <div class="schedule-item"><div class="schedule-day">Mincha Erev Shab</div>${formatList(m.mincha?.fri)}</div>
                        <div class="schedule-item"><div class="schedule-day">Mincha Shabbos</div>${formatList(m.mincha?.shabbos)}</div>
                        <div class="schedule-item"><div class="schedule-day">Maariv Motzei</div>${formatList(m.maariv?.shabbos)}</div>
                    </div>
                </div>
            `;
            const drawer = document.getElementById("details-drawer");
            drawer.classList.add("open");
            drawer.style.transform = "translateY(0)";
            document.getElementById("scrim").style.display = "block";
        }

        async function shareShul() {
            if(!selectedShul) return;
            const godavenId = selectedShul.godaven_link ? selectedShul.godaven_link.split('/').pop() : selectedShul.id;
            const link = `https://www.godaven.com/shul-details/${godavenId}`;
            
            const text = `Shared by ShulTime:\n\n${selectedShul.name}\n${selectedShul.address}\n\nNusach: ${selectedShul.nusach}\nLink: ${link}\n\nWEEKDAY TIMES:\nShacharis Sun: ${formatList(selectedShul.shacharis?.sun)}\nShacharis M/Th: ${formatList(selectedShul.shacharis?.mon_thu)}\nMincha: ${formatList(selectedShul.mincha?.week)}\nMaariv: ${formatList(selectedShul.maariv?.week)}`;
            
            if(navigator.share) {
                try { await navigator.share({ title: selectedShul.name, text: text, url: link }); } 
                catch(e) { console.log('Share failed', e); }
            } else {
                navigator.clipboard.writeText(text);
                alert("Details copied to clipboard!");
            }
        }

        function closeDetails() {
            const drawer = document.getElementById("details-drawer");
            drawer.classList.remove("open");
            drawer.style.transform = "translateY(100%)";
            document.getElementById("scrim").style.display = "none";
        }

        function initPullToDismiss() {
            const drawer = document.getElementById('details-drawer');
            let startY = 0; let currentY = 0;
            drawer.addEventListener('touchstart', (e) => { startY = e.touches[0].clientY; }, {passive: true});
            drawer.addEventListener('touchmove', (e) => {
                currentY = e.touches[0].clientY;
                let delta = currentY - startY;
                if (delta > 0) drawer.style.transform = `translateY(${delta}px)`;
            }, {passive: true});
            drawer.addEventListener('touchend', (e) => {
                let delta = currentY - startY;
                if (delta > 100) closeDetails();
                else drawer.style.transform = "translateY(0)";
                startY = 0; currentY = 0;
            }, {passive: true});
        }

        function toggleFilters() {
            const d = document.getElementById('filter-drawer');
            d.style.display = (d.style.display==='block') ? 'none' : 'block';
        }

        function setFilter(type, val, btn) {
            filters[type] = val;
            const group = btn.parentElement;
            group.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
            btn.classList.add('active');
            applyFilters();
        }

        function setAllDay() { document.getElementById('time-start').value = "00:00"; document.getElementById('time-end').value = "23:59"; applyFilters(); }
        
        function setNextHour() {
            const now = new Date(); const pad = n => String(n).padStart(2,'0');
            document.getElementById('time-start').value = `${pad(now.getHours())}:${pad(now.getMinutes())}`;
            const next = new Date(now.getTime() + 60*60*1000);
            document.getElementById('time-end').value = `${pad(next.getHours())}:${pad(next.getMinutes())}`;
            applyFilters();
        }

        function onStartTimeChange() {
            const [h,m] = document.getElementById('time-start').value.split(':').map(Number);
            let endH = h + 1; if(endH > 23) endH = 23;
            document.getElementById('time-end').value = `${String(endH).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
            applyFilters();
        }

        function useMyLocation() {
            navigator.geolocation.getCurrentPosition(pos => {
                setSearchLocation(pos.coords.latitude, pos.coords.longitude, "Current Location");
            }, e => alert("Please enable GPS/Location services."));
        }

        function clearSearch(){
            searchCenter = null;
            document.getElementById("status-pill").style.display = "none";
            document.getElementById("count-pill").style.display = "none";
            document.getElementById("map-radius-pill").style.display = "none";
            document.getElementById("list-view").innerHTML = `
                <div class="empty-state">
                    <i class="material-icons" style="font-size:54px; margin-bottom:15px; color: var(--primary); opacity: 0.8;">explore</i><br>
                    <strong>Welcome to ShulTime</strong><br><br>
                    <b>1. Search</b> for a city or zip code.<br>
                    <b>2. Filter</b> by time or Nusach.<br>
                    <b>3. Tap</b> the target to use GPS.
                </div>`;
            const el = document.querySelector('gmp-place-autocomplete');
            if(el) el.value = null;
            if(map) { markers.forEach(m => m.map = null); }
        }

        function getDistance(lat1, lon1, lat2, lon2){
            const R = 3958.8; const dLat = (lat2 - lat1) * Math.PI / 180; const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2)**2;
            return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
        }

        async function initApp(){
            const { Map } = await google.maps.importLibrary("maps");
            const { PlaceAutocompleteElement } = await google.maps.importLibrary("places");
            const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");

            const autocomplete = new PlaceAutocompleteElement();
            autocomplete.setAttribute("types", "(cities)");
            autocomplete.placeholder = "Search City...";
            const container = document.getElementById("autocomplete-container");
            container.appendChild(autocomplete);

            map = new Map(document.getElementById("map-view"), {
                center: { lat: 40.091, lng: -74.218 },
                zoom: 12, disableDefaultUI: true, mapId: "DEMO_MAP_ID"
            });

            map.addListener('idle', onMapIdle);

            autocomplete.addEventListener('input', () => { if (!autocomplete.value) clearSearch(); });

            autocomplete.addEventListener("gmp-select", async (event) => {
                if (event.placePrediction) {
                    if (document.activeElement) document.activeElement.blur();
                    setTimeout(() => { if (document.activeElement) document.activeElement.blur(); }, 200);

                    const place = event.placePrediction.toPlace();
                    await place.fetchFields({ fields: ["displayName", "location"] });
                    setSearchLocation(place.location.lat(), place.location.lng(), place.displayName);
                }
            });
        }
    </script>
    <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAOpNebt0dPJUmiEw-i1W-Dx_UezLpIvxI&loading=async&libraries=places,maps,marker&callback=initApp"></script>
</body>
</html>
