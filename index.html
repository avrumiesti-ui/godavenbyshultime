<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ShulTime Redesign</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <div id="splash-screen">
        <div class="splash-content">
            <div class="logo-area">
                <i class="material-icons" style="font-size: 64px; color: white;">synagogue</i>
                <h1 style="color: white; margin: 10px 0;">GoDaven</h1>
            </div>
            
            <div class="splash-actions">
                <button class="btn-primary" onclick="useMyLocation()">
                    <i class="material-icons">my_location</i> Use My Location
                </button>
                <button class="btn-secondary" onclick="showSearch()">
                    <i class="material-icons">search</i> Search Location
                </button>
            </div>
        </div>
    </div>

    <div id="app-interface" style="display:none;">

        <div class="app-header">
            <div class="search-row">
                <div class="search-pill">
                    <i class="material-icons search-icon">search</i>
                    <input type="text" id="location-input" placeholder="Search location..." value="New York, NY">
                    <i class="material-icons clear-icon" onclick="clearSearch()">close</i>
                </div>
                <button class="toggle-btn" onclick="toggleView()">
                    <i class="material-icons" id="toggle-icon">map</i>
                </button>
            </div>

            <div class="filter-row">
                <div class="filter-chip active">
                    <span>Sort: Time</span>
                    <i class="material-icons">expand_more</i>
                </div>
                
                <div class="filter-chip">
                    <span>6:05a - 7:05a</span>
                    <i class="material-icons">expand_more</i>
                </div>

                <div class="filter-chip">
                    <span>Shacharis</span>
                    <i class="material-icons">expand_more</i>
                </div>
                
                <div class="filter-chip">
                    <span>Sefard</span>
                    <i class="material-icons">expand_more</i>
                </div>
            </div>
            
            <div class="results-count" id="results-count">
                52 Results found
            </div>
        </div>

        <div class="results-container" id="list-view">
            
            <div class="minyan-card">
                <div class="card-left">
                    <h3>Beit Midrash Beth Gavriel</h3>
                    <p class="address">20 W 47th St, New York, NY</p>
                    <div class="nusach-row">
                        <span class="nusach-tag ashkenaz">ASHKENAZ</span>
                    </div>
                </div>
                
                <div class="card-right">
                    <div class="tefillah-label">Mincha</div>
                    <div class="time-display">01:00 PM</div>
                </div>
            </div>

            <div class="minyan-card">
                <div class="card-left">
                    <h3>Millinery Center Synagogue</h3>
                    <p class="address">1025 6th Ave, New York, NY</p>
                    <div class="nusach-row">
                        <span class="nusach-tag ashkenaz">ASHKENAZ</span>
                    </div>
                </div>
                <div class="card-right">
                    <div class="tefillah-label">Mincha</div>
                    <div class="time-display">01:35 PM</div>
                </div>
            </div>

            <div class="minyan-card">
                <div class="card-left">
                    <h3>444 Madison Minyan</h3>
                    <p class="address">444 Madison Ave, New York, NY</p>
                    <div class="nusach-row">
                        <span class="nusach-tag sefard">SEFARD</span>
                    </div>
                </div>
                <div class="card-right">
                    <div class="tefillah-label">Mincha</div>
                    <div class="time-display">01:40 PM</div>
                </div>
            </div>
            
            <div style="height: 100px;"></div>
        </div>

        <div id="map-view">
            <div class="map-placeholder">User Location Map Loading...</div>
        </div>

    </div> <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAOpNebt0dPJUmiEw-i1W-Dx_UezLpIvxI&libraries=places&callback=initApp"></script>

<script>
   let map;
    let markers = [];
    let infoWindow;
    let autocomplete;

    // 1. Initialize App
    function initApp() {
        // Init Map centered on New York
        map = new google.maps.Map(document.getElementById("map-view"), {
            center: { lat: 40.7128, lng: -74.0060 },
            zoom: 13,
            disableDefaultUI: true,
        });
        
        infoWindow = new google.maps.InfoWindow();

        // Init Autocomplete (The dropdown menu from Google)
        const input = document.getElementById('location-input');
        
        // This limits suggestions to "Geocodes" (cities/addresses) to avoid business spam
        const options = { types: ['geocode'] };
        autocomplete = new google.maps.places.Autocomplete(input, options);
        
        // Listen: When user clicks a suggestion from the dropdown
        autocomplete.addListener('place_changed', onPlaceSelected);

        // Listen: When user presses "Enter" without picking from dropdown
        input.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                const val = e.target.value;
                performSearch(val, null, null); 
            }
        });
    }

    // 2. Handle Autocomplete Selection
    function onPlaceSelected() {
        const place = autocomplete.getPlace();
        
        if (!place.geometry) {
            // User entered name but didn't pick from list
            performSearch(place.name, null, null);
            return;
        }

        // We have coordinates! 
        const lat = place.geometry.location.lat();
        const lng = place.geometry.location.lng();
        
        // Move map to the selected spot
        map.setCenter(place.geometry.location);
        map.setZoom(14);
        
        // Send Name + GPS to our backend
        performSearch(place.name, lat, lng);
    }

    // 3. Send Search to Netlify
    async function performSearch(query, lat, lng) {
        const listContainer = document.getElementById('list-view');
        const countLabel = document.getElementById('results-count');
        
        listContainer.innerHTML = '<div style="text-align:center; padding:40px; color:#888;">Searching GoDaven...</div>';
        
        try {
            // Build the URL for our "Middleman"
            let url = `/.netlify/functions/get-minyanim?q=${encodeURIComponent(query)}`;
            
            // If we have GPS, add it to the URL
            if (lat && lng) {
                url += `&lat=${lat}&lng=${lng}`;
            }

            const response = await fetch(url);
            
            if (!response.ok) throw new Error('Network response was not ok');
            
            const data = await response.json();
            
            // IMPORTANT: GoDaven's API structure might vary. 
            // We check if the data is inside "SearchResults", "results", or is the array itself.
            const results = data.SearchResults || data.results || data; 
            
            // Clear old stuff
            listContainer.innerHTML = '';
            clearMarkers();

            countLabel.innerText = `${results.length || 0} Results found`;

            if (!results || results.length === 0) {
                listContainer.innerHTML = '<div style="text-align:center; padding:20px;">No minyanim found.</div>';
                return;
            }

            // Render the cards
            results.forEach((shul) => {
                // Create Card HTML
                const card = document.createElement('div');
                card.className = 'minyan-card';
                card.innerHTML = `
                    <div class="card-left">
                        <h3>${shul.name || shul.title || 'Unknown Shul'}</h3>
                        <p class="address">${shul.address || ''}</p>
                        <div class="nusach-row">
                            <span class="nusach-tag ashkenaz">${shul.nusach || 'N/A'}</span>
                        </div>
                    </div>
                    <div class="card-right">
                        <div class="tefillah-label">${shul.nextTefillah || 'Next'}</div>
                        <div class="time-display">${shul.nextTime || '--:--'}</div>
                    </div>
                `;
                
                // Clicking card zooms map to that shul
                card.onclick = () => {
                    // Only try to zoom if shul has coordinates
                    if(shul.lat && shul.lng) {
                        toggleView('map');
                        map.setCenter({ lat: parseFloat(shul.lat), lng: parseFloat(shul.lng) });
                        map.setZoom(16);
                    }
                };
                
                listContainer.appendChild(card);

                // Add Map Marker
                addMapMarker(shul);
            });

        } catch (error) {
            console.error("Error:", error);
            listContainer.innerHTML = '<div style="text-align:center; padding:20px; color:red;">Error loading results.</div>';
        }
    }

    // 4. Map Helpers
    function addMapMarker(shul) {
        if (!shul.lat || !shul.lng) return;

        const marker = new google.maps.Marker({
            position: { lat: parseFloat(shul.lat), lng: parseFloat(shul.lng) },
            map: map,
            title: shul.name
        });

        marker.addListener("click", () => {
            infoWindow.setContent(`<strong>${shul.name}</strong><br>${shul.nextTime || ''}`);
            infoWindow.open(map, marker);
        });

        markers.push(marker);
    }

    function clearMarkers() {
        for (let i = 0; i < markers.length; i++) {
            markers[i].setMap(null);
        }
        markers = [];
    }
    
    // 5. View Toggles (Keep your existing functions here)
    function toggleView(forceView) {
        const list = document.getElementById('list-view');
        const mapDiv = document.getElementById('map-view');
        const icon = document.getElementById('toggle-icon');
        
        const isListVisible = list.style.display !== 'none';
        const targetIsMap = forceView === 'map' || (forceView === undefined && isListVisible);

        if (targetIsMap) {
            list.style.display = 'none';
            mapDiv.style.display = 'block';
            icon.innerText = 'list';
            google.maps.event.trigger(map, "resize"); 
        } else {
            list.style.display = 'block';
            mapDiv.style.display = 'none';
            icon.innerText = 'map';
        }
    }
    
    // (Include your showSearch(), useMyLocation(), clearSearch() functions here if they were removed)
</script>
</body>
</html>



