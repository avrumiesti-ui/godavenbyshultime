<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ShulTime Debug</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        :root { --primary: #0D2B4F; --bg: #F2F4F8; }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Roboto", sans-serif; background: var(--bg); color: #111; padding-bottom: 250px; }
        
        /* HEADER */
        .app-header {
            position: sticky; top: 0; z-index: 1000; background: #e0e0e0; padding: 10px;
            border-bottom: 1px solid #ccc;
        }

        /* 1. GOOGLE COMPONENT BAR */
        .google-bar {
            background: white; border-radius: 8px; padding: 5px; margin-bottom: 10px;
            border: 2px solid blue; /* Blue Border to identify */
        }
        gmp-place-autocomplete { width: 100%; display: inline-block; }

        /* 2. MANUAL SEARCH BAR */
        .manual-bar {
            display: flex; gap: 10px; background: white; border-radius: 8px; padding: 5px;
            border: 2px solid red; /* Red Border to identify */
        }
        #manual-input { flex-grow: 1; border: none; font-size: 16px; padding: 8px; outline: none; }
        .go-btn {
            background: red; color: white; border: none; padding: 0 20px; font-weight: bold; border-radius: 4px;
        }

        /* LOG BOX */
        #debug-log {
            position: fixed; bottom: 0; left: 0; right: 0; height: 150px;
            background: black; color: lime; font-family: monospace; font-size: 11px;
            padding: 10px; overflow-y: scroll; z-index: 9999; opacity: 0.9;
        }

        /* LIST & MAP */
        #list-view { padding: 15px; }
        .minyan-card {
            background: white; padding: 15px; margin-bottom: 10px; border-radius: 8px;
            border-left: 5px solid #ccc; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        #map-view { height: 300px; width: 100%; display: none; }
        
        #status-display { text-align: center; font-weight: bold; padding: 10px; background: #fff; }
    </style>
</head>
<body>

    <div class="app-header">
        <div style="font-size:10px; text-align:center; margin-bottom:5px;">OPTION 1: GOOGLE DROPDOWN (Blue)</div>
        <div class="google-bar">
            <div id="place-autocomplete-container"></div>
        </div>

        <div style="font-size:10px; text-align:center; margin-bottom:5px;">OPTION 2: MANUAL TEXT (Red)</div>
        <div class="manual-bar">
            <input type="text" id="manual-input" placeholder="Type City (e.g. Lakewood)">
            <button class="go-btn" onclick="runManualSearch()">GO</button>
        </div>
    </div>

    <div id="status-display">Waiting for location...</div>

    <div id="list-view"></div>
    <div id="map-view"></div>

    <div id="debug-log">System Initializing...<br></div>

    <script>
        function log(msg) {
            const d = document.getElementById('debug-log');
            d.innerHTML += `> ${msg}<br>`;
            d.scrollTop = d.scrollHeight;
        }

        let map, allMinyanim = [];
        let searchCenter = null;
        let PlaceLib = null;

        // 1. DATA
        fetch('database.json').then(r => r.json()).then(data => {
            log(`DB Loaded: ${data.length} records`);
            processMinyanim(data);
        });

        function processMinyanim(data) {
            allMinyanim = [];
            data.forEach(shul => {
                ['Shacharis','Mincha','Maariv'].forEach(type => {
                    if(!shul[type.toLowerCase()]) return;
                    shul[type.toLowerCase()].split(',').forEach(t => {
                        let raw = t.trim().replace(/[^0-9:]/g, '');
                        let [h, m] = raw.split(':').map(Number);
                        let isPM = (type==='Maariv' || (type==='Mincha' && h<9));
                        let sortH = (isPM && h<12) ? h+12 : ((!isPM && h===12) ? 0 : h);
                        allMinyanim.push({
                            name: shul.name, address: shul.address,
                            lat: shul.lat, lng: shul.lng,
                            tefillah: type, timeDisplay: `${h}:${String(m).padStart(2,'0')}`,
                            ampm: isPM ? "PM" : "AM", timeValue: (sortH*60)+m, distance: null
                        });
                    });
                });
            });
            log("Data Processed.");
        }

        // 2. INIT GOOGLE
        async function initApp() {
            log("Loading Google Maps...");
            try {
                const { Map } = await google.maps.importLibrary("maps");
                const { PlaceAutocompleteElement } = await google.maps.importLibrary("places");
                // Import the Place Library class specifically for manual search
                const lib = await google.maps.importLibrary("places");
                PlaceLib = lib.Place;

                // SETUP OPTION 1 (The Component)
                const container = document.getElementById('place-autocomplete-container');
                const autocomplete = new PlaceAutocompleteElement();
                autocomplete.id = "place-input";
                container.appendChild(autocomplete);

                // LISTENER FOR OPTION 1
                autocomplete.addEventListener('gmp-places-select', async ({ place }) => {
                    log("OPTION 1 EVENT FIRED!");
                    try {
                        await place.fetchFields({ fields: ['displayName', 'location'] });
                        setLocation(place.location.lat(), place.location.lng(), place.displayName);
                    } catch(e) { log("Option 1 Error: " + e.message); }
                });

                // SETUP MAP
                map = new Map(document.getElementById("map-view"), {
                    center: { lat: 40.091, lng: -74.218 },
                    zoom: 13, disableDefaultUI: true, mapId: "DEMO_MAP_ID"
                });
                log("Ready.");

            } catch(e) { log("INIT FAIL: " + e.message); }
        }

        // 3. MANUAL SEARCH (OPTION 2)
        async function runManualSearch() {
            const query = document.getElementById('manual-input').value;
            if(!query) return;
            
            log(`Option 2 Searching: "${query}"...`);
            
            if(!PlaceLib) { log("Google Place Library not loaded yet."); return; }

            try {
                // Use NEW SearchByText API (Not Legacy Geocoder)
                const { places } = await PlaceLib.searchByText({
                    textQuery: query,
                    fields: ['displayName', 'location'],
                    maxResultCount: 1
                });

                if (places && places.length > 0) {
                    const p = places[0];
                    log(`Option 2 Found: ${p.displayName}`);
                    setLocation(p.location.lat(), p.location.lng(), p.displayName);
                } else {
                    log("Option 2: No results found.");
                    alert("No city found. Try adding state (e.g. NJ).");
                }
            } catch(e) {
                log("Option 2 Error: " + e.message);
            }
        }

        // 4. SHARED LOGIC
        function setLocation(lat, lng, name) {
            searchCenter = { lat, lng, name };
            document.getElementById('status-display').innerText = `SELECTED: ${name}`;
            log(`Location Set: ${lat.toFixed(4)}, ${lng.toFixed(4)}`);
            
            if(map) {
                map.setCenter({ lat, lng });
                map.setZoom(13);
            }
            
            runFilter();
        }

        function runFilter() {
            if(!searchCenter) return;
            const results = allMinyanim.map(m => {
                m.distance = getDistance(searchCenter.lat, searchCenter.lng, m.lat, m.lng);
                return m;
            }).filter(m => m.distance <= 20); // 20 miles hardcoded for test

            results.sort((a,b) => a.distance - b.distance);
            
            log(`Found ${results.length} results.`);
            renderList(results);
        }

        function renderList(results) {
            const list = document.getElementById('list-view');
            list.innerHTML = '';
            if(results.length === 0) {
                list.innerHTML = "No results.";
                return;
            }
            results.forEach(m => {
                const div = document.createElement('div');
                div.className = 'minyan-card';
                div.innerHTML = `<b>${m.name}</b><br>${m.distance.toFixed(1)} mi - ${m.timeDisplay} ${m.ampm}`;
                list.appendChild(div);
            });
        }

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 3958.8; 
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2); 
            return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a))); 
        }
    </script>
    
    <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAOpNebt0dPJUmiEw-i1W-Dx_UezLpIvxI&loading=async&libraries=places,maps,marker&callback=initApp"></script>
</body>
</html>
