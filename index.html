<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ShulTime App</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        :root { --primary: #0D2B4F; --accent: #E3F2FD; --bg: #F2F4F8; }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Roboto", sans-serif; background: var(--bg); color: #111; padding-bottom: 200px; }
        
        /* FLOATING HEADER */
        .floating-header {
            position: fixed; top: 15px; left: 15px; right: 15px; z-index: 1000;
            display: flex; gap: 10px; align-items: center; pointer-events: none;
        }

        /* SEARCH BAR */
        .search-container {
            flex-grow: 1; background: white; height: 50px; border-radius: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15); display: flex; align-items: center;
            padding-left: 20px; padding-right: 5px; pointer-events: auto;
        }

        #search-input {
            border: none; background: transparent; font-size: 16px; color: #111;
            flex-grow: 1; height: 100%; outline: none; font-weight: 500;
        }

        /* CIRCLE BUTTONS */
        .circle-btn {
            width: 50px; height: 50px; border-radius: 50%; background: white; border: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15); display: flex; align-items: center; justify-content: center;
            cursor: pointer; color: var(--primary); pointer-events: auto; transition: transform 0.1s;
        }
        .circle-btn:active { transform: scale(0.95); }
        .go-btn {
            background: var(--primary); color: white; border-radius: 50%; 
            width: 40px; height: 40px; border: none; display: flex; align-items: center; justify-content: center;
        }
        .map-btn { background: var(--primary); color: white; }

        /* FILTER DRAWER */
        #filter-drawer {
            display: none; position: fixed; top: 80px; left: 15px; right: 15px;
            background: white; border-radius: 16px; padding: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.25); z-index: 999;
            max-height: 70vh; overflow-y: auto;
        }

        .filter-section { margin-bottom: 20px; border-bottom: 1px solid #f0f0f0; padding-bottom: 15px; }
        .filter-label { font-size: 11px; font-weight: 800; color: #888; text-transform: uppercase; margin-bottom: 8px; display: block; }
        
        /* CHIP BUTTONS */
        .chip-group { display: flex; flex-wrap: wrap; gap: 8px; }
        .chip {
            padding: 8px 16px; border-radius: 20px; border: 1px solid #ddd; background: #fff;
            font-size: 13px; font-weight: 600; color: #444; cursor: pointer;
        }
        .chip.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* MAIN CONTENT */
        #list-view { padding: 15px; padding-top: 90px; }
        #map-view { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 0; }

        /* CARDS */
        .minyan-card {
            background: white; border-radius: 12px; padding: 16px; margin-bottom: 10px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.04); border-left: 5px solid #ccc;
        }
        .type-Shacharis { border-left-color: #4CAF50; } 
        .type-Mincha { border-left-color: #FF9800; }    
        .type-Maariv { border-left-color: #3F51B5; }    

        .card-left h3 { margin: 0 0 4px 0; font-size: 16px; color: var(--primary); }
        .distance-tag { font-size: 11px; color: #fff; background: #666; padding: 2px 6px; border-radius: 8px; margin-left: 5px; }
        .time-display { font-size: 20px; font-weight: 800; color: var(--primary); }
        .ampm-label { font-size: 12px; font-weight: 600; color: #555; margin-left: 2px; }

        /* STATUS PILL */
        #status-pill {
            position: fixed; top: 75px; left: 50%; transform: translateX(-50%);
            background: rgba(13, 43, 79, 0.9); color: white; padding: 6px 16px;
            border-radius: 20px; font-size: 12px; font-weight: 600; 
            backdrop-filter: blur(4px); z-index: 800; display: none;
        }

        /* FAB */
        .fab-location {
            position: fixed; bottom: 30px; right: 20px; width: 56px; height: 56px;
            background: #fff; border-radius: 50%; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            border: none; color: #333; display: flex; align-items: center; justify-content: center; 
            cursor: pointer; z-index: 200;
        }

        /* INPUTS */
        .radius-row { display: flex; align-items: center; gap: 10px; }
        input[type=range] { flex-grow: 1; accent-color: var(--primary); }
        .radius-input { width: 60px; padding: 8px; border: 1px solid #ddd; border-radius: 8px; text-align: center; font-weight: bold; }
        .time-inputs-row { display: flex; gap: 10px; margin-top: 5px; }
        .time-input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px; text-align: center; }
        .action-btn { width: 100%; background: #eee; color: #333; border: none; padding: 12px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; margin-top: 8px; }
        .primary-action { background: var(--primary); color: white; }
    </style>
</head>
<body>

    <div class="floating-header">
        <div class="search-container">
            <input type="text" id="search-input" placeholder="Search City (e.g. Lakewood)">
            <button class="go-btn" onclick="manualSearch()">
                <i class="material-icons" style="font-size:20px;">arrow_forward</i>
            </button>
        </div>

        <button class="circle-btn" onclick="toggleFilters()">
            <i class="material-icons">tune</i>
        </button>

        <button class="circle-btn map-btn" onclick="toggleView()">
            <i class="material-icons" id="toggle-icon">map</i>
        </button>
    </div>

    <div id="status-pill"></div>

    <div id="filter-drawer">
        <div class="filter-section">
            <label class="filter-label">Radius (Miles)</label>
            <div class="radius-row">
                <input type="range" id="radius-slider" min="0.1" max="99.9" step="0.1" value="20" oninput="updateRadius(this.value)">
                <input type="number" id="radius-input" class="radius-input" value="20" onchange="updateRadius(this.value)">
            </div>
        </div>

        <div class="filter-section">
            <label class="filter-label">Sort By</label>
            <div class="chip-group">
                <div class="chip active" onclick="setFilter('sort', 'distance', this)">Distance</div>
                <div class="chip" onclick="setFilter('sort', 'time_asc', this)">Earliest</div>
                <div class="chip" onclick="setFilter('sort', 'time_desc', this)">Latest</div>
            </div>
        </div>

        <div class="filter-section">
            <label class="filter-label">Tefillah</label>
            <div class="chip-group">
                <div class="chip active" onclick="setFilter('tefillah', '', this)">All</div>
                <div class="chip" onclick="setFilter('tefillah', 'Shacharis', this)">Shacharis</div>
                <div class="chip" onclick="setFilter('tefillah', 'Mincha', this)">Mincha</div>
                <div class="chip" onclick="setFilter('tefillah', 'Maariv', this)">Maariv</div>
            </div>
        </div>

        <div class="filter-section">
            <label class="filter-label">Time Range</label>
            <div class="time-inputs-row">
                <input type="time" id="time-start" class="time-input" onchange="onStartTimeChange()">
                <input type="time" id="time-end" class="time-input" onchange="applyFilters()">
            </div>
            <div style="display:flex; gap:10px;">
                <button class="action-btn" onclick="setAllDay()">Show All Day</button>
                <button class="action-btn primary-action" onclick="setNextHour()">Next Hour</button>
            </div>
        </div>

        <button class="action-btn primary-action" onclick="toggleFilters()">Done</button>
    </div>

    <div id="list-view">
        <div style="text-align:center; padding:60px 20px; color:#999;">
            <i class="material-icons" style="font-size:48px; opacity:0.3; margin-bottom:10px;">location_on</i><br>
            <strong>Welcome</strong><br>
            Please search a city above or<br>click the location button below.
        </div>
    </div>
    <div id="map-view"></div>

    <button class="fab-location" onclick="useMyLocation()">
        <i class="material-icons">my_location</i>
    </button>

    <script>
        let map, allMinyanim = [];
        let searchCenter = null;
        let currentRadius = 20.0;
        let filters = { sort: 'distance', tefillah: '', nusach: '' };
        let mapMarkers = []; // Store markers to clear them later

        // CITY DICTIONARY (Backup)
        const CITIES = {
            "lakewood": { lat: 40.091, lng: -74.218, name: "Lakewood, NJ" },
            "brooklyn": { lat: 40.620, lng: -73.945, name: "Brooklyn, NY" },
            "monsey": { lat: 41.115, lng: -74.066, name: "Monsey, NY" },
            "passaic": { lat: 40.856, lng: -74.128, name: "Passaic, NJ" }
        };

        // 1. INIT
        document.getElementById('time-start').value = "00:00";
        document.getElementById('time-end').value = "23:59";

        fetch('database.json').then(r => r.json()).then(data => {
            processMinyanim(data);
        });

        function processMinyanim(data) {
            allMinyanim = [];
            data.forEach(shul => {
                ['Shacharis','Mincha','Maariv'].forEach(type => {
                    if(!shul[type.toLowerCase()]) return;
                    shul[type.toLowerCase()].split(',').forEach(t => {
                        let raw = t.trim().replace(/[^0-9:]/g, '');
                        let [h, m] = raw.split(':').map(Number);
                        let isPM = (type==='Maariv' || (type==='Mincha' && h<9));
                        let sortH = (isPM && h<12) ? h+12 : ((!isPM && h===12) ? 0 : h);
                        allMinyanim.push({
                            name: shul.name, address: shul.address,
                            lat: shul.lat, lng: shul.lng, nusach: shul.nusach,
                            tefillah: type, timeDisplay: `${h}:${String(m).padStart(2,'0')}`,
                            ampm: isPM ? "PM" : "AM", timeValue: (sortH*60)+m, distance: null
                        });
                    });
                });
            });
        }

        // 2. SEARCH LOGIC (Manual + API)
        function manualSearch() {
            const query = document.getElementById('search-input').value.toLowerCase().trim();
            if(!query) return;

            // 1. Dictionary Check (Fast)
            for(const key in CITIES) {
                if(query.includes(key)) {
                    setSearchLocation(CITIES[key].lat, CITIES[key].lng, CITIES[key].name);
                    return;
                }
            }

            // 2. Real API Search
            const geocoder = new google.maps.Geocoder();
            geocoder.geocode({ 'address': query }, (results, status) => {
                if (status === 'OK') {
                    const loc = results[0].geometry.location;
                    setSearchLocation(loc.lat(), loc.lng(), results[0].formatted_address.split(',')[0]);
                } else {
                    alert("Location not found. Try adding state code (e.g. 'Teaneck NJ').");
                }
            });
        }

        function setSearchLocation(lat, lng, name) {
            searchCenter = { lat, lng, name };
            const pill = document.getElementById('status-pill');
            pill.style.display = 'block';
            pill.innerText = `Near: ${name}`;
            
            if(map) {
                map.setCenter({ lat, lng });
                map.setZoom(13);
            }
            applyFilters();
        }

        function applyFilters() {
            if(!searchCenter) return;

            const [sH, sM] = document.getElementById('time-start').value.split(':').map(Number);
            const [eH, eM] = document.getElementById('time-end').value.split(':').map(Number);
            const startVal = (sH*60)+sM;
            const endVal = (eH*60)+eM;

            // Calc Distance
            let results = allMinyanim.map(m => {
                m.distance = getDistance(searchCenter.lat, searchCenter.lng, m.lat, m.lng);
                return m;
            }).filter(m => m.distance <= currentRadius);

            // Filter
            if(filters.tefillah) results = results.filter(m => m.tefillah === filters.tefillah);
            if(filters.nusach) results = results.filter(m => m.nusach === filters.nusach);
            results = results.filter(m => m.timeValue >= startVal && m.timeValue <= endVal);

            // Sort
            if(filters.sort === 'distance') results.sort((a,b) => a.distance - b.distance);
            else if(filters.sort === 'time_asc') results.sort((a,b) => a.timeValue - b.timeValue);
            else if(filters.sort === 'time_desc') results.sort((a,b) => b.timeValue - a.timeValue);

            renderList(results);
            updateMap(results);
        }

        function renderList(results) {
            const list = document.getElementById('list-view');
            list.innerHTML = '';
            
            if(results.length === 0) {
                list.innerHTML = `<div style="text-align:center; padding:40px; color:#888;">No results found within ${currentRadius} miles.</div>`;
                return;
            }

            results.forEach(m => {
                const card = document.createElement('div');
                card.className = `minyan-card type-${m.tefillah}`;
                card.innerHTML = `
                    <div class="card-left">
                        <h3>${m.name} <span class="distance-tag">${m.distance.toFixed(1)} mi</span></h3>
                        <span class="address">${m.address}</span>
                    </div>
                    <div class="card-right">
                        <div style="font-size:10px; font-weight:bold; color:#888; text-transform:uppercase;">${m.tefillah}</div>
                        <div class="time-display">${m.timeDisplay}<span class="ampm-label">${m.ampm}</span></div>
                    </div>
                `;
                card.onclick = () => {
                    toggleView(true);
                    if(map) {
                        map.setCenter({ lat: m.lat, lng: m.lng });
                        map.setZoom(16);
                    }
                };
                list.appendChild(card);
            });
        }

        // 3. MAP UPDATE (The Fix for Markers)
        async function updateMap(results) {
            if(!map) return;
            const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");
            
            // 1. CLEAR OLD MARKERS
            mapMarkers.forEach(m => m.map = null);
            mapMarkers = [];

            // 2. DEDUPLICATE LOCATIONS (One pin per shul)
            const locs = {};
            results.forEach(m => {
                const k = `${m.lat},${m.lng}`;
                if(!locs[k]) locs[k] = { ...m, count: 1 }; else locs[k].count++;
            });

            // 3. ADD NEW MARKERS
            Object.values(locs).forEach(l => {
                const marker = new AdvancedMarkerElement({
                    map: map, position: { lat: l.lat, lng: l.lng }, title: l.name
                });
                mapMarkers.push(marker);
                
                marker.addListener("click", () => {
                    new google.maps.InfoWindow({ content: `<strong>${l.name}</strong><br>${l.count} Minyanim` }).open(map, marker);
                });
            });
        }

        // 4. UTILS
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 3958.8; 
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2); 
            return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a))); 
        }

        function useMyLocation() {
            document.getElementById('status-pill').style.display = 'block';
            document.getElementById('status-pill').innerText = "Locating...";
            navigator.geolocation.getCurrentPosition(pos => {
                setSearchLocation(pos.coords.latitude, pos.coords.longitude, "Current Location");
            }, e => alert("Location Denied"));
        }

        function clearSearch() {
            document.getElementById('search-input').value = "";
            searchCenter = null;
            document.getElementById('status-pill').style.display = 'none';
            document.getElementById('list-view').innerHTML = `<div style="text-align:center; padding:60px 20px; color:#999;">
            <i class="material-icons" style="font-size:48px; opacity:0.3; margin-bottom:10px;">location_on</i><br>
            <strong>Welcome</strong><br>Please search a city above or<br>click the location button below.</div>`;
            if(map) {
                mapMarkers.forEach(m => m.map = null);
                mapMarkers = [];
            }
        }

        function updateRadius(val) {
            currentRadius = parseFloat(val);
            document.getElementById('radius-slider').value = currentRadius;
            document.getElementById('radius-input').value = currentRadius;
            applyFilters();
        }

        function setFilter(type, val, btn) {
            filters[type] = val;
            btn.parentElement.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
            btn.classList.add('active');
            applyFilters();
        }

        function setAllDay() {
            document.getElementById('time-start').value = "00:00";
            document.getElementById('time-end').value = "23:59";
            applyFilters();
        }

        function setNextHour() {
            const now = new Date();
            const pad = n => String(n).padStart(2,'0');
            document.getElementById('time-start').value = `${pad(now.getHours())}:${pad(now.getMinutes())}`;
            now.setHours(now.getHours()+1);
            document.getElementById('time-end').value = `${pad(now.getHours())}:${pad(now.getMinutes())}`;
            applyFilters();
        }

        function onStartTimeChange() {
            const [h,m] = document.getElementById('time-start').value.split(':').map(Number);
            document.getElementById('time-end').value = `${String((h+1)%24).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
            applyFilters();
        }

        function toggleFilters() {
            const d = document.getElementById('filter-drawer');
            d.style.display = (d.style.display==='block') ? 'none' : 'block';
        }

        function toggleView(forceMap) {
            const list = document.getElementById('list-view');
            const mapV = document.getElementById('map-view');
            const icon = document.getElementById('toggle-icon');
            if(forceMap || list.style.display !== 'none') {
                list.style.display='none'; mapV.style.display='block'; icon.innerText='list';
            } else {
                list.style.display='block'; mapV.style.display='none'; icon.innerText='map';
            }
        }

        // GOOGLE INIT
        async function initApp() {
            const { Map } = await google.maps.importLibrary("maps");
            map = new Map(document.getElementById("map-view"), {
                center: { lat: 40.091, lng: -74.218 },
                zoom: 13, disableDefaultUI: true, mapId: "DEMO_MAP_ID"
            });
        }
    </script>
    
    <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAOpNebt0dPJUmiEw-i1W-Dx_UezLpIvxI&loading=async&libraries=places,maps,marker&callback=initApp"></script>
</body>
</html>
