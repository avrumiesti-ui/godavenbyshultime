<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ShulTime Redesign</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <div id="splash-screen">
        <div class="splash-content">
            <div class="logo-area">
                <i class="material-icons" style="font-size: 64px; color: white;">synagogue</i>
                <h1 style="color: white; margin: 10px 0;">GoDaven</h1>
            </div>
            
            <div class="splash-actions">
                <button class="btn-primary" onclick="useMyLocation()">
                    <i class="material-icons">my_location</i> Use My Location
                </button>
                <button class="btn-secondary" onclick="showSearch()">
                    <i class="material-icons">search</i> Search Location
                </button>
            </div>
        </div>
    </div>

    <div id="app-interface" style="display:none;">

        <div class="app-header">
            <div class="search-row">
                <div class="search-pill">
                    <i class="material-icons search-icon">search</i>
                    <input type="text" id="location-input" placeholder="Search location..." value="New York, NY">
                    <i class="material-icons clear-icon" onclick="clearSearch()">close</i>
                </div>
                <button class="toggle-btn" onclick="toggleView()">
                    <i class="material-icons" id="toggle-icon">map</i>
                </button>
            </div>

            <div class="filter-row">
                <div class="filter-chip active">
                    <span>Sort: Time</span>
                    <i class="material-icons">expand_more</i>
                </div>
                
                <div class="filter-chip">
                    <span>6:05a - 7:05a</span>
                    <i class="material-icons">expand_more</i>
                </div>

                <div class="filter-chip">
                    <span>Shacharis</span>
                    <i class="material-icons">expand_more</i>
                </div>
                
                <div class="filter-chip">
                    <span>Sefard</span>
                    <i class="material-icons">expand_more</i>
                </div>
            </div>
            
            <div class="results-count" id="results-count">
                52 Results found
            </div>
        </div>

        <div class="results-container" id="list-view">
            
            <div class="minyan-card">
                <div class="card-left">
                    <h3>Beit Midrash Beth Gavriel</h3>
                    <p class="address">20 W 47th St, New York, NY</p>
                    <div class="nusach-row">
                        <span class="nusach-tag ashkenaz">ASHKENAZ</span>
                    </div>
                </div>
                
                <div class="card-right">
                    <div class="tefillah-label">Mincha</div>
                    <div class="time-display">01:00 PM</div>
                </div>
            </div>

            <div class="minyan-card">
                <div class="card-left">
                    <h3>Millinery Center Synagogue</h3>
                    <p class="address">1025 6th Ave, New York, NY</p>
                    <div class="nusach-row">
                        <span class="nusach-tag ashkenaz">ASHKENAZ</span>
                    </div>
                </div>
                <div class="card-right">
                    <div class="tefillah-label">Mincha</div>
                    <div class="time-display">01:35 PM</div>
                </div>
            </div>

            <div class="minyan-card">
                <div class="card-left">
                    <h3>444 Madison Minyan</h3>
                    <p class="address">444 Madison Ave, New York, NY</p>
                    <div class="nusach-row">
                        <span class="nusach-tag sefard">SEFARD</span>
                    </div>
                </div>
                <div class="card-right">
                    <div class="tefillah-label">Mincha</div>
                    <div class="time-display">01:40 PM</div>
                </div>
            </div>
            
            <div style="height: 100px;"></div>
        </div>

        <div id="map-view">
            <div class="map-placeholder">User Location Map Loading...</div>
        </div>

    </div> <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDnUTsITaWpGnRUBNAI6wvXpEicyS0qZAY&libraries=places&callback=initApp"></script>

<script>
    let map;
    let markers = [];
    let infoWindow;

    // 1. Initialize App (Called by Google Maps URL above)
    function initApp() {
        // Initialize the map centered on New York (default)
        map = new google.maps.Map(document.getElementById("map-view"), {
            center: { lat: 40.7128, lng: -74.0060 },
            zoom: 13,
            disableDefaultUI: true, // Makes it look like an app
            styles: [ /* Optional: Add dark mode styles here if you want */ ]
        });
        
        infoWindow = new google.maps.InfoWindow();

        // Listen for Search "Enter" key
        document.getElementById('location-input').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                performSearch(e.target.value);
            }
        });
    }

    // 2. The Search Logic (Connects to Netlify)
    async function performSearch(query) {
        const listContainer = document.getElementById('list-view');
        const countLabel = document.getElementById('results-count');
        
        // Show loading state
        listContainer.innerHTML = '<div style="text-align:center; padding:20px; color:#888;">Searching...</div>';
        
        try {
            // CALL YOUR NETLIFY FUNCTION
            // This is the "magic link" between your frontend and backend
            const response = await fetch(`/.netlify/functions/get-minyanim?q=${encodeURIComponent(query)}`);
            
            if (!response.ok) throw new Error('Network response was not ok');
            
            const data = await response.json();
            
            // Clear loading
            listContainer.innerHTML = '';
            clearMarkers();

            // Update result count
            // Note: Adjust 'data.results' based on the actual API structure (e.g., data.shuls, data.minyanim)
            const results = data.results || data; 
            countLabel.innerText = `${results.length} Results found`;

            // If no results
            if (results.length === 0) {
                listContainer.innerHTML = '<div style="text-align:center; padding:20px;">No minyanim found here.</div>';
                return;
            }

            // 3. Loop through data and build UI
            results.forEach((shul, index) => {
                // A. Add Card to List
                const card = document.createElement('div');
                card.className = 'minyan-card';
                card.innerHTML = `
                    <div class="card-left">
                        <h3>${shul.name || shul.title}</h3>
                        <p class="address">${shul.address}</p>
                        <div class="nusach-row">
                            <span class="nusach-tag ashkenaz">${shul.nusach || 'N/A'}</span>
                        </div>
                    </div>
                    <div class="card-right">
                        <div class="tefillah-label">${shul.nextTefillah || 'Next'}</div>
                        <div class="time-display">${shul.nextTime || '--:--'}</div>
                    </div>
                `;
                
                // Clicking card zooms map to that shul
                card.onclick = () => {
                    toggleView('map');
                    map.setCenter({ lat: shul.lat, lng: shul.lng });
                    map.setZoom(16);
                };
                
                listContainer.appendChild(card);

                // B. Add Marker to Map
                addMapMarker(shul);
            });

            // Re-center map to fit all new markers
            if (markers.length > 0) {
                const bounds = new google.maps.LatLngBounds();
                markers.forEach(marker => bounds.extend(marker.getPosition()));
                map.fitBounds(bounds);
            }

        } catch (error) {
            console.error("Search Error:", error);
            listContainer.innerHTML = '<div style="text-align:center; padding:20px; color:red;">Error loading results.</div>';
        }
    }

    // 3. Map Helpers
    function addMapMarker(shul) {
        if (!shul.lat || !shul.lng) return;

        const marker = new google.maps.Marker({
            position: { lat: parseFloat(shul.lat), lng: parseFloat(shul.lng) },
            map: map,
            title: shul.name
        });

        marker.addListener("click", () => {
            infoWindow.setContent(`<strong>${shul.name}</strong><br>${shul.nextTime || ''}`);
            infoWindow.open(map, marker);
        });

        markers.push(marker);
    }

    function clearMarkers() {
        for (let i = 0; i < markers.length; i++) {
            markers[i].setMap(null);
        }
        markers = [];
    }

    // 4. View Toggles (Same as before)
    function toggleView(forceView) {
        const list = document.getElementById('list-view');
        const mapDiv = document.getElementById('map-view');
        const icon = document.getElementById('toggle-icon');
        
        // Use 'forceView' to switch specifically to map or list, or toggle if undefined
        const isListVisible = list.style.display !== 'none';
        const targetIsMap = forceView === 'map' || (forceView === undefined && isListVisible);

        if (targetIsMap) {
            list.style.display = 'none';
            mapDiv.style.display = 'block'; // Changed to block for Google Maps compatibility
            icon.innerText = 'list';
            // Trigger map resize so it doesn't look gray/broken
            google.maps.event.trigger(map, "resize"); 
        } else {
            list.style.display = 'block';
            mapDiv.style.display = 'none';
            icon.innerText = 'map';
        }
    }

    function showSearch() {
        document.getElementById('splash-screen').style.display = 'none';
        document.getElementById('app-interface').style.display = 'block';
        // Trigger a default search so the page isn't empty
        performSearch("New York"); 
    }
    
    function useMyLocation() {
        document.getElementById('splash-screen').style.display = 'none';
        document.getElementById('app-interface').style.display = 'block';
        
        if (navigator.geolocation) {
             navigator.geolocation.getCurrentPosition(
                (position) => {
                    const userLat = position.coords.latitude;
                    const userLng = position.coords.longitude;
                    map.setCenter({ lat: userLat, lng: userLng });
                    // Optionally call performSearch with lat/lng if the API supports it
                    performSearch(`${userLat},${userLng}`); 
                },
                () => { alert("Could not get location."); }
            );
        }
    }
    
    function clearSearch() {
        document.getElementById('location-input').value = '';
    }
</script>
</body>
</html>

