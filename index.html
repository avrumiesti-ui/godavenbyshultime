<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ShulTime Schedule</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Roboto", sans-serif; background: #F2F4F8; color: #111; }
        
        /* HEADER */
        .app-header {
            position: sticky; top: 0; z-index: 100;
            background: white; padding: 10px 16px 10px 16px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        /* LOCATION DISPLAY BAR */
        #location-display-bar {
            background: #e3f2fd; color: #0d47a1; padding: 8px 12px; border-radius: 8px;
            font-size: 13px; font-weight: 600; text-align: center; margin-bottom: 10px;
            display: flex; align-items: center; justify-content: center; gap: 6px;
            cursor: pointer;
        }

        /* SEARCH ROW */
        .search-row { display: flex; gap: 8px; align-items: center; margin-bottom: 10px; }
        .search-pill {
            flex-grow: 1; display: flex; align-items: center;
            background: #F0F2F5; border-radius: 12px; padding: 0 12px; height: 50px; border: 1px solid #ddd;
            overflow: hidden; 
        }
        
        /* GOOGLE INPUT STYLING */
        gmp-place-autocomplete { width: 100%; display: inline-block; }
        gmp-place-autocomplete::part(input) {
            border: none; background: transparent; padding: 0; font-size: 16px; color: #111; outline: none; height: 100%;
        }

        /* FILTERS ROW */
        .filter-row { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; }
        .filter-row::-webkit-scrollbar { display: none; }

        .select-wrapper {
            position: relative; background: white; border: 1px solid #ddd;
            border-radius: 20px; padding: 0 10px;
            font-size: 13px; font-weight: 600; display: flex; align-items: center; 
            min-width: max-content; height: 32px; cursor: pointer;
        }
        .select-wrapper select { appearance: none; border: none; background: transparent; padding-right: 20px; font-size: 13px; outline: none; cursor: pointer; }
        .select-wrapper i { position: absolute; right: 8px; font-size: 16px; pointer-events: none; }

        /* TIME FILTER PANEL */
        #time-filter-panel {
            display: none; background: #fff; padding: 12px; border-radius: 12px; border: 1px solid #ddd; margin-bottom: 10px;
            flex-direction: column; gap: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .time-inputs-row { display: flex; gap: 10px; justify-content: center; width: 100%; }
        .time-group { display: flex; flex-direction: column; flex: 1; }
        .time-label { font-size: 10px; color: #666; font-weight: bold; margin-bottom: 3px; }
        .time-input { border: 1px solid #ccc; padding: 8px; border-radius: 6px; font-family: inherit; font-size: 14px; width: 100%; box-sizing: border-box; }
        
        /* NEXT HOUR BUTTON */
        .next-hour-btn {
            background: #0D2B4F; color: white; border: none; padding: 10px; border-radius: 8px;
            font-size: 13px; font-weight: 600; cursor: pointer; text-align: center; width: 100%;
        }

        /* CARD DESIGN */
        .minyan-card {
            background: white; border-radius: 12px; padding: 12px 16px; margin-bottom: 8px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.04); cursor: pointer;
            border-left: 5px solid transparent;
        }
        
        .type-Shacharis { border-left-color: #4CAF50; } 
        .type-Mincha { border-left-color: #FF9800; }    
        .type-Maariv { border-left-color: #3F51B5; }    

        .card-left h3 { margin: 0 0 4px 0; font-size: 16px; color: #0D2B4F; }
        .address { font-size: 12px; color: #777; margin: 0; display:block; margin-bottom:6px;}
        .distance-tag { font-size: 11px; color: #fff; background: #666; padding: 2px 6px; border-radius: 8px; margin-left: 5px; font-weight: normal; }

        .nusach-tag { font-size: 10px; padding: 3px 8px; border-radius: 12px; font-weight: 700; text-transform: uppercase; }
        .nusach-Ashkenaz { background: #E3F2FD; color: #1565C0; border: 1px solid #BBDEFB; } 
        .nusach-Sefard { background: #E8F5E9; color: #2E7D32; border: 1px solid #C8E6C9; } 
        .nusach-Ari { background: #F3E5F5; color: #7B1FA2; border: 1px solid #E1BEE7; } 
        .nusach-Other { background: #F5F5F5; color: #616161; }

        .card-right { text-align: right; }
        .time-display { font-size: 20px; font-weight: 800; color: #0D2B4F; letter-spacing: -0.5px; }
        .tefillah-label { font-size: 10px; font-weight: bold; text-transform: uppercase; color: #999; margin-top: 2px; }
        .ampm-label { font-size: 12px; font-weight: 600; color: #555; margin-left: 2px; }

        /* MAP */
        #map-view { display: none; height: calc(100vh - 180px); background: #e0e0e0; border-radius:12px; margin: 10px; }
        .toggle-btn { width: 50px; height: 50px; border: none; background: #0D2B4F; color: white; border-radius: 12px; display: flex; align-items: center; justify-content: center; }
        
        /* ERROR MESSAGE */
        #map-error { display: none; color: #D32F2F; font-size: 12px; text-align: center; margin-bottom: 10px; background: #FFEBEE; padding: 10px; border-radius: 8px; border: 1px solid #FFCDD2; }
        
        /* FAB */
        .fab-location {
            position: fixed; bottom: 20px; right: 20px; width: 56px; height: 56px;
            background: #fff; border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            border: none; color: #333; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 200;
        }
    </style>
</head>
<body>

    <div id="app-interface">
        <div class="app-header">
            <div id="map-error"></div>
            
            <div id="location-display-bar" onclick="useMyLocation()">
                <i class="material-icons" style="font-size:16px;">my_location</i>
                <span id="current-location-text">Detecting Location...</span>
            </div>

            <div class="search-row">
                <div class="search-pill">
                    <div id="place-autocomplete-container" style="flex-grow:1;"></div>
                    <i class="material-icons clear-icon" onclick="clearSearch()" style="color:#888; cursor:pointer;">close</i>
                </div>
                <button class="toggle-btn" onclick="toggleView()">
                    <i class="material-icons" id="toggle-icon">map</i>
                </button>
            </div>

            <div class="filter-row">
                <div class="select-wrapper">
                    <select id="filter-sort" onchange="applyFilters()">
                        <option value="distance">Sort: Distance</option>
                        <option value="time_asc">Sort: Earliest</option>
                        <option value="time_desc">Sort: Latest</option>
                    </select>
                    <i class="material-icons">sort</i>
                </div>

                <div class="select-wrapper">
                    <select id="filter-tefillah" onchange="applyFilters()">
                        <option value="">Tefillah: All</option>
                        <option value="Shacharis">Shacharis</option>
                        <option value="Mincha">Mincha</option>
                        <option value="Maariv">Maariv</option>
                    </select>
                    <i class="material-icons">expand_more</i>
                </div>

                <button class="select-wrapper" onclick="toggleTimePanel()" style="border:1px solid #ddd; background:white;">
                    <span style="font-size:13px; font-weight:600;" id="time-filter-label">Time: All Day</span>
                    <i class="material-icons" style="font-size:16px; margin-left:4px;">access_time</i>
                </button>
            </div>

            <div id="time-filter-panel">
                <button class="next-hour-btn" onclick="setNextHour()">
                    Show Only Next Hour
                </button>
                <div class="time-inputs-row">
                    <div class="time-group">
                        <span class="time-label">FROM</span>
                        <input type="time" id="time-start" class="time-input" onchange="onStartTimeChange()">
                    </div>
                    <div class="time-group">
                        <span class="time-label">TO</span>
                        <input type="time" id="time-end" class="time-input" onchange="applyFilters()">
                    </div>
                </div>
            </div>

            <div id="status-bar" style="text-align:center; font-size:12px; color:#666; margin-top:5px;">Locating...</div>
        </div>

        <div class="results-container" id="list-view" style="padding:12px;"></div>
        <div id="map-view"></div>
    </div>

    <button class="fab-location" onclick="useMyLocation()">
        <i class="material-icons">my_location</i>
    </button>

    <script>
        let map;
        let markers = []; 
        let infoWindow;
        let allShuls = []; 
        let allMinyanim = []; 
        let googleLoaded = false;
        
        let searchCenter = null; 
        const DEFAULT_RADIUS_MILES = 5;

        // 1. INIT
        document.getElementById('time-start').value = "00:00";
        document.getElementById('time-end').value = "23:59";

        fetch('database.json')
            .then(res => res.json())
            .then(data => {
                allShuls = data;
                processMinyanim(allShuls); 
                useMyLocation(); 
            })
            .catch(err => {
                document.getElementById('status-bar').innerText = "Error loading database file.";
            });

        // 2. PROCESS DATA
        function processMinyanim(shuls) {
            allMinyanim = [];
            shuls.forEach(shul => {
                const addTimes = (timeStr, type) => {
                    if (!timeStr) return;
                    const times = timeStr.split(',').map(t => t.trim());
                    times.forEach(t => {
                        let rawTime = t.replace(/[^0-9:]/g, ''); 
                        let [h, m] = rawTime.split(':').map(Number);
                        
                        let isPM = false;
                        if (type === 'Maariv') isPM = true;
                        if (type === 'Mincha' && h < 9) isPM = true; 
                        if (type === 'Shacharis' && h === 12) isPM = false; 

                        let sortHour = h;
                        if (isPM && h < 12) sortHour += 12;
                        if (!isPM && h === 12) sortHour = 0;

                        let ampm = isPM ? "PM" : "AM";
                        
                        allMinyanim.push({
                            id: shul.name + type + t, 
                            name: shul.name,
                            address: shul.address,
                            lat: shul.lat,
                            lng: shul.lng,
                            nusach: shul.nusach,
                            tefillah: type,
                            timeDisplay: `${h}:${String(m).padStart(2, '0')}`,
                            ampm: ampm,
                            timeValue: (sortHour * 60) + m,
                            distance: null
                        });
                    });
                };
                addTimes(shul.shacharis, 'Shacharis');
                addTimes(shul.mincha, 'Mincha');
                addTimes(shul.maariv, 'Maariv');
            });
        }

        // 3. TIME HELPERS
        function setNextHour() {
            const now = new Date();
            const currentH = now.getHours();
            const currentM = now.getMinutes();
            const startStr = `${String(currentH).padStart(2,'0')}:${String(currentM).padStart(2,'0')}`;
            
            now.setHours(now.getHours() + 1);
            const endH = now.getHours();
            const endM = now.getMinutes();
            const endStr = `${String(endH).padStart(2,'0')}:${String(endM).padStart(2,'0')}`;

            document.getElementById('time-start').value = startStr;
            document.getElementById('time-end').value = endStr;
            document.getElementById('time-filter-label').innerText = "Time: Next Hour";
            
            applyFilters();
            toggleTimePanel(); 
        }

        function onStartTimeChange() {
            const startVal = document.getElementById('time-start').value;
            if(!startVal) return;
            const [h, m] = startVal.split(':').map(Number);
            let endH = h + 1;
            if(endH > 23) endH = 23; 
            const endStr = `${String(endH).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
            document.getElementById('time-end').value = endStr;
            document.getElementById('time-filter-label').innerText = "Time: Custom";
            applyFilters();
        }

        // 4. APPLY FILTERS (With Fallback)
        function applyFilters() {
            if (!searchCenter) return;

            const sortType = document.getElementById('filter-sort').value;
            const tefillahFilter = document.getElementById('filter-tefillah').value;
            const startTime = document.getElementById('time-start').value;
            const endTime = document.getElementById('time-end').value;

            let results = allMinyanim;

            // Calc Distances
            results = results.map(m => {
                m.distance = getDistanceMiles(searchCenter.lat, searchCenter.lng, m.lat, m.lng);
                return m;
            });

            // Strict Radius Check
            let nearbyResults = results.filter(m => m.distance <= DEFAULT_RADIUS_MILES);

            // FALLBACK: NO RESULTS NEARBY -> RELOCATE
            if (nearbyResults.length === 0) {
                results.sort((a, b) => a.distance - b.distance);
                const closest = results[0]; 
                
                if (closest) {
                    searchCenter = {
                        lat: closest.lat,
                        lng: closest.lng,
                        name: closest.address.split(',')[1] || closest.name 
                    };
                    
                    alert(`No minyanim found within ${DEFAULT_RADIUS_MILES} miles.\n\nRelocating to nearest area: ${searchCenter.name}`);
                    updateLocationDisplay();
                    if(map) { map.setCenter(searchCenter); map.setZoom(14); }

                    // Recalculate
                    results = results.map(m => {
                        m.distance = getDistanceMiles(searchCenter.lat, searchCenter.lng, m.lat, m.lng);
                        return m;
                    });
                    nearbyResults = results.filter(m => m.distance <= DEFAULT_RADIUS_MILES);
                }
            }

            results = nearbyResults;

            // Standard Filters
            if (tefillahFilter) results = results.filter(m => m.tefillah === tefillahFilter);
            if (startTime && endTime) {
                const [startH, startM] = startTime.split(':').map(Number);
                const [endH, endM] = endTime.split(':').map(Number);
                const startMins = (startH * 60) + startM;
                const endMins = (endH * 60) + endM;
                results = results.filter(m => m.timeValue >= startMins && m.timeValue <= endMins);
            }

            // Sort
            if (sortType === 'distance') {
                results.sort((a, b) => a.distance - b.distance);
            } else if (sortType === 'time_asc') {
                results.sort((a, b) => a.timeValue - b.timeValue);
            } else if (sortType === 'time_desc') {
                results.sort((a, b) => b.timeValue - a.timeValue);
            }

            document.getElementById('status-bar').innerText = `Found ${results.length} minyanim within ${DEFAULT_RADIUS_MILES} mi`;

            renderResults(results);
            updateMapMarkers(results);
        }

        function renderResults(results) {
            const list = document.getElementById('list-view');
            list.innerHTML = '';
            
            if (results.length === 0) {
                list.innerHTML = '<div style="text-align:center; padding:40px; color:#888;">No minyanim found matching filters.</div>';
                return;
            }

            results.forEach(minyan => {
                let nusachClass = "nusach-Other";
                if(minyan.nusach === "Ashkenaz") nusachClass = "nusach-Ashkenaz";
                if(minyan.nusach === "Sefard") nusachClass = "nusach-Sefard";
                if(minyan.nusach === "Ari") nusachClass = "nusach-Ari";

                const distText = minyan.distance !== null ? `<span class="distance-tag">${minyan.distance.toFixed(1)} mi</span>` : '';

                const card = document.createElement('div');
                card.className = `minyan-card type-${minyan.tefillah}`; 
                card.innerHTML = `
                    <div class="card-left">
                        <h3>${minyan.name} ${distText}</h3>
                        <span class="address">${minyan.address}</span>
                        <span class="nusach-tag ${nusachClass}">${minyan.nusach}</span>
                    </div>
                    <div class="card-right">
                        <div class="tefillah-label">${minyan.tefillah}</div>
                        <div class="time-display">
                            ${minyan.timeDisplay}<span class="ampm-label">${minyan.ampm}</span>
                        </div>
                    </div>
                `;
                
                card.onclick = () => {
                    if (googleLoaded && map) {
                        toggleView('map');
                        map.setCenter({ lat: minyan.lat, lng: minyan.lng });
                        map.setZoom(16);
                        infoWindow.setContent(`<strong>${minyan.name}</strong><br>${minyan.timeDisplay} ${minyan.ampm}`);
                        infoWindow.setPosition({ lat: minyan.lat, lng: minyan.lng });
                        infoWindow.open(map);
                    } 
                };
                list.appendChild(card);
            });
        }

        async function updateMapMarkers(minyanResults) {
            if (!googleLoaded || !map) return;
            
            // Remove Old Markers (Advanced Markers Logic)
            markers.forEach(m => m.map = null);
            markers = [];

            const uniqueLocations = {};
            minyanResults.forEach(m => {
                const key = `${m.lat},${m.lng}`;
                if (!uniqueLocations[key]) uniqueLocations[key] = { lat: m.lat, lng: m.lng, title: m.name, count: 1 };
                else uniqueLocations[key].count++;
            });

            // Use New Advanced Markers
            const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");
            const bounds = new google.maps.LatLngBounds();

            Object.values(uniqueLocations).forEach(loc => {
                const marker = new AdvancedMarkerElement({
                    map: map,
                    position: { lat: loc.lat, lng: loc.lng },
                    title: loc.title,
                });
                
                marker.addListener("click", () => {
                    infoWindow.setContent(`<strong>${loc.title}</strong><br>${loc.count} Minyanim Here`);
                    infoWindow.setPosition(marker.position);
                    infoWindow.open(map);
                });
                
                markers.push(marker);
                bounds.extend({ lat: loc.lat, lng: loc.lng });
            });
        }

        function getDistanceMiles(lat1, lon1, lat2, lon2) {
            const R = 3958.8; 
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2); 
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
            return R * c;
        }

        function useMyLocation() {
            document.getElementById('current-location-text').innerText = "Locating...";
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        searchCenter = { 
                            lat: position.coords.latitude, 
                            lng: position.coords.longitude,
                            name: "Current Location"
                        };
                        updateLocationDisplay();
                        if(map) { map.setCenter(searchCenter); map.setZoom(14); }
                        applyFilters();
                    },
                    (err) => { 
                        document.getElementById('current-location-text').innerText = "Location Error";
                        // Fallback Default
                        searchCenter = { lat: 40.091, lng: -74.218, name: "Lakewood (Default)" };
                        updateLocationDisplay();
                        applyFilters();
                    }
                );
            }
        }

        function updateLocationDisplay() {
            if(searchCenter && searchCenter.name) {
                document.getElementById('current-location-text').innerText = `Searching near: ${searchCenter.name}`;
            }
        }

        function toggleTimePanel() {
            const p = document.getElementById('time-filter-panel');
            p.style.display = p.style.display === 'flex' ? 'none' : 'flex';
        }

        function toggleView(forceView) {
            const list = document.getElementById('list-view');
            const mapDiv = document.getElementById('map-view');
            const icon = document.getElementById('toggle-icon');
            const targetIsMap = forceView === 'map' || (forceView === undefined && list.style.display !== 'none');

            if (targetIsMap) {
                list.style.display = 'none'; mapDiv.style.display = 'block'; icon.innerText = 'list';
                if(map) google.maps.event.trigger(map, 'resize');
            } else {
                list.style.display = 'block'; mapDiv.style.display = 'none'; icon.innerText = 'map';
            }
        }
        
        function clearSearch() { 
            const el = document.querySelector('gmp-place-autocomplete');
            if(el) el.value = null;
            useMyLocation();
        }

        // --- GOOGLE INIT ---
        async function initApp() {
            try {
                const { Map } = await google.maps.importLibrary("maps");
                const { PlaceAutocompleteElement } = await google.maps.importLibrary("places");
                const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");

                googleLoaded = true;
                
                // 1. Map
                map = new Map(document.getElementById("map-view"), {
                    center: { lat: 40.091, lng: -74.218 },
                    zoom: 14, 
                    disableDefaultUI: true,
                    mapId: "DEMO_MAP_ID" // REQUIRED for Advanced Markers
                });
                infoWindow = new google.maps.InfoWindow();

                // 2. Autocomplete
                const autocomplete = new PlaceAutocompleteElement();
                autocomplete.id = "place-input";
                autocomplete.placeholder = "Change Location";
                document.getElementById("place-autocomplete-container").appendChild(autocomplete);

                // 3. Selection Listener
                autocomplete.addEventListener("gmp-places-select", async ({ place }) => {
                    await place.fetchFields({ fields: ['displayName', 'location'] });
                    
                    searchCenter = {
                        lat: place.location.lat(),
                        lng: place.location.lng(),
                        name: place.displayName
                    };
                    updateLocationDisplay();
                    
                    map.setCenter(searchCenter);
                    map.setZoom(14);
                    applyFilters();
                });

            } catch (e) { 
                console.error("Map Init Error:", e);
                window.gm_authFailure();
            }
        }
        
        window.gm_authFailure = function() {
            document.getElementById('map-error').style.display = 'block';
            document.getElementById('map-error').innerHTML = "<strong>Map Unavailable:</strong> Google API Key blocked.";
            googleLoaded = false;
        };
    </script>

    <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAOpNebt0dPJUmiEw-i1W-Dx_UezLpIvxI&loading=async&libraries=places,maps,marker&callback=initApp"></script>
</body>
</html>
