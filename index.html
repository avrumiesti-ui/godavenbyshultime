<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ShulTime Schedule</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Roboto", sans-serif; background: #F2F4F8; color: #111; }
        
        /* HEADER */
        .app-header {
            position: sticky; top: 0; z-index: 100;
            background: white; padding: 10px 16px 5px 16px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        /* SEARCH BAR (Container for New Google Component) */
        .search-row { display: flex; gap: 8px; align-items: center; margin-bottom: 5px; }
        .search-pill {
            flex-grow: 1; display: flex; align-items: center;
            background: #F0F2F5; border-radius: 12px; padding: 0 12px; height: 50px; border: 1px solid #ddd;
            overflow: hidden; /* Keeps the google input inside */
        }
        
        /* NEW GOOGLE INPUT STYLING */
        gmp-place-autocomplete {
            width: 100%;
            display: inline-block;
        }
        /* Hide the default border of the component to blend in */
        gmp-place-autocomplete::part(input) {
            border: none; background: transparent; padding: 0; font-size: 16px; color: #111; outline: none;
        }

        /* FILTERS ROW */
        .filter-row { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; padding-top: 5px; scrollbar-width: none; }
        .filter-row::-webkit-scrollbar { display: none; }

        .select-wrapper {
            position: relative; background: white; border: 1px solid #ddd;
            border-radius: 20px; padding: 0 10px;
            font-size: 13px; font-weight: 600; display: flex; align-items: center; 
            min-width: max-content; height: 32px; cursor: pointer;
        }
        .select-wrapper select { appearance: none; border: none; background: transparent; padding-right: 20px; font-size: 13px; outline: none; cursor: pointer; }
        .select-wrapper i { position: absolute; right: 8px; font-size: 16px; pointer-events: none; }

        /* TIME FILTER PANEL */
        #time-filter-panel {
            display: none; background: #fff; padding: 12px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 10px;
            flex-direction: row; gap: 15px; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .time-group { display: flex; flex-direction: column; }
        .time-label { font-size: 10px; color: #666; font-weight: bold; margin-bottom: 3px; }
        .time-input { border: 1px solid #ccc; padding: 5px; border-radius: 6px; font-family: inherit; font-size: 14px; }

        /* CARD DESIGN */
        .minyan-card {
            background: white; border-radius: 12px; padding: 12px 16px; margin-bottom: 8px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.04); cursor: pointer;
            border-left: 5px solid transparent;
        }
        
        /* Tefillah Types (Left Border) */
        .type-Shacharis { border-left-color: #4CAF50; } /* Green */
        .type-Mincha { border-left-color: #FF9800; }    /* Orange */
        .type-Maariv { border-left-color: #3F51B5; }    /* Blue */

        .card-left h3 { margin: 0 0 4px 0; font-size: 16px; color: #0D2B4F; }
        .address { font-size: 12px; color: #777; margin: 0; display:block; margin-bottom:6px;}
        
        /* NUSACH COLORS */
        .nusach-tag { font-size: 10px; padding: 3px 8px; border-radius: 12px; font-weight: 700; text-transform: uppercase; }
        .nusach-Ashkenaz { background: #E3F2FD; color: #1565C0; border: 1px solid #BBDEFB; } /* Blue */
        .nusach-Sefard { background: #E8F5E9; color: #2E7D32; border: 1px solid #C8E6C9; } /* Green */
        .nusach-Ari { background: #F3E5F5; color: #7B1FA2; border: 1px solid #E1BEE7; } /* Purple */
        .nusach-Other { background: #F5F5F5; color: #616161; }

        .card-right { text-align: right; }
        .time-display { font-size: 20px; font-weight: 800; color: #0D2B4F; letter-spacing: -0.5px; }
        .tefillah-label { font-size: 10px; font-weight: bold; text-transform: uppercase; color: #999; margin-top: 2px; }
        .ampm-label { font-size: 12px; font-weight: 600; color: #555; margin-left: 2px; }

        /* MAP */
        #map-view { display: none; height: calc(100vh - 120px); background: #e0e0e0; border-radius:12px; margin: 10px; }
        .toggle-btn { width: 50px; height: 50px; border: none; background: #0D2B4F; color: white; border-radius: 12px; display: flex; align-items: center; justify-content: center; }
        
        #map-error { display: none; color: #D32F2F; font-size: 12px; text-align: center; margin-bottom: 10px; background: #FFEBEE; padding: 10px; border-radius: 8px; border: 1px solid #FFCDD2; }
    </style>
</head>
<body>

    <div id="app-interface">
        <div class="app-header">
            <div id="map-error"></div>
            
            <div class="search-row">
                <div class="search-pill">
                    <i class="material-icons search-icon" style="color:#888;">search</i>
                    <div id="place-autocomplete-container" style="flex-grow:1;"></div>
                    <i class="material-icons clear-icon" onclick="clearSearch()">close</i>
                </div>
                <button class="toggle-btn" onclick="toggleView()">
                    <i class="material-icons" id="toggle-icon">map</i>
                </button>
            </div>

            <div class="filter-row">
                <div class="select-wrapper">
                    <select id="filter-sort" onchange="applyFilters()">
                        <option value="time_asc">Sort: Earliest</option>
                        <option value="time_desc">Sort: Latest</option>
                    </select>
                    <i class="material-icons">sort</i>
                </div>

                <div class="select-wrapper">
                    <select id="filter-tefillah" onchange="applyFilters()">
                        <option value="">Tefillah: All</option>
                        <option value="Shacharis">Shacharis</option>
                        <option value="Mincha">Mincha</option>
                        <option value="Maariv">Maariv</option>
                    </select>
                    <i class="material-icons">expand_more</i>
                </div>

                <div class="select-wrapper">
                    <select id="filter-nusach" onchange="applyFilters()">
                        <option value="">Nusach: All</option>
                        <option value="Ashkenaz">Ashkenaz</option>
                        <option value="Sefard">Sefard</option>
                        <option value="Ari">Ari</option>
                    </select>
                    <i class="material-icons">expand_more</i>
                </div>

                <button class="select-wrapper" onclick="toggleTimePanel()" style="border:1px solid #ddd; background:white;">
                    <span style="font-size:13px; font-weight:600;">Time</span>
                    <i class="material-icons" style="font-size:16px; margin-left:4px;">access_time</i>
                </button>
            </div>

            <div id="time-filter-panel">
                <div class="time-group">
                    <span class="time-label">FROM</span>
                    <input type="time" id="time-start" class="time-input" onchange="applyFilters()">
                </div>
                <div class="time-group">
                    <span class="time-label">TO</span>
                    <input type="time" id="time-end" class="time-input" onchange="applyFilters()">
                </div>
            </div>

            <div id="status-bar" style="text-align:center; font-size:12px; color:#666; margin-bottom:5px;">Loading Schedule...</div>
        </div>

        <div class="results-container" id="list-view" style="padding:12px;"></div>
        <div id="map-view"></div>
    </div>

    <script>
        let map;
        let markers = [];
        let infoWindow;
        let allShuls = []; 
        let allMinyanim = []; 
        let googleLoaded = false;
        let lastSearchQuery = "";

        // 1. INIT
        document.getElementById('time-start').value = "00:00";
        document.getElementById('time-end').value = "23:59";

        // Load Database
        fetch('database.json')
            .then(res => res.json())
            .then(data => {
                allShuls = data;
                processMinyanim(allShuls); 
                document.getElementById('status-bar').innerText = `Schedule Loaded (${allMinyanim.length} times)`;
                applyFilters(); 
            })
            .catch(err => {
                document.getElementById('status-bar').innerText = "Error loading database file.";
            });

        // 2. PROCESS DATA
        function processMinyanim(shuls) {
            allMinyanim = [];
            
            shuls.forEach(shul => {
                const addTimes = (timeStr, type) => {
                    if (!timeStr) return;
                    const times = timeStr.split(',').map(t => t.trim());
                    
                    times.forEach(t => {
                        let rawTime = t.replace(/[^0-9:]/g, ''); 
                        let [h, m] = rawTime.split(':').map(Number);
                        
                        let isPM = false;
                        if (type === 'Maariv') isPM = true;
                        if (type === 'Mincha' && h < 9) isPM = true; 
                        if (type === 'Shacharis' && h === 12) isPM = false; 

                        let sortHour = h;
                        if (isPM && h < 12) sortHour += 12;
                        if (!isPM && h === 12) sortHour = 0;

                        let displayH = h;
                        let ampm = isPM ? "PM" : "AM";
                        
                        allMinyanim.push({
                            id: shul.name + type + t, 
                            name: shul.name,
                            address: shul.address,
                            lat: shul.lat,
                            lng: shul.lng,
                            nusach: shul.nusach,
                            tefillah: type,
                            timeDisplay: `${displayH}:${String(m).padStart(2, '0')}`,
                            ampm: ampm,
                            timeValue: (sortHour * 60) + m
                        });
                    });
                };

                addTimes(shul.shacharis, 'Shacharis');
                addTimes(shul.mincha, 'Mincha');
                addTimes(shul.maariv, 'Maariv');
            });
        }

        // 3. APPLY FILTERS
        function applyFilters() {
            const sortType = document.getElementById('filter-sort').value;
            const tefillahFilter = document.getElementById('filter-tefillah').value;
            const nusachFilter = document.getElementById('filter-nusach').value;
            const startTime = document.getElementById('time-start').value;
            const endTime = document.getElementById('time-end').value;

            let results = allMinyanim;

            // Search (Filter by cached query)
            if (lastSearchQuery.length > 0) {
                results = results.filter(m => 
                    m.name.toLowerCase().includes(lastSearchQuery) || 
                    m.address.toLowerCase().includes(lastSearchQuery)
                );
            }

            if (tefillahFilter) results = results.filter(m => m.tefillah === tefillahFilter);
            if (nusachFilter) results = results.filter(m => m.nusach === nusachFilter);

            if (startTime && endTime) {
                const [startH, startM] = startTime.split(':').map(Number);
                const [endH, endM] = endTime.split(':').map(Number);
                const startMins = (startH * 60) + startM;
                const endMins = (endH * 60) + endM;
                results = results.filter(m => m.timeValue >= startMins && m.timeValue <= endMins);
            }

            if (sortType === 'time_asc') results.sort((a, b) => a.timeValue - b.timeValue);
            if (sortType === 'time_desc') results.sort((a, b) => b.timeValue - a.timeValue);

            renderResults(results);
        }

        // 4. RENDER LIST
        function renderResults(results) {
            const list = document.getElementById('list-view');
            const status = document.getElementById('status-bar');
            list.innerHTML = '';
            
            if(googleLoaded && map) {
                markers.forEach(m => m.setMap(null)); 
                markers = [];
            }

            if (results.length === 0) {
                status.innerText = "0 Results Found";
                list.innerHTML = '<div style="text-align:center; padding:40px; color:#888;">No minyanim found matching filters.</div>';
                return;
            }

            status.innerText = `Found ${results.length} minyanim`;

            results.forEach(minyan => {
                let nusachClass = "nusach-Other";
                if(minyan.nusach === "Ashkenaz") nusachClass = "nusach-Ashkenaz";
                if(minyan.nusach === "Sefard") nusachClass = "nusach-Sefard";
                if(minyan.nusach === "Ari") nusachClass = "nusach-Ari";

                const card = document.createElement('div');
                card.className = `minyan-card type-${minyan.tefillah}`; 
                card.innerHTML = `
                    <div class="card-left">
                        <h3>${minyan.name}</h3>
                        <span class="address">${minyan.address}</span>
                        <span class="nusach-tag ${nusachClass}">${minyan.nusach}</span>
                    </div>
                    <div class="card-right">
                        <div class="tefillah-label">${minyan.tefillah}</div>
                        <div class="time-display">
                            ${minyan.timeDisplay}<span class="ampm-label">${minyan.ampm}</span>
                        </div>
                    </div>
                `;
                
                card.onclick = () => {
                    if (googleLoaded && map) {
                        toggleView('map');
                        map.setCenter({ lat: minyan.lat, lng: minyan.lng });
                        map.setZoom(16);
                        const marker = new google.maps.Marker({
                            position: { lat: minyan.lat, lng: minyan.lng },
                            map: map, title: minyan.name
                        });
                        markers.push(marker);
                        infoWindow.setContent(`<strong>${minyan.name}</strong><br>${minyan.timeDisplay} ${minyan.ampm}`);
                        infoWindow.open(map, marker);
                    } 
                    else {
                        const confirmNav = confirm("Map Preview is unavailable (Waiting for Google Key).\n\nOpen navigation?");
                        if(confirmNav) {
                            window.open(`https://www.google.com/maps/search/?api=1&query=${minyan.address}`);
                        }
                    }
                };
                list.appendChild(card);
            });
        }

        // UI Helpers
        function toggleTimePanel() {
            const p = document.getElementById('time-filter-panel');
            p.style.display = p.style.display === 'flex' ? 'none' : 'flex';
        }

        function toggleView(forceView) {
            const list = document.getElementById('list-view');
            const mapDiv = document.getElementById('map-view');
            const icon = document.getElementById('toggle-icon');
            const targetIsMap = forceView === 'map' || (forceView === undefined && list.style.display !== 'none');

            if (targetIsMap) {
                list.style.display = 'none'; mapDiv.style.display = 'block'; icon.innerText = 'list';
            } else {
                list.style.display = 'block'; mapDiv.style.display = 'none'; icon.innerText = 'map';
            }
        }
        
        function clearSearch() { 
            lastSearchQuery = "";
            applyFilters();
            // Clear the actual web component text if possible, though strict shadow DOM makes it hard.
        }

        // --- NEW GOOGLE INIT ---
        async function initApp() {
            try {
                // Import the NEW Libraries
                const { Map } = await google.maps.importLibrary("maps");
                const { PlaceAutocompleteElement } = await google.maps.importLibrary("places");
                const { Marker } = await google.maps.importLibrary("marker");

                googleLoaded = true;
                
                // 1. Setup Map
                map = new Map(document.getElementById("map-view"), {
                    center: { lat: 40.091, lng: -74.218 },
                    zoom: 13, disableDefaultUI: true,
                });
                infoWindow = new google.maps.InfoWindow();

                // 2. Setup New Autocomplete Element
                const autocomplete = new PlaceAutocompleteElement();
                autocomplete.id = "place-input";
                document.getElementById("place-autocomplete-container").appendChild(autocomplete);

                // Listen for user selection
                autocomplete.addEventListener("gmp-places-select", ({ place }) => {
                    const placeName = place.displayName || ""; // Get text
                    lastSearchQuery = placeName.toLowerCase();
                    applyFilters(); // Filter list
                });

            } catch (e) { 
                console.error("Map Init Error:", e);
                window.gm_authFailure();
            }
        }
        
        window.gm_authFailure = function() {
            document.getElementById('map-error').style.display = 'block';
            document.getElementById('map-error').innerHTML = "<strong>Map Unavailable:</strong> Google API Key blocked.<br>Add <code>https://avrumiesti-ui.github.io/godavenbyshultime/*</code> to Google Cloud Console.";
            googleLoaded = false;
        };
    </script>

    <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAOpNebt0dPJUmiEw-i1W-Dx_UezLpIvxI&loading=async&libraries=places,maps,marker&callback=initApp"></script>
</body>
</html>
